<!-- SSH Guardian v3.0 - Blocked IPs Page (Active + History Tabs) -->
<div id="page-blocked-ips" class="page-content" style="display: none;">
    <div class="ev-header">
        <div>
            <h1>Blocked IPs</h1>
            <p>View active blocks and block history</p>
        </div>
        <button class="refresh-btn" onclick="BLK.refresh()">
            <span class="refresh-icon">&#8635;</span> Refresh
        </button>
    </div>

    <!-- Tab Navigation -->
    <div class="blk-tabs">
        <button class="blk-tab active" data-tab="active" onclick="BLK.switchTab('active')">Active Blocks</button>
        <button class="blk-tab" data-tab="history" onclick="BLK.switchTab('history')">History</button>
    </div>

    <!-- Stats Row (only for Active tab) -->
    <div id="blkStatsRow" class="blk-stats-row">
        <div class="blk-stat-card blk-stat-red">
            <span class="blk-stat-value" id="blk-stat-total">-</span>
            <span class="blk-stat-label">Active Blocks</span>
        </div>
        <div class="blk-stat-card blk-stat-blue">
            <span class="blk-stat-value" id="blk-stat-ufw">-</span>
            <span class="blk-stat-label">UFW DENY</span>
        </div>
        <div class="blk-stat-card blk-stat-orange">
            <span class="blk-stat-value" id="blk-stat-fail2ban">-</span>
            <span class="blk-stat-label">Fail2ban</span>
        </div>
    </div>

    <!-- Filters -->
    <div class="ev-filters">
        <input type="text" id="blkIp" placeholder="Filter IP..." onkeyup="BLK.debounceFilter()">
        <select id="blkSource" onchange="BLK.load()">
            <option value="">All Sources</option>
            <option value="ufw">UFW</option>
            <option value="fail2ban">Fail2ban</option>
        </select>
        <select id="blkAgent" onchange="BLK.load()"><option value="">All Agents</option></select>
        <!-- History-only filters (hidden on active tab) -->
        <select id="blkStatus" onchange="BLK.load()" style="display:none"><option value="">All Status</option><option value="blocked">Blocked</option><option value="escalate">Escalated</option><option value="unblocked">Unblocked</option></select>
        <select id="blkTime" onchange="BLK.load()" style="display:none"><option value="24h">24 Hours</option><option value="7d" selected>7 Days</option><option value="30d">30 Days</option><option value="90d">90 Days</option></select>
    </div>

    <div id="blkBox" class="ev-card"><div class="ev-msg">Loading...</div></div>

    <div id="blkPg" class="ev-pg" style="display:none">
        <span id="blkInfo"></span>
        <div><button onclick="BLK.load(BLK.pg-1)">&#8592; Prev</button><button onclick="BLK.load(BLK.pg+1)">Next &#8594;</button></div>
    </div>
</div>

<style>
/* Blocked IPs Page - Uses shared CSS components */

/* Tab Navigation */
.blk-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
}
.blk-tab {
    padding: 10px 24px;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    color: var(--text-secondary);
    transition: all 0.2s;
}
.blk-tab.active {
    color: var(--azure-blue, #3b82f6);
    border-bottom-color: var(--azure-blue, #3b82f6);
}
.blk-tab:hover:not(.active) {
    color: var(--text-primary);
    background: var(--surface-hover, rgba(0,0,0,0.05));
}

/* Stats Row */
.blk-stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 20px;
}
.blk-stat-card {
    background: var(--surface);
    border-radius: 10px;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border);
}
.blk-stat-value {
    font-size: 28px;
    font-weight: 700;
    line-height: 1.2;
}
.blk-stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}
.blk-stat-red .blk-stat-value { color: var(--color-danger, #ef4444); }
.blk-stat-blue .blk-stat-value { color: var(--azure-blue, #3b82f6); }
.blk-stat-orange .blk-stat-value { color: var(--color-warning, #f59e0b); }

@media (max-width: 768px) {
    .blk-stats-row { grid-template-columns: repeat(3, 1fr); }
}
@media (max-width: 480px) {
    .blk-stats-row { grid-template-columns: 1fr; }
}

/* Table minimum width override */
#page-blocked-ips .ev-tbl{min-width:600px}

/* IP cell font-weight override */
#page-blocked-ips .c-ip{font-weight:600}
</style>

<script>
const BLK = {
    pg: 1,
    total: 0,
    filterTimer: null,
    currentTab: 'active',

    async init() {
        await this.loadAgents();
        this.load(1);
    },

    async loadAgents() {
        try {
            const r = await fetch('/api/agents/list');
            const d = await r.json();
            if (d.success && d.agents) {
                const s = document.getElementById('blkAgent');
                while (s.options.length > 1) s.remove(1);
                d.agents.forEach(a => s.add(new Option(a.hostname || a.agent_id, a.id)));
            }
        } catch (e) {}
    },

    switchTab(tab) {
        this.currentTab = tab;
        this.pg = 1;
        document.querySelectorAll('.blk-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));

        // Show/hide elements based on tab
        const statsRow = document.getElementById('blkStatsRow');
        const statusFilter = document.getElementById('blkStatus');
        const timeFilter = document.getElementById('blkTime');

        if (tab === 'history') {
            statsRow.style.display = 'none';
            statusFilter.style.display = '';
            timeFilter.style.display = '';
        } else {
            statsRow.style.display = '';
            statusFilter.style.display = 'none';
            timeFilter.style.display = 'none';
        }

        this.load(1);
    },

    refresh() { this.load(1); },

    debounceFilter() {
        clearTimeout(this.filterTimer);
        this.filterTimer = setTimeout(() => this.load(), 400);
    },

    async load(page = 1) {
        if (this.currentTab === 'history') {
            await this.loadHistory(page);
        } else {
            await this.loadActive();
        }
    },

    async loadActive() {
        const box = document.getElementById('blkBox');
        const pgEl = document.getElementById('blkPg');
        box.innerHTML = '<div class="ev-msg">Loading...</div>';
        if (pgEl) pgEl.style.display = 'none';

        const ip = document.getElementById('blkIp')?.value?.trim() || '';
        const source = document.getElementById('blkSource')?.value || '';
        const agent = document.getElementById('blkAgent')?.value || '';

        const params = new URLSearchParams({ _t: Date.now() });
        if (ip) params.append('search', ip);
        if (agent) params.append('agent_id', agent);

        try {
            const r = await fetch(`/api/dashboard/blocking/real-blocks?${params.toString()}`);
            const d = await r.json();

            if (d.success && d.blocks?.length) {
                let blocks = d.blocks;

                // Client-side filter by source
                if (source) {
                    blocks = blocks.filter(b => b.source === source);
                }

                // Update stats
                document.getElementById('blk-stat-total').textContent = blocks.length;
                document.getElementById('blk-stat-ufw').textContent = d.ufw_count || blocks.filter(b => b.source === 'ufw').length;
                document.getElementById('blk-stat-fail2ban').textContent = d.fail2ban_count || blocks.filter(b => b.source === 'fail2ban').length;

                box.innerHTML = `<div class="ev-tbl-wrap"><table class="ev-tbl"><thead><tr>
                    <th>Blocked At</th><th>IP Address</th><th>Source</th><th>Agent</th><th>Reason</th>
                </tr></thead><tbody>${blocks.map(b => {
                    const srcClass = b.source === 'ufw' ? 'ufw' : 'fail2ban';
                    const srcLabel = b.block_type || (b.source === 'ufw' ? 'UFW DENY' : 'Fail2ban');
                    return `<tr>
                    <td style="white-space:nowrap;font-size:12px;color:var(--text-secondary)">${this.fmtTime(b.blocked_at)}</td>
                    <td class="c-ip">${this.esc(b.ip_address)}</td>
                    <td><span class="c-source ${srcClass}">${this.esc(srcLabel)}</span></td>
                    <td><span class="c-agent">${this.esc(b.agent_name || 'System')}</span></td>
                    <td><div class="c-reason" title="${this.esc(b.reason || '')}">${this.esc(b.reason || '-')}</div></td>
                </tr>`;
                }).join('')}</tbody></table></div>`;

            } else {
                document.getElementById('blk-stat-total').textContent = '0';
                document.getElementById('blk-stat-ufw').textContent = '0';
                document.getElementById('blk-stat-fail2ban').textContent = '0';
                box.innerHTML = '<div class="ev-msg">No active blocks found</div>';
            }
        } catch (e) {
            console.error('Error loading active blocks:', e);
            box.innerHTML = '<div class="ev-msg err">Failed to load active blocks</div>';
        }
    },

    async loadHistory(page = 1) {
        this.pg = page;
        const box = document.getElementById('blkBox');
        const pgEl = document.getElementById('blkPg');
        box.innerHTML = '<div class="ev-msg">Loading...</div>';
        if (pgEl) pgEl.style.display = 'none';

        const ip = document.getElementById('blkIp')?.value?.trim() || '';
        const status = document.getElementById('blkStatus')?.value || '';
        const source = document.getElementById('blkSource')?.value || '';
        const agent = document.getElementById('blkAgent')?.value || '';
        const time = document.getElementById('blkTime')?.value || '7d';

        const params = new URLSearchParams({
            page_size: 50,
            page: page,
            time_range: time,
            _t: Date.now()
        });
        if (ip) params.append('ip_filter', ip);
        if (status) params.append('event_type', status);
        if (source) params.append('block_source', source);
        if (agent) params.append('agent_id', agent);

        try {
            const r = await fetch(`/api/dashboard/block-events/list?${params.toString()}`);
            const d = await r.json();

            if (d.success && d.events?.length) {
                this.total = d.total || d.events.length;
                const totalPages = Math.ceil(this.total / 50);

                box.innerHTML = `<div class="ev-tbl-wrap"><table class="ev-tbl"><thead><tr>
                    <th>Time</th><th>IP Address</th><th>Event</th><th>Source</th><th>Agent</th><th>Reason</th>
                </tr></thead><tbody>${d.events.map(e => {
                    const src = (e.block_source || '').toLowerCase();
                    const srcClass = src.includes('rule') ? 'rule_based' : src.includes('ml') ? 'ml' : src.includes('fail2ban') ? 'fail2ban' : src.includes('ufw') ? 'ufw' : 'manual';
                    const srcLabel = e.block_source ? e.block_source.replace(/_/g, ' ').replace('based', '').trim() : '-';
                    const evType = (e.event_type || '').toLowerCase();
                    const isBlocked = evType === 'blocked' || evType === 'block' || evType === 'escalate';
                    const isEscalated = evType === 'escalate';
                    const statClass = isEscalated ? 'escalated' : (isBlocked ? 'active' : 'inactive');
                    const statLabel = isEscalated ? 'Escalated' : (isBlocked ? 'Blocked' : 'Unblocked');
                    return `<tr>
                    <td style="white-space:nowrap;font-size:12px;color:var(--text-secondary)">${this.fmtTime(e.created_at || e.blocked_at)}</td>
                    <td class="c-ip">${this.esc(e.ip_address)}</td>
                    <td><span class="c-stat ${statClass}">${statLabel}</span></td>
                    <td><span class="c-source ${srcClass}">${this.esc(srcLabel)}</span></td>
                    <td><span class="c-agent">${this.esc(e.agent_hostname || e.agent_name || 'System')}</span></td>
                    <td><div class="c-reason" title="${this.esc(e.reason || '')}">${this.esc(e.reason || 'No reason specified')}</div></td>
                </tr>`;
                }).join('')}</tbody></table></div>`;

                if (pgEl) {
                    document.getElementById('blkInfo').textContent = `Page ${page} of ${totalPages} (${this.total} total)`;
                    pgEl.style.display = 'flex';
                    pgEl.querySelectorAll('button')[0].disabled = page <= 1;
                    pgEl.querySelectorAll('button')[1].disabled = page >= totalPages;
                }
            } else {
                box.innerHTML = '<div class="ev-msg">No block history found</div>';
            }
        } catch (e) {
            console.error('Error loading history:', e);
            box.innerHTML = '<div class="ev-msg err">Failed to load block history</div>';
        }
    },

    esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; },

    fmtTime(t) {
        if (!t) return '-';
        if (window.TimeSettings?.isLoaded()) return window.TimeSettings.formatFull(t);
        const d = new Date(t);
        return d.toLocaleString();
    }
};

window.initBlockedIpsPage = () => BLK.init();
window.BLK = BLK;
</script>
