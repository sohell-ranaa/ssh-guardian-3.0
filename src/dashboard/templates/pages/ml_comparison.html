<!-- SSH Guardian v3.0 - ML vs Rule-Based Comparison Page -->
<div id="page-ml-comparison" class="page-content" style="display: none;">
    <div class="page-header-with-cache">
        <div>
            <h2 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 24px; font-weight: 600;">
                ML vs Rule-Based Comparison
            </h2>
            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                Prove ML detection is better than traditional fail2ban-style rules
            </p>
        </div>
        <div class="page-header-actions">
            <div class="cache-indicator loading" data-cache-endpoint="ml_comparison">
                <span class="cache-status-dot"></span>
                <span class="cache-indicator-text">Loading...</span>
                <span class="cache-time"></span>
                <button class="cache-refresh-btn" onclick="loadComparison()" title="Refresh data">â†»</button>
            </div>
            <select id="comparison-days" onchange="loadComparison()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--background); color: var(--text-primary);">
                <option value="7" selected>Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
            </select>
        </div>
    </div>

    <!-- Key Comparison Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <!-- ML Detection Card -->
        <div class="card" style="padding: 20px; border-left: 4px solid var(--azure-blue);">
            <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: var(--azure-blue);">ML-Based Detection</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">Anomalies Detected</div>
                    <div style="font-size: 24px; font-weight: 600; color: var(--text-primary);" id="ml-anomalies-detected">0</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">High Risk Events</div>
                    <div style="font-size: 24px; font-weight: 600; color: #D13438;" id="ml-high-risk">0</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">First-Attempt Detections</div>
                    <div style="font-size: 24px; font-weight: 600; color: #2EA44F;" id="ml-first-attempt">0</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">ML Blocks</div>
                    <div style="font-size: 24px; font-weight: 600; color: var(--azure-blue);" id="ml-blocks">0</div>
                </div>
            </div>
        </div>

        <!-- Rule-Based Card -->
        <div class="card" style="padding: 20px; border-left: 4px solid #888;">
            <h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #888;">Rule-Based Detection (Fail2Ban Style)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">Would Block IPs</div>
                    <div style="font-size: 24px; font-weight: 600; color: var(--text-primary);" id="rule-would-block">0</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">Actual Rule Blocks</div>
                    <div style="font-size: 24px; font-weight: 600; color: #888;" id="rule-actual-blocks">0</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">Avg Attempts Before Block</div>
                    <div style="font-size: 24px; font-weight: 600; color: #E6A502;" id="rule-avg-attempts">5</div>
                </div>
                <div>
                    <div style="color: var(--text-secondary); font-size: 11px; margin-bottom: 2px;">Events Under Threshold</div>
                    <div style="font-size: 24px; font-weight: 600; color: #D13438;" id="rule-missed">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Metrics -->
    <div class="card" style="padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Detection Comparison</h3>
        <div class="table-wrapper">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: var(--background); border-bottom: 2px solid var(--border);">
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Metric</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Rule-Based</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">ML-Based</th>
                        <th style="padding: 12px; text-align: center; font-weight: 600;">Improvement</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px; color: var(--text-primary);">Detection Rate</td>
                        <td style="padding: 12px; text-align: center; color: #888;" id="compare-rule-rate">-</td>
                        <td style="padding: 12px; text-align: center; color: var(--azure-blue); font-weight: 600;" id="compare-ml-rate">-</td>
                        <td style="padding: 12px; text-align: center; color: #2EA44F; font-weight: 600;" id="compare-rate-improvement">-</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px; color: var(--text-primary);">First-Attempt Detection</td>
                        <td style="padding: 12px; text-align: center; color: #888;">0%</td>
                        <td style="padding: 12px; text-align: center; color: var(--azure-blue); font-weight: 600;" id="compare-first-attempt">-</td>
                        <td style="padding: 12px; text-align: center; color: #2EA44F; font-weight: 600;" id="compare-first-improvement">-</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px; color: var(--text-primary);">Additional Threats Caught</td>
                        <td style="padding: 12px; text-align: center; color: #888;">-</td>
                        <td style="padding: 12px; text-align: center; color: #2EA44F; font-weight: 600;" id="compare-additional">-</td>
                        <td style="padding: 12px; text-align: center; color: #2EA44F;">Proactive</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; color: var(--text-primary);">Events Rules Would Miss</td>
                        <td style="padding: 12px; text-align: center; color: #D13438; font-weight: 600;" id="compare-missed">-</td>
                        <td style="padding: 12px; text-align: center; color: var(--azure-blue);">Detected</td>
                        <td style="padding: 12px; text-align: center; color: #2EA44F; font-weight: 600;">100%</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Why ML is Better -->
    <div class="card" style="padding: 20px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(0, 120, 212, 0.05), rgba(46, 164, 79, 0.05));">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Why ML is Better Than Fail2Ban</h3>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #D13438;">Fail2Ban Limitations</h4>
                <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 13px; line-height: 1.8;">
                    <li>Only triggers after threshold failures (reactive)</li>
                    <li>Cannot detect distributed attacks across IPs</li>
                    <li>No geographic or behavioral analysis</li>
                    <li>High false positive rate for legitimate users</li>
                    <li>Cannot adapt to new attack patterns</li>
                    <li>Static rules require manual updates</li>
                </ul>
            </div>
            <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #2EA44F;">ML Advantages</h4>
                <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary); font-size: 13px; line-height: 1.8;">
                    <li>Detects threats on first attempt (proactive)</li>
                    <li>Correlates attacks across multiple IPs</li>
                    <li>Uses 40+ features including geo, behavior, reputation</li>
                    <li>Lower false positive rate with confidence scoring</li>
                    <li>Learns and adapts to new patterns via retraining</li>
                    <li>Catches slow brute force and credential stuffing</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Key Benefits Summary -->
    <div id="comparison-summary" class="card" style="padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ML Detection Benefits Summary</h3>
        <div id="benefits-summary-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
            <div style="color: var(--text-secondary);">Loading...</div>
        </div>
    </div>

    <!-- Detection Cases -->
    <div class="card" style="padding: 20px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Notable ML Detection Cases</h3>
        <div id="detection-cases-container">
            <div style="color: var(--text-secondary);">Loading detection cases...</div>
        </div>
    </div>
</div>

<script>
async function loadComparison() {
    const CACHE_ENDPOINT = 'ml_comparison';
    if (typeof CacheManager !== 'undefined') {
        CacheManager.setLoading(CACHE_ENDPOINT);
    }
    const startTime = performance.now();

    const days = document.getElementById('comparison-days').value;

    try {
        const response = await fetch(`/api/ml/comparison?days=${days}`);
        const data = await response.json();

        if (data.success && data.comparison) {
            const c = data.comparison;

            // ML Stats
            const mlStats = c.ml_stats || {};
            document.getElementById('ml-anomalies-detected').textContent = mlStats.anomalies_detected?.toLocaleString() || '0';
            document.getElementById('ml-high-risk').textContent = mlStats.high_risk_events?.toLocaleString() || '0';
            document.getElementById('ml-first-attempt').textContent = mlStats.first_attempt_detections?.toLocaleString() || '0';
            document.getElementById('ml-blocks').textContent = mlStats.ml_blocks?.toLocaleString() || '0';

            // Rule Stats
            const ruleStats = c.rule_stats || {};
            document.getElementById('rule-would-block').textContent = ruleStats.would_block_ips?.toLocaleString() || '0';
            document.getElementById('rule-actual-blocks').textContent = ruleStats.actual_rule_blocks?.toLocaleString() || '0';
            document.getElementById('rule-avg-attempts').textContent = ruleStats.avg_attempts_before_block?.toFixed(1) || '5';
            document.getElementById('rule-missed').textContent = ruleStats.events_under_threshold?.toLocaleString() || '0';

            // Comparison metrics
            const comparison = c.comparison || {};
            document.getElementById('compare-rule-rate').textContent = (comparison.rule_detection_rate || 0).toFixed(1) + '%';
            document.getElementById('compare-ml-rate').textContent = (comparison.ml_detection_rate || 0).toFixed(1) + '%';
            document.getElementById('compare-rate-improvement').textContent = '+' + (comparison.detection_improvement || 0).toFixed(1) + '%';
            document.getElementById('compare-first-attempt').textContent = (comparison.first_attempt_percentage || 0).toFixed(1) + '%';
            document.getElementById('compare-first-improvement').textContent = '+' + (comparison.first_attempt_percentage || 0).toFixed(1) + '%';
            document.getElementById('compare-additional').textContent = (comparison.additional_threats_caught || 0).toLocaleString();
            document.getElementById('compare-missed').textContent = (comparison.threats_rules_would_miss || 0).toLocaleString();

            // Summary benefits
            if (comparison.summary) {
                const summaryContainer = document.getElementById('benefits-summary-content');
                summaryContainer.innerHTML = `
                    <div style="padding: 16px; background: rgba(46, 164, 79, 0.1); border-radius: 8px;">
                        <div style="font-size: 13px; color: #2EA44F; font-weight: 600; margin-bottom: 4px;">Key Benefit #1</div>
                        <div style="font-size: 13px; color: var(--text-primary);">${comparison.summary.key_benefit_1 || 'First-attempt detection'}</div>
                    </div>
                    <div style="padding: 16px; background: rgba(0, 120, 212, 0.1); border-radius: 8px;">
                        <div style="font-size: 13px; color: var(--azure-blue); font-weight: 600; margin-bottom: 4px;">Key Benefit #2</div>
                        <div style="font-size: 13px; color: var(--text-primary);">${comparison.summary.key_benefit_2 || 'More threats caught'}</div>
                    </div>
                    <div style="padding: 16px; background: rgba(230, 165, 2, 0.1); border-radius: 8px;">
                        <div style="font-size: 13px; color: #E6A502; font-weight: 600; margin-bottom: 4px;">Key Benefit #3</div>
                        <div style="font-size: 13px; color: var(--text-primary);">${comparison.summary.key_benefit_3 || 'Adaptive learning'}</div>
                    </div>
                `;
            }

            // Detection cases
            const casesContainer = document.getElementById('detection-cases-container');
            const cases = c.detection_cases || [];

            if (cases.length > 0) {
                casesContainer.innerHTML = cases.map(cs => `
                    <div style="padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--text-primary);">${cs.title || 'Detection Case'}</div>
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; background: rgba(0, 120, 212, 0.1); color: var(--azure-blue);">
                                ${cs.case_type || 'detection'}
                            </span>
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${cs.description || ''}</div>
                        ${cs.risk_score ? `<div style="font-size: 12px; color: #D13438;">Risk Score: ${cs.risk_score}</div>` : ''}
                        ${cs.ip_count ? `<div style="font-size: 12px; color: var(--azure-blue);">IPs involved: ${cs.ip_count}</div>` : ''}
                    </div>
                `).join('');
            } else {
                casesContainer.innerHTML = '<div style="color: var(--text-secondary);">No notable detection cases found. Run some simulations to generate data.</div>';
            }

            const loadTime = Math.round(performance.now() - startTime);
            const fromCache = data.from_cache === true;
            if (typeof CacheManager !== 'undefined') {
                CacheManager.updateStatus(CACHE_ENDPOINT, fromCache, loadTime);
                CacheManager.clearLoading(CACHE_ENDPOINT);
            }
        }
    } catch (error) {
        console.error('Error loading comparison:', error);
        if (typeof CacheManager !== 'undefined') {
            CacheManager.setError(CACHE_ENDPOINT, 'Failed to load comparison');
        }
    }
}

// Load on page show
document.addEventListener('DOMContentLoaded', function() {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.id === 'page-ml-comparison' && mutation.target.style.display !== 'none') {
                loadComparison();
            }
        });
    });

    const page = document.getElementById('page-ml-comparison');
    if (page) {
        observer.observe(page, { attributes: true, attributeFilter: ['style'] });
    }
});
</script>
