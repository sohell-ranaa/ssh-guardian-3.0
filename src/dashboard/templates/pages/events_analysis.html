<!-- SSH Guardian v3.0 - Events Analysis Page - Enhanced -->
<div id="page-events-analysis" class="page-content" style="display: none;">
    <div class="page-header-with-cache">
        <div>
            <h2 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 24px; font-weight: 600;">
                Events Analysis & Intelligence
            </h2>
            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                Comprehensive analysis with geographic insights, trends, and AI recommendations
            </p>
        </div>
        <div class="page-header-actions" style="display: flex; align-items: center; gap: 12px;">
            <button id="events-export-btn" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                ðŸ“Š Export
            </button>
            <button id="events-refresh-btn" style="padding: 8px; background: var(--azure-blue); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 18px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;" title="Refresh analysis">
                â†»
            </button>
            <div class="cache-indicator loading" data-cache-endpoint="events_analysis">
                <span class="cache-status-dot"></span>
                <span class="cache-indicator-text">Loading...</span>
                <span class="cache-time"></span>
                <button class="cache-refresh-btn" onclick="loadEventsAnalysisPage()" title="Refresh data">â†»</button>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div id="events-analysis-error" style="display: none; background: #FDE7E9; border: 1px solid #D13438; color: #A80000; padding: 16px; border-radius: 4px; margin-bottom: 16px; text-align: center;">
        Error loading data
    </div>

    <!-- Advanced Filters -->
    <div class="card" style="padding: 20px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Advanced Filters</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div>
                <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary);">Date Range</label>
                <select id="events-date-range" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--background);">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d" selected>Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="90d">Last 90 Days</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary);">Event Type</label>
                <select id="events-type-filter" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--background);">
                    <option value="">All Types</option>
                    <option value="failed">Failed Login</option>
                    <option value="successful">Successful Login</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary);">Threat Level</label>
                <select id="events-threat-filter" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--background);">
                    <option value="">All Levels</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                    <option value="clean">Clean</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary);">Country</label>
                <select id="events-country-filter" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--background);">
                    <option value="">All Countries</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary);">Agent/Server</label>
                <select id="events-agent-filter" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--background);">
                    <option value="">All Agents</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary);">Search IP/User</label>
                <input type="text" id="events-search" placeholder="IP or username..." style="width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--background);">
            </div>
        </div>
        <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
            <button id="events-clear-filters" style="padding: 8px 16px; background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); border-radius: 3px; cursor: pointer; font-size: 13px;">
                Clear Filters
            </button>
            <button id="events-apply-filters" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 13px;">
                Apply Filters
            </button>
        </div>
    </div>

    <!-- Key Metrics Summary -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div class="card" style="padding: 20px; border-left: 4px solid #0078D4;">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Total Events</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);" id="events-total-count">0</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;" id="events-total-change">-</div>
        </div>
        <div class="card" style="padding: 20px; border-left: 4px solid #D83B01;">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Failed Attempts</div>
            <div style="font-size: 28px; font-weight: 600; color: #D83B01;" id="events-failed-count">0</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;" id="events-failed-change">-</div>
        </div>
        <div class="card" style="padding: 20px; border-left: 4px solid #107C10;">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Successful Logins</div>
            <div style="font-size: 28px; font-weight: 600; color: #107C10;" id="events-success-count">0</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;" id="events-success-change">-</div>
        </div>
        <div class="card" style="padding: 20px; border-left: 4px solid #FFB900;">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Unique IPs</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);" id="events-unique-ips">0</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;" id="events-ips-change">-</div>
        </div>
        <div class="card" style="padding: 20px; border-left: 4px solid #A80000;">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">High Threat IPs</div>
            <div style="font-size: 28px; font-weight: 600; color: #A80000;" id="events-high-risk">0</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;" id="events-threat-change">-</div>
        </div>
        <div class="card" style="padding: 20px; border-left: 4px solid #8661C5;">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Countries</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);" id="events-countries-count">0</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Geographic spread</div>
        </div>
    </div>

    <!-- AI Recommendations -->
    <div class="card" style="padding: 20px; margin-bottom: 20px; border-left: 4px solid var(--azure-blue);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="font-size: 24px;">ðŸ’¡</div>
            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Security Recommendations</h3>
        </div>
        <div id="events-ai-recommendations" style="display: grid; gap: 12px;">
            <div style="background: var(--background); padding: 12px; border-radius: 4px; border: 1px solid var(--border);">
                <div style="font-weight: 500; margin-bottom: 4px; color: var(--text-primary);">âš¡ Loading recommendations...</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Analyzing patterns and threats</div>
            </div>
        </div>
    </div>

    <!-- Charts Row - Removed non-working charts, keeping only functional ones when data is available -->

    <!-- Geography & Top Lists Row -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <!-- Geographic Distribution -->
        <div class="card" style="padding: 20px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Top Countries by Events</h3>
            <div id="events-geography-list" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading geography data...</p>
            </div>
        </div>

        <!-- Top Attackers -->
        <div class="card" style="padding: 20px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Top Attack Sources</h3>
            <div id="events-top-ips-list" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading top IPs...</p>
            </div>
        </div>
    </div>

    <!-- Comparison Section - Removed (not yet implemented) -->

    <!-- Detailed Analysis Tabs -->
    <div class="card" style="padding: 0; margin-bottom: 20px;">
        <div style="display: flex; border-bottom: 1px solid var(--border);">
            <button class="analysis-tab active" data-tab="patterns" style="flex: 1; padding: 16px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                Attack Patterns
            </button>
            <button class="analysis-tab" data-tab="usernames" style="flex: 1; padding: 16px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">
                Targeted Usernames
            </button>
        </div>
        <div style="padding: 20px;">
            <!-- Attack Patterns Tab -->
            <div id="tab-patterns" class="analysis-tab-content">
                <div class="table-wrapper">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: var(--background); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Failure Reason</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Count</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">% of Total</th>
                            </tr>
                        </thead>
                        <tbody id="events-failure-reasons-body">
                            <tr>
                                <td colspan="3" style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Usernames Tab -->
            <div id="tab-usernames" class="analysis-tab-content" style="display: none;">
                <div class="table-wrapper">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: var(--background); border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Username</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Total Attempts</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Failed</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Success Rate</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600;">Unique IPs</th>
                            </tr>
                        </thead>
                        <tbody id="events-top-usernames-body">
                            <tr>
                                <td colspan="5" style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Events Table -->
    <div class="card" style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Recent Events</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
                <select id="events-sort" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 3px; font-size: 13px;">
                    <option value="timestamp">Latest First</option>
                    <option value="ml_risk_score">Highest Risk</option>
                    <option value="source_ip_text">By IP</option>
                </select>
                <select id="events-per-page" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 3px; font-size: 13px;">
                    <option value="20">20 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
        </div>
        <div class="table-wrapper">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: var(--background); border-bottom: 2px solid var(--border);">
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Time</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Type</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">IP Address</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Country</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Username</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Agent</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Threat</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th>
                    </tr>
                </thead>
                <tbody id="events-table-body">
                    <tr>
                        <td colspan="8" style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading events...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="events-pagination" style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;">
            <div id="events-pagination-info" style="font-size: 13px; color: var(--text-secondary);">-</div>
            <div style="display: flex; gap: 8px;">
                <button id="events-prev-page" style="padding: 6px 12px; border: 1px solid var(--border); background: var(--surface); border-radius: 2px; cursor: pointer; font-size: 13px;">Previous</button>
                <button id="events-next-page" style="padding: 6px 12px; border: 1px solid var(--border); background: var(--surface); border-radius: 2px; cursor: pointer; font-size: 13px;">Next</button>
            </div>
        </div>
    </div>
</div>

<style>
.analysis-tab.active {
    color: var(--azure-blue);
    border-bottom-color: var(--azure-blue) !important;
    background: rgba(0, 120, 212, 0.05);
}

.analysis-tab:hover {
    background: var(--hover-bg, #f5f5f5);
}
</style>
