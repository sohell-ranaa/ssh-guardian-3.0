<!-- SSH Guardian v3.0 - ML Benefits Report Page -->
<div id="page-ml-benefits" class="page-content" style="display: none;">
    <div class="page-header-with-cache">
        <div>
            <h2 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 24px; font-weight: 600;">
                ML Benefits Report
            </h2>
            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                ROI, threats detected, and value provided by ML detection
            </p>
        </div>
        <div class="page-header-actions">
            <button class="refresh-btn" onclick="loadBenefitsReport()">
                <span class="refresh-icon">â†»</span> Refresh
            </button>
            <select id="benefits-days" onchange="loadBenefitsReport()" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; background: var(--background); color: var(--text-primary);">
                <option value="7">Last 7 days</option>
                <option value="30" selected>Last 30 days</option>
                <option value="90">Last 90 days</option>
            </select>
        </div>
    </div>

    <!-- Executive Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div class="card" style="padding: 20px; text-align: center; background: linear-gradient(135deg, rgba(0, 120, 212, 0.1), rgba(0, 120, 212, 0.05));">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Total Predictions</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--azure-blue);" id="benefits-total-predictions">0</div>
        </div>
        <div class="card" style="padding: 20px; text-align: center; background: linear-gradient(135deg, rgba(209, 52, 56, 0.1), rgba(209, 52, 56, 0.05));">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Threats Detected</div>
            <div style="font-size: 28px; font-weight: 600; color: #D13438;" id="benefits-threats-detected">0</div>
        </div>
        <div class="card" style="padding: 20px; text-align: center; background: linear-gradient(135deg, rgba(230, 165, 2, 0.1), rgba(230, 165, 2, 0.05));">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">High Risk Events</div>
            <div style="font-size: 28px; font-weight: 600; color: #E6A502;" id="benefits-high-risk">0</div>
        </div>
        <div class="card" style="padding: 20px; text-align: center; background: linear-gradient(135deg, rgba(46, 164, 79, 0.1), rgba(46, 164, 79, 0.05));">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">IPs Blocked</div>
            <div style="font-size: 28px; font-weight: 600; color: #2EA44F;" id="benefits-ips-blocked">0</div>
        </div>
        <div class="card" style="padding: 20px; text-align: center; background: linear-gradient(135deg, rgba(0, 120, 212, 0.1), rgba(0, 120, 212, 0.05));">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Avg Confidence</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);" id="benefits-confidence">0%</div>
        </div>
        <div class="card" style="padding: 20px; text-align: center; background: linear-gradient(135deg, rgba(46, 164, 79, 0.1), rgba(46, 164, 79, 0.05));">
            <div style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Time Saved</div>
            <div style="font-size: 28px; font-weight: 600; color: #2EA44F;" id="benefits-time-saved">0h</div>
        </div>
    </div>

    <!-- Active Model Info -->
    <div class="card" style="padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Active Model</h3>
        <div id="benefits-active-model" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
            <div style="color: var(--text-secondary);">Loading...</div>
        </div>
    </div>

    <!-- Key Benefits -->
    <div class="card" style="padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Key Benefits</h3>
        <div id="key-benefits-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
            <div style="color: var(--text-secondary);">Loading...</div>
        </div>
    </div>

    <!-- Threat Distribution -->
    <div class="card" style="padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Threat Types Detected</h3>
        <div id="threat-distribution-container">
            <div style="color: var(--text-secondary);">Loading...</div>
        </div>
    </div>

    <!-- Detection Timeline Chart -->
    <div class="card" style="padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Detection Timeline</h3>
        <div id="benefits-timeline" style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around;">
            <div style="color: var(--text-secondary);">Loading timeline...</div>
        </div>
    </div>

    <!-- ML vs Fail2Ban Summary -->
    <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(46, 164, 79, 0.05), rgba(0, 120, 212, 0.05));">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Why SSH Guardian ML is Superior to Fail2Ban</h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #D13438;">Fail2Ban Limitations</h4>
                <div id="fail2ban-limitations" style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                    Loading...
                </div>
            </div>
            <div>
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #2EA44F;">ML Advantages</h4>
                <div id="ml-advantages" style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                    Loading...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function loadBenefitsReport() {
    const days = document.getElementById('benefits-days').value;

    const CACHE_ENDPOINT = 'ml_benefits';
    if (typeof CacheManager !== 'undefined') {
        CacheManager.setLoading(CACHE_ENDPOINT);
    }
    const startTime = performance.now();

    try {
        const response = await fetch(`/api/ml/benefits?days=${days}`);
        const data = await response.json();

        if (data.success && data.benefits) {
            const b = data.benefits;
            const summary = b.executive_summary || {};

            // Executive summary
            document.getElementById('benefits-total-predictions').textContent = summary.total_predictions?.toLocaleString() || '0';
            document.getElementById('benefits-threats-detected').textContent = summary.threats_detected?.toLocaleString() || '0';
            document.getElementById('benefits-high-risk').textContent = summary.high_risk_events?.toLocaleString() || '0';
            document.getElementById('benefits-ips-blocked').textContent = summary.ips_blocked?.toLocaleString() || '0';
            document.getElementById('benefits-confidence').textContent = ((summary.avg_confidence || 0) * 100).toFixed(0) + '%';
            document.getElementById('benefits-time-saved').textContent = (summary.time_saved_hours || 0).toFixed(1) + 'h';

            // Active model
            const modelContainer = document.getElementById('benefits-active-model');
            if (b.active_model) {
                modelContainer.innerHTML = `
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Model Name</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${b.active_model.model_name || '-'}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Algorithm</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${b.active_model.algorithm || '-'}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">F1 Score</div>
                        <div style="font-size: 14px; font-weight: 600; color: #2EA44F;">${b.active_model.f1_score ? (b.active_model.f1_score * 100).toFixed(1) + '%' : '-'}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Accuracy</div>
                        <div style="font-size: 14px; font-weight: 600; color: #2EA44F;">${b.active_model.accuracy ? (b.active_model.accuracy * 100).toFixed(1) + '%' : '-'}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Total Predictions</div>
                        <div style="font-size: 14px; font-weight: 600; color: var(--azure-blue);">${b.active_model.predictions_made?.toLocaleString() || '0'}</div>
                    </div>
                `;
            } else {
                modelContainer.innerHTML = '<div style="color: var(--text-secondary);">No active model. Train a model to see benefits.</div>';
            }

            // Key benefits
            const benefitsContainer = document.getElementById('key-benefits-container');
            if (b.key_benefits && b.key_benefits.length > 0) {
                const colors = ['#2EA44F', 'var(--azure-blue)', '#E6A502', '#D13438'];
                benefitsContainer.innerHTML = b.key_benefits.map((benefit, i) => `
                    <div style="padding: 16px; border-left: 4px solid ${colors[i % colors.length]}; background: var(--background); border-radius: 0 8px 8px 0;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${benefit.title}</div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${benefit.description}</div>
                        <div style="font-size: 14px; color: ${colors[i % colors.length]}; font-weight: 600;">${benefit.metric}</div>
                    </div>
                `).join('');
            }

            // Threat distribution
            const threatContainer = document.getElementById('threat-distribution-container');
            if (b.threat_distribution && b.threat_distribution.length > 0) {
                const total = b.threat_distribution.reduce((sum, t) => sum + t.count, 0);
                threatContainer.innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${b.threat_distribution.map(t => {
                            const percentage = (t.count / total * 100).toFixed(1);
                            return `
                                <div style="padding: 8px 16px; background: var(--background); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 600; color: var(--text-primary);">${t.threat_type || 'Unknown'}</span>
                                    <span style="color: var(--azure-blue);">${t.count}</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;">(${percentage}%)</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                threatContainer.innerHTML = '<div style="color: var(--text-secondary);">No threat data available</div>';
            }

            // Timeline chart
            const timelineContainer = document.getElementById('benefits-timeline');
            if (b.detection_timeline && b.detection_timeline.length > 0) {
                const maxPredictions = Math.max(...b.detection_timeline.map(t => t.predictions));

                timelineContainer.innerHTML = `
                    <div style="width: 100%; display: flex; align-items: flex-end; justify-content: space-around; height: 180px;">
                        ${b.detection_timeline.slice(-14).map(t => {
                            const height = maxPredictions > 0 ? (t.predictions / maxPredictions * 150) : 10;
                            const detectionHeight = maxPredictions > 0 ? (t.detections / maxPredictions * 150) : 5;
                            const date = new Date(t.date);
                            const dateStr = (date.getMonth() + 1) + '/' + date.getDate();
                            return `
                                <div style="text-align: center; flex: 1; max-width: 50px;">
                                    <div style="position: relative;">
                                        <div style="background: var(--azure-blue); width: 20px; height: ${height}px; margin: 0 auto; border-radius: 4px 4px 0 0;"></div>
                                        <div style="background: #D13438; width: 14px; height: ${detectionHeight}px; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 4px 4px 0 0;"></div>
                                    </div>
                                    <div style="font-size: 9px; color: var(--text-secondary); margin-top: 4px;">${dateStr}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 11px;">
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--azure-blue); border-radius: 2px; margin-right: 4px;"></span>Predictions</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: #D13438; border-radius: 2px; margin-right: 4px;"></span>Detections</span>
                    </div>
                `;
            }

            // ML vs Fail2Ban comparison
            const comparison = b.comparison_to_fail2ban || {};

            if (comparison.fail2ban_limitations) {
                document.getElementById('fail2ban-limitations').innerHTML =
                    '<ul style="margin: 0; padding-left: 20px;">' +
                    comparison.fail2ban_limitations.map(l => `<li>${l}</li>`).join('') +
                    '</ul>';
            }

            if (comparison.ml_advantages) {
                document.getElementById('ml-advantages').innerHTML =
                    '<ul style="margin: 0; padding-left: 20px;">' +
                    comparison.ml_advantages.map(a => `<li>${a}</li>`).join('') +
                    '</ul>';
            }
        }

        const loadTime = Math.round(performance.now() - startTime);
        const fromCache = data.from_cache === true;
        if (typeof CacheManager !== 'undefined') {
            CacheManager.updateStatus(CACHE_ENDPOINT, fromCache, loadTime);
            CacheManager.clearLoading(CACHE_ENDPOINT);
        }
    } catch (error) {
        console.error('Error loading benefits report:', error);
        if (typeof CacheManager !== 'undefined') {
            CacheManager.setError(CACHE_ENDPOINT, 'Failed to load benefits report');
        }
    }
}

// Load on page show
document.addEventListener('DOMContentLoaded', function() {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.id === 'page-ml-benefits' && mutation.target.style.display !== 'none') {
                loadBenefitsReport();
            }
        });
    });

    const page = document.getElementById('page-ml-benefits');
    if (page) {
        observer.observe(page, { attributes: true, attributeFilter: ['style'] });
    }
});
</script>
