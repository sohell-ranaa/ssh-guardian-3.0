<!-- SSH Guardian v3.0 - Simulation Page (Simplified 3-Tab Flow) -->
<!-- Version: v3.2.0 - Scenarios ‚Üí Analysis ‚Üí Recommendations -->
<div id="page-simulation" class="page-content" style="display: none;">
    <div class="page-header-with-cache">
        <div>
            <h2 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 24px; font-weight: 600;">
                Threat Simulation
            </h2>
            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                Run attack scenarios, analyze threats, get recommendations
            </p>
        </div>
        <div class="page-header-actions">
            <div class="cache-indicator loading" data-cache-endpoint="simulation">
                <span class="cache-status-dot"></span>
                <span class="cache-indicator-text">Loading...</span>
                <span class="cache-time"></span>
                <button class="cache-refresh-btn" onclick="loadSimulationPage()" title="Refresh data">‚Üª</button>
            </div>
        </div>
    </div>

    <!-- Simplified 3-Tab Navigation -->
    <div class="simulation-tabs" style="display: flex; gap: 8px; border-bottom: 2px solid var(--border); margin-bottom: 24px; position: sticky; top: 0; z-index: 100; background: var(--background); padding: 8px 0;">
        <button class="sim-tab-btn active" data-tab="scenarios" onclick="switchSimulationTab('scenarios')">
            <span style="font-size: 18px;">1Ô∏è‚É£</span> Scenarios
        </button>
        <button class="sim-tab-btn" data-tab="analysis" onclick="switchSimulationTab('analysis')">
            <span style="font-size: 18px;">2Ô∏è‚É£</span> Analysis
        </button>
        <button class="sim-tab-btn" data-tab="results" onclick="switchSimulationTab('results')">
            <span style="font-size: 18px;">3Ô∏è‚É£</span> Recommendations
        </button>
    </div>

    <!-- TAB 1: SCENARIOS -->
    <div id="tab-scenarios" class="sim-tab-content active">
        <div class="card" style="padding: 24px; margin-bottom: 24px;">
            <!-- Header with Refresh IPs button -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">Attack Scenarios</h3>
                    <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                        Click a scenario to run threat analysis. Select an agent to also deploy UFW blocks.
                    </p>
                </div>
                <button id="refresh-ips-btn" onclick="refreshIPPool()" style="padding: 8px 16px; background: var(--background); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span id="refresh-ips-icon">üîÑ</span> Refresh IPs
                </button>
            </div>

            <!-- IP Pool Status -->
            <div id="ip-pool-status" style="display: none; margin-bottom: 16px; padding: 10px 14px; background: rgba(46, 164, 79, 0.1); border: 1px solid #2EA44F; border-radius: 6px; font-size: 12px;">
                <span id="ip-pool-count">0</span> fresh IPs available
                <span style="color: var(--text-secondary); margin-left: 8px;">Last refresh: <span id="ip-pool-time">Never</span></span>
            </div>

            <!-- Agent Selection + Options -->
            <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 20px; padding: 12px 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
                <label style="font-weight: 600; font-size: 13px; white-space: nowrap;">Deploy to:</label>
                <select id="scenario-agent" style="flex: 1; max-width: 280px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--card-bg); color: var(--text-primary);">
                    <option value="">Analysis Only</option>
                </select>
                <span id="scenario-agent-status" style="font-size: 12px; color: var(--text-secondary);"></span>
            </div>

            <!-- Scenarios Grid -->
            <div id="demo-scenarios-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                <!-- Loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- TAB 2: ANALYSIS -->
    <div id="tab-analysis" class="sim-tab-content" style="display: none;">
        <div id="analysis-empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--text-primary);">No Analysis Available</h3>
            <p style="margin: 0; font-size: 14px;">Run a scenario from the Scenarios tab to see detailed threat analysis</p>
        </div>
        <div id="analysis-content" style="display: none;"></div>
    </div>

    <!-- TAB 3: RECOMMENDATIONS -->
    <div id="tab-results" class="sim-tab-content" style="display: none;">
        <div id="results-empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">üí°</div>
            <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--text-primary);">No Recommendations Yet</h3>
            <p style="margin: 0; font-size: 14px;">Run a scenario first, then check here for security recommendations</p>
        </div>
        <div id="results-content" style="display: none;"></div>
    </div>
</div>

<style>
.simulation-tabs { display: flex; gap: 8px; border-bottom: 2px solid var(--border); }
.sim-tab-btn { padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; font-weight: 600; color: var(--text-secondary); transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
.sim-tab-btn:hover { color: var(--text-primary); background: var(--hover-bg); }
.sim-tab-btn.active { color: var(--azure-blue); border-bottom-color: var(--azure-blue); background: rgba(0, 120, 212, 0.05); }
.sim-tab-content { display: none; }
.sim-tab-content.active { display: block; animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.demo-scenario-card { padding: 16px; background: var(--card-bg); border-radius: 8px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
.demo-scenario-card:hover { border-color: var(--azure-blue); box-shadow: 0 4px 12px rgba(0, 120, 212, 0.2); transform: translateY(-2px); }
.demo-scenario-card.running { border-color: var(--azure-blue); background: linear-gradient(135deg, var(--card-bg), rgba(0, 120, 212, 0.1)); pointer-events: none; }

/* Scenario Loading Overlay */
.scenario-loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(0, 120, 212, 0.95), rgba(0, 90, 170, 0.95)); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; z-index: 10; border-radius: 6px; }
.scenario-spinner { width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
.scenario-loading-text { font-size: 13px; font-weight: 600; color: #fff; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.recommendation-card { padding: 20px; background: var(--card-bg); border-radius: 12px; border-left: 5px solid; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s; margin-bottom: 16px; }
.recommendation-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
.recommendation-card.critical { border-left-color: #D13438; background: linear-gradient(135deg, var(--card-bg), rgba(209, 52, 56, 0.05)); }
.recommendation-card.high { border-left-color: #E6A502; background: linear-gradient(135deg, var(--card-bg), rgba(230, 165, 2, 0.05)); }
.recommendation-card.medium { border-left-color: #0078D4; background: linear-gradient(135deg, var(--card-bg), rgba(0, 120, 212, 0.05)); }
.recommendation-card.low { border-left-color: #2EA44F; background: linear-gradient(135deg, var(--card-bg), rgba(46, 164, 79, 0.05)); }

/* Mini Pipeline Steps for Scenarios */
.pipeline-mini-step { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 12px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; min-width: 60px; transition: all 0.3s ease; }
.pipeline-mini-step .step-icon { font-size: 18px; }
.pipeline-mini-step .step-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); }
.pipeline-mini-step[data-status="running"] { border-color: var(--azure-blue); background: rgba(0, 120, 212, 0.1); animation: pulse 1.5s infinite; }
.pipeline-mini-step[data-status="success"] { border-color: #2EA44F; background: rgba(46, 164, 79, 0.1); }
.pipeline-mini-step[data-status="success"] .step-label { color: #2EA44F; }
.pipeline-mini-step[data-status="failed"] { border-color: #D13438; background: rgba(209, 52, 56, 0.1); }
.pipeline-mini-step[data-status="failed"] .step-label { color: #D13438; }
.pipeline-mini-step[data-status="skipped"] { opacity: 0.5; border-style: dashed; }
.pipeline-connector { display: flex; align-items: center; color: var(--text-secondary); font-size: 16px; }

/* Pipeline Flow Styles */
.pipeline-flow { display: flex; flex-direction: column; gap: 0; }
.pipeline-step { display: flex; align-items: flex-start; gap: 16px; padding: 20px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 12px; margin-bottom: -1px; transition: all 0.3s ease; position: relative; }
.pipeline-step:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
.pipeline-step:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; margin-bottom: 0; }
.pipeline-step::after { content: ''; position: absolute; left: 38px; bottom: -12px; width: 2px; height: 12px; background: var(--border); z-index: 1; }
.pipeline-step:last-child::after { display: none; }
.pipeline-step .step-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--background); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; border: 2px solid var(--border); transition: all 0.3s ease; }
.pipeline-step .step-content { flex: 1; }
.pipeline-step .step-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.pipeline-step .step-status { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
.pipeline-step .step-details { font-size: 12px; color: var(--text-secondary); padding: 8px 12px; background: var(--background); border-radius: 6px; display: none; }
.pipeline-step.running { border-color: var(--azure-blue); background: linear-gradient(135deg, var(--card-bg), rgba(0, 120, 212, 0.1)); }
.pipeline-step.running .step-icon { border-color: var(--azure-blue); background: rgba(0, 120, 212, 0.2); animation: pulse 1.5s infinite; }
.pipeline-step.success { border-color: #2EA44F; background: linear-gradient(135deg, var(--card-bg), rgba(46, 164, 79, 0.1)); }
.pipeline-step.success .step-icon { border-color: #2EA44F; background: rgba(46, 164, 79, 0.2); }
.pipeline-step.success .step-status { color: #2EA44F; font-weight: 600; }
.pipeline-step.failed { border-color: #D13438; background: linear-gradient(135deg, var(--card-bg), rgba(209, 52, 56, 0.1)); }
.pipeline-step.failed .step-icon { border-color: #D13438; background: rgba(209, 52, 56, 0.2); }
.pipeline-step.failed .step-status { color: #D13438; font-weight: 600; }
.pipeline-step.skipped { border-color: #8B8B8B; opacity: 0.7; }
.pipeline-step.skipped .step-status { color: #8B8B8B; font-style: italic; }
.pipeline-step .step-details.visible { display: block; }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
</style>

<script>
// Global state
let currentAnalysisData = null;

// ========================
// HELPER FUNCTIONS
// ========================

// Tab switching
function switchSimulationTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.sim-tab-content').forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });

    // Deactivate all tab buttons
    document.querySelectorAll('.sim-tab-btn').forEach(btn => btn.classList.remove('active'));

    // Show selected tab
    const selectedTab = document.getElementById('tab-' + tabName);
    if (selectedTab) {
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
    }

    // Activate selected tab button
    const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
    }

    console.log('[Simulation] Switched to tab:', tabName);
}

// Load page
async function loadSimulationPage() {
    console.log('[Simulation] Loading page...');
    const startTime = performance.now();

    // Set loading state for cache indicator
    if (typeof CacheManager !== 'undefined') {
        CacheManager.setLoading('simulation');
    }

    try {
        // Load demo scenarios
        await loadDemoScenarios();

        // Load scenario agent dropdown
        await loadScenarioAgents();

        // Load IP pool stats
        await loadIPPoolStats();

        // Load other data that dashboard expects (for cache status)
        await Promise.all([
            loadSimulationTemplates(),
            loadSimulationHistory()
        ]);

        const loadTime = Math.round(performance.now() - startTime);
        console.log('[Simulation] Page loaded successfully in', loadTime, 'ms');

        // Update cache status to "fresh" (not from cache)
        if (typeof CacheManager !== 'undefined') {
            CacheManager.updateStatus('simulation', false, loadTime);
        }
    } catch (error) {
        console.error('[Simulation] Error loading page:', error);

        // Set error state for cache indicator
        if (typeof CacheManager !== 'undefined') {
            CacheManager.setError('simulation', 'Failed to load simulation data');
        }
    }
}

// Load agents for scenario dropdown
async function loadScenarioAgents() {
    try {
        const response = await fetch('/api/pipeline-sim/agents', { credentials: 'same-origin' });
        const data = await response.json();

        const select = document.getElementById('scenario-agent');
        if (data.success && data.agents.length > 0) {
            select.innerHTML = '<option value="">No agent (analysis only)</option>' +
                data.agents.map(agent =>
                    `<option value="${agent.id}">${agent.display_name || agent.hostname} ${agent.is_active ? '(Active)' : '(Inactive)'}</option>`
                ).join('');
        }
    } catch (error) {
        console.error('[Simulation] Error loading scenario agents:', error);
    }
}

// Load simulation templates (for dashboard cache)
async function loadSimulationTemplates() {
    try {
        const response = await fetch('/api/simulation/templates', { credentials: 'same-origin' });
        await response.json();
    } catch (error) {
        console.error('[Simulation] Error loading templates:', error);
    }
}

// Load simulation history (for dashboard cache)
async function loadSimulationHistory() {
    try {
        const response = await fetch('/api/simulation/history?limit=10&offset=0', { credentials: 'same-origin' });
        await response.json();
    } catch (error) {
        console.error('[Simulation] Error loading history:', error);
    }
}

// Refresh IP Pool from external sources
async function refreshIPPool() {
    const btn = document.getElementById('refresh-ips-btn');
    const icon = document.getElementById('refresh-ips-icon');

    btn.disabled = true;
    icon.textContent = '‚è≥';
    btn.style.opacity = '0.7';

    try {
        const response = await fetch('/api/demo/refresh-ips', {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();

        if (data.success) {
            // Update pool status display
            const statusEl = document.getElementById('ip-pool-status');
            const countEl = document.getElementById('ip-pool-count');
            const timeEl = document.getElementById('ip-pool-time');

            statusEl.style.display = 'block';
            countEl.textContent = data.pool_stats?.total_ips || data.fetched;
            timeEl.textContent = new Date().toLocaleTimeString();

            // Reload scenarios to get new IPs in the cards
            await loadDemoScenarios();

            showToast(`Fetched ${data.fetched} fresh IPs and updated scenarios`, 'success');
        } else {
            showToast(`Failed to refresh IPs: ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Failed to refresh IP pool', 'error');
    } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
        icon.textContent = 'üîÑ';
    }
}

// Load IP pool stats on page load
async function loadIPPoolStats() {
    try {
        const response = await fetch('/api/demo/ip-pool/stats', { credentials: 'same-origin' });
        const data = await response.json();

        if (data.success && data.total_ips > 0) {
            const statusEl = document.getElementById('ip-pool-status');
            const countEl = document.getElementById('ip-pool-count');
            const timeEl = document.getElementById('ip-pool-time');

            statusEl.style.display = 'block';
            countEl.textContent = data.total_ips;
            timeEl.textContent = data.last_refresh ? new Date(data.last_refresh).toLocaleTimeString() : 'Recently';
        }
    } catch (error) {
        // Silent fail - pool stats are optional
    }
}

// Load demo scenarios
async function loadDemoScenarios() {
    try {
        const response = await fetch('/api/demo/scenarios', { credentials: 'same-origin' });
        const data = await response.json();
        if (data.success) {
            renderDemoScenarios(data.scenarios);
        } else {
            const grid = document.getElementById('demo-scenarios-grid');
            if (grid) grid.innerHTML = '<div style="padding: 20px; color: var(--text-secondary);">Failed to load scenarios.</div>';
        }
    } catch (error) {
        const grid = document.getElementById('demo-scenarios-grid');
        if (grid) grid.innerHTML = '<div style="padding: 20px; color: var(--text-secondary);">Error loading scenarios.</div>';
    }
}

// Render demo scenarios
function renderDemoScenarios(scenarios) {
    const grid = document.getElementById('demo-scenarios-grid');
    const colors = { critical: '#D13438', high: '#E6A502', medium: '#0078D4', low: '#2EA44F' };
    const icons = { critical: 'üî¥', high: 'üü†', medium: 'üü°', low: 'üü¢' };

    grid.innerHTML = scenarios.map(s => `
        <div class="demo-scenario-card" data-scenario="${s.id}" onclick="runDemoScenario('${s.id}')">
            <!-- Loading overlay (hidden by default) -->
            <div class="scenario-loading-overlay" style="display: none;">
                <div class="scenario-spinner"></div>
                <div class="scenario-loading-text">Analyzing...</div>
            </div>
            <div class="scenario-card-content">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">${s.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.4;">${s.description}</div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; background: ${colors[s.severity]}; color: white;">
                        ${icons[s.severity]} ${s.severity}
                    </span>
                    <span class="scenario-ip" style="font-family: monospace; font-size: 12px; color: var(--azure-blue); font-weight: 600;">${s.ip}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// Run demo scenario
async function runDemoScenario(scenarioId) {
    const card = document.querySelector(`.demo-scenario-card[data-scenario="${scenarioId}"]`);
    const loadingOverlay = card.querySelector('.scenario-loading-overlay');
    const loadingText = card.querySelector('.scenario-loading-text');

    // Show loading overlay
    card.classList.add('running');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }

    // Get agent selection - if agent selected, run full pipeline automatically
    const agentId = document.getElementById('scenario-agent')?.value || '';
    const runFullPipeline = !!agentId;

    // Update status indicator
    const statusEl = document.getElementById('scenario-agent-status');
    if (statusEl) {
        statusEl.textContent = runFullPipeline ? 'Will block & deploy UFW rules' : '';
        statusEl.style.color = runFullPipeline ? '#2EA44F' : 'var(--text-secondary)';
    }

    // Update loading text based on pipeline type
    if (loadingText) {
        loadingText.textContent = runFullPipeline ? 'Running full pipeline...' : 'Analyzing threat...';
    }

    try {
        const response = await fetch(`/api/demo/run/${scenarioId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                agent_id: agentId ? parseInt(agentId) : null,
                run_full_pipeline: runFullPipeline
            })
        });
        const data = await response.json();

        if (data.success) {
            currentAnalysisData = data;

            // Check blocking status from enrichment result
            const blocking = data.blocking || {};
            const blocked = blocking.blocked || data.pipeline_steps?.ip_blocked?.is_blocked;
            const skipped = blocking.skipped;
            const alreadyBlocked = blocking.success === false &&
                blocking.message && blocking.message.toLowerCase().includes('already blocked');
            const triggeredRules = blocking.triggered_rules || data.pipeline_steps?.ip_blocked?.triggered_rules || [];

            // Update loading text based on blocking status
            if (loadingText) {
                if (blocked) {
                    loadingText.textContent = 'üö´ BLOCKED!';
                } else if (alreadyBlocked) {
                    loadingText.textContent = '‚ö†Ô∏è Already Blocked';
                } else if (skipped) {
                    loadingText.textContent = '‚úÖ Analyzed';
                } else {
                    loadingText.textContent = 'Complete!';
                }
            }

            // Show toast for blocking result
            if (blocked) {
                const rulesText = triggeredRules.length > 0 ? ` (${triggeredRules.join(', ')})` : '';
                showToast(`üö´ IP ${data.ip} AUTO-BLOCKED${rulesText}`, 'warning', 5000);
            } else if (alreadyBlocked) {
                showToast(`‚ö†Ô∏è IP ${data.ip} is already blocked (ID: #${blocking.block_id})`, 'warning', 5000);
            } else if (skipped) {
                showToast(`‚ÑπÔ∏è Analysis complete - select an agent to enable blocking`, 'info', 3000);
            }

            try {
                populateAnalysisTab(data);
                populateResultsTab(data);

                // Brief delay to show status before switching tabs
                await new Promise(resolve => setTimeout(resolve, blocked || alreadyBlocked ? 800 : 300));
                switchSimulationTab('analysis');

                if (typeof CacheManager !== 'undefined') {
                    CacheManager.updateStatus('simulation', false, 0);
                }

                let suffix = '';
                if (blocked) suffix = ' - IP BLOCKED';
                else if (alreadyBlocked) suffix = ' - Already Blocked';
                else if (runFullPipeline) suffix = ' + Deployed';
                else if (skipped) suffix = ' (Analysis Only)';

                const toastType = blocked ? 'warning' : (alreadyBlocked ? 'warning' : 'success');
                showToast(`${data.scenario_name} completed${suffix}`, toastType);
            } catch (renderError) {
                showToast(`Rendering failed: ${renderError.message}`, 'error');
            }
        } else {
            if (loadingText) {
                loadingText.textContent = 'Failed!';
            }
            showToast(`Failed: ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('[Demo] Error:', error);
        if (loadingText) {
            loadingText.textContent = 'Error!';
        }
        showToast('Failed to run scenario', 'error');
    } finally {
        // Hide loading overlay after a short delay
        setTimeout(() => {
            card.classList.remove('running');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }, 500);
    }
}

// Render Blocking Banner
function renderBlockingBanner(blocking) {
    if (!blocking) return '';

    // Case 1: Blocking was skipped (analysis-only mode)
    if (blocking.skipped) {
        return `
        <div class="card" style="padding: 16px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(0, 120, 212, 0.15), rgba(0, 120, 212, 0.05)); border: 2px solid var(--azure-blue); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--azure-blue); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;">
                    ‚ÑπÔ∏è
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 700; color: var(--azure-blue);">
                        ANALYSIS ONLY MODE
                    </h3>
                    <div style="font-size: 13px; color: var(--text-secondary);">
                        No blocking applied. Select an agent to enable auto-blocking.
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // Case 2: IP already blocked (blocking failed because duplicate)
    const isAlreadyBlocked = blocking.success === false &&
        blocking.message && blocking.message.toLowerCase().includes('already blocked');

    if (isAlreadyBlocked) {
        const blockId = blocking.block_id || 'N/A';
        return `
        <div class="card" style="padding: 20px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(230, 165, 2, 0.15), rgba(230, 165, 2, 0.05)); border: 2px solid #E6A502; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 60px; height: 60px; border-radius: 50%; background: #E6A502; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0;">
                    ‚ö†Ô∏è
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; color: #E6A502;">
                        IP ALREADY BLOCKED
                    </h3>
                    <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 8px;">
                        This IP is already in the block list. No duplicate block was created.
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                        <span style="padding: 4px 10px; background: rgba(230, 165, 2, 0.2); border-radius: 4px; font-weight: 600;">
                            üÜî Existing Block ID: #${blockId}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // Case 3: Not blocked
    if (!blocking.blocked) return '';

    // Case 4: Successfully blocked (red banner)
    const rules = blocking.triggered_rules || [];
    const duration = blocking.adjusted_duration || blocking.base_duration || 0;
    const blockId = blocking.block_id || 'N/A';

    // Format duration
    let durationText = '';
    if (duration >= 10080) {
        durationText = `${Math.round(duration / 10080)} week(s)`;
    } else if (duration >= 1440) {
        durationText = `${Math.round(duration / 1440)} day(s)`;
    } else if (duration >= 60) {
        durationText = `${Math.round(duration / 60)} hour(s)`;
    } else {
        durationText = `${duration} minute(s)`;
    }

    return `
    <div class="card" style="padding: 20px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(209, 52, 56, 0.15), rgba(209, 52, 56, 0.05)); border: 2px solid #D13438; border-radius: 12px;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; border-radius: 50%; background: #D13438; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0;">
                üö´
            </div>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; color: #D13438;">
                    IP AUTO-BLOCKED
                </h3>
                <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 8px;">
                    This IP was automatically blocked by the threat detection rules.
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                    <span style="padding: 4px 10px; background: rgba(209, 52, 56, 0.2); border-radius: 4px; font-weight: 600;">
                        ‚è±Ô∏è Duration: ${durationText}
                    </span>
                    <span style="padding: 4px 10px; background: rgba(209, 52, 56, 0.2); border-radius: 4px; font-weight: 600;">
                        üÜî Block ID: #${blockId}
                    </span>
                </div>
                ${rules.length > 0 ? `
                <div style="margin-top: 12px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">TRIGGERED RULES:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${rules.map(rule => `
                            <span style="padding: 4px 10px; background: #D13438; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ${rule}
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    </div>
    `;
}

// Populate Analysis Tab
function populateAnalysisTab(data) {
    console.log('[Analysis] Populating tab with data:', data);

    document.getElementById('analysis-empty-state').style.display = 'none';
    const content = document.getElementById('analysis-content');
    content.style.display = 'block';

    const composite = data.composite_risk || {};
    const behavioral = data.behavioral_analysis || {};
    const geo = data.geographic_intelligence || {};
    const ti = data.results?.threat_intel || {};
    const ml = data.results?.ml || {};
    const history = data.results?.history || {};
    const blocking = data.blocking || {};

    console.log('[Analysis] Composite:', composite);
    console.log('[Analysis] Behavioral:', behavioral);
    console.log('[Analysis] Geographic:', geo);
    console.log('[Analysis] Blocking:', blocking);

    try {
        const html = `
            ${renderBlockingBanner(blocking)}
            ${renderCompositeRisk(composite, data.ip, behavioral.pattern)}
            ${renderRiskBreakdown(composite.breakdown)}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                ${renderThreatIntel(ti)}
                ${renderMLAnalysis(ml)}
                ${renderBehavioral(behavioral)}
                ${renderGeographic(geo, data.results?.geo)}
            </div>
            ${renderHistorical(history)}
        `;
        console.log('[Analysis] HTML generated, length:', html.length);
        content.innerHTML = html;
        console.log('[Analysis] Content updated successfully');
    } catch (err) {
        console.error('[Analysis] Error rendering HTML:', err);
        content.innerHTML = `<div class="card" style="padding: 20px; background: #fee; color: #c00;">Error rendering analysis: ${err.message}</div>`;
    }
}

// Copy to clipboard helper
function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(() => {
        showToast(`‚úÖ ${label} copied: ${text}`, 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('‚ùå Copy failed', 'error');
    });
}

// Render Composite Risk
function renderCompositeRisk(composite, ip, pattern) {
    const score = composite.overall_score || 0;
    const level = composite.threat_level || 'UNKNOWN';
    const confidence = composite.confidence || 0;
    const colors = { CRITICAL: '#D13438', HIGH: '#E6A502', MODERATE: '#0078D4', LOW: '#2EA44F', CLEAN: '#2EA44F' };

    return `
    <div class="card" style="padding: 24px; margin-bottom: 24px; background: linear-gradient(135deg, var(--card-bg), var(--background));">
        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;"><span style="font-size: 20px;">üéØ</span> Overall Threat Assessment</h3>
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 24px; align-items: center;">
            <div style="width: 140px; height: 140px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 8px solid ${colors[level]}; background: var(--card-bg);">
                <div style="font-size: 42px; font-weight: 700;">${score.toFixed(1)}</div>
                <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">RISK SCORE</div>
            </div>
            <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="padding: 6px 16px; border-radius: 6px; font-size: 14px; font-weight: 700; text-transform: uppercase; background: ${colors[level]}; color: white;">${level}</span>
                    <span
                        onclick="copyToClipboard('${ip}', 'IP Address')"
                        style="font-size: 16px; font-weight: 600; font-family: monospace; color: var(--azure-blue); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(0,120,212,0.1)'"
                        onmouseout="this.style.background='transparent'"
                        title="Click to copy IP address">
                        ${ip} üìã
                    </span>
                </div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Analysis Confidence: <strong>${confidence.toFixed(1)}%</strong></div>
                <div style="font-size: 13px; color: var(--text-secondary);">Pattern Detected: <strong>${pattern || 'Unknown'}</strong></div>
            </div>
        </div>
    </div>
    `;
}

// Render Risk Breakdown
function renderRiskBreakdown(breakdown) {
    if (!breakdown) return '';
    const components = [
        { key: 'threat_intel', label: 'Threat Intelligence', color: '#D13438' },
        { key: 'ml_prediction', label: 'ML Prediction', color: '#0078D4' },
        { key: 'behavioral', label: 'Behavioral Analysis', color: '#E6A502' },
        { key: 'geographic', label: 'Geographic Risk', color: '#2EA44F' }
    ];
    
    return `
    <div class="card" style="padding: 24px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;"><span style="font-size: 20px;">üìà</span> Multi-Factor Risk Breakdown</h3>
        ${components.map(c => {
            const comp = breakdown[c.key] || {};
            const score = comp.score || 0;
            const weighted = comp.weighted || 0;
            const weight = comp.weight || 0;
            return `
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                    <span><strong>${c.label}</strong> <span style="color: var(--text-secondary);">(√ó${weight})</span></span>
                    <span><strong>${score.toFixed(1)}</strong>/100 = <strong style="color: ${c.color};">${weighted.toFixed(1)}</strong> points</span>
                </div>
                <div style="height: 24px; background: var(--background); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; width: ${score}%; background: linear-gradient(90deg, ${c.color}, ${c.color}aa); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 12px; font-weight: 600; transition: width 0.5s;"></div>
                </div>
            </div>
            `;
        }).join('')}
    </div>
    `;
}

// Render sections (simplified for space)
function renderThreatIntel(ti) {
    return `<div class="card" style="padding: 20px; border-left: 4px solid #D13438;"><h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>üîç</span> Threat Intelligence</h4><div style="font-size: 13px;">AbuseIPDB: <strong>${ti.abuseipdb_score || 0}</strong>/100<br>VirusTotal: <strong>${ti.virustotal_positives || 0}</strong>/${ti.virustotal_total || 70} vendors<br>Threat Level: <strong>${(ti.threat_level || 'unknown').toUpperCase()}</strong></div></div>`;
}

function renderMLAnalysis(ml) {
    return `<div class="card" style="padding: 20px; border-left: 4px solid #0078D4;"><h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>ü§ñ</span> ML Analysis</h4><div style="font-size: 13px;">Risk Score: <strong>${ml.risk_score || 0}</strong>/100<br>Confidence: <strong>${ml.confidence ? (ml.confidence*100).toFixed(1) : 0}%</strong><br>Anomaly: <strong>${ml.is_anomaly ? 'YES' : 'NO'}</strong><br>Type: <strong>${ml.threat_type || 'Unknown'}</strong></div></div>`;
}

function renderBehavioral(b) {
    return `<div class="card" style="padding: 20px; border-left: 4px solid #E6A502;"><h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>‚ö°</span> Behavioral Analysis</h4><div style="font-size: 13px;">Pattern: <strong>${b.pattern || 'Unknown'}</strong><br>Velocity: <strong>${b.velocity || 0}</strong>/min<br>Failure Rate: <strong>${b.failure_rate || 0}%</strong><br>Indicators: <ul style="margin: 8px 0 0 0; padding-left: 20px;">${(b.indicators || []).map(i => `<li>${i}</li>`).join('')}</ul></div></div>`;
}

function renderGeographic(gi, geo) {
    const country = geo?.country || 'Unknown';
    const city = geo?.city || 'Unknown';
    const location = city !== 'Unknown' ? `${city}, ${country}` : country;

    return `<div class="card" style="padding: 20px; border-left: 4px solid #2EA44F;">
        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>üåç</span> Geographic Intelligence</h4>
        <div style="font-size: 13px;">
            Country: <strong
                onclick="copyToClipboard('${location}', 'Location')"
                style="cursor: pointer; padding: 2px 6px; border-radius: 3px; transition: background 0.2s;"
                onmouseover="this.style.background='rgba(46,164,79,0.1)'"
                onmouseout="this.style.background='transparent'"
                title="Click to copy location">
                ${country} üìã
            </strong><br>
            ${city !== 'Unknown' ? `City: <strong>${city}</strong><br>` : ''}
            Risk Score: <strong>${gi.score || 0}</strong>/100<br>
            High-Risk Region: <strong>${gi.is_high_risk_region ? 'YES' : 'NO'}</strong><br>
            Anonymized: <strong>${gi.is_anonymized ? 'YES' : 'NO'}</strong><br>
            Factors:
            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                ${(gi.factors || []).map(f => `<li>${f}</li>`).join('')}
            </ul>
        </div>
    </div>`;
}

function renderHistorical(h) {
    return `<div class="card" style="padding: 24px;"><h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;"><span>üìú</span> Historical Context</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;"><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Total Events</div><div style="font-size: 24px; font-weight: 700;">${h.total_events || 0}</div></div><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Failed Attempts</div><div style="font-size: 24px; font-weight: 700;">${h.failed_attempts || 0}</div></div><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Unique Usernames</div><div style="font-size: 24px; font-weight: 700;">${h.unique_usernames || 0}</div></div><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Anomalies</div><div style="font-size: 24px; font-weight: 700;">${h.anomaly_count || 0}</div></div></div></div>`;
}

// Populate Results Tab
function populateResultsTab(data) {
    console.log('[Results] Populating tab with data:', data);

    document.getElementById('results-empty-state').style.display = 'none';
    const content = document.getElementById('results-content');
    content.style.display = 'block';

    const recs = data.results?.recommendations || [];
    console.log('[Results] Total recommendations:', recs.length);

    const immediate = recs.filter(r => r.urgency === 'immediate');
    const shortTerm = recs.filter(r => r.urgency === 'short_term');
    const longTerm = recs.filter(r => r.urgency === 'long_term');

    console.log('[Results] Grouped:', { immediate: immediate.length, shortTerm: shortTerm.length, longTerm: longTerm.length });

    try {
        const html = `
            ${renderQuickActions(recs.slice(0, 3))}
            ${immediate.length > 0 ? `<div style="margin-bottom: 24px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"><span style="font-size: 24px;">üö®</span><h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #D13438;">Immediate Actions (Next 5 Minutes)</h3></div>${immediate.map(renderRecommendation).join('')}</div>` : ''}
            ${shortTerm.length > 0 ? `<div style="margin-bottom: 24px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"><span style="font-size: 24px;">üìÖ</span><h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #E6A502;">Short-Term Actions (Next Hour)</h3></div>${shortTerm.map(renderRecommendation).join('')}</div>` : ''}
            ${longTerm.length > 0 ? `<div style="margin-bottom: 24px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"><span style="font-size: 24px;">üõ°Ô∏è</span><h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #0078D4;">Long-Term Hardening (This Week)</h3></div>${longTerm.map(renderRecommendation).join('')}</div>` : ''}
        `;
        console.log('[Results] HTML generated, length:', html.length);
        content.innerHTML = html;
        console.log('[Results] Content updated successfully');
    } catch (err) {
        console.error('[Results] Error rendering HTML:', err);
        content.innerHTML = `<div class="card" style="padding: 20px; background: #fee; color: #c00;">Error rendering results: ${err.message}</div>`;
    }
}

// Render Quick Actions
function renderQuickActions(topRecs) {
    if (!topRecs || topRecs.length === 0) return '';

    const priorityColors = {
        'critical': '#D13438',
        'high': '#E6A502',
        'medium': '#0078D4',
        'low': '#2EA44F'
    };

    return `
    <div class="card" style="padding: 24px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(0, 120, 212, 0.05), rgba(230, 165, 2, 0.05)); border: 2px solid #E6A502;">
        <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">
            <span>‚ö°</span> Quick Actions
        </h3>
        <p style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-secondary);">
            Most critical recommendations - displayed as cards below
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
            ${topRecs.map(r => {
                const color = priorityColors[r.priority] || '#0078D4';
                const confidence = r.confidence ? (r.confidence * 100).toFixed(0) : r.ai_confidence ? (r.ai_confidence * 100).toFixed(0) : 0;
                return `
                <div style="padding: 16px; background: var(--card-bg); border-left: 4px solid ${color}; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px; color: ${color};">
                        ${r.icon || 'üîπ'} ${r.action}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                        ${confidence}% confidence ¬∑ ${r.urgency || 'N/A'} priority
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary); font-style: italic;">
                        See full details in recommendations below
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    </div>`;
}

// Render Recommendation
function renderRecommendation(rec) {
    const confidence = rec.confidence ? (rec.confidence * 100).toFixed(0) : rec.ai_confidence ? (rec.ai_confidence * 100).toFixed(0) : 0;
    return `
    <div class="recommendation-card ${rec.priority}">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${rec.icon || 'üîπ'} ${rec.action}</h4>
            <span style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">${confidence}% confidence</span>
        </div>
        <div style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">${rec.reason}</div>
        ${rec.why && rec.why.length > 0 ? `<div style="margin-bottom: 12px;"><strong style="font-size: 13px;">Why:</strong><ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 13px;">${rec.why.map(w => `<li>${w}</li>`).join('')}</ul></div>` : ''}
        ${rec.impact ? `<div style="margin-bottom: 12px; font-size: 13px;"><strong>Impact:</strong> ${rec.impact}</div>` : ''}
        ${rec.risk_if_ignored ? `<div style="padding: 8px 12px; background: rgba(209, 52, 56, 0.1); border-left: 3px solid #D13438; margin-bottom: 12px; font-size: 13px;"><strong>Risk if Ignored:</strong> ${rec.risk_if_ignored}</div>` : ''}
        ${rec.alternatives && rec.alternatives.length > 0 ? `<div style="margin-bottom: 12px;"><strong style="font-size: 13px;">Alternatives:</strong>${rec.alternatives.map(alt => `<div style="padding: 6px; background: var(--background); border-radius: 4px; margin-top: 4px; font-size: 12px;"><strong>${alt.action}:</strong> ${alt.impact}</div>`).join('')}</div>` : ''}
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            ${getActionButton(rec)}
        </div>
    </div>
    `;
}

// Get Action Button
function getActionButton(rec) {
    const type = rec.action_type;
    const data = rec.action_data;
    if (type === 'block_ip') return `<button onclick="blockIPWithModal('${data.ip}')" style="padding: 8px 16px; background: #D13438; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üö´ Block IP</button>`;
    if (type === 'add_blocklist') return `<button onclick="blockIPWithModal('${data.ip}')" style="padding: 8px 16px; background: #E6A502; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üìã Add to Blocklist</button>`;
    if (type === 'view_events') return `<button onclick="window.location.href='/dashboard?page=events-live'" style="padding: 8px 16px; background: #0078D4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üëÅÔ∏è View Events</button>`;
    return `<button style="padding: 8px 16px; background: var(--background); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">‚ÑπÔ∏è Learn More</button>`;
}

// Execute Action
function executeAction(actionType, actionData) {
    console.log('[Action]', actionType, actionData);
    if (actionType === 'block_ip') blockIPInline(actionData.ip);
    else if (actionType === 'add_blocklist') window.location.href = '/dashboard?page=ip-blocks';
    else if (actionType === 'view_events') window.location.href = '/dashboard?page=events-live';
}

// Block IP with Modal Confirmation
async function blockIPWithModal(ip) {
    console.log('[Block] Checking IP status:', ip);

    // Create modal overlay
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background: var(--card-bg); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);';

    // Show loading state
    modalContent.innerHTML = `
        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">üîç Checking IP Status...</h3>
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 48px;">‚è≥</div>
            <p style="margin: 16px 0 0 0; color: var(--text-secondary);">Checking if ${ip} is already blocked on any agent...</p>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    try {
        // Check global block status
        const globalResponse = await fetch(`/api/dashboard/blocking/blocks/check/${ip}`, { credentials: 'same-origin' });
        const globalStatus = await globalResponse.json();

        // Get all agents
        const agentsResponse = await fetch('/api/agents/list', { credentials: 'same-origin' });
        const agentsData = await agentsResponse.json();
        const agents = agentsData.agents || [];

        // Check each agent
        const agentChecks = await Promise.all(
            agents.map(async (agent) => {
                try {
                    const resp = await fetch(`/api/agents/${agent.id}/blocked-ips`, { credentials: 'same-origin' });
                    const data = await resp.json();
                    const isBlocked = data.blocked_ips?.some(blocked => blocked.ip_address === ip);
                    return { agent: agent.hostname, id: agent.id, blocked: isBlocked };
                } catch (err) {
                    console.error(`[Block] Error checking agent ${agent.hostname}:`, err);
                    return { agent: agent.hostname, id: agent.id, blocked: false, error: true };
                }
            })
        );

        const blockedOnAgents = agentChecks.filter(a => a.blocked);
        const isAlreadyBlocked = globalStatus.is_blocked || blockedOnAgents.length > 0;

        // Update modal with results
        modalContent.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">
                ${isAlreadyBlocked ? '‚ö†Ô∏è' : 'üö´'} Block IP Address
            </h3>
            <div style="background: var(--background); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-family: monospace; font-size: 18px; font-weight: 600; color: var(--azure-blue);">${ip}</div>
            </div>

            ${isAlreadyBlocked ? `
                <div style="background: rgba(230, 165, 2, 0.1); border-left: 4px solid #E6A502; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                    <strong style="color: #E6A502;">‚ö†Ô∏è Already Blocked</strong>
                    <p style="margin: 8px 0 0 0; font-size: 14px;">This IP is already blocked on the following:</p>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px;">
                        ${globalStatus.is_blocked ? `<li><strong>Global Blocklist</strong> (${globalStatus.reason || 'No reason specified'})</li>` : ''}
                        ${blockedOnAgents.map(a => `<li><strong>Agent:</strong> ${a.agent}</li>`).join('')}
                    </ul>
                </div>
            ` : `
                <div style="background: rgba(209, 52, 56, 0.1); border-left: 4px solid #D13438; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                    <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è Warning:</strong> This will block the IP address on all SSH Guardian agents.</p>
                </div>
            `}

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Block Reason:</label>
                <input id="block-reason" type="text" value="Threat detected via simulation analysis" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: var(--background); color: var(--text-primary);">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Block Duration:</label>
                <select id="block-duration" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: var(--background); color: var(--text-primary);">
                    <option value="permanent">Permanent</option>
                    <option value="24h">24 Hours</option>
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                </select>
            </div>

            <div style="margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">
                <strong>Status Check Results:</strong>
                <div style="margin-top: 8px;">
                    <div>‚úì Checked ${agents.length} agent(s)</div>
                    <div>‚úì Global blocklist status: ${globalStatus.is_blocked ? 'Blocked' : 'Not blocked'}</div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 10px 20px; background: var(--background); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    Cancel
                </button>
                ${!isAlreadyBlocked ? `
                <button onclick="executeIPBlock('${ip}')" style="padding: 10px 20px; background: #D13438; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üö´ Block IP
                </button>
                ` : ''}
            </div>
        `;

    } catch (error) {
        console.error('[Block] Error checking status:', error);
        modalContent.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">‚ùå Error</h3>
            <p style="margin: 0 0 16px 0;">Failed to check IP status: ${error.message}</p>
            <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 10px 20px; background: var(--background); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600;">
                Close
            </button>
        `;
    }
}

// Execute IP Block
async function executeIPBlock(ip) {
    const reason = document.getElementById('block-reason').value;
    const duration = document.getElementById('block-duration').value;
    const modal = document.querySelector('[style*="position: fixed"]');

    console.log('[Block] Executing block:', { ip, reason, duration });

    try {
        const response = await fetch('/api/dashboard/blocking/blocks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                ip_address: ip,
                reason: reason,
                duration: duration
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast(`‚úÖ IP ${ip} blocked successfully`, 'success');
            modal.remove();
        } else {
            showToast(`‚ùå Failed to block IP: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('[Block] Error:', error);
        showToast('‚ùå Failed to block IP', 'error');
    }
}

// Legacy function for backward compatibility
async function blockIPInline(ip) {
    blockIPWithModal(ip);
}

// Toast notification
function showToast(message, type, duration = 3000) {
    const toast = document.createElement('div');
    toast.textContent = message;
    const colors = {
        success: '#2EA44F',
        error: '#D13438',
        warning: '#E6A502',
        info: '#0078D4'
    };
    const bgColor = colors[type] || colors.info;
    toast.style.cssText = `position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: ${bgColor}; color: white; border-radius: 6px; font-weight: 600; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

// Track if page has been initialized
let isSimulationPageInitialized = false;

// Auto-initialize when page becomes visible
function initializeSimulationPageIfVisible() {
    const pageEl = document.getElementById('page-simulation');
    if (!pageEl) return;

    const isVisible = pageEl.style.display !== 'none' && pageEl.classList.contains('active');

    if (isVisible && !isSimulationPageInitialized) {
        console.log('[Simulation] Page became visible, loading data...');
        isSimulationPageInitialized = true;
        loadSimulationPage();
    }
}

// Set up MutationObserver to watch for page visibility changes
function setupPageVisibilityWatcher() {
    const pageEl = document.getElementById('page-simulation');
    if (!pageEl) {
        console.log('[Simulation] Page element not found, retrying...');
        setTimeout(setupPageVisibilityWatcher, 100);
        return;
    }

    console.log('[Simulation] Setting up visibility watcher...');

    // Check immediately
    initializeSimulationPageIfVisible();

    // Watch for attribute changes (style, class)
    const observer = new MutationObserver(() => {
        initializeSimulationPageIfVisible();
    });

    observer.observe(pageEl, {
        attributes: true,
        attributeFilter: ['style', 'class']
    });
}

// Initialize based on document ready state
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupPageVisibilityWatcher);
} else {
    setupPageVisibilityWatcher();
}
</script>
</div>
