<!-- SSH Guardian v3.0 - Simulation Page (Simplified 3-Tab Flow) -->
<!-- Version: v3.2.0 - Scenarios ‚Üí Analysis ‚Üí Recommendations -->
<div id="page-simulation" class="page-content" style="display: none;">
    <div class="page-header-with-cache">
        <div>
            <h2 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 24px; font-weight: 600;">
                Threat Simulation
            </h2>
            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                Run attack scenarios, analyze threats, get recommendations
            </p>
        </div>
        <div class="page-header-actions">
            <div class="cache-indicator loading" data-cache-endpoint="simulation">
                <span class="cache-status-dot"></span>
                <span class="cache-indicator-text">Loading...</span>
                <span class="cache-time"></span>
                <button class="cache-refresh-btn" onclick="loadSimulationPage()" title="Refresh data">‚Üª</button>
            </div>
        </div>
    </div>

    <!-- 3-Tab Navigation -->
    <div class="simulation-tabs" style="display: flex; gap: 8px; border-bottom: 2px solid var(--border); margin-bottom: 24px; position: sticky; top: 0; z-index: 100; background: var(--background); padding: 8px 0;">
        <button class="sim-tab-btn active" data-tab="scenarios" onclick="switchSimulationTab('scenarios')">
            <span style="font-size: 18px;">1Ô∏è‚É£</span> Scenarios
        </button>
        <button class="sim-tab-btn" data-tab="analysis" onclick="switchSimulationTab('analysis')">
            <span style="font-size: 18px;">2Ô∏è‚É£</span> Analysis
        </button>
        <button class="sim-tab-btn" data-tab="results" onclick="switchSimulationTab('results')">
            <span style="font-size: 18px;">3Ô∏è‚É£</span> Recommendations
        </button>
    </div>

    <!-- TAB 1: SCENARIOS -->
    <div id="tab-scenarios" class="sim-tab-content active">
        <div class="card" style="padding: 24px; margin-bottom: 24px;">
            <!-- Header with Refresh IPs button -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">Attack Scenarios</h3>
                    <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                        Click a scenario to run threat analysis. Select an agent to also deploy UFW blocks.
                    </p>
                </div>
                <button id="refresh-ips-btn" onclick="refreshIPPool()" style="padding: 8px 16px; background: var(--background); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                    <span id="refresh-ips-icon">üîÑ</span> Refresh IPs
                </button>
            </div>

            <!-- IP Pool Status -->
            <div id="ip-pool-status" style="display: none; margin-bottom: 16px; padding: 10px 14px; background: rgba(46, 164, 79, 0.1); border: 1px solid #2EA44F; border-radius: 6px; font-size: 12px;">
                <span id="ip-pool-count">0</span> fresh IPs available
                <span style="color: var(--text-secondary); margin-left: 8px;">Last refresh: <span id="ip-pool-time">Never</span></span>
            </div>

            <!-- Target Server Selection -->
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px; padding: 10px 14px; background: var(--background); border-radius: 4px; border: 1px solid var(--border);">
                <label style="font-weight: 600; font-size: 12px; color: var(--text-secondary); white-space: nowrap;">Run on:</label>
                <select id="scenario-target" style="flex: 1; max-width: 300px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface); color: var(--text-primary);">
                    <option value="">Local Analysis Only</option>
                </select>
                <span id="scenario-target-status" style="font-size: 11px; color: var(--text-hint);"></span>
                <button onclick="showAddTargetModal()" style="padding: 6px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 12px; color: var(--text-primary);" title="Manage Target Servers">
                    Manage
                </button>
            </div>

            <!-- Live Attack Status Panel (shows during remote attacks) -->
            <div id="live-attack-status" style="display: none; margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(0, 120, 212, 0.1), rgba(0, 90, 170, 0.05)); border: 2px solid var(--azure-blue); border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div id="live-status-spinner" class="scenario-spinner" style="width: 24px; height: 24px;"></div>
                    <div style="flex: 1;">
                        <div id="live-status-title" style="font-weight: 600; font-size: 15px; color: var(--text-primary);">Attack Running...</div>
                        <div id="live-status-subtitle" style="font-size: 12px; color: var(--text-secondary);">Waiting for response</div>
                    </div>
                    <button onclick="hideLiveStatus()" style="background: none; border: none; cursor: pointer; font-size: 16px; color: var(--text-secondary);">‚úï</button>
                </div>
                <div id="live-status-steps" style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <span class="live-step" data-step="inject">üì§ Injecting</span>
                    <span class="live-step" data-step="detect">üëÅÔ∏è Detecting</span>
                    <span class="live-step" data-step="block">üö´ Blocking</span>
                    <span class="live-step" data-step="complete">‚úÖ Done</span>
                </div>
            </div>

            <!-- Category: UFW Blocking Scenarios -->
            <div id="category-ufw" style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                    <span style="font-size: 20px;">üõ°Ô∏è</span>
                    <div>
                        <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">UFW Blocking Scenarios</h4>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Trigger SSH Guardian rules ‚Üí Agent blocks IP via UFW</p>
                    </div>
                </div>
                <div id="scenarios-ufw" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    <!-- UFW scenarios loaded here -->
                </div>
            </div>

            <!-- Category: Fail2ban Scenarios -->
            <div id="category-fail2ban" style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                    <span style="font-size: 20px;">üîí</span>
                    <div>
                        <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Fail2ban Scenarios</h4>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Generate auth.log entries ‚Üí Fail2ban detects & bans automatically</p>
                    </div>
                    <span style="margin-left: auto; padding: 4px 10px; background: #E6A502; color: white; font-size: 11px; font-weight: 600; border-radius: 4px;">REQUIRES TARGET SERVER</span>
                </div>
                <div id="scenarios-fail2ban" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    <!-- Fail2ban scenarios loaded here -->
                </div>
            </div>

            <!-- Category: Baseline (hidden by default) -->
            <div id="category-baseline" style="margin-bottom: 24px; display: none;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                    <span style="font-size: 20px;">‚úÖ</span>
                    <div>
                        <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">Baseline (Clean IPs)</h4>
                        <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">For comparison - should NOT be blocked</p>
                    </div>
                </div>
                <div id="scenarios-baseline" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
                    <!-- Baseline scenarios loaded here -->
                </div>
            </div>

            <!-- Fallback grid for uncategorized -->
            <div id="demo-scenarios-grid" style="display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
            </div>
        </div>
    </div>

    <!-- TAB 2: ANALYSIS -->
    <div id="tab-analysis" class="sim-tab-content" style="display: none;">
        <div id="analysis-empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--text-primary);">No Analysis Available</h3>
            <p style="margin: 0; font-size: 14px;">Run a scenario from the Scenarios tab to see detailed threat analysis</p>
        </div>
        <div id="analysis-content" style="display: none;"></div>
    </div>

    <!-- TAB 3: RECOMMENDATIONS -->
    <div id="tab-results" class="sim-tab-content" style="display: none;">
        <div id="results-empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
            <div style="font-size: 48px; margin-bottom: 16px;">üí°</div>
            <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--text-primary);">No Recommendations Yet</h3>
            <p style="margin: 0; font-size: 14px;">Run a scenario first, then check here for security recommendations</p>
        </div>
        <div id="results-content" style="display: none;"></div>
    </div>

</div>

<style>
.simulation-tabs { display: flex; gap: 8px; border-bottom: 2px solid var(--border); }
.sim-tab-btn { padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: 15px; font-weight: 600; color: var(--text-secondary); transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
.sim-tab-btn:hover { color: var(--text-primary); background: var(--hover-bg); }
.sim-tab-btn.active { color: var(--azure-blue); border-bottom-color: var(--azure-blue); background: rgba(0, 120, 212, 0.05); }
.sim-tab-content { display: none; }
.sim-tab-content.active { display: block; animation: fadeIn 0.3s ease-in; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.demo-scenario-card { padding: 16px; background: var(--card-bg); border-radius: 8px; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
.demo-scenario-card:hover { border-color: var(--azure-blue); box-shadow: 0 4px 12px rgba(0, 120, 212, 0.2); transform: translateY(-2px); }
.demo-scenario-card.running { border-color: var(--azure-blue); background: linear-gradient(135deg, var(--card-bg), rgba(0, 120, 212, 0.1)); pointer-events: none; }

/* Scenario Loading Overlay */
.scenario-loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(0, 120, 212, 0.95), rgba(0, 90, 170, 0.95)); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; z-index: 10; border-radius: 6px; }
.scenario-spinner { width: 36px; height: 36px; border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
.scenario-loading-text { font-size: 13px; font-weight: 600; color: #fff; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.recommendation-card { padding: 20px; background: var(--card-bg); border-radius: 12px; border-left: 5px solid; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s; margin-bottom: 16px; }
.recommendation-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
.recommendation-card.critical { border-left-color: #D13438; background: linear-gradient(135deg, var(--card-bg), rgba(209, 52, 56, 0.05)); }
.recommendation-card.high { border-left-color: #E6A502; background: linear-gradient(135deg, var(--card-bg), rgba(230, 165, 2, 0.05)); }
.recommendation-card.medium { border-left-color: #0078D4; background: linear-gradient(135deg, var(--card-bg), rgba(0, 120, 212, 0.05)); }
.recommendation-card.low { border-left-color: #2EA44F; background: linear-gradient(135deg, var(--card-bg), rgba(46, 164, 79, 0.05)); }

/* Mini Pipeline Steps for Scenarios */
.pipeline-mini-step { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 12px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 8px; min-width: 60px; transition: all 0.3s ease; }
.pipeline-mini-step .step-icon { font-size: 18px; }
.pipeline-mini-step .step-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); }
.pipeline-mini-step[data-status="running"] { border-color: var(--azure-blue); background: rgba(0, 120, 212, 0.1); animation: pulse 1.5s infinite; }
.pipeline-mini-step[data-status="success"] { border-color: #2EA44F; background: rgba(46, 164, 79, 0.1); }
.pipeline-mini-step[data-status="success"] .step-label { color: #2EA44F; }
.pipeline-mini-step[data-status="failed"] { border-color: #D13438; background: rgba(209, 52, 56, 0.1); }
.pipeline-mini-step[data-status="failed"] .step-label { color: #D13438; }
.pipeline-mini-step[data-status="skipped"] { opacity: 0.5; border-style: dashed; }
.pipeline-connector { display: flex; align-items: center; color: var(--text-secondary); font-size: 16px; }

/* Pipeline Flow Styles */
.pipeline-flow { display: flex; flex-direction: column; gap: 0; }
.pipeline-step { display: flex; align-items: flex-start; gap: 16px; padding: 20px; background: var(--card-bg); border: 2px solid var(--border); border-radius: 12px; margin-bottom: -1px; transition: all 0.3s ease; position: relative; }
.pipeline-step:first-child { border-top-left-radius: 12px; border-top-right-radius: 12px; }
.pipeline-step:last-child { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; margin-bottom: 0; }
.pipeline-step::after { content: ''; position: absolute; left: 38px; bottom: -12px; width: 2px; height: 12px; background: var(--border); z-index: 1; }
.pipeline-step:last-child::after { display: none; }
.pipeline-step .step-icon { width: 48px; height: 48px; border-radius: 50%; background: var(--background); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; border: 2px solid var(--border); transition: all 0.3s ease; }
.pipeline-step .step-content { flex: 1; }
.pipeline-step .step-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
.pipeline-step .step-status { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
.pipeline-step .step-details { font-size: 12px; color: var(--text-secondary); padding: 8px 12px; background: var(--background); border-radius: 6px; display: none; }
.pipeline-step.running { border-color: var(--azure-blue); background: linear-gradient(135deg, var(--card-bg), rgba(0, 120, 212, 0.1)); }
.pipeline-step.running .step-icon { border-color: var(--azure-blue); background: rgba(0, 120, 212, 0.2); animation: pulse 1.5s infinite; }
.pipeline-step.success { border-color: #2EA44F; background: linear-gradient(135deg, var(--card-bg), rgba(46, 164, 79, 0.1)); }
.pipeline-step.success .step-icon { border-color: #2EA44F; background: rgba(46, 164, 79, 0.2); }
.pipeline-step.success .step-status { color: #2EA44F; font-weight: 600; }
.pipeline-step.failed { border-color: #D13438; background: linear-gradient(135deg, var(--card-bg), rgba(209, 52, 56, 0.1)); }
.pipeline-step.failed .step-icon { border-color: #D13438; background: rgba(209, 52, 56, 0.2); }
.pipeline-step.failed .step-status { color: #D13438; font-weight: 600; }
.pipeline-step.skipped { border-color: #8B8B8B; opacity: 0.7; }
.pipeline-step.skipped .step-status { color: #8B8B8B; font-style: italic; }
.pipeline-step .step-details.visible { display: block; }
@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }

/* Live Attack Status Steps */
.live-step { padding: 6px 12px; background: var(--background); border: 1px solid var(--border); border-radius: 20px; font-size: 12px; color: var(--text-secondary); }
.live-step.active { background: var(--azure-blue); color: white; border-color: var(--azure-blue); animation: pulse 1.5s infinite; }
.live-step.complete { background: #2EA44F; color: white; border-color: #2EA44F; }
.live-step.failed { background: #D13438; color: white; border-color: #D13438; }

/* Category disabled state for fail2ban without target */
.category-disabled .demo-scenario-card { opacity: 0.6; pointer-events: none; }
.category-disabled .demo-scenario-card::after { content: 'Select a target server first'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; white-space: nowrap; }
</style>

<script>
// Global state
let currentAnalysisData = null;

// ========================
// HELPER FUNCTIONS
// ========================

// Tab switching
function switchSimulationTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.sim-tab-content').forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });

    // Deactivate all tab buttons
    document.querySelectorAll('.sim-tab-btn').forEach(btn => btn.classList.remove('active'));

    // Show selected tab
    const selectedTab = document.getElementById('tab-' + tabName);
    if (selectedTab) {
        selectedTab.classList.add('active');
        selectedTab.style.display = 'block';
    }

    // Activate selected tab button
    const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (selectedBtn) {
        selectedBtn.classList.add('active');
    }

    console.log('[Simulation] Switched to tab:', tabName);
}

// Load page
async function loadSimulationPage() {
    console.log('[Simulation] Loading page...');
    const startTime = performance.now();

    // Set loading state for cache indicator
    if (typeof CacheManager !== 'undefined') {
        CacheManager.setLoading('simulation');
    }

    try {
        // Load demo scenarios
        await loadDemoScenarios();

        // Load target server dropdown
        await loadScenarioTargets();

        // Load IP pool stats
        await loadIPPoolStats();

        // Load other data that dashboard expects (for cache status)
        await Promise.all([
            loadSimulationTemplates(),
            loadSimulationHistory()
        ]);

        const loadTime = Math.round(performance.now() - startTime);
        console.log('[Simulation] Page loaded successfully in', loadTime, 'ms');

        // Update cache status to "fresh" (not from cache)
        if (typeof CacheManager !== 'undefined') {
            CacheManager.updateStatus('simulation', false, loadTime);
        }
    } catch (error) {
        console.error('[Simulation] Error loading page:', error);

        // Set error state for cache indicator
        if (typeof CacheManager !== 'undefined') {
            CacheManager.setError('simulation', 'Failed to load simulation data');
        }
    }
}

// Load target servers for scenario dropdown (agent-based)
async function loadScenarioTargets() {
    try {
        const response = await fetch('/api/live-sim/targets/from-agents', { credentials: 'same-origin' });
        const data = await response.json();

        const select = document.getElementById('scenario-target');
        if (data.success) {
            // Filter to only enabled agents
            const enabledAgents = data.agents.filter(a => a.sim_enabled);

            if (enabledAgents.length > 0) {
                select.innerHTML = '<option value="">Local Analysis Only</option>' +
                    enabledAgents.map(a => {
                        const name = a.display_name || a.hostname;
                        const statusIcon = a.test_status === 'success' ? '‚úÖ' : a.test_status === 'failed' ? '‚ùå' : '';
                        return `<option value="${a.sim_target_id}" data-ip="${a.ip_address_primary}" data-port="${a.sim_port || 5001}">
                            üéØ ${name} (${a.ip_address_primary}) ${statusIcon}
                        </option>`;
                    }).join('');
            } else {
                select.innerHTML = '<option value="">Local Analysis Only (no agents configured)</option>';
            }
        } else {
            select.innerHTML = '<option value="">Local Analysis Only</option>';
        }

        // Add change listener to update fail2ban category state
        select.addEventListener('change', () => {
            updateFail2banCategoryState();
        });

        // Initial state update
        updateFail2banCategoryState();
    } catch (error) {
        console.error('[Simulation] Error loading target servers:', error);
    }
}

// Load simulation templates (for dashboard cache)
async function loadSimulationTemplates() {
    try {
        const response = await fetch('/api/simulation/templates', { credentials: 'same-origin' });
        await response.json();
    } catch (error) {
        console.error('[Simulation] Error loading templates:', error);
    }
}

// Load simulation history (for dashboard cache)
async function loadSimulationHistory() {
    try {
        const response = await fetch('/api/simulation/history?limit=10&offset=0', { credentials: 'same-origin' });
        await response.json();
    } catch (error) {
        console.error('[Simulation] Error loading history:', error);
    }
}

// Refresh IP Pool from external sources
async function refreshIPPool() {
    const btn = document.getElementById('refresh-ips-btn');
    const icon = document.getElementById('refresh-ips-icon');

    btn.disabled = true;
    icon.textContent = '‚è≥';
    btn.style.opacity = '0.7';

    try {
        const response = await fetch('/api/demo/refresh-ips', {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();

        if (data.success) {
            // Update pool status display
            const statusEl = document.getElementById('ip-pool-status');
            const countEl = document.getElementById('ip-pool-count');
            const timeEl = document.getElementById('ip-pool-time');

            statusEl.style.display = 'block';
            countEl.textContent = data.pool_stats?.total_ips || data.fetched;
            timeEl.textContent = new Date().toLocaleTimeString();

            // Reload scenarios to get new IPs in the cards
            await loadDemoScenarios();

            showToast(`Fetched ${data.fetched} fresh IPs and updated scenarios`, 'success');
        } else {
            showToast(`Failed to refresh IPs: ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Failed to refresh IP pool', 'error');
    } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
        icon.textContent = 'üîÑ';
    }
}

// Load IP pool stats on page load
async function loadIPPoolStats() {
    try {
        const response = await fetch('/api/demo/ip-pool/stats', { credentials: 'same-origin' });
        const data = await response.json();

        if (data.success && data.total_ips > 0) {
            const statusEl = document.getElementById('ip-pool-status');
            const countEl = document.getElementById('ip-pool-count');
            const timeEl = document.getElementById('ip-pool-time');

            statusEl.style.display = 'block';
            countEl.textContent = data.total_ips;
            timeEl.textContent = data.last_refresh ? new Date(data.last_refresh).toLocaleTimeString() : 'Recently';
        }
    } catch (error) {
        // Silent fail - pool stats are optional
    }
}

// Load demo scenarios
async function loadDemoScenarios() {
    try {
        const response = await fetch('/api/demo/scenarios', { credentials: 'same-origin' });
        const data = await response.json();
        if (data.success) {
            renderDemoScenarios(data.scenarios);
        } else {
            const grid = document.getElementById('demo-scenarios-grid');
            if (grid) grid.innerHTML = '<div style="padding: 20px; color: var(--text-secondary);">Failed to load scenarios.</div>';
        }
    } catch (error) {
        const grid = document.getElementById('demo-scenarios-grid');
        if (grid) grid.innerHTML = '<div style="padding: 20px; color: var(--text-secondary);">Error loading scenarios.</div>';
    }
}

// Render demo scenarios by category
function renderDemoScenarios(scenarios) {
    const colors = { critical: '#D13438', high: '#E6A502', medium: '#0078D4', low: '#2EA44F' };
    const icons = { critical: 'üî¥', high: 'üü†', medium: 'üü°', low: 'üü¢' };

    // Group scenarios by category
    const ufwScenarios = scenarios.filter(s => s.category === 'ufw_block');
    const f2bScenarios = scenarios.filter(s => s.category === 'fail2ban');
    const baselineScenarios = scenarios.filter(s => s.category === 'baseline');

    // Helper to render a single scenario card
    const renderCard = (s) => `
        <div class="demo-scenario-card" data-scenario="${s.id}" data-category="${s.category}" onclick="runDemoScenario('${s.id}')">
            <div class="scenario-loading-overlay" style="display: none;">
                <div class="scenario-spinner"></div>
                <div class="scenario-loading-text">Analyzing...</div>
            </div>
            <div class="scenario-card-content">
                <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">${s.name}</div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4;">${s.description}</div>
                ${s.trigger ? `<div style="font-size: 11px; color: var(--azure-blue); margin-bottom: 8px;"><strong>Trigger:</strong> ${s.trigger}</div>` : ''}
                ${s.block_duration ? `<div style="font-size: 11px; color: #E6A502; margin-bottom: 8px;"><strong>Block:</strong> ${s.block_duration}</div>` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; background: ${colors[s.severity]}; color: white;">
                        ${icons[s.severity]} ${s.severity}
                    </span>
                    <span class="scenario-ip" style="font-family: monospace; font-size: 11px; color: var(--azure-blue); font-weight: 600;">${s.ip}</span>
                </div>
            </div>
        </div>
    `;

    // Render UFW scenarios
    const ufwContainer = document.getElementById('scenarios-ufw');
    if (ufwContainer) {
        ufwContainer.innerHTML = ufwScenarios.length > 0
            ? ufwScenarios.map(renderCard).join('')
            : '<p style="color: var(--text-secondary); font-size: 13px;">No UFW scenarios available</p>';
    }

    // Render Fail2ban scenarios
    const f2bContainer = document.getElementById('scenarios-fail2ban');
    if (f2bContainer) {
        f2bContainer.innerHTML = f2bScenarios.length > 0
            ? f2bScenarios.map(renderCard).join('')
            : '<p style="color: var(--text-secondary); font-size: 13px;">No Fail2ban scenarios available</p>';
    }

    // Render Baseline scenarios
    const baselineContainer = document.getElementById('scenarios-baseline');
    if (baselineContainer && baselineScenarios.length > 0) {
        baselineContainer.innerHTML = baselineScenarios.map(renderCard).join('');
        document.getElementById('category-baseline').style.display = 'block';
    }

    // Update fail2ban category state based on target selection
    updateFail2banCategoryState();

    console.log(`[Simulation] Rendered ${ufwScenarios.length} UFW, ${f2bScenarios.length} Fail2ban, ${baselineScenarios.length} Baseline scenarios`);
}

// Update fail2ban category state based on target selection
function updateFail2banCategoryState() {
    const targetId = document.getElementById('scenario-target')?.value;
    const f2bCategory = document.getElementById('category-fail2ban');

    if (f2bCategory) {
        if (targetId) {
            f2bCategory.classList.remove('category-disabled');
        } else {
            f2bCategory.classList.add('category-disabled');
        }
    }
}

// Live attack status functions
function showLiveStatus(title, subtitle) {
    const panel = document.getElementById('live-attack-status');
    if (panel) {
        panel.style.display = 'block';
        document.getElementById('live-status-title').textContent = title || 'Attack Running...';
        document.getElementById('live-status-subtitle').textContent = subtitle || 'Waiting for response';

        // Reset all steps
        document.querySelectorAll('.live-step').forEach(el => {
            el.classList.remove('active', 'complete', 'failed');
        });
    }
}

function updateLiveStep(step, status) {
    const stepEl = document.querySelector(`.live-step[data-step="${step}"]`);
    if (stepEl) {
        stepEl.classList.remove('active', 'complete', 'failed');
        if (status) stepEl.classList.add(status);
    }
}

function hideLiveStatus() {
    const panel = document.getElementById('live-attack-status');
    if (panel) panel.style.display = 'none';
}

// Run demo scenario
async function runDemoScenario(scenarioId) {
    const card = document.querySelector(`.demo-scenario-card[data-scenario="${scenarioId}"]`);
    const loadingOverlay = card.querySelector('.scenario-loading-overlay');
    const loadingText = card.querySelector('.scenario-loading-text');

    // Show loading overlay
    card.classList.add('running');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }

    // Get target server selection - if target selected, run on remote server
    const targetId = document.getElementById('scenario-target')?.value || '';
    const runOnRemote = !!targetId;

    // Update status indicator
    const statusEl = document.getElementById('scenario-target-status');
    if (statusEl) {
        if (runOnRemote) {
            const targetSelect = document.getElementById('scenario-target');
            const targetOption = targetSelect.selectedOptions[0];
            statusEl.textContent = `‚Üí ${targetOption?.dataset?.ip || 'Remote'}`;
            statusEl.style.color = '#2EA44F';
        } else {
            statusEl.textContent = '';
        }
    }

    // Update loading text based on mode
    if (loadingText) {
        loadingText.textContent = runOnRemote ? 'Injecting to remote server...' : 'Analyzing threat...';
    }

    try {
        let data;

        if (runOnRemote) {
            // Show live status panel
            const targetSelect = document.getElementById('scenario-target');
            const targetName = targetSelect.selectedOptions[0]?.text || 'Remote Server';
            showLiveStatus(`Running: ${scenarioId}`, `Target: ${targetName}`);
            updateLiveStep('inject', 'active');

            // Run on remote server via live simulation API
            const response = await fetch('/api/live-sim/live/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    target_id: parseInt(targetId),
                    scenario_id: scenarioId
                })
            });
            const runResult = await response.json();

            if (runResult.success) {
                if (loadingText) {
                    loadingText.textContent = `‚úÖ Injected ${runResult.lines_written} events`;
                }

                // Update live status
                updateLiveStep('inject', 'complete');
                updateLiveStep('detect', 'active');
                document.getElementById('live-status-subtitle').textContent =
                    `Injected ${runResult.lines_written} events - waiting for detection...`;

                showToast(`üéØ Injected ${runResult.lines_written} events to ${runResult.target_name}`, 'success', 3000);

                // Poll for status updates with live status callback
                pollRemoteSimStatus(runResult.run_id, scenarioId, (status) => {
                    // Update live status based on poll result
                    if (status.detected) {
                        updateLiveStep('detect', 'complete');
                        updateLiveStep('block', 'active');
                        document.getElementById('live-status-subtitle').textContent = 'Detected! Blocking...';
                    }
                    if (status.blocked) {
                        updateLiveStep('block', 'complete');
                        updateLiveStep('complete', 'complete');
                        document.getElementById('live-status-title').textContent = '‚úÖ Attack Blocked!';
                        document.getElementById('live-status-subtitle').textContent = `IP ${status.ip} was blocked by ${status.blocked_by || 'fail2ban'}`;
                        document.getElementById('live-status-spinner').style.display = 'none';
                    }
                    if (status.completed && !status.blocked) {
                        updateLiveStep('complete', 'complete');
                        document.getElementById('live-status-title').textContent = '‚úÖ Simulation Complete';
                        document.getElementById('live-status-subtitle').textContent = 'Check Firewall & Blocking page for results';
                        document.getElementById('live-status-spinner').style.display = 'none';
                    }
                });

                // Hide card loading after short delay
                setTimeout(() => {
                    card.classList.remove('running');
                    if (loadingOverlay) loadingOverlay.style.display = 'none';
                }, 2000);
                return;
            } else {
                if (loadingText) loadingText.textContent = 'Failed!';
                updateLiveStep('inject', 'failed');
                document.getElementById('live-status-title').textContent = '‚ùå Injection Failed';
                document.getElementById('live-status-subtitle').textContent = runResult.error;
                document.getElementById('live-status-spinner').style.display = 'none';
                showToast(`Failed: ${runResult.error}`, 'error');
            }
        } else {
            // Run local analysis (original behavior)
            const response = await fetch(`/api/demo/run/${scenarioId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    agent_id: null,
                    run_full_pipeline: false
                })
            });
            data = await response.json();

            if (data.success) {
                currentAnalysisData = data;

                // Check blocking status from enrichment result
                const blocking = data.blocking || {};
                const blocked = blocking.blocked || data.pipeline_steps?.ip_blocked?.is_blocked;
                const skipped = blocking.skipped;
                const alreadyBlocked = blocking.success === false &&
                    blocking.message && blocking.message.toLowerCase().includes('already blocked');
                const triggeredRules = blocking.triggered_rules || data.pipeline_steps?.ip_blocked?.triggered_rules || [];

                // Update loading text based on blocking status
                if (loadingText) {
                    if (blocked) {
                        loadingText.textContent = 'üö´ BLOCKED!';
                    } else if (alreadyBlocked) {
                        loadingText.textContent = '‚ö†Ô∏è Already Blocked';
                    } else if (skipped) {
                        loadingText.textContent = '‚úÖ Analyzed';
                    } else {
                        loadingText.textContent = 'Complete!';
                    }
                }

                // Show toast for blocking result
                if (blocked) {
                    const rulesText = triggeredRules.length > 0 ? ` (${triggeredRules.join(', ')})` : '';
                    showToast(`üö´ IP ${data.ip} AUTO-BLOCKED${rulesText}`, 'warning', 5000);
                } else if (alreadyBlocked) {
                    showToast(`‚ö†Ô∏è IP ${data.ip} is already blocked (ID: #${blocking.block_id})`, 'warning', 5000);
                } else if (skipped) {
                    showToast(`‚ÑπÔ∏è Analysis complete - select a target server to run live attack`, 'info', 3000);
                }

                try {
                    populateAnalysisTab(data);
                    populateResultsTab(data);

                    // Brief delay to show status before switching tabs
                    await new Promise(resolve => setTimeout(resolve, blocked || alreadyBlocked ? 800 : 300));
                    switchSimulationTab('analysis');

                    if (typeof CacheManager !== 'undefined') {
                        CacheManager.updateStatus('simulation', false, 0);
                    }

                    let suffix = '';
                    if (blocked) suffix = ' - IP BLOCKED';
                    else if (alreadyBlocked) suffix = ' - Already Blocked';
                    else if (skipped) suffix = ' (Analysis Only)';

                    const toastType = blocked ? 'warning' : (alreadyBlocked ? 'warning' : 'success');
                    showToast(`${data.scenario_name} completed${suffix}`, toastType);
                } catch (renderError) {
                    showToast(`Rendering failed: ${renderError.message}`, 'error');
                }
            } else {
                if (loadingText) {
                    loadingText.textContent = 'Failed!';
                }
                showToast(`Failed: ${data.error}`, 'error');
            }
        }
    } catch (error) {
        console.error('[Demo] Error:', error);
        if (loadingText) {
            loadingText.textContent = 'Error!';
        }
        showToast('Failed to run scenario', 'error');
    } finally {
        // Hide loading overlay after a short delay
        setTimeout(() => {
            card.classList.remove('running');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }, 500);
    }
}

// Poll remote simulation status and show updates
async function pollRemoteSimStatus(runId, scenarioId, statusCallback) {
    let attempts = 0;
    const maxAttempts = 60; // Poll for up to 2 minutes
    let detectedOnce = false;

    const poll = async () => {
        if (attempts >= maxAttempts) {
            console.log('[LiveSim] Stopped polling after max attempts');
            showToast('Simulation polling stopped - check Firewall page for results', 'info');
            if (statusCallback) statusCallback({ completed: true, timeout: true });
            return;
        }

        attempts++;

        try {
            const response = await fetch(`/api/live-sim/live/${runId}/status`, { credentials: 'same-origin' });
            const data = await response.json();

            if (data.success) {
                // Show progress toasts and call callback
                if (data.events_detected > 0 && !detectedOnce) {
                    detectedOnce = true;
                    showToast(`üëÅÔ∏è Detected ${data.events_detected} events from agent`, 'info', 3000);
                    if (statusCallback) statusCallback({ detected: true, events: data.events_detected });
                }

                if (data.is_complete) {
                    let blockedBy = null;
                    let ip = data.source_ip;

                    if (data.fail2ban_block) {
                        blockedBy = 'fail2ban';
                        showToast('üö´ Fail2ban blocked the attacking IP!', 'success', 5000);
                    }
                    if (data.ip_block) {
                        blockedBy = blockedBy ? `${blockedBy} + SSH Guardian` : 'SSH Guardian';
                        showToast(`üîí SSH Guardian blocked IP (${data.ip_block.source})`, 'success', 5000);
                    }

                    if (statusCallback) {
                        statusCallback({
                            completed: true,
                            blocked: !!blockedBy,
                            blocked_by: blockedBy,
                            ip: ip,
                            fail2ban: data.fail2ban_block,
                            ufw: data.ip_block
                        });
                    }

                    if (!blockedBy) {
                        showToast('‚úÖ Simulation complete - IP not blocked (may need more events)', 'info', 4000);
                    }
                    return; // Stop polling
                }
            }
        } catch (error) {
            console.error('[LiveSim] Error polling status:', error);
        }

        // Continue polling every 2 seconds
        setTimeout(poll, 2000);
    };

    // Start polling after a short delay to let events propagate
    setTimeout(poll, 3000);
}

// Render Blocking Banner
function renderBlockingBanner(blocking) {
    if (!blocking) return '';

    // Case 1: Blocking was skipped (analysis-only mode)
    if (blocking.skipped) {
        return `
        <div class="card" style="padding: 16px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(0, 120, 212, 0.15), rgba(0, 120, 212, 0.05)); border: 2px solid var(--azure-blue); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--azure-blue); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;">
                    ‚ÑπÔ∏è
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 700; color: var(--azure-blue);">
                        ANALYSIS ONLY MODE
                    </h3>
                    <div style="font-size: 13px; color: var(--text-secondary);">
                        No blocking applied. Select an agent to enable auto-blocking.
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // Case 2: IP already blocked (blocking failed because duplicate)
    const isAlreadyBlocked = blocking.success === false &&
        blocking.message && blocking.message.toLowerCase().includes('already blocked');

    if (isAlreadyBlocked) {
        const blockId = blocking.block_id || 'N/A';
        return `
        <div class="card" style="padding: 20px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(230, 165, 2, 0.15), rgba(230, 165, 2, 0.05)); border: 2px solid #E6A502; border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 60px; height: 60px; border-radius: 50%; background: #E6A502; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0;">
                    ‚ö†Ô∏è
                </div>
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; color: #E6A502;">
                        IP ALREADY BLOCKED
                    </h3>
                    <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 8px;">
                        This IP is already in the block list. No duplicate block was created.
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                        <span style="padding: 4px 10px; background: rgba(230, 165, 2, 0.2); border-radius: 4px; font-weight: 600;">
                            üÜî Existing Block ID: #${blockId}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    // Case 3: Not blocked
    if (!blocking.blocked) return '';

    // Case 4: Successfully blocked (red banner)
    const rules = blocking.triggered_rules || [];
    const duration = blocking.adjusted_duration || blocking.base_duration || 0;
    const blockId = blocking.block_id || 'N/A';

    // Format duration
    let durationText = '';
    if (duration >= 10080) {
        durationText = `${Math.round(duration / 10080)} week(s)`;
    } else if (duration >= 1440) {
        durationText = `${Math.round(duration / 1440)} day(s)`;
    } else if (duration >= 60) {
        durationText = `${Math.round(duration / 60)} hour(s)`;
    } else {
        durationText = `${duration} minute(s)`;
    }

    return `
    <div class="card" style="padding: 20px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(209, 52, 56, 0.15), rgba(209, 52, 56, 0.05)); border: 2px solid #D13438; border-radius: 12px;">
        <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 60px; height: 60px; border-radius: 50%; background: #D13438; display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0;">
                üö´
            </div>
            <div style="flex: 1;">
                <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; color: #D13438;">
                    IP AUTO-BLOCKED
                </h3>
                <div style="font-size: 14px; color: var(--text-primary); margin-bottom: 8px;">
                    This IP was automatically blocked by the threat detection rules.
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px;">
                    <span style="padding: 4px 10px; background: rgba(209, 52, 56, 0.2); border-radius: 4px; font-weight: 600;">
                        ‚è±Ô∏è Duration: ${durationText}
                    </span>
                    <span style="padding: 4px 10px; background: rgba(209, 52, 56, 0.2); border-radius: 4px; font-weight: 600;">
                        üÜî Block ID: #${blockId}
                    </span>
                </div>
                ${rules.length > 0 ? `
                <div style="margin-top: 12px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">TRIGGERED RULES:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${rules.map(rule => `
                            <span style="padding: 4px 10px; background: #D13438; color: white; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ${rule}
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    </div>
    `;
}

// Populate Analysis Tab
function populateAnalysisTab(data) {
    console.log('[Analysis] Populating tab with data:', data);

    document.getElementById('analysis-empty-state').style.display = 'none';
    const content = document.getElementById('analysis-content');
    content.style.display = 'block';

    const composite = data.composite_risk || {};
    const behavioral = data.behavioral_analysis || {};
    const geo = data.geographic_intelligence || {};
    const ti = data.results?.threat_intel || {};
    const ml = data.results?.ml || {};
    const history = data.results?.history || {};
    const blocking = data.blocking || {};

    console.log('[Analysis] Composite:', composite);
    console.log('[Analysis] Behavioral:', behavioral);
    console.log('[Analysis] Geographic:', geo);
    console.log('[Analysis] Blocking:', blocking);

    try {
        const html = `
            ${renderBlockingBanner(blocking)}
            ${renderCompositeRisk(composite, data.ip, behavioral.pattern)}
            ${renderRiskBreakdown(composite.breakdown)}
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                ${renderThreatIntel(ti)}
                ${renderMLAnalysis(ml)}
                ${renderBehavioral(behavioral)}
                ${renderGeographic(geo, data.results?.geo)}
            </div>
            ${renderHistorical(history)}
        `;
        console.log('[Analysis] HTML generated, length:', html.length);
        content.innerHTML = html;
        console.log('[Analysis] Content updated successfully');
    } catch (err) {
        console.error('[Analysis] Error rendering HTML:', err);
        content.innerHTML = `<div class="card" style="padding: 20px; background: #fee; color: #c00;">Error rendering analysis: ${err.message}</div>`;
    }
}

// Copy to clipboard helper
function copyToClipboard(text, label) {
    navigator.clipboard.writeText(text).then(() => {
        showToast(`‚úÖ ${label} copied: ${text}`, 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showToast('‚ùå Copy failed', 'error');
    });
}

// Render Composite Risk
function renderCompositeRisk(composite, ip, pattern) {
    const score = composite.overall_score || 0;
    const level = composite.threat_level || 'UNKNOWN';
    const confidence = composite.confidence || 0;
    const colors = { CRITICAL: '#D13438', HIGH: '#E6A502', MODERATE: '#0078D4', LOW: '#2EA44F', CLEAN: '#2EA44F' };

    return `
    <div class="card" style="padding: 24px; margin-bottom: 24px; background: linear-gradient(135deg, var(--card-bg), var(--background));">
        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;"><span style="font-size: 20px;">üéØ</span> Overall Threat Assessment</h3>
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 24px; align-items: center;">
            <div style="width: 140px; height: 140px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 8px solid ${colors[level]}; background: var(--card-bg);">
                <div style="font-size: 42px; font-weight: 700;">${score.toFixed(1)}</div>
                <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">RISK SCORE</div>
            </div>
            <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <span style="padding: 6px 16px; border-radius: 6px; font-size: 14px; font-weight: 700; text-transform: uppercase; background: ${colors[level]}; color: white;">${level}</span>
                    <span
                        onclick="copyToClipboard('${ip}', 'IP Address')"
                        style="font-size: 16px; font-weight: 600; font-family: monospace; color: var(--azure-blue); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(0,120,212,0.1)'"
                        onmouseout="this.style.background='transparent'"
                        title="Click to copy IP address">
                        ${ip} üìã
                    </span>
                </div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Analysis Confidence: <strong>${confidence.toFixed(1)}%</strong></div>
                <div style="font-size: 13px; color: var(--text-secondary);">Pattern Detected: <strong>${pattern || 'Unknown'}</strong></div>
            </div>
        </div>
    </div>
    `;
}

// Render Risk Breakdown
function renderRiskBreakdown(breakdown) {
    if (!breakdown) return '';
    const components = [
        { key: 'threat_intel', label: 'Threat Intelligence', color: '#D13438' },
        { key: 'ml_prediction', label: 'ML Prediction', color: '#0078D4' },
        { key: 'behavioral', label: 'Behavioral Analysis', color: '#E6A502' },
        { key: 'geographic', label: 'Geographic Risk', color: '#2EA44F' }
    ];
    
    return `
    <div class="card" style="padding: 24px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;"><span style="font-size: 20px;">üìà</span> Multi-Factor Risk Breakdown</h3>
        ${components.map(c => {
            const comp = breakdown[c.key] || {};
            const score = comp.score || 0;
            const weighted = comp.weighted || 0;
            const weight = comp.weight || 0;
            return `
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                    <span><strong>${c.label}</strong> <span style="color: var(--text-secondary);">(√ó${weight})</span></span>
                    <span><strong>${score.toFixed(1)}</strong>/100 = <strong style="color: ${c.color};">${weighted.toFixed(1)}</strong> points</span>
                </div>
                <div style="height: 24px; background: var(--background); border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; width: ${score}%; background: linear-gradient(90deg, ${c.color}, ${c.color}aa); display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 12px; font-weight: 600; transition: width 0.5s;"></div>
                </div>
            </div>
            `;
        }).join('')}
    </div>
    `;
}

// Render sections (simplified for space)
function renderThreatIntel(ti) {
    return `<div class="card" style="padding: 20px; border-left: 4px solid #D13438;"><h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>üîç</span> Threat Intelligence</h4><div style="font-size: 13px;">AbuseIPDB: <strong>${ti.abuseipdb_score || 0}</strong>/100<br>VirusTotal: <strong>${ti.virustotal_positives || 0}</strong>/${ti.virustotal_total || 70} vendors<br>Threat Level: <strong>${(ti.threat_level || 'unknown').toUpperCase()}</strong></div></div>`;
}

function renderMLAnalysis(ml) {
    return `<div class="card" style="padding: 20px; border-left: 4px solid #0078D4;"><h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>ü§ñ</span> ML Analysis</h4><div style="font-size: 13px;">Risk Score: <strong>${ml.risk_score || 0}</strong>/100<br>Confidence: <strong>${ml.confidence ? (ml.confidence*100).toFixed(1) : 0}%</strong><br>Anomaly: <strong>${ml.is_anomaly ? 'YES' : 'NO'}</strong><br>Type: <strong>${ml.threat_type || 'Unknown'}</strong></div></div>`;
}

function renderBehavioral(b) {
    return `<div class="card" style="padding: 20px; border-left: 4px solid #E6A502;"><h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>‚ö°</span> Behavioral Analysis</h4><div style="font-size: 13px;">Pattern: <strong>${b.pattern || 'Unknown'}</strong><br>Velocity: <strong>${b.velocity || 0}</strong>/min<br>Failure Rate: <strong>${b.failure_rate || 0}%</strong><br>Indicators: <ul style="margin: 8px 0 0 0; padding-left: 20px;">${(b.indicators || []).map(i => `<li>${i}</li>`).join('')}</ul></div></div>`;
}

function renderGeographic(gi, geo) {
    const country = geo?.country || 'Unknown';
    const city = geo?.city || 'Unknown';
    const location = city !== 'Unknown' ? `${city}, ${country}` : country;

    return `<div class="card" style="padding: 20px; border-left: 4px solid #2EA44F;">
        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;"><span>üåç</span> Geographic Intelligence</h4>
        <div style="font-size: 13px;">
            Country: <strong
                onclick="copyToClipboard('${location}', 'Location')"
                style="cursor: pointer; padding: 2px 6px; border-radius: 3px; transition: background 0.2s;"
                onmouseover="this.style.background='rgba(46,164,79,0.1)'"
                onmouseout="this.style.background='transparent'"
                title="Click to copy location">
                ${country} üìã
            </strong><br>
            ${city !== 'Unknown' ? `City: <strong>${city}</strong><br>` : ''}
            Risk Score: <strong>${gi.score || 0}</strong>/100<br>
            High-Risk Region: <strong>${gi.is_high_risk_region ? 'YES' : 'NO'}</strong><br>
            Anonymized: <strong>${gi.is_anonymized ? 'YES' : 'NO'}</strong><br>
            Factors:
            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                ${(gi.factors || []).map(f => `<li>${f}</li>`).join('')}
            </ul>
        </div>
    </div>`;
}

function renderHistorical(h) {
    return `<div class="card" style="padding: 24px;"><h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;"><span>üìú</span> Historical Context</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;"><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Total Events</div><div style="font-size: 24px; font-weight: 700;">${h.total_events || 0}</div></div><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Failed Attempts</div><div style="font-size: 24px; font-weight: 700;">${h.failed_attempts || 0}</div></div><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Unique Usernames</div><div style="font-size: 24px; font-weight: 700;">${h.unique_usernames || 0}</div></div><div><div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Anomalies</div><div style="font-size: 24px; font-weight: 700;">${h.anomaly_count || 0}</div></div></div></div>`;
}

// Populate Results Tab
function populateResultsTab(data) {
    console.log('[Results] Populating tab with data:', data);

    document.getElementById('results-empty-state').style.display = 'none';
    const content = document.getElementById('results-content');
    content.style.display = 'block';

    const recs = data.results?.recommendations || [];
    console.log('[Results] Total recommendations:', recs.length);

    const immediate = recs.filter(r => r.urgency === 'immediate');
    const shortTerm = recs.filter(r => r.urgency === 'short_term');
    const longTerm = recs.filter(r => r.urgency === 'long_term');

    console.log('[Results] Grouped:', { immediate: immediate.length, shortTerm: shortTerm.length, longTerm: longTerm.length });

    try {
        const html = `
            ${renderQuickActions(recs.slice(0, 3))}
            ${immediate.length > 0 ? `<div style="margin-bottom: 24px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"><span style="font-size: 24px;">üö®</span><h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #D13438;">Immediate Actions (Next 5 Minutes)</h3></div>${immediate.map(renderRecommendation).join('')}</div>` : ''}
            ${shortTerm.length > 0 ? `<div style="margin-bottom: 24px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"><span style="font-size: 24px;">üìÖ</span><h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #E6A502;">Short-Term Actions (Next Hour)</h3></div>${shortTerm.map(renderRecommendation).join('')}</div>` : ''}
            ${longTerm.length > 0 ? `<div style="margin-bottom: 24px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;"><span style="font-size: 24px;">üõ°Ô∏è</span><h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #0078D4;">Long-Term Hardening (This Week)</h3></div>${longTerm.map(renderRecommendation).join('')}</div>` : ''}
        `;
        console.log('[Results] HTML generated, length:', html.length);
        content.innerHTML = html;
        console.log('[Results] Content updated successfully');
    } catch (err) {
        console.error('[Results] Error rendering HTML:', err);
        content.innerHTML = `<div class="card" style="padding: 20px; background: #fee; color: #c00;">Error rendering results: ${err.message}</div>`;
    }
}

// Render Quick Actions
function renderQuickActions(topRecs) {
    if (!topRecs || topRecs.length === 0) return '';

    const priorityColors = {
        'critical': '#D13438',
        'high': '#E6A502',
        'medium': '#0078D4',
        'low': '#2EA44F'
    };

    return `
    <div class="card" style="padding: 24px; margin-bottom: 24px; background: linear-gradient(135deg, rgba(0, 120, 212, 0.05), rgba(230, 165, 2, 0.05)); border: 2px solid #E6A502;">
        <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">
            <span>‚ö°</span> Quick Actions
        </h3>
        <p style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-secondary);">
            Most critical recommendations - displayed as cards below
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;">
            ${topRecs.map(r => {
                const color = priorityColors[r.priority] || '#0078D4';
                const confidence = r.confidence ? (r.confidence * 100).toFixed(0) : r.ai_confidence ? (r.ai_confidence * 100).toFixed(0) : 0;
                return `
                <div style="padding: 16px; background: var(--card-bg); border-left: 4px solid ${color}; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px; color: ${color};">
                        ${r.icon || 'üîπ'} ${r.action}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                        ${confidence}% confidence ¬∑ ${r.urgency || 'N/A'} priority
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary); font-style: italic;">
                        See full details in recommendations below
                    </div>
                </div>
                `;
            }).join('')}
        </div>
    </div>`;
}

// Render Recommendation
function renderRecommendation(rec) {
    const confidence = rec.confidence ? (rec.confidence * 100).toFixed(0) : rec.ai_confidence ? (rec.ai_confidence * 100).toFixed(0) : 0;
    return `
    <div class="recommendation-card ${rec.priority}">
        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
            <h4 style="margin: 0; font-size: 16px; font-weight: 600;">${rec.icon || 'üîπ'} ${rec.action}</h4>
            <span style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">${confidence}% confidence</span>
        </div>
        <div style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">${rec.reason}</div>
        ${rec.why && rec.why.length > 0 ? `<div style="margin-bottom: 12px;"><strong style="font-size: 13px;">Why:</strong><ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 13px;">${rec.why.map(w => `<li>${w}</li>`).join('')}</ul></div>` : ''}
        ${rec.impact ? `<div style="margin-bottom: 12px; font-size: 13px;"><strong>Impact:</strong> ${rec.impact}</div>` : ''}
        ${rec.risk_if_ignored ? `<div style="padding: 8px 12px; background: rgba(209, 52, 56, 0.1); border-left: 3px solid #D13438; margin-bottom: 12px; font-size: 13px;"><strong>Risk if Ignored:</strong> ${rec.risk_if_ignored}</div>` : ''}
        ${rec.alternatives && rec.alternatives.length > 0 ? `<div style="margin-bottom: 12px;"><strong style="font-size: 13px;">Alternatives:</strong>${rec.alternatives.map(alt => `<div style="padding: 6px; background: var(--background); border-radius: 4px; margin-top: 4px; font-size: 12px;"><strong>${alt.action}:</strong> ${alt.impact}</div>`).join('')}</div>` : ''}
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            ${getActionButton(rec)}
        </div>
    </div>
    `;
}

// Get Action Button
function getActionButton(rec) {
    const type = rec.action_type;
    const data = rec.action_data;
    if (type === 'block_ip') return `<button onclick="blockIPWithModal('${data.ip}')" style="padding: 8px 16px; background: #D13438; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üö´ Block IP</button>`;
    if (type === 'add_blocklist') return `<button onclick="blockIPWithModal('${data.ip}')" style="padding: 8px 16px; background: #E6A502; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üìã Add to Blocklist</button>`;
    if (type === 'view_events') return `<button onclick="window.location.href='/dashboard?page=events-live'" style="padding: 8px 16px; background: #0078D4; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">üëÅÔ∏è View Events</button>`;
    return `<button style="padding: 8px 16px; background: var(--background); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px; cursor: pointer;">‚ÑπÔ∏è Learn More</button>`;
}

// Execute Action
function executeAction(actionType, actionData) {
    console.log('[Action]', actionType, actionData);
    if (actionType === 'block_ip') blockIPInline(actionData.ip);
    else if (actionType === 'add_blocklist') window.location.href = '/dashboard?page=firewall';
    else if (actionType === 'view_events') window.location.href = '/dashboard?page=events-live';
}

// Block IP with Modal Confirmation
async function blockIPWithModal(ip) {
    console.log('[Block] Checking IP status:', ip);

    // Create modal overlay
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';

    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background: var(--card-bg); border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);';

    // Show loading state
    modalContent.innerHTML = `
        <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">üîç Checking IP Status...</h3>
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 48px;">‚è≥</div>
            <p style="margin: 16px 0 0 0; color: var(--text-secondary);">Checking if ${ip} is already blocked on any agent...</p>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    try {
        // Check global block status
        const globalResponse = await fetch(`/api/dashboard/blocking/blocks/check/${ip}`, { credentials: 'same-origin' });
        const globalStatus = await globalResponse.json();

        // Get all agents
        const agentsResponse = await fetch('/api/agents/list', { credentials: 'same-origin' });
        const agentsData = await agentsResponse.json();
        const agents = agentsData.agents || [];

        // Check each agent
        const agentChecks = await Promise.all(
            agents.map(async (agent) => {
                try {
                    const resp = await fetch(`/api/agents/${agent.id}/blocked-ips`, { credentials: 'same-origin' });
                    const data = await resp.json();
                    const isBlocked = data.blocked_ips?.some(blocked => blocked.ip_address === ip);
                    return { agent: agent.hostname, id: agent.id, blocked: isBlocked };
                } catch (err) {
                    console.error(`[Block] Error checking agent ${agent.hostname}:`, err);
                    return { agent: agent.hostname, id: agent.id, blocked: false, error: true };
                }
            })
        );

        const blockedOnAgents = agentChecks.filter(a => a.blocked);
        const isAlreadyBlocked = globalStatus.is_blocked || blockedOnAgents.length > 0;

        // Update modal with results
        modalContent.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">
                ${isAlreadyBlocked ? '‚ö†Ô∏è' : 'üö´'} Block IP Address
            </h3>
            <div style="background: var(--background); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-family: monospace; font-size: 18px; font-weight: 600; color: var(--azure-blue);">${ip}</div>
            </div>

            ${isAlreadyBlocked ? `
                <div style="background: rgba(230, 165, 2, 0.1); border-left: 4px solid #E6A502; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                    <strong style="color: #E6A502;">‚ö†Ô∏è Already Blocked</strong>
                    <p style="margin: 8px 0 0 0; font-size: 14px;">This IP is already blocked on the following:</p>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 13px;">
                        ${globalStatus.is_blocked ? `<li><strong>Global Blocklist</strong> (${globalStatus.reason || 'No reason specified'})</li>` : ''}
                        ${blockedOnAgents.map(a => `<li><strong>Agent:</strong> ${a.agent}</li>`).join('')}
                    </ul>
                </div>
            ` : `
                <div style="background: rgba(209, 52, 56, 0.1); border-left: 4px solid #D13438; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                    <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è Warning:</strong> This will block the IP address on all SSH Guardian agents.</p>
                </div>
            `}

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Block Reason:</label>
                <input id="block-reason" type="text" value="Threat detected via simulation analysis" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: var(--background); color: var(--text-primary);">
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Block Duration:</label>
                <select id="block-duration" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: var(--background); color: var(--text-primary);">
                    <option value="permanent">Permanent</option>
                    <option value="24h">24 Hours</option>
                    <option value="7d">7 Days</option>
                    <option value="30d">30 Days</option>
                </select>
            </div>

            <div style="margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">
                <strong>Status Check Results:</strong>
                <div style="margin-top: 8px;">
                    <div>‚úì Checked ${agents.length} agent(s)</div>
                    <div>‚úì Global blocklist status: ${globalStatus.is_blocked ? 'Blocked' : 'Not blocked'}</div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 10px 20px; background: var(--background); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    Cancel
                </button>
                ${!isAlreadyBlocked ? `
                <button onclick="executeIPBlock('${ip}')" style="padding: 10px 20px; background: #D13438; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üö´ Block IP
                </button>
                ` : ''}
            </div>
        `;

    } catch (error) {
        console.error('[Block] Error checking status:', error);
        modalContent.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">‚ùå Error</h3>
            <p style="margin: 0 0 16px 0;">Failed to check IP status: ${error.message}</p>
            <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 10px 20px; background: var(--background); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-weight: 600;">
                Close
            </button>
        `;
    }
}

// Execute IP Block
async function executeIPBlock(ip) {
    const reason = document.getElementById('block-reason').value;
    const duration = document.getElementById('block-duration').value;
    const modal = document.querySelector('[style*="position: fixed"]');

    console.log('[Block] Executing block:', { ip, reason, duration });

    try {
        const response = await fetch('/api/dashboard/blocking/blocks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                ip_address: ip,
                reason: reason,
                duration: duration
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast(`‚úÖ IP ${ip} blocked successfully`, 'success');
            modal.remove();
        } else {
            showToast(`‚ùå Failed to block IP: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('[Block] Error:', error);
        showToast('‚ùå Failed to block IP', 'error');
    }
}

// Legacy function for backward compatibility
async function blockIPInline(ip) {
    blockIPWithModal(ip);
}

// Toast notification
function showToast(message, type, duration = 3000) {
    const toast = document.createElement('div');
    toast.textContent = message;
    const colors = {
        success: '#2EA44F',
        error: '#D13438',
        warning: '#E6A502',
        info: '#0078D4'
    };
    const bgColor = colors[type] || colors.info;
    toast.style.cssText = `position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: ${bgColor}; color: white; border-radius: 6px; font-weight: 600; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), duration);
}

// Track if page has been initialized
let isSimulationPageInitialized = false;

// Auto-initialize when page becomes visible
function initializeSimulationPageIfVisible() {
    const pageEl = document.getElementById('page-simulation');
    if (!pageEl) return;

    const isVisible = pageEl.style.display !== 'none' && pageEl.classList.contains('active');

    if (isVisible && !isSimulationPageInitialized) {
        console.log('[Simulation] Page became visible, loading data...');
        isSimulationPageInitialized = true;
        loadSimulationPage();
    }
}

// Set up MutationObserver to watch for page visibility changes
function setupPageVisibilityWatcher() {
    const pageEl = document.getElementById('page-simulation');
    if (!pageEl) {
        console.log('[Simulation] Page element not found, retrying...');
        setTimeout(setupPageVisibilityWatcher, 100);
        return;
    }

    console.log('[Simulation] Setting up visibility watcher...');

    // Check immediately
    initializeSimulationPageIfVisible();

    // Watch for attribute changes (style, class)
    const observer = new MutationObserver(() => {
        initializeSimulationPageIfVisible();
    });

    observer.observe(pageEl, {
        attributes: true,
        attributeFilter: ['style', 'class']
    });
}

// Initialize based on document ready state
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupPageVisibilityWatcher);
} else {
    setupPageVisibilityWatcher();
}

// ========================
// TARGET SERVER MANAGEMENT
// ========================

let targetManagementModal = null;

// Open Target Management Modal - Shows all agents with simulation status
function showAddTargetModal() {
    // Remove existing modal if any
    if (targetManagementModal) {
        targetManagementModal.remove();
    }

    targetManagementModal = document.createElement('div');
    targetManagementModal.id = 'target-management-modal';
    targetManagementModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';

    targetManagementModal.innerHTML = `
        <div style="background: var(--surface); border-radius: 8px; max-width: 700px; width: 95%; max-height: 85vh; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex; flex-direction: column;">
            <!-- Header -->
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--surface);">
                <div>
                    <h3 style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">
                        Simulation Targets
                    </h3>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Enable simulation on registered agents</p>
                </div>
                <button onclick="closeTargetModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); padding: 4px; line-height: 1;">√ó</button>
            </div>

            <!-- Content Area -->
            <div id="target-modal-content" style="flex: 1; overflow-y: auto; padding: 16px; background: var(--surface);">
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <div class="scenario-spinner" style="margin: 0 auto 12px;"></div>
                    <div style="font-size: 13px;">Loading agents...</div>
                </div>
            </div>
        </div>
    `;

    // Close on backdrop click
    targetManagementModal.addEventListener('click', (e) => {
        if (e.target === targetManagementModal) {
            closeTargetModal();
        }
    });

    document.body.appendChild(targetManagementModal);
    loadAgentsForSimulation();
}

function closeTargetModal() {
    if (targetManagementModal) {
        targetManagementModal.remove();
        targetManagementModal = null;
    }
    loadScenarioTargets(); // Refresh dropdown
}

// Load agents with their simulation status
async function loadAgentsForSimulation() {
    const container = document.getElementById('target-modal-content');

    try {
        const response = await fetch('/api/live-sim/targets/from-agents', { credentials: 'same-origin' });
        const data = await response.json();

        if (!data.success) {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: #D13438; font-size: 13px;">Error: ${data.error}</div>`;
            return;
        }

        if (data.agents.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 48px 20px;">
                    <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.6;">üì°</div>
                    <h4 style="margin: 0 0 6px 0; font-size: 15px; font-weight: 600; color: var(--text-primary);">No Agents Registered</h4>
                    <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Register an SSH Guardian agent first to enable simulation targets.</p>
                </div>
            `;
            return;
        }

        const enabledCount = data.agents.filter(a => a.sim_enabled).length;

        container.innerHTML = `
            <div style="margin-bottom: 12px; font-size: 12px; color: var(--text-hint);">
                ${enabledCount} of ${data.agents.length} agent(s) enabled for simulation
            </div>
            <div id="agents-list-container">
                ${data.agents.map(a => renderAgentCard(a)).join('')}
            </div>
        `;
    } catch (error) {
        container.innerHTML = `<div style="text-align: center; padding: 40px; color: #D13438; font-size: 13px;">Failed to load agents: ${error.message}</div>`;
    }
}

// Render a single agent card with simulation status
function renderAgentCard(agent) {
    const name = agent.display_name || agent.hostname;
    const statusColor = agent.agent_status === 'online' ? '#2EA44F' : agent.agent_status === 'offline' ? '#D13438' : 'var(--text-hint)';
    const statusIcon = agent.agent_status === 'online' ? '‚óè' : '‚óã';
    const isLocal = agent.is_local;

    // Simulation status
    const simEnabled = agent.sim_enabled;
    const simStatusColor = agent.test_status === 'success' ? '#2EA44F' : agent.test_status === 'failed' ? '#D13438' : 'var(--text-hint)';
    const simStatusText = agent.test_status === 'success' ? 'Ready' : agent.test_status === 'failed' ? 'Failed' : 'Not Tested';

    // Local badge
    const localBadge = isLocal ? `<span style="padding: 2px 6px; border-radius: 2px; font-size: 10px; font-weight: 600; background: #0078D415; color: #0078D4;">LOCAL</span>` : '';

    if (simEnabled) {
        // For local targets, show simplified info (no port/key needed)
        const connectionInfo = isLocal
            ? `<span style="color: var(--text-secondary);">Direct write to auth.log</span>`
            : `${escapeHtml(agent.ip_address_primary || 'N/A')}:${agent.sim_port || 5001}`;

        // For local targets, hide Config and Key buttons
        const buttons = isLocal
            ? `
                <button onclick="testAgentSimulation(${agent.agent_id})" title="Test Write Access" style="padding: 6px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 2px; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                    Test
                </button>
                <button onclick="disableAgentSimulation(${agent.agent_id}, '${escapeHtml(name)}')" title="Disable Simulation" style="padding: 6px 10px; background: var(--surface); border: 1px solid #D13438; border-radius: 2px; cursor: pointer; font-size: 12px; color: #D13438;">
                    Disable
                </button>
            `
            : `
                <button onclick="testAgentSimulation(${agent.agent_id})" title="Test Connection" style="padding: 6px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 2px; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                    Test
                </button>
                <button onclick="showAgentSimConfig(${agent.agent_id}, '${escapeHtml(name)}', ${agent.sim_port || 5001})" title="Configure" style="padding: 6px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 2px; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                    Config
                </button>
                <button onclick="showAgentApiKey(${agent.agent_id}, '${escapeHtml(name)}', '${agent.api_key}')" title="View API Key" style="padding: 6px 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 2px; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                    Key
                </button>
                <button onclick="disableAgentSimulation(${agent.agent_id}, '${escapeHtml(name)}')" title="Disable Simulation" style="padding: 6px 10px; background: var(--surface); border: 1px solid #D13438; border-radius: 2px; cursor: pointer; font-size: 12px; color: #D13438;">
                    Disable
                </button>
            `;

        return `
            <div class="agent-card" style="padding: 14px 16px; background: var(--background); border-radius: 4px; border: 1px solid var(--border); margin-bottom: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                            <span style="color: ${statusColor}; font-size: 10px;">${statusIcon}</span>
                            <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${escapeHtml(name)}</span>
                            ${localBadge}
                            <span style="padding: 2px 6px; border-radius: 2px; font-size: 10px; font-weight: 600; background: #2EA44F15; color: #2EA44F;">
                                SIM ENABLED
                            </span>
                            <span style="padding: 2px 6px; border-radius: 2px; font-size: 10px; font-weight: 500; background: ${simStatusColor}15; color: ${simStatusColor};">
                                ${simStatusText}
                            </span>
                        </div>
                        <div style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; color: var(--azure-blue); margin-bottom: 4px;">
                            ${connectionInfo}
                        </div>
                        <div style="font-size: 11px; color: var(--text-hint);">
                            ${agent.last_tested_at ? `Last tested: ${new Date(agent.last_tested_at).toLocaleString()}` : 'Never tested'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 4px; flex-shrink: 0;">
                        ${buttons}
                    </div>
                </div>
            </div>
        `;
    } else {
        return `
            <div class="agent-card" style="padding: 14px 16px; background: var(--background); border-radius: 4px; border: 1px solid var(--border); margin-bottom: 8px; opacity: 0.8;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                            <span style="color: ${statusColor}; font-size: 10px;">${statusIcon}</span>
                            <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${escapeHtml(name)}</span>
                            ${localBadge}
                            <span style="padding: 2px 6px; border-radius: 2px; font-size: 10px; font-weight: 500; background: var(--background); color: var(--text-hint); border: 1px solid var(--border);">
                                Not Configured
                            </span>
                        </div>
                        <div style="font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; color: var(--text-secondary);">
                            ${isLocal ? 'Local machine (direct write)' : escapeHtml(agent.ip_address_primary || 'No IP')}
                        </div>
                    </div>
                    <button onclick="enableAgentSimulation(${agent.agent_id}, '${escapeHtml(name)}', '${escapeHtml(agent.ip_address_primary || '')}', ${isLocal})" style="padding: 8px 14px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">
                        Enable Simulation
                    </button>
                </div>
            </div>
        `;
    }
}

// Enable simulation for an agent
async function enableAgentSimulation(agentId, name, ip, isLocal = false) {
    if (isLocal) {
        // LOCAL AGENT: No port/API key needed, just confirm
        const dialog = document.createElement('div');
        dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001;';

        dialog.innerHTML = `
            <div style="background: var(--surface); border-radius: 4px; padding: 20px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; color: var(--text-primary);">Enable Local Simulation</h3>
                <p style="margin: 0 0 16px 0; font-size: 12px; color: var(--text-secondary);">${escapeHtml(name)}</p>

                <div style="padding: 12px; background: #0078D410; border: 1px solid #0078D4; border-radius: 4px; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 13px; color: #0078D4; margin-bottom: 4px;">Local Agent Detected</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        This agent is on the same machine as the dashboard. Simulation will write directly to <code>/var/log/auth.log</code> without needing a separate receiver or API key.
                    </div>
                </div>

                <div id="enable-sim-error" style="display: none; padding: 10px 12px; background: rgba(209,52,56,0.08); border: 1px solid #D13438; border-radius: 4px; color: #D13438; margin-bottom: 14px; font-size: 12px;"></div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 8px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--text-primary);">
                        Cancel
                    </button>
                    <button id="enable-sim-btn" onclick="confirmEnableLocalSimulation(${agentId}, '${escapeHtml(name)}', '${escapeHtml(ip)}', this)" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        Enable Local Simulation
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);
        return;
    }

    // REMOTE AGENT: Show port configuration dialog
    const dialog = document.createElement('div');
    dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001;';

    dialog.innerHTML = `
        <div style="background: var(--surface); border-radius: 4px; padding: 20px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; color: var(--text-primary);">Enable Remote Simulation</h3>
            <p style="margin: 0 0 16px 0; font-size: 12px; color: var(--text-secondary);">Configure simulation receiver for "${escapeHtml(name)}"</p>

            <div id="enable-sim-error" style="display: none; padding: 10px 12px; background: rgba(209,52,56,0.08); border: 1px solid #D13438; border-radius: 4px; color: #D13438; margin-bottom: 14px; font-size: 12px;"></div>

            <div style="margin-bottom: 14px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--text-secondary);">IP Address *</label>
                <input id="enable-sim-ip" type="text" value="${escapeHtml(ip)}" placeholder="e.g., 192.168.1.100"
                    style="width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface); color: var(--text-primary); box-sizing: border-box;">
                <div style="font-size: 11px; color: var(--text-hint); margin-top: 4px;">Change if different from agent's registered IP</div>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Receiver Port *</label>
                <input id="enable-sim-port" type="number" value="5001" placeholder="5001"
                    style="width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface); color: var(--text-primary); box-sizing: border-box;">
                <div style="font-size: 11px; color: var(--text-hint); margin-top: 4px;">Port where simulation receiver will listen</div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 8px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--text-primary);">
                    Cancel
                </button>
                <button id="enable-sim-btn" onclick="confirmEnableSimulation(${agentId}, '${escapeHtml(name)}', this)" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">
                    Enable & Generate Key
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(dialog);
}

// Enable local simulation (no port/API key needed)
async function confirmEnableLocalSimulation(agentId, name, ip, btn) {
    btn.disabled = true;
    btn.textContent = 'Enabling...';
    const errorEl = document.getElementById('enable-sim-error');

    try {
        const response = await fetch(`/api/live-sim/targets/enable-agent/${agentId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ ip_address: ip, port: 0 })  // port 0 indicates local
        });

        const data = await response.json();

        if (data.success) {
            btn.closest('[style*=fixed]').remove();
            showToast(`Local simulation enabled for ${name}`, 'success');
            loadAgentsForSimulation();
        } else {
            errorEl.textContent = data.error || 'Failed to enable simulation';
            errorEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Enable Local Simulation';
        }
    } catch (error) {
        errorEl.textContent = 'Network error';
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Enable Local Simulation';
    }
}

async function confirmEnableSimulation(agentId, name, btn) {
    const ip = document.getElementById('enable-sim-ip').value.trim();
    const port = parseInt(document.getElementById('enable-sim-port').value) || 5001;
    const errorEl = document.getElementById('enable-sim-error');

    // Validate IP
    if (!ip) {
        errorEl.textContent = 'IP address is required';
        errorEl.style.display = 'block';
        return;
    }

    const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipRegex.test(ip)) {
        errorEl.textContent = 'Invalid IP address format';
        errorEl.style.display = 'block';
        return;
    }

    if (port < 1 || port > 65535) {
        errorEl.textContent = 'Port must be between 1 and 65535';
        errorEl.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Enabling...';
    errorEl.style.display = 'none';

    try {
        const response = await fetch(`/api/live-sim/targets/enable-agent/${agentId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ ip_address: ip, port: port })
        });

        const data = await response.json();

        if (data.success) {
            // Close enable dialog
            btn.closest('[style*=fixed]').remove();
            // Show API key dialog
            showNewApiKeyDialog(name, data.api_key, data.ip_address, data.port);
            // Refresh agent list
            loadAgentsForSimulation();
        } else {
            errorEl.textContent = data.error;
            errorEl.style.display = 'block';
        }
    } catch (error) {
        errorEl.textContent = 'Failed to enable simulation: ' + error.message;
        errorEl.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Enable & Generate Key';
    }
}

// Disable simulation for an agent
async function disableAgentSimulation(agentId, name) {
    if (!confirm(`Disable simulation for "${name}"?\n\nThis will remove the simulation target and invalidate the API key.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/live-sim/targets/disable-agent/${agentId}`, {
            method: 'POST',
            credentials: 'same-origin'
        });

        const data = await response.json();

        if (data.success) {
            showToast('Simulation disabled', 'success');
            loadAgentsForSimulation();
        } else {
            showToast(`Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Failed to disable simulation', 'error');
    }
}

// Test agent simulation connection (tests both health AND API key)
async function testAgentSimulation(agentId) {
    showToast('Testing connection and API key...', 'info');

    try {
        // Use the dedicated test-agent endpoint
        const response = await fetch(`/api/live-sim/targets/test-agent/${agentId}`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();

        if (data.success) {
            showToast(`${data.target_name}: Connection and API key verified!`, 'success');
        } else {
            // Show detailed error message
            let errorMsg = data.message || 'Unknown error';
            if (data.api_key_valid === false && data.health_data) {
                // Server is reachable but API key is wrong
                errorMsg = `API key mismatch: ${errorMsg}`;
            }
            showToast(`Test failed: ${errorMsg}`, 'error');
        }

        loadAgentsForSimulation(); // Refresh to show updated status
    } catch (error) {
        showToast('Failed to test connection', 'error');
    }
}

// Show agent simulation configuration
function showAgentSimConfig(agentId, name, currentPort) {
    const dialog = document.createElement('div');
    dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001;';

    dialog.innerHTML = `
        <div style="background: var(--surface); border-radius: 4px; padding: 20px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; color: var(--text-primary);">Configure Simulation</h3>
            <p style="margin: 0 0 16px 0; font-size: 12px; color: var(--text-secondary);">${escapeHtml(name)}</p>

            <div id="config-sim-error" style="display: none; padding: 10px 12px; background: rgba(209,52,56,0.08); border: 1px solid #D13438; border-radius: 4px; color: #D13438; margin-bottom: 14px; font-size: 12px;"></div>

            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px; color: var(--text-secondary);">Receiver Port</label>
                <input id="config-sim-port" type="number" value="${currentPort}" placeholder="5001"
                    style="width: 100%; padding: 9px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface); color: var(--text-primary); box-sizing: border-box;">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 8px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--text-primary);">
                    Cancel
                </button>
                <button id="config-sim-btn" onclick="saveAgentSimConfig(${agentId}, this)" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">
                    Save
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(dialog);
}

async function saveAgentSimConfig(agentId, btn) {
    const port = parseInt(document.getElementById('config-sim-port').value) || 5001;
    const errorEl = document.getElementById('config-sim-error');

    if (port < 1 || port > 65535) {
        errorEl.textContent = 'Port must be between 1 and 65535';
        errorEl.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Saving...';
    errorEl.style.display = 'none';

    try {
        const response = await fetch(`/api/live-sim/targets/update-agent/${agentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ port })
        });

        const data = await response.json();

        if (data.success) {
            btn.closest('[style*=fixed]').remove();
            showToast('Configuration saved', 'success');
            loadAgentsForSimulation();
        } else {
            errorEl.textContent = data.error;
            errorEl.style.display = 'block';
        }
    } catch (error) {
        errorEl.textContent = 'Failed to save: ' + error.message;
        errorEl.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save';
    }
}

// Show API key for agent
function showAgentApiKey(agentId, name, apiKey) {
    const dialog = document.createElement('div');
    dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001;';

    dialog.innerHTML = `
        <div style="background: var(--surface); border-radius: 4px; padding: 20px; max-width: 480px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-primary);">API Key - ${escapeHtml(name)}</h3>
                <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-secondary); padding: 0;">√ó</button>
            </div>

            <div style="background: var(--background); border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                <div style="display: flex; gap: 6px;">
                    <input type="text" value="${apiKey}" readonly
                        style="flex: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; background: var(--surface); color: var(--text-primary);">
                    <button onclick="copyApiKeyFromInput(this)" style="padding: 8px 12px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">
                        Copy
                    </button>
                </div>
            </div>

            <div style="display: flex; gap: 8px;">
                <button onclick="this.closest('[style*=fixed]').remove()" style="flex: 1; padding: 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; color: var(--text-primary);">
                    Close
                </button>
                <button onclick="regenerateAgentApiKey(${agentId}, '${escapeHtml(name)}', this)" style="flex: 1; padding: 8px; background: rgba(230,165,2,0.08); border: 1px solid #E6A502; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; color: #E6A502;">
                    Regenerate Key
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(dialog);
}

// Regenerate API key for agent
async function regenerateAgentApiKey(agentId, name, btn) {
    if (!confirm(`Regenerate API key for "${name}"?\n\nThe old key will stop working immediately.`)) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Regenerating...';

    try {
        const response = await fetch(`/api/live-sim/targets/regenerate-key-agent/${agentId}`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();

        if (data.success) {
            btn.closest('[style*=fixed]').remove();
            showNewApiKeyDialog(name + ' (regenerated)', data.api_key);
            loadAgentsForSimulation();
        } else {
            showToast(`Error: ${data.error}`, 'error');
        }
    } catch (error) {
        showToast('Failed to regenerate key', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Regenerate Key';
    }
}

// Show API key dialog for new target (with optional connection info)
function showNewApiKeyDialog(name, apiKey, ip = null, port = null) {
    const dialog = document.createElement('div');
    dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001;';

    const connectionInfo = ip ? `
        <div style="background: var(--background); border-radius: 4px; padding: 10px 12px; margin-bottom: 12px; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; color: var(--azure-blue);">
            ${escapeHtml(ip)}:${port || 5001}
        </div>
    ` : '';

    dialog.innerHTML = `
        <div style="background: var(--surface); border-radius: 4px; padding: 20px; max-width: 480px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="text-align: center; margin-bottom: 16px;">
                <div style="font-size: 36px; margin-bottom: 8px;">üîë</div>
                <h3 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600; color: #2EA44F;">Simulation Enabled!</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">"${escapeHtml(name)}" is ready for simulation.</p>
            </div>

            ${connectionInfo}

            <div style="background: var(--background); border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 11px; color: var(--text-hint);">API KEY (save this securely)</label>
                <div style="display: flex; gap: 6px;">
                    <input id="new-api-key-input" type="text" value="${apiKey}" readonly
                        style="flex: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; background: var(--surface); color: var(--text-primary);">
                    <button onclick="copyApiKeyFromInput(this)" style="padding: 8px 12px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">
                        Copy
                    </button>
                </div>
            </div>

            <div style="background: rgba(230,165,2,0.08); border: 1px solid #E6A502; border-radius: 4px; padding: 10px; margin-bottom: 16px;">
                <div style="font-weight: 600; font-size: 12px; color: #E6A502; margin-bottom: 2px;">Important</div>
                <div style="font-size: 11px; color: var(--text-primary);">
                    Save this API key securely. Use it when installing the simulation receiver on the target server.
                </div>
            </div>

            <button onclick="this.closest('[style*=fixed]').remove(); showToast('Simulation enabled', 'success');" style="width: 100%; padding: 10px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">
                Got it, I've saved the key
            </button>
        </div>
    `;

    document.body.appendChild(dialog);
}

// Copy API key to clipboard
function copyApiKey(apiKey) {
    // Handle both direct calls and event-based calls
    const textToCopy = apiKey || '';

    if (!textToCopy) {
        showToast('No API key to copy', 'error');
        return;
    }

    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            showToast('API key copied to clipboard', 'success');
        }).catch((err) => {
            console.error('Clipboard API failed:', err);
            fallbackCopy(textToCopy);
        });
    } else {
        fallbackCopy(textToCopy);
    }
}

// Fallback copy method for older browsers or when clipboard API fails
function fallbackCopy(text) {
    try {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.style.top = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);

        if (successful) {
            showToast('API key copied to clipboard', 'success');
        } else {
            showToast('Failed to copy - please copy manually', 'error');
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showToast('Failed to copy - please copy manually', 'error');
    }
}

// Copy from input field next to button
function copyApiKeyFromInput(btn) {
    const input = btn.parentElement.querySelector('input');
    if (input && input.value) {
        copyApiKey(input.value);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</div>
