<!-- SSH Guardian v3.0 - Live Events Page (Unified Design) -->
<div id="page-events-live" class="page-content" style="display: none;">
    <div class="ev-header">
        <div>
            <h1>SSH Auth Events</h1>
            <p>Monitor SSH login attempts across all agents</p>
        </div>
        <button class="refresh-btn" onclick="EV.refresh()">
            <span class="refresh-icon">‚Üª</span> Refresh
        </button>
    </div>

    <!-- SSH Logins Content -->
    <div id="ev-ssh" class="ev-content active" style="display:block">
        <div class="ev-filters">
            <select id="sshType"><option value="">All Types</option><option value="failed">Failed</option><option value="successful">Successful</option></select>
            <select id="sshAgent"><option value="">All Agents</option></select>
            <select id="sshTime"><option value="1h">Last Hour</option><option value="6h">6 Hours</option><option value="24h">24 Hours</option><option value="7d">7 Days</option><option value="30d" selected>30 Days</option></select>
            <button class="ev-apply" onclick="EV.loadSSH(1)">Apply</button>
        </div>
        <div class="ev-card">
            <div id="sshLoad" class="ev-msg">Loading...</div>
            <div id="sshNone" class="ev-msg" style="display:none">No events found</div>
            <div id="sshErr" class="ev-msg err" style="display:none">Failed to load</div>
            <div class="ev-tbl-wrap">
                <table id="sshTbl" class="ev-tbl" style="display:none">
                    <thead><tr><th>Last Activity</th><th>IP Address</th><th>Location</th><th>Attempts</th><th>Users</th><th>Risk</th><th>Actions</th></tr></thead>
                    <tbody id="sshBody"></tbody>
                </table>
            </div>
        </div>
        <div id="sshPg" class="ev-pg" style="display:none">
            <span id="sshInfo"></span>
            <div><button onclick="EV.loadSSH(EV.sshPg-1)">‚Üê Prev</button><button onclick="EV.loadSSH(EV.sshPg+1)">Next ‚Üí</button></div>
        </div>
    </div>
</div>

<!-- Shared Modal for SSH Events -->
<div id="evModal" class="ev-modal" style="display:none" onclick="if(event.target===this)EV.closeModal()">
    <div class="ev-modal-box" onclick="event.stopPropagation()">
        <div class="ev-modal-hdr">
            <div>
                <h2 id="modalTitle">IP Details</h2>
                <span id="modalAgent"></span>
            </div>
            <button onclick="EV.closeModal()">√ó</button>
        </div>
        <div class="ev-modal-tabs">
            <button class="active" onclick="EV.modalTab('analysis')">Analysis</button>
            <button onclick="EV.modalTab('history')">History</button>
        </div>
        <div class="ev-modal-body">
            <div id="mAnalysis" class="ev-modal-pane active"></div>
            <div id="mHistory" class="ev-modal-pane"></div>
        </div>
        <div class="ev-modal-ftr"><button onclick="EV.closeModal()">Close</button></div>
    </div>
</div>

<style>
/* Events Live Page - Uses shared CSS components:
   - events-table.css (.ev-* classes)
   - cell-badges.css (.c-* classes)
   - analysis-modal.css (.m-* and .h-* classes)
   Page-specific overrides only below */

/* Refresh button style */
.ev-refresh{padding:8px 16px;background:var(--surface);border:1px solid var(--border);border-radius:6px;font-size:13px;cursor:pointer}
.ev-refresh:hover{background:var(--background)}
</style>

<script>
const EV = {
    // State
    sshPg: 1,
    mIP: '',
    mData: null,
    mPg: 1,
    blockedIPs: new Set(),
    rowData: [],
    _keyBound: false,

    // ==================== INITIALIZATION ====================
    init() {
        this.loadAgents();
        this.loadBlockedList();
        this.loadSSH(1);
        if (!this._keyBound) {
            this._keyBound = true;
            document.addEventListener('keydown', e => this.handleKey(e));
        }
    },

    async loadBlockedList() {
        try {
            const r = await fetch('/api/dashboard/blocking/blocks/list?is_active=true&limit=1000');
            const d = await r.json();
            if (d.success && d.blocks) {
                this.blockedIPs = new Set(d.blocks.map(b => b.ip_address || b.ip_address_text));
            }
        } catch (e) { console.error('Error loading blocked list:', e); }
    },

    async loadAgents() {
        try {
            const r = await fetch('/api/agents/list');
            const d = await r.json();
            if (d.success && d.agents) {
                const s = document.getElementById('sshAgent');
                if (s && s.options.length <= 1) {
                    d.agents.forEach(a => s.add(new Option(a.hostname || a.agent_id, a.id)));
                }
            }
        } catch (e) { console.error('Error loading agents:', e); }
    },

    refresh() { this.loadBlockedList(); this.loadSSH(1); },

    // ==================== SSH TAB ====================
    async loadSSH(pg = 1) {
        this.sshPg = pg;
        const $ = id => document.getElementById(id);
        $('sshBody').innerHTML = '';
        $('sshLoad').style.display = 'block';
        $('sshTbl').style.display = 'none';
        $('sshNone').style.display = 'none';
        $('sshErr').style.display = 'none';
        $('sshPg').style.display = 'none';

        try {
            const type = $('sshType')?.value || '';
            const agent = $('sshAgent')?.value || '';
            const time = $('sshTime')?.value || '24h';
            let url = `/api/dashboard/events/grouped?time_range=${time}&limit=30&offset=${(pg - 1) * 30}&_t=${Date.now()}`;
            if (type) url += `&event_type=${type}`;
            if (agent) url += `&agent_id=${agent}`;

            const r = await fetch(url);
            const d = await r.json();
            $('sshLoad').style.display = 'none';

            if (d.success && d.groups?.length) {
                this.rowData = d.groups.map(g => ({ ...g, _type: 'ssh' }));
                $('sshBody').innerHTML = d.groups.map((g, i) => this.renderSSHRow(g, i)).join('');
                $('sshTbl').style.display = 'table';
                if (d.pagination) {
                    $('sshInfo').textContent = `${d.pagination.offset + 1}-${Math.min(d.pagination.offset + d.groups.length, d.pagination.total)} of ${d.pagination.total}`;
                    $('sshPg').querySelectorAll('button')[0].disabled = d.pagination.offset === 0;
                    $('sshPg').querySelectorAll('button')[1].disabled = !d.pagination.has_more;
                    $('sshPg').style.display = 'flex';
                }
            } else {
                $('sshNone').style.display = 'block';
            }
        } catch (e) {
            console.error('SSH load error:', e);
            $('sshLoad').style.display = 'none';
            $('sshErr').style.display = 'block';
        }
    },

    renderSSHRow(g, idx) {
        const loc = g.location || {};
        const flag = this.getFlag(loc.country_code);
        const risk = g.max_risk_score || 0;
        const cls = this.getRiskClass(risk);
        const tags = this.getTags(loc);
        const blocked = this.blockedIPs.has(g.ip_address);

        return `<tr>
            <td>${this.fmtTime(g.last_activity || g.latest_timestamp)}</td>
            <td><div class="c-ip">${this.esc(g.ip_address)}</div>${tags}</td>
            <td class="c-loc"><div>${flag} ${loc.city || ''} ${loc.country_code || ''}</div>${loc.isp ? `<div class="isp">${this.esc(loc.isp)}</div>` : ''}</td>
            <td><div class="c-att"><span class="f">${g.failed_count || 0}F</span><span class="s">${g.success_count || 0}S</span></div></td>
            <td><span class="c-users">${g.unique_users || 0}</span></td>
            <td>${this.renderRisk(risk, cls)}</td>
            <td><button class="c-detail" onclick="EV.openModal(${idx})">Details</button>${blocked ? '<span class="c-status">Blocked</span>' : ''}</td>
        </tr>`;
    },

    // ==================== MODAL ====================
    openModal(idx) {
        const g = this.rowData[idx];
        if (!g) return;
        this.mIP = g.ip_address;
        this.mData = g;
        this.mPg = 1;
        document.getElementById('modalTitle').textContent = `IP: ${g.ip_address}`;
        document.getElementById('modalAgent').textContent = g.agent?.hostname ? `Agent: ${g.agent.hostname}` : '';
        document.getElementById('evModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        this.modalTab('analysis');
    },

    closeModal() {
        document.getElementById('evModal').style.display = 'none';
        document.body.style.overflow = '';
        this.mIP = '';
        this.mData = null;
    },

    handleKey(e) {
        if (e.key === 'Escape' && document.getElementById('evModal').style.display === 'flex') {
            this.closeModal();
        }
    },

    modalTab(t) {
        document.querySelectorAll('.ev-modal-tabs button').forEach((b, i) => b.classList.toggle('active', t === 'analysis' ? i === 0 : i === 1));
        document.querySelectorAll('.ev-modal-pane').forEach(p => p.classList.remove('active'));
        const pane = document.getElementById(t === 'analysis' ? 'mAnalysis' : 'mHistory');
        pane.classList.add('active');
        if (t === 'analysis') {
            this.renderAnalysis();
        } else {
            pane.innerHTML = '<div class="h-load">Loading history...</div>';
            this.loadHistory(1);
        }
    },

    // ==================== ANALYSIS RENDERER ====================
    renderAnalysis() {
        const d = this.mData;
        if (!d) return;
        const loc = d.location || {};
        const threat = d.threat || {};
        const risk = d.max_risk_score || 0;
        const rc = this.getRiskColor(risk);
        const flag = this.getFlag(loc.country_code);
        const days = this.daysSince(d.first_timestamp);
        const tagsHtml = this.getTagsHtml(loc);
        const blocked = this.blockedIPs.has(this.mIP);

        const stats = `
            <div class="m-stat"><div class="m-stat-val red">${d.failed_count || 0}</div><div class="m-stat-lbl">Failed</div></div>
            <div class="m-stat"><div class="m-stat-val green">${d.success_count || 0}</div><div class="m-stat-lbl">Success</div></div>
            <div class="m-stat"><div class="m-stat-val">${d.event_count || 0}</div><div class="m-stat-lbl">Total</div></div>
            <div class="m-stat"><div class="m-stat-val blue">${d.unique_users || 0}</div><div class="m-stat-lbl">Users</div></div>
            <div class="m-stat"><div class="m-stat-val" style="color:${rc}">${Math.round(risk)}</div><div class="m-stat-lbl">Risk</div></div>
            <div class="m-stat"><div class="m-stat-val">${days}</div><div class="m-stat-lbl">Days</div></div>
        `;

        const extraInfo = `
            <div class="m-row"><span class="l">First Seen</span><span class="v">${this.fmtDateTime(d.first_timestamp)}</span></div>
        `;

        document.getElementById('mAnalysis').innerHTML = `
            <div class="m-stats">${stats}</div>
            <div class="m-cards">
                <div class="m-card"><h4>Location</h4>
                    <div class="m-row"><span class="l">Country</span><span class="v">${flag} ${loc.country_name || 'Unknown'}</span></div>
                    <div class="m-row"><span class="l">City</span><span class="v">${loc.city || 'Unknown'}</span></div>
                    <div class="m-row"><span class="l">ISP</span><span class="v">${loc.isp || 'Unknown'}</span></div>
                </div>
                <div class="m-card"><h4>Network</h4>
                    <div class="m-row"><span class="l">IP</span><span class="v">${this.mIP}</span></div>
                    <div class="m-row"><span class="l">Type</span><span class="v">${tagsHtml || 'Regular'}</span></div>
                    <div class="m-row"><span class="l">Status</span><span class="v">${blocked ? '<span class="c-status">Blocked</span>' : 'Active'}</span></div>
                    ${extraInfo}
                </div>
            </div>
            <div class="m-sec"><h4>Risk Analysis</h4>
                <div class="m-meter"><div class="m-meter-bar"><div class="m-meter-fill" style="width:${risk}%;background:${rc}"></div></div><div class="m-meter-val" style="color:${rc}">${Math.round(risk)}</div></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <div class="m-row"><span class="l">Level</span><span class="v" style="color:${rc}">${this.getRiskLevel(risk)}</span></div>
                    <div class="m-row"><span class="l">Threat</span><span class="v">${this.detectThreat(d)}</span></div>
                    <div class="m-row"><span class="l">Pattern</span><span class="v">${this.detectPattern(d)}</span></div>
                    <div class="m-row"><span class="l">Confidence</span><span class="v">${risk > 0 ? Math.min(95, 50 + risk * 0.45).toFixed(0) + '%' : 'N/A'}</span></div>
                </div>
            </div>
            <div class="m-sec"><h4>Threat Intel</h4>
                <div class="m-intel">
                    <div class="m-intel-item"><div class="src">AbuseIPDB</div><div class="score" style="color:${(threat.abuseipdb_score || 0) > 50 ? '#dc2626' : '#16a34a'}">${threat.abuseipdb_score || 0}%</div><div class="det">${threat.abuseipdb_reports || 0} reports</div></div>
                    <div class="m-intel-item"><div class="src">Risk</div><div class="score" style="color:${this.threatColor(threat.level)}">${threat.level || 'Unknown'}</div><div class="det">Overall</div></div>
                    <div class="m-intel-item"><div class="src">ML</div><div class="score" style="color:${risk > 60 ? '#dc2626' : '#16a34a'}">${Math.round(risk)}</div><div class="det">Behavior</div></div>
                </div>
            </div>
            <div class="m-sec"><h4>ML Decision</h4><div id="mDecision" class="m-decision">Loading...</div></div>
            <div class="m-sec"><h4>Recommendations</h4><div class="m-recs">${this.genRecs(d)}</div></div>`;

        // Fetch ML decision from API
        this.fetchMLDecision();
    },

    async fetchMLDecision() {
        const decDiv = document.getElementById('mDecision');
        if (!decDiv) return;

        try {
            // Find most recent event for this IP
            const url = `/api/dashboard/events/by-ip?ip=${encodeURIComponent(this.mIP)}&page=1&page_size=1&time_range=30d`;
            const r = await fetch(url);
            const d = await r.json();

            if (!d.success || !d.events?.length) {
                decDiv.innerHTML = '<div class="m-dec-empty">No event data available</div>';
                return;
            }

            const eventId = d.events[0].id;
            const detailUrl = `/api/dashboard/events-analysis/${eventId}`;
            const detailR = await fetch(detailUrl);
            const detailD = await detailR.json();

            if (!detailD.success) {
                decDiv.innerHTML = '<div class="m-dec-empty">Could not load decision data</div>';
                return;
            }

            const { ml_decision, block_info } = detailD.data;
            let html = '';

            // Show block info if blocked
            if (block_info?.is_blocked) {
                const blockColor = block_info.is_active ? '#dc2626' : '#6b7280';
                html += `
                    <div class="m-dec-block" style="background:${blockColor}15;border:1px solid ${blockColor}40;border-radius:6px;padding:10px;margin-bottom:10px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                            <span style="font-size:16px">üö´</span>
                            <strong style="color:${blockColor}">IP BLOCKED</strong>
                            <span class="c-tag" style="background:${blockColor};color:white;padding:2px 6px;border-radius:3px;font-size:10px">${block_info.block_source}</span>
                        </div>
                        <div style="font-size:12px;color:var(--text-secondary)">${this.esc(block_info.block_reason)}</div>
                    </div>`;
            }

            // Show ML decision
            if (ml_decision) {
                const decColors = {
                    block_permanent: '#991b1b',
                    block_temporary: '#dc2626',
                    monitor: '#d97706',
                    allow: '#16a34a'
                };
                const decColor = decColors[ml_decision.decision] || '#6b7280';
                const decIcon = ml_decision.decision.includes('block') ? 'üõ°Ô∏è' : ml_decision.decision === 'monitor' ? 'üëÅÔ∏è' : '‚úÖ';

                html += `
                    <div class="m-dec-main" style="background:${decColor}10;border:1px solid ${decColor}30;border-radius:6px;padding:10px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                            <span style="font-size:16px">${decIcon}</span>
                            <strong style="color:${decColor}">${ml_decision.decision_text}</strong>
                        </div>
                        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px">${ml_decision.reason}</div>
                        ${ml_decision.factors?.length ? `
                            <div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:6px">CONTRIBUTING FACTORS:</div>
                            <div style="display:flex;flex-wrap:wrap;gap:6px">
                                ${ml_decision.factors.map(f => {
                                    const impactColors = { critical: '#991b1b', high: '#dc2626', medium: '#d97706', low: '#16a34a' };
                                    const ic = impactColors[f.impact] || '#6b7280';
                                    return `<span class="m-factor" style="background:${ic}15;border:1px solid ${ic}30;padding:4px 8px;border-radius:4px;font-size:11px">
                                        <strong style="color:${ic}">${f.label}:</strong> ${f.value}
                                    </span>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>`;
            }

            decDiv.innerHTML = html || '<div class="m-dec-empty">No decision data</div>';
        } catch (e) {
            console.error('Error fetching ML decision:', e);
            decDiv.innerHTML = '<div class="m-dec-empty">Error loading decision</div>';
        }
    },

    // ==================== HISTORY LOADER ====================
    async loadHistory(pg = 1) {
        this.mPg = pg;
        const c = document.getElementById('mHistory');
        c.innerHTML = '<div class="h-load">Loading...</div>';

        try {
            const url = `/api/dashboard/events/by-ip?ip=${encodeURIComponent(this.mIP)}&page=${pg}&page_size=100&time_range=30d&_t=${Date.now()}`;
            const r = await fetch(url);
            const d = await r.json();

            if (d.success && d.events?.length) {
                this.renderHistory(d.events, d.pagination);
            } else {
                c.innerHTML = '<div class="h-load">No events found</div>';
            }
        } catch (e) {
            c.innerHTML = '<div class="h-load">Error loading</div>';
        }
    },

    renderHistory(events, pg) {
        const stat1 = events.filter(e => e.event_type === 'failed').length;
        const stat2 = events.filter(e => e.event_type === 'successful').length;
        const stat1Label = 'Failed';
        const stat2Label = 'Success';
        const agents = [...new Set(events.map(e => e.agent_hostname).filter(Boolean))].length;

        // Group by date
        const grouped = {};
        events.forEach(e => {
            const date = this.getDateInTz(e.timestamp);
            if (!date) return;
            if (!grouped[date]) grouped[date] = { events: [], s1: 0, s2: 0 };
            grouped[date].events.push(e);
            if (e.event_type === 'failed') grouped[date].s1++;
            if (e.event_type === 'successful') grouped[date].s2++;
        });
        const dates = Object.keys(grouped).sort((a, b) => b.localeCompare(a));

        // Sort events within each date group by processed_at (newest first)
        dates.forEach(date => {
            grouped[date].events.sort((a, b) => new Date(b.processed_at || b.created_at || b.timestamp) - new Date(a.processed_at || a.created_at || a.timestamp));
        });

        const tableHeaders = '<th>Processed At</th><th>Auth.log Time</th><th>IP</th><th>User</th><th>Status</th><th>Auth</th>';

        const renderRow = e => `<tr>
            <td>${this.fmtFullDateTime(e.processed_at || e.created_at)}</td>
            <td class="time-cell${this.isUnusualTime(e.timestamp) ? ' unusual' : ''}">${this.fmtFullDateTime(e.timestamp)}</td>
            <td class="ip-cell">${this.esc(e.ip || e.source_ip || e.source_ip_text || '-')}</td>
            <td>${this.esc(e.username)}</td>
            <td><span class="c-badge ${e.event_type}">${e.event_type === 'failed' ? 'F' : 'S'}</span></td>
            <td>${this.esc(e.auth_method || '-')}</td>
        </tr>`;

        document.getElementById('mHistory').innerHTML = `
            <div class="h-over">
                <div class="h-stat"><div class="h-stat-val">${events.length}</div><div class="h-stat-lbl">Total</div></div>
                <div class="h-stat"><div class="h-stat-val red">${stat1}</div><div class="h-stat-lbl">${stat1Label}</div></div>
                <div class="h-stat"><div class="h-stat-val green">${stat2}</div><div class="h-stat-lbl">${stat2Label}</div></div>
                <div class="h-stat"><div class="h-stat-val">${agents}</div><div class="h-stat-lbl">Agents</div></div>
                <div class="h-stat"><div class="h-stat-val">${dates.length}</div><div class="h-stat-lbl">Days</div></div>
            </div>
            <div class="h-filters">
                <input type="date" id="hDate" onchange="EV.applyHistFilter()">
                <select id="hType" onchange="EV.applyHistFilter()">
                    <option value="">All</option>
                    <option value="s1">${stat1Label}</option>
                    <option value="s2">${stat2Label}</option>
                </select>
                <button class="clear" onclick="EV.clearHistFilter()">Clear</button>
            </div>
            <div class="h-wrap">${dates.map((date, idx) => {
                const g = grouped[date];
                const isExpanded = idx === 0;  // Auto-expand first date
                return `<div class="h-date${isExpanded ? ' expanded' : ''}" id="hd-${date}">
                    <div class="h-date-hdr" onclick="EV.toggleDate('${date}')">
                        <div class="h-date-title"><span class="arrow">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>${this.fmtDateFull(date)}</div>
                        <div class="h-date-stats"><span class="f">${g.s1}F</span><span class="s">${g.s2}S</span><span class="t">(${g.events.length})</span></div>
                    </div>
                    <div class="h-date-body"><table class="h-tbl"><thead><tr>${tableHeaders}</tr></thead><tbody>${g.events.map(renderRow).join('')}</tbody></table></div>
                </div>`;
            }).join('')}</div>
            ${pg ? `<div class="ev-pg" style="margin-top:10px"><span>Page ${pg.page}/${pg.total_pages}</span><div><button ${!pg.has_prev ? 'disabled' : ''} onclick="EV.loadHistory(${this.mPg - 1})">‚Üê</button><button ${!pg.has_next ? 'disabled' : ''} onclick="EV.loadHistory(${this.mPg + 1})">‚Üí</button></div></div>` : ''}`;
    },

    applyHistFilter() {
        const dateF = document.getElementById('hDate')?.value || '';
        const typeF = document.getElementById('hType')?.value || '';

        document.querySelectorAll('.h-date').forEach(el => {
            const date = el.id.replace('hd-', '');
            const rows = el.querySelectorAll('.h-tbl tbody tr');
            let visCount = 0;
            rows.forEach(row => {
                let typeMatch = true;
                if (typeF) {
                    const badge = row.cells[4]?.textContent || '';
                    typeMatch = (typeF === 's1' && badge === 'F') || (typeF === 's2' && badge === 'S');
                }
                const show = (!dateF || date === dateF) && typeMatch;
                row.style.display = show ? '' : 'none';
                if (show) visCount++;
            });
            el.style.display = (!dateF || date === dateF) && visCount > 0 ? '' : 'none';
        });
    },

    clearHistFilter() {
        ['hDate', 'hType'].forEach(id => { const e = document.getElementById(id); if (e) e.value = ''; });
        document.querySelectorAll('.h-date').forEach(el => { el.style.display = ''; el.querySelectorAll('tr').forEach(r => r.style.display = ''); });
    },

    toggleDate(d) {
        const el = document.getElementById('hd-' + d);
        if (el) {
            el.classList.toggle('expanded');
            const arrow = el.querySelector('.arrow');
            if (arrow) arrow.textContent = el.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
        }
    },

    // ==================== SHARED HELPERS ====================
    esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; },

    getFlag(cc) { return cc ? String.fromCodePoint(...cc.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0))) : ''; },

    getRiskClass(r) { return r >= 80 ? 'crit' : r >= 60 ? 'high' : r >= 40 ? 'med' : r >= 20 ? 'low' : 'clean'; },

    getRiskColor(r) { return r >= 80 ? '#991b1b' : r >= 60 ? '#dc2626' : r >= 40 ? '#d97706' : r >= 20 ? '#ca8a04' : '#16a34a'; },

    getRiskLevel(r) { return r >= 80 ? 'CRITICAL' : r >= 60 ? 'HIGH' : r >= 40 ? 'MEDIUM' : r >= 20 ? 'LOW' : 'CLEAN'; },

    renderRisk(r, cls) { return `<div class="c-risk"><span>${Math.round(r)}</span><div class="c-risk-bar"><div class="c-risk-fill ${cls}" style="width:${r}%"></div></div></div>`; },

    getTags(loc) {
        const t = [loc.is_tor && 'tor', loc.is_vpn && 'vpn', loc.is_proxy && 'proxy'].filter(Boolean);
        return t.length ? `<div class="c-tags">${t.map(x => `<span class="c-tag ${x}">${x.toUpperCase()}</span>`).join('')}</div>` : '';
    },

    getTagsHtml(loc) {
        const t = [loc.is_tor && '<span class="c-tag tor">TOR</span>', loc.is_vpn && '<span class="c-tag vpn">VPN</span>', loc.is_proxy && '<span class="c-tag proxy">PROXY</span>'].filter(Boolean);
        return t.join(' ');
    },

    fmtTime(t) {
        if (!t) return '-';
        if (window.TimeSettings?.isLoaded()) return window.TimeSettings.formatFull(t);
        // Fallback: browser's native timezone
        let ts = String(t).replace(' ', 'T');
        if (!ts.endsWith('Z') && !ts.includes('+')) ts += '+08:00';
        const d = new Date(ts);
        if (isNaN(d.getTime())) return t;
        return d.toLocaleString();
    },

    fmtDateTime(t) { return this.fmtTime(t); },

    fmtTimeOnly(t) {
        if (!t) return '-';
        if (window.TimeSettings?.isLoaded()) return window.TimeSettings.format(t, 'time');
        // Fallback: browser's native timezone
        let ts = String(t).replace(' ', 'T');
        if (!ts.endsWith('Z') && !ts.includes('+')) ts += '+08:00';
        const d = new Date(ts);
        if (isNaN(d.getTime())) return t;
        return d.toLocaleTimeString();
    },

    fmtFullDateTime(t) {
        if (!t) return '-';
        if (window.TimeSettings?.isLoaded()) return window.TimeSettings.format(t, 'full');
        // Fallback: browser's native timezone
        let ts = String(t).replace(' ', 'T');
        if (!ts.endsWith('Z') && !ts.includes('+')) ts += '+08:00';
        const d = new Date(ts);
        if (isNaN(d.getTime())) return t;
        return d.toLocaleString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric',
            hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true
        });
    },

    isUnusualTime(t) {
        if (!t) return false;
        let ts = String(t).replace(' ', 'T');
        if (!ts.endsWith('Z') && !ts.includes('+')) ts += '+08:00';
        const d = new Date(ts);
        if (isNaN(d.getTime())) return false;
        // Get hour in user's timezone (browser timezone)
        const hour = d.getHours();
        // Unusual = before 7am or after 10pm
        return hour < 7 || hour >= 22;
    },

    fmtDateFull(d) { if (!d) return ''; const dt = new Date(d + 'T12:00:00'); return ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][dt.getDay()] + ', ' + ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][dt.getMonth()] + ' ' + dt.getDate(); },

    getDateInTz(t) {
        if (!t) return null;
        let ts = String(t).replace(' ', 'T');
        if (!ts.endsWith('Z') && !ts.includes('+')) ts += '+08:00';
        const d = new Date(ts);
        if (isNaN(d.getTime())) return null;
        return d.toLocaleDateString('en-CA');
    },

    daysSince(t) { if (!t) return 1; return Math.max(1, Math.ceil((new Date() - new Date(t)) / 86400000)); },

    detectThreat(d) {
        if (d.failed_count > 50 && d.unique_users > 10) return 'Brute Force';
        if (d.unique_users > 20) return 'Credential Stuffing';
        if (d.failed_count > 0 && d.success_count > 0) return 'Mixed';
        if (d.failed_count > 10) return 'Password Guess';
        return d.success_count > 0 ? 'Legitimate' : 'Recon';
    },

    detectPattern(d) {
        const r = d.event_count / Math.max(1, this.daysSince(d.first_timestamp));
        if (r > 50) return 'High Velocity';
        if (r > 10) return 'Moderate';
        if (d.unique_users > 5) return 'User Enum';
        return 'Low & Slow';
    },

    threatColor(l) { return { critical: '#991b1b', high: '#dc2626', medium: '#d97706', low: '#16a34a', clean: '#16a34a' }[l?.toLowerCase()] || '#6b7280'; },

    genRecs(d) {
        const r = [], risk = d.max_risk_score || 0, loc = d.location || {};
        if (risk >= 70) r.push({ t: 'crit', i: 'üö®', m: 'Block immediately' });
        if (d.failed_count > 50) r.push({ t: 'crit', i: 'üîí', m: 'Brute force - Rate limit' });
        if (loc.is_tor || loc.is_vpn || loc.is_proxy) r.push({ t: 'warn', i: '‚ö†Ô∏è', m: 'Anonymous network - Monitor' });
        if (d.unique_users > 10) r.push({ t: 'warn', i: 'üë•', m: 'Multi-user attack' });
        if (d.success_count > 0 && d.failed_count > 0) r.push({ t: 'warn', i: 'üîç', m: 'Verify successful logins' });
        if (!r.length) r.push({ t: 'info', i: '‚úÖ', m: 'No immediate threats' });
        return r.map(x => `<div class="m-rec ${x.t}"><span>${x.i}</span><span>${x.m}</span></div>`).join('');
    }
};

window.loadEventsLivePage = () => EV.init();
window.EV = EV;
</script>
