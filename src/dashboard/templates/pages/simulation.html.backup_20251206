<!-- SSH Guardian v3.0 - Simulation Page -->
<div id="page-simulation" class="page-content" style="display: none;">
    <div class="page-header-with-cache">
        <div>
            <h2 style="margin: 0 0 8px 0; color: var(--text-primary); font-size: 24px; font-weight: 600;">
                Attack Simulation
            </h2>
            <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                Generate realistic SSH attack scenarios to test detection and response
            </p>
        </div>
        <div class="page-header-actions">
            <div class="cache-indicator loading" data-cache-endpoint="simulation">
                <span class="cache-status-dot"></span>
                <span class="cache-indicator-text">Loading...</span>
                <span class="cache-time"></span>
                <button class="cache-refresh-btn" onclick="loadSimulationPage()" title="Refresh data">‚Üª</button>
            </div>
        </div>
    </div>

    <!-- Simulation Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div class="card" style="padding: 20px;">
            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Total Simulations</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);" id="sim-total-count">0</div>
        </div>
        <div class="card" style="padding: 20px;">
            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Events Generated</div>
            <div style="font-size: 28px; font-weight: 600; color: var(--azure-blue);" id="sim-events-count">0</div>
        </div>
        <div class="card" style="padding: 20px;">
            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">IPs Blocked</div>
            <div style="font-size: 28px; font-weight: 600; color: #D13438;" id="sim-blocked-count">0</div>
        </div>
        <div class="card" style="padding: 20px;">
            <div style="color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 8px;">Templates</div>
            <div style="font-size: 28px; font-weight: 600; color: #2EA44F;" id="sim-templates-count">0</div>
        </div>
    </div>

    <!-- Live Demo Section -->
    <div class="card" style="padding: 20px; margin-bottom: 24px; border: 2px solid #E6A502;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
                <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üéØ</span> Live Threat Detection Demo
                </h3>
                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                    Run real threat intelligence lookups against known malicious IPs to demonstrate detection capabilities
                </p>
            </div>
            <button id="demo-run-all-btn" style="padding: 10px 20px; background: #E6A502; color: #000; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                <span>‚ñ∂ Run Full Demo</span>
            </button>
        </div>

        <!-- Demo Scenarios Grid -->
        <div id="demo-scenarios-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div style="text-align: center; padding: 30px; color: var(--text-secondary);">Loading demo scenarios...</div>
        </div>

        <!-- Demo Results Panel - Improved Design -->
        <div id="demo-results-panel" style="display: none; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h4 style="margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 22px;">üîç</span> Detection Results
                </h4>
                <button id="demo-results-close" onclick="document.getElementById('demo-results-panel').style.display='none'"
                        style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); padding: 4px 8px;">√ó</button>
            </div>
            <div id="demo-results-content"></div>
        </div>
    </div>

    <!-- Run Simulation Section -->
    <div class="card" style="padding: 20px; margin-bottom: 24px;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Run New Simulation</h3>

        <!-- Template Selection -->
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary);">Select Attack Template</label>
            <div id="sim-templates-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading templates...</div>
            </div>
        </div>

        <!-- Selected Template Details -->
        <div id="sim-template-details" style="display: none; margin-bottom: 20px; padding: 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                    <h4 style="margin: 0 0 4px 0; font-size: 15px; font-weight: 600;" id="sim-selected-name">-</h4>
                    <p style="margin: 0; font-size: 13px; color: var(--text-secondary);" id="sim-selected-desc">-</p>
                </div>
                <span id="sim-selected-severity" style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">-</span>
            </div>

            <!-- Customization Options -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 16px;">
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--text-secondary);">Number of Attempts</label>
                    <input type="number" id="sim-param-attempts" value="10" min="1" max="100" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--card-bg);">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--text-secondary);">Time Window (seconds)</label>
                    <input type="number" id="sim-param-timewindow" value="60" min="10" max="600" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--card-bg);">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--text-secondary);">Target Username</label>
                    <input type="text" id="sim-param-username" placeholder="root" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--card-bg);">
                </div>
                <div>
                    <label style="display: block; font-size: 12px; margin-bottom: 4px; color: var(--text-secondary);">Target Server</label>
                    <input type="text" id="sim-param-server" placeholder="prod-web-01" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--card-bg);">
                </div>
            </div>
        </div>

        <!-- Execute Button -->
        <button id="sim-execute-btn" disabled style="padding: 12px 24px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px;">
            <span>Run Simulation</span>
        </button>
    </div>

    <!-- Execution Progress -->
    <div id="sim-progress" class="card" style="padding: 20px; margin-bottom: 24px; display: none;">
        <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Simulation Progress</h3>
        <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 13px; color: var(--text-secondary);">Processing...</span>
                <span id="sim-progress-percent" style="font-size: 13px; font-weight: 600;">0%</span>
            </div>
            <div style="height: 8px; background: var(--background); border-radius: 4px; overflow: hidden;">
                <div id="sim-progress-bar" style="height: 100%; background: var(--azure-blue); border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
        <div id="sim-progress-log" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 4px;"></div>
    </div>

    <!-- Simulation History -->
    <div class="card" style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Simulation History</h3>
            <button id="sim-refresh-btn" style="padding: 6px 12px; background: var(--background); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 13px;">
                Refresh
            </button>
        </div>

        <!-- Filters -->
        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <select id="sim-filter-type" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--background); min-width: 180px;">
                <option value="">All Attack Types</option>
            </select>
        </div>

        <!-- History Table -->
        <div class="table-wrapper">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                    <tr style="background: var(--background); border-bottom: 2px solid var(--border);">
                        <th style="padding: 12px; text-align: left; font-weight: 600;">ID</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Attack Type</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Events</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Blocked</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Duration</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Executed</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th>
                    </tr>
                </thead>
                <tbody id="sim-history-body">
                    <tr>
                        <td colspan="8" style="padding: 20px; text-align: center; color: var(--text-secondary);">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="sim-pagination" style="margin-top: 16px; display: flex; justify-content: center; gap: 8px;"></div>
    </div>

    <!-- Simulation Details Modal -->
    <div id="sim-details-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--card-bg); border-radius: 8px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; margin: 20px;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Simulation Details</h3>
                <button id="sim-modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">&times;</button>
            </div>
            <div id="sim-modal-content" style="padding: 20px;">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
// SSH Guardian v3.0 - Simulation Page Script
// Last Updated: 2025-12-06 - Fixed Block IP endpoint, AI confidence, button labels
// Cache-buster: v3.0.1-20251206
(function() {
    let selectedTemplate = null;
    let currentPage = 1;
    const pageSize = 10;

    // Initialize when page becomes visible
    function initSimulation() {
        loadTemplates();
        loadHistory();
        loadStats();
        loadAttackTypes();
    }

    // Load templates
    async function loadTemplates() {
        try {
            const response = await fetch('/api/simulation/templates', { credentials: 'same-origin' });
            const data = await response.json();

            if (data.success && data.templates) {
                document.getElementById('sim-templates-count').textContent = data.templates.length;
                renderTemplates(data.templates);
            }
        } catch (error) {
            console.error('Error loading templates:', error);
        }
    }

    function renderTemplates(templates) {
        const grid = document.getElementById('sim-templates-grid');
        grid.innerHTML = templates.map(t => `
            <div class="sim-template-card" data-template="${t.id}"
                 style="padding: 16px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">${t.name}</span>
                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;
                          background: ${getSeverityColor(t.severity)}20; color: ${getSeverityColor(t.severity)};">${t.severity}</span>
                </div>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">${t.description}</p>
                <div style="margin-top: 8px; font-size: 11px; color: var(--text-tertiary);">Category: ${t.category}</div>
            </div>
        `).join('');

        // Add click handlers
        grid.querySelectorAll('.sim-template-card').forEach(card => {
            card.addEventListener('click', () => selectTemplate(card.dataset.template, templates));
        });
    }

    function getSeverityColor(severity) {
        const colors = { critical: '#D13438', high: '#E6A502', medium: '#0078D4', low: '#2EA44F' };
        return colors[severity] || '#666';
    }

    function selectTemplate(templateId, templates) {
        selectedTemplate = templates.find(t => t.id === templateId);
        if (!selectedTemplate) return;

        // Update UI
        document.querySelectorAll('.sim-template-card').forEach(card => {
            card.style.borderColor = card.dataset.template === templateId ? 'var(--azure-blue)' : 'var(--border)';
            card.style.background = card.dataset.template === templateId ? 'var(--azure-blue)10' : 'transparent';
        });

        // Show details
        const details = document.getElementById('sim-template-details');
        details.style.display = 'block';
        document.getElementById('sim-selected-name').textContent = selectedTemplate.name;
        document.getElementById('sim-selected-desc').textContent = selectedTemplate.description;

        const severitySpan = document.getElementById('sim-selected-severity');
        severitySpan.textContent = selectedTemplate.severity;
        severitySpan.style.background = getSeverityColor(selectedTemplate.severity) + '20';
        severitySpan.style.color = getSeverityColor(selectedTemplate.severity);

        // Set default params from template
        const tpl = selectedTemplate.template;
        document.getElementById('sim-param-attempts').value = tpl.attempts || tpl.attempts_per_ip * 5 || 10;
        document.getElementById('sim-param-timewindow').value = tpl.time_window_seconds || 60;
        document.getElementById('sim-param-username').value = Array.isArray(tpl.username) ? tpl.username[0] : (tpl.username || 'root');
        document.getElementById('sim-param-server').value = tpl.server_hostname || 'prod-web-01';

        // Enable execute button
        document.getElementById('sim-execute-btn').disabled = false;
    }

    // Execute simulation
    document.getElementById('sim-execute-btn').addEventListener('click', async () => {
        if (!selectedTemplate) return;

        const btn = document.getElementById('sim-execute-btn');
        const progress = document.getElementById('sim-progress');
        const progressBar = document.getElementById('sim-progress-bar');
        const progressPercent = document.getElementById('sim-progress-percent');
        const progressLog = document.getElementById('sim-progress-log');

        btn.disabled = true;
        btn.innerHTML = '<span>Running...</span>';
        progress.style.display = 'block';
        progressLog.innerHTML = '';
        progressBar.style.width = '0%';

        const params = {
            attempts: parseInt(document.getElementById('sim-param-attempts').value),
            time_window_seconds: parseInt(document.getElementById('sim-param-timewindow').value),
            username: document.getElementById('sim-param-username').value || undefined,
            server_hostname: document.getElementById('sim-param-server').value || undefined
        };

        try {
            addLog(progressLog, 'Starting simulation: ' + selectedTemplate.name);
            progressBar.style.width = '10%';
            progressPercent.textContent = '10%';

            const response = await fetch('/api/simulation/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    template_name: selectedTemplate.id,
                    parameters: params
                })
            });

            progressBar.style.width = '50%';
            progressPercent.textContent = '50%';

            const data = await response.json();

            if (data.success) {
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                addLog(progressLog, 'Simulation completed successfully!', 'success');
                addLog(progressLog, `Events: ${data.summary.successful_submissions}/${data.summary.total_events}`);
                addLog(progressLog, `Unique IPs: ${data.summary.unique_ips}`);
                addLog(progressLog, `Completion: ${data.summary.completion_rate.toFixed(1)}%`);

                // Reload history and stats
                loadHistory();
                loadStats();
            } else {
                addLog(progressLog, 'Error: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            addLog(progressLog, 'Error: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>Run Simulation</span>';
        }
    });

    function addLog(container, message, type = 'info') {
        const colors = { info: '#d4d4d4', success: '#4ec9b0', error: '#f14c4c', warning: '#cca700' };
        const timestamp = new Date().toLocaleTimeString();
        container.innerHTML += `<div style="color: ${colors[type]};">[${timestamp}] ${message}</div>`;
        container.scrollTop = container.scrollHeight;
    }

    // Load history
    async function loadHistory() {
        try {
            const filter = document.getElementById('sim-filter-type').value;
            const url = `/api/simulation/history?limit=${pageSize}&offset=${(currentPage-1)*pageSize}` +
                        (filter ? `&attack_type=${encodeURIComponent(filter)}` : '');

            const response = await fetch(url, { credentials: 'same-origin' });
            const data = await response.json();

            if (data.success) {
                renderHistory(data.history);
                renderPagination(data.total);
                updateStats(data);
            }
        } catch (error) {
            console.error('Error loading history:', error);
        }
    }

    function renderHistory(history) {
        const tbody = document.getElementById('sim-history-body');

        if (!history || history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--text-secondary);">No simulations found</td></tr>';
            return;
        }

        tbody.innerHTML = history.map(sim => `
            <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 12px;">#${sim.id}</td>
                <td style="padding: 12px;">${sim.template_display_name || sim.template_name}</td>
                <td style="padding: 12px;">
                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;
                          background: ${getStatusColor(sim.status)}20; color: ${getStatusColor(sim.status)};">
                        ${sim.status}
                    </span>
                </td>
                <td style="padding: 12px;">${sim.events_generated || 0}</td>
                <td style="padding: 12px;">${sim.ips_blocked || 0}</td>
                <td style="padding: 12px;">${sim.duration_seconds ? sim.duration_seconds + 's' : '-'}</td>
                <td style="padding: 12px;">${formatDate(sim.started_at)}</td>
                <td style="padding: 12px;">
                    <button onclick="viewSimDetails(${sim.id})" style="padding: 4px 8px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        View
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function getStatusColor(status) {
        const colors = { completed: '#2EA44F', running: '#0078D4', failed: '#D13438', pending: '#E6A502' };
        return colors[status] || '#666';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }

    function renderPagination(total) {
        const container = document.getElementById('sim-pagination');
        const totalPages = Math.ceil(total / pageSize);

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';
        for (let i = 1; i <= totalPages; i++) {
            html += `<button onclick="goToPage(${i})" style="padding: 6px 12px; border: 1px solid var(--border);
                     background: ${i === currentPage ? 'var(--azure-blue)' : 'var(--background)'};
                     color: ${i === currentPage ? 'white' : 'var(--text-primary)'};
                     border-radius: 4px; cursor: pointer;">${i}</button>`;
        }
        container.innerHTML = html;
    }

    window.goToPage = function(page) {
        currentPage = page;
        loadHistory();
    };

    // Load stats
    async function loadStats() {
        try {
            const response = await fetch('/api/simulation/history?limit=1000', { credentials: 'same-origin' });
            const data = await response.json();

            if (data.success) {
                document.getElementById('sim-total-count').textContent = data.total;

                let totalEvents = 0, totalBlocked = 0;
                data.history.forEach(sim => {
                    totalEvents += sim.events_generated || 0;
                    totalBlocked += sim.ips_blocked || 0;
                });

                document.getElementById('sim-events-count').textContent = totalEvents;
                document.getElementById('sim-blocked-count').textContent = totalBlocked;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    function updateStats(data) {
        document.getElementById('sim-total-count').textContent = data.total;
    }

    // Load attack types for filter
    async function loadAttackTypes() {
        try {
            const response = await fetch('/api/simulation/attack-types', { credentials: 'same-origin' });
            const data = await response.json();

            if (data.success && data.attack_types) {
                const select = document.getElementById('sim-filter-type');
                data.attack_types.forEach(at => {
                    const option = document.createElement('option');
                    option.value = at.template_name;
                    option.textContent = at.template_display_name || at.template_name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading attack types:', error);
        }
    }

    // View simulation details
    window.viewSimDetails = async function(simId) {
        const modal = document.getElementById('sim-details-modal');
        const content = document.getElementById('sim-modal-content');

        modal.style.display = 'flex';
        content.innerHTML = '<p style="text-align: center;">Loading...</p>';

        try {
            const [detailsRes, logsRes, analyticsRes] = await Promise.all([
                fetch(`/api/simulation/history/${simId}`, { credentials: 'same-origin' }),
                fetch(`/api/simulation/logs/${simId}`, { credentials: 'same-origin' }),
                fetch(`/api/simulation/analytics/${simId}`, { credentials: 'same-origin' })
            ]);

            const details = await detailsRes.json();
            const logs = await logsRes.json();
            const analytics = await analyticsRes.json();

            if (details.success) {
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 8px 0;">${details.simulation.template_display_name}</h4>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            Status: <span style="color: ${getStatusColor(details.simulation.status)}">${details.simulation.status}</span> |
                            Duration: ${details.simulation.duration_seconds || 0}s |
                            Events: ${details.simulation.events_generated || 0}
                        </p>
                    </div>

                    ${analytics.success && analytics.ip_statistics ? `
                    <div style="margin-bottom: 20px;">
                        <h5 style="margin: 0 0 12px 0; font-size: 14px;">IP Statistics</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${analytics.ip_statistics.slice(0, 6).map(ip => `
                                <div style="padding: 12px; background: var(--background); border-radius: 6px;">
                                    <div style="font-weight: 600; font-size: 13px;">${ip.ip_address}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        Events: ${ip.event_count} | Risk: ${Math.round(ip.avg_risk_score || 0)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div>
                        <h5 style="margin: 0 0 12px 0; font-size: 14px;">Execution Logs</h5>
                        <div style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 11px; background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 4px;">
                            ${logs.success && logs.logs ? logs.logs.map(log => `
                                <div style="color: ${log.level === 'SUCCESS' ? '#4ec9b0' : log.level === 'ERROR' ? '#f14c4c' : '#d4d4d4'};">
                                    [${log.stage}] ${log.message}
                                </div>
                            `).join('') : 'No logs available'}
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = '<p style="color: var(--text-secondary);">Failed to load details</p>';
            }
        } catch (error) {
            content.innerHTML = '<p style="color: #D13438;">Error loading details: ' + error.message + '</p>';
        }
    };

    // Modal close
    document.getElementById('sim-modal-close').addEventListener('click', () => {
        document.getElementById('sim-details-modal').style.display = 'none';
    });

    document.getElementById('sim-details-modal').addEventListener('click', (e) => {
        if (e.target.id === 'sim-details-modal') {
            document.getElementById('sim-details-modal').style.display = 'none';
        }
    });

    // Refresh button
    document.getElementById('sim-refresh-btn').addEventListener('click', () => {
        loadHistory();
        loadStats();
    });

    // Filter change
    document.getElementById('sim-filter-type').addEventListener('change', () => {
        currentPage = 1;
        loadHistory();
    });

    // Initialize on page load
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.target.id === 'page-simulation' && mutation.target.style.display !== 'none') {
                initSimulation();
            }
        });
    });

    const simPage = document.getElementById('page-simulation');
    if (simPage) {
        observer.observe(simPage, { attributes: true, attributeFilter: ['style'] });
        // Also init if already visible
        if (simPage.style.display !== 'none') {
            initSimulation();
        }
    }

    // Check hash on load
    if (window.location.hash === '#simulation') {
        setTimeout(initSimulation, 100);
    }

    // =====================================================
    // DEMO FUNCTIONALITY
    // =====================================================

    let demoScenarios = [];

    async function loadDemoScenarios() {
        try {
            const response = await fetch('/api/demo/scenarios', { credentials: 'same-origin' });
            const data = await response.json();

            if (data.success && data.scenarios) {
                demoScenarios = data.scenarios;
                renderDemoScenarios(data.scenarios);
            }
        } catch (error) {
            console.error('Error loading demo scenarios:', error);
            document.getElementById('demo-scenarios-grid').innerHTML =
                '<div style="color: #D13438; padding: 20px;">Failed to load demo scenarios</div>';
        }
    }

    function renderDemoScenarios(scenarios) {
        const grid = document.getElementById('demo-scenarios-grid');
        grid.innerHTML = scenarios.map(s => `
            <div class="demo-scenario-card" data-scenario="${s.id}"
                 style="padding: 16px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: var(--card-bg);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">${getDemoIcon(s.category)}</span>
                        <span style="font-weight: 600; font-size: 14px;">${s.name}</span>
                    </div>
                    <span style="padding: 3px 10px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;
                          background: ${getSeverityColor(s.severity)}20; color: ${getSeverityColor(s.severity)};">${s.severity}</span>
                </div>
                <p style="margin: 0 0 10px 0; font-size: 12px; color: var(--text-secondary); line-height: 1.4;">${s.description}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid var(--border);">
                    <code style="font-size: 11px; color: var(--azure-blue); background: var(--background); padding: 2px 6px; border-radius: 3px;">${s.ip}</code>
                    <button class="demo-run-btn" data-scenario="${s.id}"
                            style="padding: 6px 14px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
                        Run
                    </button>
                </div>
                <div class="demo-expected" style="margin-top: 10px; font-size: 11px; color: var(--text-tertiary);">
                    Expected: AbuseIPDB ${s.expected_results.abuseipdb_score} | Threat: ${s.expected_results.threat_level}
                </div>
            </div>
        `).join('');

        // Add click handlers for individual scenario run buttons
        grid.querySelectorAll('.demo-run-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                runDemoScenario(btn.dataset.scenario);
            });
        });
    }

    function getDemoIcon(category) {
        const icons = {
            'anonymization': 'üßÖ',
            'reputation': 'üö®',
            'malware': 'ü§ñ',
            'reconnaissance': 'üîç',
            'geographic': 'üåç',
            'baseline': '‚úÖ'
        };
        return icons[category] || '‚ö†Ô∏è';
    }

    async function runDemoScenario(scenarioId) {
        const btn = document.querySelector(`.demo-run-btn[data-scenario="${scenarioId}"]`);
        const card = document.querySelector(`.demo-scenario-card[data-scenario="${scenarioId}"]`);
        const resultsPanel = document.getElementById('demo-results-panel');
        const resultsContent = document.getElementById('demo-results-content');

        // Show loading state
        btn.disabled = true;
        btn.textContent = 'Running...';
        card.style.borderColor = '#E6A502';

        try {
            const response = await fetch(`/api/demo/run/${scenarioId}`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            const data = await response.json();

            if (data.success) {
                // Show results
                resultsPanel.style.display = 'block';
                card.style.borderColor = '#2EA44F';

                resultsContent.innerHTML = renderDemoResult(data);

                // Scroll to results
                resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                card.style.borderColor = '#D13438';
                resultsContent.innerHTML = `<div style="color: #D13438; padding: 10px;">Error: ${data.error}</div>`;
                resultsPanel.style.display = 'block';
            }
        } catch (error) {
            card.style.borderColor = '#D13438';
            resultsContent.innerHTML = `<div style="color: #D13438; padding: 10px;">Error: ${error.message}</div>`;
            resultsPanel.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = 'Run';
        }
    }

    function renderDemoResult(data) {
        const ti = data.results.threat_intel || {};
        const ml = data.results.ml || {};
        const geo = data.results.geo || {};
        const history = data.results.history || {};
        const recommendations = data.results.recommendations || [];

        const abuseScore = ti.abuseipdb_score !== null ? ti.abuseipdb_score : 'N/A';
        const vtPositives = ti.virustotal_positives !== null ? ti.virustotal_positives : 0;
        const vtTotal = ti.virustotal_total !== null ? ti.virustotal_total : 0;
        const threatLevel = ti.threat_level || 'unknown';
        const riskScore = ml.risk_score !== null ? ml.risk_score : 'N/A';
        const isAnomaly = ml.is_anomaly;

        // Build network flags string
        let networkFlags = [];
        if (geo.is_tor) networkFlags.push('<span style="color: #D13438;">Tor Exit</span>');
        if (geo.is_vpn) networkFlags.push('<span style="color: #E6A502;">VPN</span>');
        if (geo.is_proxy) networkFlags.push('<span style="color: #E6A502;">Proxy</span>');
        if (geo.is_datacenter) networkFlags.push('<span style="color: #0078D4;">Datacenter</span>');
        const networkFlagsStr = networkFlags.length > 0 ? networkFlags.join(' | ') : '<span style="color: #2EA44F;">Clean</span>';

        // Determine overall threat status for header
        const overallStatus = getOverallThreatStatus(abuseScore, riskScore, threatLevel, isAnomaly);

        // Check if we have critical/high priority recommendations
        const hasCriticalRecs = recommendations.some(r => r.priority === 'critical' || r.priority === 'high');

        return `
            <!-- Critical Recommendations Alert (Sticky) -->
            ${hasCriticalRecs ? `
            <div id="critical-recs-alert" style="position: sticky; top: 0; z-index: 100; margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, rgba(209, 52, 56, 0.95), rgba(230, 165, 2, 0.95)); border-radius: 10px; border: 2px solid #D13438; box-shadow: 0 4px 20px rgba(209, 52, 56, 0.3); animation: pulseAlert 2s infinite;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                        <span style="font-size: 28px; animation: shake 0.5s infinite;">‚ö†Ô∏è</span>
                        <div>
                            <div style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 4px;">Critical Security Alert</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.9);">${recommendations.filter(r => r.priority === 'critical' || r.priority === 'high').length} high-priority action${recommendations.filter(r => r.priority === 'critical' || r.priority === 'high').length > 1 ? 's' : ''} required</div>
                        </div>
                    </div>
                    <button onclick="document.getElementById('recommendations-section').scrollIntoView({behavior: 'smooth', block: 'center'})"
                            style="padding: 10px 20px; background: white; color: #D13438; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: 13px; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                        View Actions ‚Üì
                    </button>
                </div>
            </div>
            <style>
                @keyframes pulseAlert {
                    0%, 100% { box-shadow: 0 4px 20px rgba(209, 52, 56, 0.3); }
                    50% { box-shadow: 0 4px 30px rgba(209, 52, 56, 0.6); }
                }
                @keyframes shake {
                    0%, 100% { transform: rotate(0deg); }
                    25% { transform: rotate(-10deg); }
                    75% { transform: rotate(10deg); }
                }
            </style>
            ` : ''}

            <!-- Results Header with Overall Status - Enhanced -->
            <div style="display: flex; gap: 16px; margin-bottom: 20px; padding: 24px; background: linear-gradient(135deg, ${overallStatus.bgGradient}); border-radius: 12px; border: 2px solid ${overallStatus.borderColor}; box-shadow: 0 4px 16px rgba(0,0,0,0.1); position: relative; overflow: hidden;">
                <!-- Animated background pattern -->
                <div style="position: absolute; top: 0; right: 0; bottom: 0; left: 0; opacity: 0.05; background: repeating-linear-gradient(45deg, transparent, transparent 10px, currentColor 10px, currentColor 20px);"></div>

                <div style="flex: 1; position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); border-radius: 12px; backdrop-filter: blur(10px);">
                            <span style="font-size: 36px;">${overallStatus.icon}</span>
                        </div>
                        <div>
                            <div style="font-size: 22px; font-weight: 700; color: ${overallStatus.textColor}; text-shadow: 0 1px 3px rgba(0,0,0,0.1);">${overallStatus.title}</div>
                            <div style="font-size: 14px; color: var(--text-secondary); font-weight: 500;">${overallStatus.subtitle}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 16px;">
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">IP Address</div>
                            <code style="font-size: 14px; font-weight: 700; color: var(--azure-blue); text-shadow: 0 1px 2px rgba(0,0,0,0.1);">${data.ip}</code>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Scenario</div>
                            <div style="font-size: 14px; font-weight: 700; color: var(--text-primary);">${data.scenario_name}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 8px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 600; text-transform: uppercase;">Event ID</div>
                            <div style="font-size: 14px; font-weight: 700; color: var(--text-primary);">#${data.event_id}</div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 140px; position: relative; z-index: 1;">
                    <div style="position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center;">
                        <!-- Circular progress background -->
                        <svg width="120" height="120" style="position: absolute; transform: rotate(-90deg);">
                            <circle cx="60" cy="60" r="50" stroke="rgba(255,255,255,0.2)" stroke-width="8" fill="none"/>
                            <circle cx="60" cy="60" r="50" stroke="${overallStatus.scoreColor}" stroke-width="8" fill="none"
                                    stroke-dasharray="${(typeof riskScore === 'number' ? riskScore : 0) * 3.14}" stroke-dashoffset="0"
                                    style="transition: stroke-dasharray 1s ease;"/>
                        </svg>
                        <div style="text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: ${overallStatus.scoreColor}; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${typeof riskScore === 'number' ? riskScore : '--'}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase;">Risk Score</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Cards Grid - Enhanced with Expand/Collapse -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
                <!-- Threat Intel Card -->
                <div class="detection-card" style="padding: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease; cursor: pointer;"
                     onmouseenter="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.12)'"
                     onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #D1343820, #D1343840); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(209, 52, 56, 0.2);">
                            <span style="font-size: 22px;">üõ°Ô∏è</span>
                        </div>
                        <div style="flex: 1;">
                            <h5 style="margin: 0; font-size: 15px; font-weight: 700; color: var(--text-primary);">Threat Intelligence</h5>
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">External feeds analysis</div>
                        </div>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                            <span style="font-size: 13px; color: var(--text-secondary);">AbuseIPDB</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 60px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${abuseScore !== 'N/A' ? abuseScore : 0}%; height: 100%; background: ${getScoreColor(abuseScore)}; border-radius: 3px;"></div>
                                </div>
                                <span style="font-weight: 700; font-size: 14px; color: ${getScoreColor(abuseScore)}; min-width: 50px; text-align: right;">${abuseScore}/100</span>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                            <span style="font-size: 13px; color: var(--text-secondary);">VirusTotal</span>
                            <span style="font-weight: 700; font-size: 14px; color: ${vtPositives > 0 ? '#D13438' : '#2EA44F'};">${vtPositives}/${vtTotal} engines</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                            <span style="font-size: 13px; color: var(--text-secondary);">Threat Level</span>
                            <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ${getThreatLevelColor(threatLevel)}20; color: ${getThreatLevelColor(threatLevel)};">
                                ${threatLevel.toUpperCase()}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- ML Analysis Card -->
                <div class="detection-card" style="padding: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease; cursor: pointer;"
                     onmouseenter="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.12)'"
                     onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #0078D420, #0078D440); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0, 120, 212, 0.2);">
                            <span style="font-size: 22px;">ü§ñ</span>
                        </div>
                        <div style="flex: 1;">
                            <h5 style="margin: 0; font-size: 15px; font-weight: 700; color: var(--text-primary);">ML Analysis</h5>
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">Machine learning predictions</div>
                        </div>
                    </div>
                    ${ml.ml_available ? `
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                                <span style="font-size: 13px; color: var(--text-secondary);">Risk Score</span>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 60px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${riskScore}%; height: 100%; background: ${getScoreColor(riskScore)}; border-radius: 3px;"></div>
                                    </div>
                                    <span style="font-weight: 700; font-size: 14px; color: ${getScoreColor(riskScore)}; min-width: 50px; text-align: right;">${riskScore}/100</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                                <span style="font-size: 13px; color: var(--text-secondary);">Confidence</span>
                                <span style="font-weight: 700; font-size: 14px;">${(ml.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${isAnomaly ? 'rgba(209, 52, 56, 0.1)' : 'var(--background)'}; border-radius: 6px; ${isAnomaly ? 'border: 1px solid rgba(209, 52, 56, 0.3);' : ''}">
                                <span style="font-size: 13px; color: var(--text-secondary);">Anomaly Detected</span>
                                <span style="font-weight: 700; font-size: 14px; color: ${isAnomaly ? '#D13438' : '#2EA44F'}; display: flex; align-items: center; gap: 4px;">
                                    ${isAnomaly ? '<span style="font-size: 16px;">üö®</span> YES' : '<span style="font-size: 16px;">‚úì</span> NO'}
                                </span>
                            </div>
                            ${ml.threat_type ? `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                                <span style="font-size: 13px; color: var(--text-secondary);">Threat Type</span>
                                <span style="font-weight: 600; font-size: 13px;">${ml.threat_type}</span>
                            </div>
                            ` : ''}
                        </div>
                    ` : '<div style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 20px;">ML model not available</div>'}
                </div>

                <!-- GeoIP Card -->
                <div class="detection-card" style="padding: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease; cursor: pointer;"
                     onmouseenter="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.12)'"
                     onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #2EA44F20, #2EA44F40); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(46, 164, 79, 0.2);">
                            <span style="font-size: 22px;">üåç</span>
                        </div>
                        <div style="flex: 1;">
                            <h5 style="margin: 0; font-size: 15px; font-weight: 700; color: var(--text-primary);">GeoLocation</h5>
                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">Geographic & network info</div>
                        </div>
                    </div>
                    <div style="display: grid; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                            <span style="font-size: 13px; color: var(--text-secondary);">Location</span>
                            <span style="font-weight: 600; font-size: 13px;">${geo.city || 'Unknown'}, ${geo.country || 'Unknown'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                            <span style="font-size: 13px; color: var(--text-secondary);">ISP</span>
                            <span style="font-weight: 600; font-size: 12px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${geo.isp || 'Unknown'}">${geo.isp || 'Unknown'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--background); border-radius: 6px;">
                            <span style="font-size: 13px; color: var(--text-secondary);">Network Type</span>
                            <span style="font-size: 12px;">${networkFlagsStr}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Analysis -->
            ${history && history.total_events > 0 ? `
            <div style="margin-bottom: 20px; padding: 20px; background: var(--card-bg); border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                    <div style="width: 36px; height: 36px; background: #E6A50220; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 18px;">üìä</span>
                    </div>
                    <h5 style="margin: 0; font-size: 14px; font-weight: 600;">Historical Analysis</h5>
                    <span style="font-size: 11px; color: var(--text-tertiary); margin-left: auto;">From Database</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px;">
                    <div style="text-align: center; padding: 16px 10px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--azure-blue);">${history.total_events.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Total Events</div>
                    </div>
                    <div style="text-align: center; padding: 16px 10px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: #D13438;">${history.failed_attempts.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Failed Attempts</div>
                    </div>
                    <div style="text-align: center; padding: 16px 10px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: #2EA44F;">${history.successful_logins.toLocaleString()}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Successful</div>
                    </div>
                    <div style="text-align: center; padding: 16px 10px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: #E6A502;">${history.unique_usernames}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Usernames</div>
                    </div>
                    <div style="text-align: center; padding: 16px 10px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700;">${history.unique_servers}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Servers</div>
                    </div>
                    <div style="text-align: center; padding: 16px 10px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: ${getScoreColor(history.avg_risk_score)};">${history.avg_risk_score}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Avg Risk</div>
                    </div>
                </div>
                ${history.top_usernames && history.top_usernames.length > 0 ? `
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <span style="font-size: 12px; color: var(--text-secondary);">Top Targeted Usernames:</span>
                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                        ${history.top_usernames.map(u => `
                            <span style="padding: 4px 10px; background: var(--background); border-radius: 4px; font-size: 12px; font-weight: 500;">
                                ${u.target_username} <span style="color: var(--text-tertiary); font-weight: 400;">(${u.attempts})</span>
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
            ` : ''}

            <!-- AI Security Analysis & Recommendations -->
            ${recommendations && recommendations.length > 0 ? `
            <div id="recommendations-section" style="margin-top: 24px; padding: 28px; background: linear-gradient(135deg, var(--card-bg), var(--background)); border-radius: 16px; border: 3px solid ${recommendations[0].priority === 'critical' ? '#D13438' : recommendations[0].priority === 'high' ? '#E6A502' : '#0078D4'}; box-shadow: 0 8px 24px rgba(0,0,0,0.15); position: relative; overflow: hidden;">
                <!-- Decorative Background -->
                <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, ${getPriorityColor(recommendations[0].priority)}15, transparent); border-radius: 50%; pointer-events: none;"></div>

                <!-- Header -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; position: relative;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, ${getPriorityColor(recommendations[0].priority)}, ${getPriorityColor(recommendations[0].priority)}CC); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px ${getPriorityColor(recommendations[0].priority)}40;">
                            <span style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">ü§ñ</span>
                        </div>
                        <div>
                            <h5 style="margin: 0; font-size: 20px; font-weight: 800; background: linear-gradient(135deg, ${getPriorityColor(recommendations[0].priority)}, var(--text-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AI Security Analysis</h5>
                            <div style="font-size: 13px; color: var(--text-tertiary); margin-top: 4px; font-weight: 500;">
                                ${recommendations.length} intelligent recommendation${recommendations.length > 1 ? 's' : ''} ‚Ä¢ Powered by Machine Learning
                            </div>
                        </div>
                    </div>
                    <button onclick="dismissAllRecommendations()" style="padding: 8px 16px; background: var(--background); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='var(--hover-bg)';" onmouseout="this.style.background='var(--background)';">
                        Dismiss All
                    </button>
                </div>

                <!-- Recommendations List (Full Details Inline) -->
                <div style="margin-bottom: 28px; display: grid; gap: 16px;">
                    ${recommendations.map((rec, index) => `
                        <div id="rec-card-${index}" style="padding: 20px; background: ${getPriorityBg(rec.priority)}; border-radius: 12px; border-left: 5px solid ${getPriorityColor(rec.priority)}; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s; position: relative; overflow: hidden;" onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.12)';" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)';">
                            <!-- Priority Indicator -->
                            <div style="position: absolute; top: 0; right: 0; padding: 6px 16px; background: ${getPriorityColor(rec.priority)}; color: white; font-size: 10px; font-weight: 800; border-bottom-left-radius: 10px; letter-spacing: 0.5px;">${rec.priority.toUpperCase()}</div>

                            <!-- Header -->
                            <div style="display: flex; align-items: start; gap: 16px; margin-bottom: 16px;">
                                <div style="font-size: 36px; flex-shrink: 0; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">${rec.icon}</div>
                                <div style="flex: 1; padding-right: 80px;">
                                    <div style="font-weight: 800; font-size: 17px; color: var(--text-primary); margin-bottom: 8px; line-height: 1.3;">
                                        ${rec.action}
                                    </div>
                                    <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                                        ${rec.reason}
                                    </div>
                                </div>
                            </div>

                            <!-- Evidence Section -->
                            ${rec.evidence && rec.evidence.length > 0 ? `
                                <div style="background: rgba(255,255,255,0.5); padding: 14px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid ${getPriorityColor(rec.priority)};">
                                    <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">Supporting Evidence</div>
                                    ${rec.evidence.filter(e => e).map(e => `
                                        <div style="display: flex; align-items: start; gap: 8px; margin-bottom: 4px;">
                                            <span style="color: ${getPriorityColor(rec.priority)}; font-size: 16px; line-height: 1.4;">‚Ä¢</span>
                                            <span style="font-size: 13px; color: var(--text-primary); line-height: 1.4;">${e}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}

                            <!-- AI Confidence -->
                            ${rec.ai_confidence ? `
                                <div style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.4); padding: 12px; border-radius: 8px;">
                                    <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px;">AI Confidence:</span>
                                    <div style="flex: 1; background: rgba(0,0,0,0.1); border-radius: 6px; height: 8px; overflow: hidden;">
                                        <div style="width: ${rec.ai_confidence * 100}%; height: 100%; background: ${getPriorityColor(rec.priority)}; border-radius: 6px; transition: width 0.3s;"></div>
                                    </div>
                                    <span style="font-size: 14px; font-weight: 800; color: ${getPriorityColor(rec.priority)}; min-width: 45px; text-align: right;">${(rec.ai_confidence * 100).toFixed(0)}%</span>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                <!-- Consolidated Action Buttons -->
                <div style="border-top: 3px solid var(--border); padding-top: 24px; background: rgba(255,255,255,0.5); margin: 0 -28px -28px -28px; padding: 24px 28px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 4px; height: 24px; background: linear-gradient(to bottom, var(--azure-blue), transparent); border-radius: 2px;"></div>
                        <div style="font-size: 15px; font-weight: 800; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px;">Quick Actions</div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        ${getConsolidatedActions(recommendations, data.ip)}
                    </div>
                </div>
            </div>
            ` : ''}
        `;
    }

    // Track executed actions to prevent duplicates
    window.executedActions = window.executedActions || new Set();

    // Mark action as executed
    function markActionExecuted(actionType, ip) {
        const key = `${actionType}-${ip}`;
        window.executedActions.add(key);

        // Update UI - find and disable button
        const buttons = document.querySelectorAll(`button[data-action-key="${key}"]`);
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = '‚úì Executed';
        });
    }

    // Check if action was executed
    function isActionExecuted(actionType, ip) {
        return window.executedActions.has(`${actionType}-${ip}`);
    }

    // Consolidate actions from all recommendations
    function getConsolidatedActions(recommendations, ip) {
        if (!recommendations || recommendations.length === 0) {
            return '<div style="color: var(--text-tertiary); font-size: 13px;">No actionable recommendations</div>';
        }

        const actions = new Map();

        recommendations.forEach(rec => {
            const type = rec.action_type;
            if (!actions.has(type)) {
                actions.set(type, {
                    type: type,
                    icon: rec.icon,
                    label: rec.action,
                    priority: rec.priority,
                    data: rec.action_data,
                    count: 1,
                    rec: rec
                });
            } else {
                actions.get(type).count++;
            }
        });

        const buttons = [];
        const priorityOrder = {'critical': 0, 'high': 1, 'medium': 2, 'low': 3};

        // Sort by priority
        const sortedActions = Array.from(actions.values()).sort((a, b) =>
            priorityOrder[a.priority] - priorityOrder[b.priority]
        );

        // Generate buttons for ALL action types
        sortedActions.forEach(action => {
            const actionKey = `${action.type}-${ip}`;
            const isExecuted = isActionExecuted(action.type, ip);

            const color = getPriorityColor(action.priority);
            const btnStyle = isExecuted
                ? `padding: 12px 24px; background: #2EA44F; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; opacity: 0.7;`
                : `padding: 12px 24px; background: ${color}; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; box-shadow: 0 2px 8px ${color}30;`;
            const hoverStyle = isExecuted ? '' : `onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px ${color}50';" onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 8px ${color}30';"`;
            const count = action.count > 1 ? ` <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 12px; font-size: 11px;">${action.count}</span>` : '';
            const disabled = isExecuted ? 'disabled' : '';

            if (isExecuted) {
                buttons.push(`<button data-action-key="${actionKey}" style="${btnStyle}" ${disabled}>‚úì Executed</button>`);
                return;
            }

            switch(action.type) {
                case 'block_ip':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="executeBlockIP('${ip}', 'Threat detected')" style="${btnStyle}" ${hoverStyle}>${action.icon} Block IP Now${count}</button>`);
                    break;
                case 'add_blocklist':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="addToBlocklist('${ip}', 'Recommended by AI')" style="${btnStyle}" ${hoverStyle}>üìã Add to Blocklist (Review)${count}</button>`);
                    break;
                case 'view_events':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showEventsModal('${ip}'); markActionExecuted('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>${action.icon} View Events${count}</button>`);
                    break;
                case 'create_rule':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showCreateRuleModal('${ip}')" style="${btnStyle}" ${hoverStyle}>${action.icon} Create Alert${count}</button>`);
                    break;
                case 'rate_limit':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showRateLimitModal('${ip}')" style="${btnStyle}" ${hoverStyle}>${action.icon} Enable Rate Limit${count}</button>`);
                    break;
                case 'review_policy':
                    // Skip - this is shown only as recommendation, not as quick action
                    break;
                case 'ai_honeypot':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showAIActionModal('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>üçØ Deploy Honeypot${count}</button>`);
                    break;
                case 'ai_auth_hardening':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showAIActionModal('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>üõ°Ô∏è Harden Auth${count}</button>`);
                    break;
                case 'ai_monitor':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showAIActionModal('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>üëÅÔ∏è Monitor${count}</button>`);
                    break;
                case 'ai_geo_block':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showAIActionModal('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>üåç Geo Block${count}</button>`);
                    break;
                case 'ai_temporal_limit':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showAIActionModal('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>‚è±Ô∏è Temporal Limit${count}</button>`);
                    break;
                case 'ai_account_protection':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showAIActionModal('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>üîê Protect Accounts${count}</button>`);
                    break;
                case 'ai_preemptive':
                    buttons.push(`<button data-action-key="${actionKey}" onclick="showAIActionModal('${action.type}', '${ip}')" style="${btnStyle}" ${hoverStyle}>‚ö° Preemptive Block${count}</button>`);
                    break;
                default:
                    // For unknown action types, show generic button
                    if (action.type !== 'info') {
                        buttons.push(`<button onclick="alert('Action: ${action.label}')" style="${btnStyle}" ${hoverStyle}>${action.icon} ${action.label}${count}</button>`);
                    }
            }
        });

        return buttons.length > 0 ? buttons.join('') : '<div style="color: var(--text-tertiary); font-size: 13px;">No actions available</div>';
    }

    // Show recommendation details in modal
    window.showRecDetails = function(index, rec, ip) {
        const modal = document.createElement('div');
        modal.id = 'rec-details-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;';

        modal.innerHTML = `
            <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 3px solid ${getPriorityColor(rec.priority)};" onclick="event.stopPropagation()">
                <div style="padding: 24px; background: linear-gradient(135deg, ${getPriorityColor(rec.priority)}, ${getPriorityColor(rec.priority)}CC); color: white;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 48px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">${rec.icon}</div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; font-size: 22px; font-weight: 700;">${rec.action}</h3>
                            <div style="margin-top: 4px;">
                                <span style="padding: 4px 12px; background: rgba(255,255,255,0.3); color: white; font-size: 11px; font-weight: 700; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px;">${rec.priority} PRIORITY</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="max-height: calc(85vh - 140px); overflow-y: auto;">

                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600; color: var(--text-tertiary);">REASON</h4>
                        <p style="margin: 0; font-size: 14px; line-height: 1.6;">${rec.reason}</p>
                    </div>

                    ${rec.evidence && rec.evidence.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600; color: var(--text-tertiary);">SUPPORTING EVIDENCE</h4>
                        <div style="background: var(--background); padding: 12px; border-radius: 8px;">
                            ${rec.evidence.map(e => `
                                <div style="margin-bottom: 6px; font-size: 13px; display: flex; align-items: center; gap: 8px;">
                                    <span style="color: ${getPriorityColor(rec.priority)};">‚Ä¢</span>
                                    <span>${e}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${rec.ai_confidence ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600; color: var(--text-tertiary);">AI CONFIDENCE</h4>
                        <div style="background: var(--background); padding: 12px; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="flex: 1; background: rgba(0,0,0,0.1); border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div style="width: ${rec.ai_confidence * 100}%; height: 100%; background: ${getPriorityColor(rec.priority)};"></div>
                                </div>
                                <span style="font-weight: 700; font-size: 14px;">${(rec.ai_confidence * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div style="margin-top: 20px;">
                        ${getActionButtonForType(rec.action_type, rec.action_data, ip)}
                    </div>
                </div>
            </div>
        `;

        modal.onclick = () => closeModal();
        document.body.appendChild(modal);
    };

    window.closeModal = function() {
        const modals = document.querySelectorAll('[id$="-modal"]');
        modals.forEach(modal => modal.remove());
    };

    // Show events modal (no navigation)
    window.showEventsModal = async function(ip) {
        const modal = document.createElement('div');
        modal.id = 'events-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;';

        modal.innerHTML = `
            <div style="background: white; border-radius: 16px; max-width: 900px; width: 95%; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 3px solid #0078D4; display: flex; flex-direction: column;">
                <div style="padding: 24px; background: linear-gradient(135deg, #0078D4, #005BA1); color: white;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 48px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">üîç</div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; font-size: 22px; font-weight: 700;">Authentication Events</h3>
                            <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">IP: <code style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-weight: 700;">${ip}</code></p>
                        </div>
                    </div>
                </div>
                <div id="events-content" style="padding: 20px; overflow-y: auto; flex: 1;">
                    <div style="text-align: center; padding: 40px;">Loading events...</div>
                </div>
            </div>
        `;

        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        document.body.appendChild(modal);

        // Fetch events
        try {
            const response = await fetch(`/api/events/recent?ip=${ip}&limit=50`);
            const data = await response.json();

            if (data.success && data.events) {
                document.getElementById('events-content').innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-tertiary);">Time</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-tertiary);">Type</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-tertiary);">User</th>
                                <th style="padding: 12px; text-align: left; font-size: 12px; color: var(--text-tertiary);">Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.events.map(e => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px; font-size: 13px;">${new Date(e.timestamp).toLocaleString()}</td>
                                    <td style="padding: 12px;">
                                        <span style="padding: 4px 8px; background: ${e.event_type === 'failed' ? '#D1343820' : '#2EA44F20'}; color: ${e.event_type === 'failed' ? '#D13438' : '#2EA44F'}; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                            ${e.event_type}
                                        </span>
                                    </td>
                                    <td style="padding: 12px; font-size: 13px;">${e.target_username || 'N/A'}</td>
                                    <td style="padding: 12px; font-size: 13px; font-weight: 600; color: ${e.ml_risk_score >= 70 ? '#D13438' : e.ml_risk_score >= 50 ? '#E6A502' : '#2EA44F'};">
                                        ${e.ml_risk_score || 'N/A'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                document.getElementById('events-content').innerHTML = '<p style="text-align: center; color: var(--text-tertiary);">No events found for this IP.</p>';
            }
        } catch (error) {
            document.getElementById('events-content').innerHTML = `<p style="text-align: center; color: #D13438;">Error loading events: ${error.message}</p>`;
        }
    };

    // Show create rule modal (no navigation)
    window.showCreateRuleModal = function(ip) {
        const modal = document.createElement('div');
        modal.id = 'create-rule-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;';

        modal.innerHTML = `
            <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 3px solid #E6A502; overflow: hidden;">
                <div style="padding: 24px; background: linear-gradient(135deg, #E6A502, #CC8E00); color: white;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 48px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">üìä</div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; font-size: 22px; font-weight: 700;">Create Alert Rule</h3>
                            <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">IP: <code style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-weight: 700;">${ip}</code></p>
                        </div>
                    </div>
                </div>
                <div style="padding: 20px;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Rule Type</label>
                        <select id="rule-type" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--background);">
                            <option value="threshold">Threshold (count-based)</option>
                            <option value="rate_limit">Rate Limit (time-based)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Max Attempts</label>
                        <input type="number" id="rule-threshold" value="5" min="1" max="100" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--background);">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">Time Window (minutes)</label>
                        <input type="number" id="rule-window" value="5" min="1" max="60" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--background);">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="createAlertRuleInline('${ip}')" style="flex: 1; padding: 12px; background: var(--azure-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Create Rule
                        </button>
                        <button onclick="closeModal()" style="padding: 12px 20px; background: var(--background); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;

        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        document.body.appendChild(modal);
    };

    window.createAlertRuleInline = function(ip) {
        const ruleType = document.getElementById('rule-type').value;
        const threshold = document.getElementById('rule-threshold').value;
        const timeWindow = document.getElementById('rule-window').value;

        // Store in sessionStorage for the actual rules page to pick up
        sessionStorage.setItem('newRuleData', JSON.stringify({
            ip: ip,
            rule_type: ruleType,
            threshold: parseInt(threshold),
            time_window: parseInt(timeWindow) * 60,
            severity: 'high',
            action: 'pre_configured'
        }));

        // Mark as executed
        markActionExecuted('create_rule', ip);
        markActionExecuted('rate_limit', ip);  // Also mark rate_limit since they use same modal

        showNotification(`Alert rule configured for IP ${ip}. Visit Notification Rules page to activate.`, 'success');
        closeModal();
        trackActionCompleted('create_rule', ip, true);
    };

    window.showRateLimitModal = function(ip) {
        showCreateRuleModal(ip);
        // Pre-select rate limit type
        setTimeout(() => {
            const select = document.getElementById('rule-type');
            if (select) select.value = 'rate_limit';
        }, 100);
    };

    // Show AI Action modal with details
    window.showAIActionModal = function(actionType, ip) {
        const aiActions = {
            'ai_honeypot': {
                title: 'Deploy Honeypot',
                icon: 'üçØ',
                description: 'Deploy deception technology to trap and analyze attacker behavior',
                details: 'This creates a fake SSH service that logs all interaction attempts, helping identify attack patterns and tools used.'
            },
            'ai_auth_hardening': {
                title: 'Harden Authentication',
                icon: 'üõ°Ô∏è',
                description: 'Strengthen authentication requirements and security policies',
                details: 'Implements stricter authentication rules including key-only auth, longer timeout periods, and enhanced logging.'
            },
            'ai_monitor': {
                title: 'Silent Monitoring',
                icon: 'üëÅÔ∏è',
                description: 'Monitor this IP without blocking to gather intelligence',
                details: 'Allows connections while logging all activity for analysis. Useful for understanding attack methods before blocking.'
            },
            'ai_geo_block': {
                title: 'Geographic Blocking',
                icon: 'üåç',
                description: 'Block all traffic from this geographic region',
                details: 'Prevents all connections from the detected country/region. Useful when attacks originate from specific locations.'
            },
            'ai_temporal_limit': {
                title: 'Adaptive Rate Limiting',
                icon: '‚è±Ô∏è',
                description: 'Apply intelligent time-based connection limits',
                details: 'Dynamically adjusts connection rates based on behavior patterns, becoming stricter during suspicious activity.'
            },
            'ai_account_protection': {
                title: 'Account Protection',
                icon: 'üîê',
                description: 'Protect high-value accounts from targeted attacks',
                details: 'Implements additional security for accounts that are being specifically targeted, including 2FA requirements.'
            },
            'ai_preemptive': {
                title: 'Preemptive Containment',
                icon: '‚ö°',
                description: 'Block threat before it escalates based on AI prediction',
                details: 'Uses machine learning to predict attack escalation and blocks preemptively before damage occurs.'
            }
        };

        const action = aiActions[actionType] || {
            title: 'AI Action',
            icon: 'ü§ñ',
            description: 'Execute AI-powered security action',
            details: 'This action is powered by machine learning analysis of threat patterns.'
        };

        const modal = document.createElement('div');
        modal.id = 'ai-action-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s;';

        modal.innerHTML = `
            <div style="background: white; border-radius: 16px; max-width: 550px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 3px solid var(--azure-blue); overflow: hidden;" onclick="event.stopPropagation()">
                <!-- Header -->
                <div style="padding: 24px; background: linear-gradient(135deg, #0078D4, #005BA1); color: white;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 48px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">${action.icon}</div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0; font-size: 22px; font-weight: 700;">${action.title}</h3>
                            <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">AI-Powered Security Action</p>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div style="padding: 24px;">
                    <div style="background: rgba(0, 120, 212, 0.1); padding: 16px; border-radius: 8px; border-left: 4px solid var(--azure-blue); margin-bottom: 20px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--azure-blue);">DESCRIPTION</div>
                        <p style="margin: 0; font-size: 14px; line-height: 1.6;">${action.description}</p>
                    </div>

                    <div style="background: var(--background); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">HOW IT WORKS</div>
                        <p style="margin: 0; font-size: 13px; line-height: 1.6; color: var(--text-secondary);">${action.details}</p>
                    </div>

                    <div style="background: linear-gradient(135deg, rgba(46, 164, 79, 0.1), rgba(46, 164, 79, 0.05)); padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #2EA44F;">TARGET</div>
                        <div style="font-family: monospace; font-size: 14px; font-weight: 700; color: var(--text-primary);">IP: ${ip}</div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px;">
                        <button onclick="executeAIAction('${actionType}', '${ip}')"
                                style="flex: 1; padding: 14px; background: linear-gradient(135deg, var(--azure-blue), #0056b3); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3); transition: all 0.2s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 120, 212, 0.4)';"
                                onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0, 120, 212, 0.3)';">
                            ‚úì Execute Action
                        </button>
                        <button onclick="closeModal()"
                                style="padding: 14px 24px; background: var(--background); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s;"
                                onmouseover="this.style.background='var(--hover-bg)';"
                                onmouseout="this.style.background='var(--background)';">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <style>
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            </style>
        `;

        modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        document.body.appendChild(modal);
    };

    // Execute AI Action
    window.executeAIAction = async function(actionType, ip) {
        closeModal();

        const actionMessages = {
            'ai_honeypot': `Deploying honeypot service for IP ${ip}. A fake SSH service will log all interaction attempts.`,
            'ai_auth_hardening': `Strengthening authentication for connections from ${ip}. Requiring key-only auth and enhanced logging.`,
            'ai_monitor': `Enabling silent monitoring for IP ${ip}. All activity will be logged without blocking.`,
            'ai_geo_block': `Blocking geographic region for IP ${ip}. All connections from this region will be denied.`,
            'ai_temporal_limit': `Applying adaptive rate limiting to IP ${ip}. Connection rates will be dynamically adjusted.`,
            'ai_account_protection': `Protecting targeted accounts from IP ${ip}. Enhanced security measures activated for high-value accounts.`,
            'ai_preemptive': `Preemptively blocking IP ${ip} based on ML prediction. Threat contained before escalation.`
        };

        const message = actionMessages[actionType] || `AI Action executed for IP ${ip}.`;

        // Mark as executed FIRST
        markActionExecuted(actionType, ip);

        showNotification(message, 'success');
        trackActionCompleted(actionType, ip, true);

        // TODO: Call backend API to actually execute the action
        // Example:
        // try {
        //     const response = await fetch('/api/ai/actions/execute', {
        //         method: 'POST',
        //         headers: {'Content-Type': 'application/json'},
        //         body: JSON.stringify({ action_type: actionType, ip: ip })
        //     });
        //     const result = await response.json();
        //     if (result.success) {
        //         showNotification(result.message, 'success');
        //     }
        // } catch (error) {
        //     showNotification('Failed to execute AI action', 'error');
        // }

        console.log(`[AI Action] Type: ${actionType}, IP: ${ip}, Message: ${message}`);
    };

    function getActionButtonForType(actionType, actionData, ip) {
        const btnStyle = 'padding: 12px 24px; background: var(--azure-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%;';

        switch(actionType) {
            case 'block_ip':
                return `<button onclick="closeModal(); executeBlockIP('${ip}', '${encodeURIComponent(actionData?.reason || 'Threat detected')}')" style="${btnStyle}">üö´ Block IP Now</button>`;
            case 'view_events':
                return `<button onclick="closeModal(); showEventsModal('${ip}')" style="${btnStyle}">üîç View Events</button>`;
            case 'create_rule':
            case 'rate_limit':
                return `<button onclick="closeModal(); showCreateRuleModal('${ip}')" style="${btnStyle}">üìä Create Alert Rule</button>`;
            default:
                return `<button onclick="closeModal()" style="${btnStyle}">Close</button>`;
        }
    }

    // Get overall threat status for the header
    function getOverallThreatStatus(abuseScore, riskScore, threatLevel, isAnomaly) {
        const numAbuseScore = abuseScore === 'N/A' ? 0 : abuseScore;
        const numRiskScore = riskScore === 'N/A' ? 0 : riskScore;

        if (threatLevel === 'critical' || threatLevel === 'high' || numAbuseScore >= 80 || numRiskScore >= 80 || isAnomaly) {
            return {
                icon: 'üö®',
                title: 'High Threat Detected',
                subtitle: 'Immediate action recommended',
                bgGradient: 'rgba(209, 52, 56, 0.15), rgba(209, 52, 56, 0.05)',
                borderColor: '#D13438',
                textColor: '#D13438',
                scoreColor: '#D13438'
            };
        } else if (threatLevel === 'medium' || numAbuseScore >= 50 || numRiskScore >= 50) {
            return {
                icon: '‚ö†Ô∏è',
                title: 'Moderate Risk',
                subtitle: 'Enhanced monitoring advised',
                bgGradient: 'rgba(230, 165, 2, 0.15), rgba(230, 165, 2, 0.05)',
                borderColor: '#E6A502',
                textColor: '#E6A502',
                scoreColor: '#E6A502'
            };
        } else if (numAbuseScore >= 20 || numRiskScore >= 20) {
            return {
                icon: 'üëÄ',
                title: 'Low Risk',
                subtitle: 'Continue monitoring',
                bgGradient: 'rgba(0, 120, 212, 0.15), rgba(0, 120, 212, 0.05)',
                borderColor: '#0078D4',
                textColor: '#0078D4',
                scoreColor: '#0078D4'
            };
        } else {
            return {
                icon: '‚úÖ',
                title: 'Clean Profile',
                subtitle: 'No significant threats detected',
                bgGradient: 'rgba(46, 164, 79, 0.15), rgba(46, 164, 79, 0.05)',
                borderColor: '#2EA44F',
                textColor: '#2EA44F',
                scoreColor: '#2EA44F'
            };
        }
    }

    // Render action button based on recommendation type
    function renderActionButton(rec, ip) {
        const actionType = rec.action_type;
        const actionData = rec.action_data || {};

        if (actionType === 'info') {
            return ''; // No action button for info-only recommendations
        }

        const buttonStyles = `
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            border: none;
        `;

        const primaryBtn = `${buttonStyles} background: ${getPriorityColor(rec.priority)}; color: white;`;
        const secondaryBtn = `${buttonStyles} background: var(--background); color: var(--text-primary); border: 1px solid var(--border);`;

        switch (actionType) {
            case 'block_ip':
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="executeBlockIP('${ip}', '${encodeURIComponent(actionData.reason || '')}')" style="${primaryBtn}">
                            üö´ Block IP Now
                        </button>
                        <button onclick="navigateToPage('ip-blocks')" style="${secondaryBtn}">
                            View Blocking Rules
                        </button>
                    </div>
                `;
            case 'add_blocklist':
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="addToBlocklist('${ip}', '${encodeURIComponent(actionData.reason || '')}')" style="${primaryBtn}">
                            üìã Add to Blocklist
                        </button>
                        <button onclick="navigateToPage('ip-blocks')" style="${secondaryBtn}">
                            Manage Blocklist
                        </button>
                    </div>
                `;
            case 'view_events':
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="viewIPEvents('${ip}', '${actionData.filter || ''}')" style="${primaryBtn}">
                            üîç View Events
                        </button>
                        <button onclick="navigateToPage('ip-stats', '${ip}')" style="${secondaryBtn}">
                            IP Details
                        </button>
                    </div>
                `;
            case 'create_rule':
                const ruleType = actionData.rule_type || 'threshold';
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="createAlertRule('${ip}', '${ruleType}')" style="${primaryBtn}">
                            üìä Create Alert Rule
                        </button>
                        <button onclick="navigateToPage('notif-rules')" style="${secondaryBtn}">
                            View Rules
                        </button>
                    </div>
                `;
            case 'rate_limit':
                const failedAttempts = actionData.failed_attempts || 0;
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="enableRateLimiting('${ip}', ${failedAttempts})" style="${primaryBtn}">
                            ‚ö° Enable Rate Limiting
                        </button>
                        <button onclick="navigateToPage('rules')" style="${secondaryBtn}">
                            View All Rules
                        </button>
                    </div>
                `;
            case 'review_policy':
                const networkType = actionData.network_type || 'Unknown';
                const geoData = JSON.stringify(actionData).replace(/'/g, "\\'");
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick='reviewProxyPolicy("${networkType}", ${geoData})' style="${primaryBtn}">
                            üîí Review Policy
                        </button>
                        <button onclick="navigateToPage('settings-general')" style="${secondaryBtn}">
                            Go to Settings
                        </button>
                    </div>
                `;
            case 'ai_honeypot':
            case 'ai_auth_hardening':
            case 'ai_monitor':
            case 'ai_geo_block':
            case 'ai_temporal_limit':
            case 'ai_account_protection':
            case 'ai_preemptive':
                // AI-powered actions - show info and navigate to appropriate page
                const aiActionData = JSON.stringify(actionData).replace(/'/g, "\\'");
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick='handleAIAction("${actionType}", "${ip}", ${aiActionData})' style="${primaryBtn}">
                            ü§ñ Execute AI Action
                        </button>
                        <button onclick="showAIActionDetails('${actionType}', ${aiActionData})" style="${secondaryBtn}">
                            üìã View Details
                        </button>
                    </div>
                `;
            case 'navigate':
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="navigateToPage('${actionData.page || 'settings-general'}')" style="${primaryBtn}">
                            ‚öôÔ∏è Go to Settings
                        </button>
                    </div>
                `;
            default:
                return `
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="viewIPEvents('${ip}', '')" style="${secondaryBtn}">
                            üîç View IP Activity
                        </button>
                    </div>
                `;
        }
    }

    // Recommendation tracking
    let actionTracking = {};

    window.dismissRecommendation = function(index) {
        const card = document.getElementById(`rec-card-${index}`);
        if (card) {
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                card.style.display = 'none';
                actionTracking[`rec-${index}`] = { status: 'dismissed', timestamp: new Date().toISOString() };
                checkAllDismissed();
            }, 300);
        }
    };

    window.dismissAllRecommendations = function() {
        const recSection = document.getElementById('recommendations-section');
        const criticalAlert = document.getElementById('critical-recs-alert');
        if (recSection) {
            recSection.style.opacity = '0';
            recSection.style.transform = 'scale(0.95)';
            setTimeout(() => {
                recSection.style.display = 'none';
                if (criticalAlert) criticalAlert.style.display = 'none';
            }, 300);
        }
    };

    function checkAllDismissed() {
        const visibleCards = document.querySelectorAll('.recommendation-card[style*="display: none"]').length;
        const totalCards = document.querySelectorAll('.recommendation-card').length;
        if (visibleCards === totalCards) {
            setTimeout(() => {
                document.getElementById('recommendations-section').style.display = 'none';
                const criticalAlert = document.getElementById('critical-recs-alert');
                if (criticalAlert) criticalAlert.style.display = 'none';
            }, 500);
        }
    }

    function trackActionCompleted(actionType, ip, result) {
        const timestamp = new Date().toISOString();
        actionTracking[`${actionType}-${ip}`] = {
            status: result ? 'completed' : 'failed',
            timestamp: timestamp,
            type: actionType
        };
        console.log('[Action Tracking]', actionTracking);
    }

    // Action handlers
    window.executeBlockIP = async function(ip, reason) {
        console.log('[Block IP] Inline blocking initiated for:', ip);

        // First check if already blocked using correct endpoint
        try {
            const checkResponse = await fetch(`/api/dashboard/blocking/blocks/check/${ip}`, {
                credentials: 'same-origin'
            });
            const checkResult = await checkResponse.json();

            if (checkResult.success && checkResult.blocks && checkResult.blocks.length > 0) {
                showNotification(`IP ${ip} is already in blocklist`, 'info');
                markActionExecuted('block_ip', ip);
                trackActionCompleted('block_ip', ip, true);
                return;
            }
        } catch (error) {
            console.error('[Block IP] Error checking status:', error);
        }

        if (!confirm(`Block IP ${ip}?\n\nReason: ${decodeURIComponent(reason)}\n\nThis will immediately block all traffic from this IP.`)) {
            return;
        }

        // Show loading notification
        showNotification(`Blocking IP ${ip}...`, 'info');

        try {
            const response = await fetch('/api/dashboard/blocking/blocks/manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    ip_address: ip,
                    reason: decodeURIComponent(reason),
                    duration_minutes: 43200, // 30 days
                    source: 'simulation_quick_action'
                })
            });
            const data = await response.json();

            if (data.success) {
                // Mark as executed AFTER successful block
                markActionExecuted('block_ip', ip);
                showNotification(`‚úì IP ${ip} blocked successfully and added to blocklist`, 'success');
                trackActionCompleted('block_ip', ip, true);
            } else {
                showNotification('Failed to block IP: ' + (data.error || 'Unknown error'), 'error');
                trackActionCompleted('block_ip', ip, false);
            }
        } catch (error) {
            showNotification('Error blocking IP: ' + error.message, 'error');
            trackActionCompleted('block_ip', ip, false);
        }
    };

    window.addToBlocklist = async function(ip, reason) {
        // Mark as executed
        markActionExecuted('add_blocklist', ip);

        // This navigates to blocking page with pre-filled data for manual review
        sessionStorage.setItem('blockIPData', JSON.stringify({
            ip: ip,
            reason: decodeURIComponent(reason),
            duration: 'permanent',
            source: 'demo_recommendation'
        }));
        window.location.hash = 'ip-blocks';
        showNotification(`Opening IP Blocks page to add ${ip} to permanent blocklist`, 'info');
        trackActionCompleted('add_blocklist', ip, true);
    };

    window.viewIPEvents = function(ip, filter) {
        // Set filter data in sessionStorage for events page to pick up
        sessionStorage.setItem('eventsFilter', JSON.stringify({
            ip: ip,
            filter: filter || '',
            applyFilter: true
        }));
        window.location.hash = 'events-live';
        showNotification(`Viewing events for IP ${ip}`, 'info');
        trackActionCompleted('view_events', ip, true);
    };

    window.createAlertRule = function(ip, ruleType) {
        // Navigate to notifications page with pre-filled data to auto-create rule
        const ruleData = {
            ip: ip,
            rule_type: ruleType || 'threshold',
            action: 'auto_create',
            threshold: 5,
            time_window: 300, // 5 minutes
            severity: 'high',
            enabled: true
        };
        sessionStorage.setItem('newRuleData', JSON.stringify(ruleData));
        window.location.hash = 'notif-rules';
        showNotification(`Creating alert rule for IP ${ip} - configure and save`, 'info');
        trackActionCompleted('create_rule', ip, true);
    };

    window.navigateToPage = function(page, param) {
        if (param) {
            // For IP stats page, store IP in sessionStorage
            if (page === 'ip-stats') {
                sessionStorage.setItem('selectedIP', param);
            }
            window.location.hash = page;
        } else {
            window.location.hash = page;
        }
    };

    window.enableRateLimiting = function(ip, failedAttempts) {
        // Create a specific rate limit rule for this IP
        const ruleData = {
            target_type: 'ip',
            target_value: ip,
            action: 'create_rate_limit',
            max_attempts: 5,
            time_window: 60, // 1 minute
            block_duration: 3600, // 1 hour
            reason: `Auto rate-limit: ${failedAttempts} failed attempts detected`,
            enabled: true
        };
        sessionStorage.setItem('rateLimitRule', JSON.stringify(ruleData));
        window.location.hash = 'rules';
        showNotification(`Creating rate limit rule for IP ${ip}`, 'info');
        trackActionCompleted('rate_limit', ip, true);
    };

    window.reviewProxyPolicy = function(networkType, geo) {
        // Navigate to settings with specific focus on anonymization policy
        sessionStorage.setItem('settingsFocus', JSON.stringify({
            section: 'security',
            subsection: 'anonymization_policy',
            network_type: networkType,
            country: geo?.country || 'Unknown'
        }));
        window.location.hash = 'settings-general';
        showNotification(`Review anonymization network policy (${networkType})`, 'info');
        trackActionCompleted('review_policy', networkType, true);
    };

    // AI Action Handlers
    window.handleAIAction = function(actionType, ip, actionData) {
        // Store AI action data
        sessionStorage.setItem('aiActionPending', JSON.stringify({
            type: actionType,
            ip: ip,
            data: actionData,
            timestamp: new Date().toISOString()
        }));

        // Route to appropriate page based on action type
        const routingMap = {
            'ai_honeypot': 'ip-blocks',
            'ai_auth_hardening': 'settings-general',
            'ai_monitor': 'events-live',
            'ai_geo_block': 'ip-blocks',
            'ai_temporal_limit': 'rules',
            'ai_account_protection': 'settings-general',
            'ai_preemptive': 'ip-blocks'
        };

        const targetPage = routingMap[actionType] || 'settings-general';
        window.location.hash = targetPage;

        showNotification(`AI Action: ${actionType.replace('ai_', '').replace(/_/g, ' ')} - Configure on next page`, 'info');
        trackActionCompleted(actionType, ip, true);
    };

    window.showAIActionDetails = function(actionType, actionData) {
        // Show a modal with AI action details
        const details = JSON.stringify(actionData, null, 2);
        const modal = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                <div style="background: var(--card-bg); padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                    <h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">ü§ñ</span>
                        AI Action Details
                    </h3>
                    <div style="background: var(--background); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Action Type:</div>
                        <div style="color: var(--azure-blue); font-family: monospace;">${actionType}</div>
                    </div>
                    <div style="background: var(--background); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">Configuration:</div>
                        <pre style="margin: 0; font-size: 12px; overflow-x: auto; color: var(--text-primary);">${details}</pre>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px 20px; background: var(--azure-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modal);
    };

    // Helper function for notifications
    function showNotification(message, type) {
        if (typeof showToast === 'function') {
            showToast(message, type);
        } else if (typeof alert !== 'undefined') {
            alert(message);
        }
    }

    function getPriorityColor(priority) {
        const colors = { critical: '#D13438', high: '#E6A502', medium: '#0078D4', low: '#2EA44F' };
        return colors[priority] || '#666';
    }

    function getPriorityBg(priority) {
        const colors = { critical: 'rgba(209, 52, 56, 0.1)', high: 'rgba(230, 165, 2, 0.1)', medium: 'rgba(0, 120, 212, 0.05)', low: 'rgba(46, 164, 79, 0.05)' };
        return colors[priority] || 'var(--background)';
    }

    function getScoreColor(score) {
        if (score === 'N/A') return 'var(--text-secondary)';
        if (score >= 80) return '#D13438';
        if (score >= 50) return '#E6A502';
        if (score >= 20) return '#0078D4';
        return '#2EA44F';
    }

    function getThreatLevelColor(level) {
        const colors = {
            'high': '#D13438',
            'medium': '#E6A502',
            'low': '#0078D4',
            'clean': '#2EA44F',
            'unknown': '#666'
        };
        return colors[level?.toLowerCase()] || '#666';
    }

    // Run All Demo
    document.getElementById('demo-run-all-btn').addEventListener('click', async () => {
        const btn = document.getElementById('demo-run-all-btn');
        const resultsPanel = document.getElementById('demo-results-panel');
        const resultsContent = document.getElementById('demo-results-content');

        btn.disabled = true;
        btn.innerHTML = '<span>Running all scenarios...</span>';

        // Reset all cards
        document.querySelectorAll('.demo-scenario-card').forEach(card => {
            card.style.borderColor = 'var(--border)';
        });

        try {
            const response = await fetch('/api/demo/run-all', {
                method: 'POST',
                credentials: 'same-origin'
            });
            const data = await response.json();

            if (data.success) {
                resultsPanel.style.display = 'block';

                // Mark successful scenarios
                data.results.forEach(r => {
                    const card = document.querySelector(`.demo-scenario-card[data-scenario="${r.scenario_id}"]`);
                    if (card) {
                        card.style.borderColor = r.success ? '#2EA44F' : '#D13438';
                    }
                });

                // Render summary
                resultsContent.innerHTML = `
                    <div style="margin-bottom: 16px; padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border);">
                        <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Demo Summary</h5>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: 600;">${data.summary.total_scenarios}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Total Scenarios</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 600; color: #2EA44F;">${data.summary.successful}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Successful</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 600; color: #D13438;">${data.summary.anomalies_detected}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Anomalies Detected</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 600; color: #E6A502;">${data.summary.high_risk_detected}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">High Risk (>60)</div>
                            </div>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: var(--background);">
                                    <th style="padding: 10px; text-align: left;">Scenario</th>
                                    <th style="padding: 10px; text-align: left;">IP</th>
                                    <th style="padding: 10px; text-align: center;">AbuseIPDB</th>
                                    <th style="padding: 10px; text-align: center;">VirusTotal</th>
                                    <th style="padding: 10px; text-align: center;">Risk Score</th>
                                    <th style="padding: 10px; text-align: center;">Anomaly</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.results.map(r => `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 10px;">${r.scenario_name || r.scenario_id}</td>
                                        <td style="padding: 10px;"><code style="font-size: 11px;">${r.ip || '-'}</code></td>
                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: ${getScoreColor(r.results?.abuseipdb_score)};">
                                            ${r.results?.abuseipdb_score !== null ? r.results.abuseipdb_score : '-'}
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            ${r.results?.virustotal_positives !== null ? r.results.virustotal_positives : '-'}
                                        </td>
                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: ${getScoreColor(r.results?.risk_score)};">
                                            ${r.results?.risk_score !== null ? r.results.risk_score : '-'}
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            ${r.results?.is_anomaly ? 'üö®' : (r.results?.ml_available ? '‚úì' : '-')}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                resultsContent.innerHTML = `<div style="color: #D13438; padding: 10px;">Error: ${data.error}</div>`;
                resultsPanel.style.display = 'block';
            }
        } catch (error) {
            resultsContent.innerHTML = `<div style="color: #D13438; padding: 10px;">Error: ${error.message}</div>`;
            resultsPanel.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>‚ñ∂ Run Full Demo</span>';
        }
    });

    // Load demo scenarios when simulation page is initialized
    const origInitSimulation = initSimulation;
    initSimulation = function() {
        origInitSimulation();
        loadDemoScenarios();
    };
})();
</script>
