<!-- SSH Guardian v3.0 - Fail2ban Page (Standalone) -->
<div id="page-fail2ban" class="page-content" style="display: none;">
    <div class="ev-header">
        <div>
            <h1>Fail2ban Events</h1>
            <p>Monitor ban/unban actions from Fail2ban</p>
        </div>
        <button class="refresh-btn" onclick="F2B.refresh()">
            <span class="refresh-icon">↻</span> Refresh
        </button>
    </div>

    <div class="ev-filters">
        <input type="text" id="f2bPageIp" placeholder="Filter IP...">
        <select id="f2bPageAction"><option value="">All Actions</option><option value="ban">Bans</option><option value="unban">Unbans</option></select>
        <select id="f2bPageAgent"><option value="">All Agents</option></select>
        <select id="f2bPageTime"><option value="24h">24 Hours</option><option value="7d" selected>7 Days</option><option value="30d">30 Days</option></select>
        <button class="ev-apply" onclick="F2B.load(1)">Apply</button>
    </div>

    <div class="ev-card">
        <div id="f2bPageLoad" class="ev-msg">Loading...</div>
        <div id="f2bPageNone" class="ev-msg" style="display:none">No events found</div>
        <div id="f2bPageErr" class="ev-msg err" style="display:none">Failed to load</div>
        <div class="ev-tbl-wrap">
            <table id="f2bPageTbl" class="ev-tbl" style="display:none">
                <thead><tr><th>Last Activity</th><th>IP Address</th><th>Location</th><th>Actions</th><th>Failures</th><th>Risk</th><th></th></tr></thead>
                <tbody id="f2bPageBody"></tbody>
            </table>
        </div>
    </div>

    <div id="f2bPagePg" class="ev-pg" style="display:none">
        <span id="f2bPageInfo"></span>
        <div><button onclick="F2B.load(F2B.pg-1)">← Prev</button><button onclick="F2B.load(F2B.pg+1)">Next →</button></div>
    </div>
</div>

<!-- Modal -->
<div id="f2bModal" class="ev-modal" style="display:none" onclick="if(event.target===this)F2B.closeModal()">
    <div class="ev-modal-box" onclick="event.stopPropagation()">
        <div class="ev-modal-hdr">
            <div>
                <h2 id="f2bModalTitle">IP Details</h2>
                <span id="f2bModalAgent"></span>
            </div>
            <button onclick="F2B.closeModal()">×</button>
        </div>
        <div class="ev-modal-tabs">
            <button class="active" onclick="F2B.modalTab('analysis')">Analysis</button>
            <button onclick="F2B.modalTab('history')">History</button>
        </div>
        <div class="ev-modal-body">
            <div id="f2bMAnalysis" class="ev-modal-pane active"></div>
            <div id="f2bMHistory" class="ev-modal-pane"></div>
        </div>
        <div class="ev-modal-ftr"><button onclick="F2B.closeModal()">Close</button></div>
    </div>
</div>

<style>
/* Fail2ban Page - Uses shared CSS components:
   - events-table.css (.ev-* classes)
   - cell-badges.css (.c-* classes)
   - analysis-modal.css (.m-* and .h-* classes)
   Page-specific overrides only below */

/* Modal scope selector for f2bModal */
#page-fail2ban ~ #f2bModal,
#f2bModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    box-sizing: border-box;
}
</style>

<script>
const F2B = {
    pg: 1,
    rowData: [],
    mIP: '',
    mData: null,
    blockedIPs: new Set(),

    async init() {
        await this.loadAgents();
        await this.loadBlockedList();
        this.load(1);
    },

    async loadBlockedList() {
        try {
            const r = await fetch('/api/dashboard/blocking/blocks/list?is_active=true&limit=1000');
            const d = await r.json();
            if (d.success && d.blocks) this.blockedIPs = new Set(d.blocks.map(b => b.ip_address));
        } catch (e) {}
    },

    async loadAgents() {
        try {
            const r = await fetch('/api/agents/list');
            const d = await r.json();
            if (d.success && d.agents) {
                const s = document.getElementById('f2bPageAgent');
                d.agents.forEach(a => s.add(new Option(a.hostname || a.agent_id, a.id)));
            }
        } catch (e) {}
    },

    refresh() { this.loadBlockedList(); this.load(1); },

    async load(pg = 1) {
        this.pg = pg;
        const $ = id => document.getElementById(id);
        $('f2bPageBody').innerHTML = '';
        $('f2bPageLoad').style.display = 'block';
        $('f2bPageTbl').style.display = 'none';
        $('f2bPageNone').style.display = 'none';
        $('f2bPageErr').style.display = 'none';
        $('f2bPagePg').style.display = 'none';

        try {
            const ip = $('f2bPageIp')?.value || '';
            const action = $('f2bPageAction')?.value || '';
            const agent = $('f2bPageAgent')?.value || '';
            const time = $('f2bPageTime')?.value || '7d';
            let url = `/api/agents/fail2ban/grouped?time_range=${time}&limit=30&offset=${(pg - 1) * 30}&_t=${Date.now()}`;
            if (ip) url += `&ip=${encodeURIComponent(ip)}`;
            if (action) url += `&action=${action}`;
            if (agent) url += `&agent_id=${agent}`;

            const r = await fetch(url);
            const d = await r.json();
            $('f2bPageLoad').style.display = 'none';

            if (d.success && d.groups?.length) {
                this.rowData = d.groups;
                $('f2bPageBody').innerHTML = d.groups.map((g, i) => this.renderRow(g, i)).join('');
                $('f2bPageTbl').style.display = 'table';
                if (d.pagination) {
                    $('f2bPageInfo').textContent = `${d.pagination.offset + 1}-${Math.min(d.pagination.offset + d.groups.length, d.pagination.total)} of ${d.pagination.total}`;
                    $('f2bPagePg').querySelectorAll('button')[0].disabled = d.pagination.offset === 0;
                    $('f2bPagePg').querySelectorAll('button')[1].disabled = !d.pagination.has_more;
                    $('f2bPagePg').style.display = 'flex';
                }
            } else {
                $('f2bPageNone').style.display = 'block';
            }
        } catch (e) {
            $('f2bPageLoad').style.display = 'none';
            $('f2bPageErr').style.display = 'block';
        }
    },

    renderRow(g, idx) {
        const loc = g.location || {};
        const flag = this.getFlag(loc.country_code);
        const risk = g.max_risk_score || 0;
        const cls = risk >= 80 ? 'crit' : risk >= 60 ? 'high' : risk >= 40 ? 'med' : 'low';
        const tags = this.getTags(loc);
        const blocked = this.blockedIPs.has(g.ip_address);

        return `<tr>
            <td>${this.fmtTime(g.latest_timestamp)}</td>
            <td><div class="c-ip">${this.esc(g.ip_address)}</div>${tags}</td>
            <td class="c-loc"><div>${flag} ${loc.city || ''} ${loc.country_code || ''}</div>${loc.isp ? `<div class="isp">${this.esc(loc.isp)}</div>` : ''}</td>
            <td><div class="c-att"><span class="b">${g.ban_count || 0} ban</span><span class="u">${g.unban_count || 0} unban</span></div></td>
            <td><span class="c-users">${g.total_failures || 0}</span></td>
            <td><div class="c-risk"><span>${Math.round(risk)}</span><div class="c-risk-bar"><div class="c-risk-fill ${cls}" style="width:${risk}%"></div></div></div></td>
            <td><button class="c-detail" onclick="F2B.openModal(${idx})">Details</button>${blocked ? '<span class="c-status">Blocked</span>' : ''}</td>
        </tr>`;
    },

    openModal(idx) {
        const g = this.rowData[idx];
        if (!g) return;
        this.mIP = g.ip_address;
        this.mData = g;
        document.getElementById('f2bModalTitle').textContent = `IP: ${g.ip_address}`;
        document.getElementById('f2bModalAgent').textContent = g.agent?.hostname ? `Agent: ${g.agent.hostname}` : '';
        document.getElementById('f2bModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        this.modalTab('analysis');
    },

    closeModal() {
        document.getElementById('f2bModal').style.display = 'none';
        document.body.style.overflow = '';
    },

    modalTab(t) {
        document.querySelectorAll('#f2bModal .ev-modal-tabs button').forEach((b, i) => b.classList.toggle('active', t === 'analysis' ? i === 0 : i === 1));
        document.querySelectorAll('#f2bModal .ev-modal-pane').forEach(p => p.classList.remove('active'));
        document.getElementById(t === 'analysis' ? 'f2bMAnalysis' : 'f2bMHistory').classList.add('active');
        if (t === 'analysis') this.renderAnalysis();
        else this.loadHistory();
    },

    renderAnalysis() {
        const d = this.mData;
        if (!d) return;
        const loc = d.location || {};
        const threat = d.threat || {};
        const risk = d.max_risk_score || 0;
        const rc = risk >= 80 ? '#991b1b' : risk >= 60 ? '#dc2626' : risk >= 40 ? '#d97706' : '#16a34a';
        const flag = this.getFlag(loc.country_code);
        const blocked = this.blockedIPs.has(this.mIP);

        document.getElementById('f2bMAnalysis').innerHTML = `
            <div class="m-stats">
                <div class="m-stat"><div class="m-stat-val red">${d.ban_count || 0}</div><div class="m-stat-lbl">Bans</div></div>
                <div class="m-stat"><div class="m-stat-val green">${d.unban_count || 0}</div><div class="m-stat-lbl">Unbans</div></div>
                <div class="m-stat"><div class="m-stat-val">${d.event_count || 0}</div><div class="m-stat-lbl">Events</div></div>
                <div class="m-stat"><div class="m-stat-val blue">${d.total_failures || 0}</div><div class="m-stat-lbl">Failures</div></div>
                <div class="m-stat"><div class="m-stat-val" style="color:${rc}">${Math.round(risk)}</div><div class="m-stat-lbl">Risk</div></div>
                <div class="m-stat"><div class="m-stat-val">${d.unique_agents || 1}</div><div class="m-stat-lbl">Agents</div></div>
            </div>
            <div class="m-cards">
                <div class="m-card"><h4>Location</h4>
                    <div class="m-row"><span class="l">Country</span><span class="v">${flag} ${loc.country_name || 'Unknown'}</span></div>
                    <div class="m-row"><span class="l">City</span><span class="v">${loc.city || 'Unknown'}</span></div>
                    <div class="m-row"><span class="l">ISP</span><span class="v">${loc.isp || 'Unknown'}</span></div>
                </div>
                <div class="m-card"><h4>Network</h4>
                    <div class="m-row"><span class="l">IP</span><span class="v">${this.mIP}</span></div>
                    <div class="m-row"><span class="l">Status</span><span class="v">${blocked ? '<span class="c-status">Blocked</span>' : 'Active'}</span></div>
                    <div class="m-row"><span class="l">Jails</span><span class="v">${d.jails || 'sshd'}</span></div>
                </div>
            </div>
            <div class="m-sec"><h4>Risk Analysis</h4>
                <div class="m-meter"><div class="m-meter-bar"><div class="m-meter-fill" style="width:${risk}%;background:${rc}"></div></div><div class="m-meter-val" style="color:${rc}">${Math.round(risk)}</div></div>
            </div>
            <div class="m-sec"><h4>Threat Intel</h4>
                <div class="m-intel">
                    <div class="m-intel-item"><div class="src">AbuseIPDB</div><div class="score" style="color:${(threat.abuseipdb_score || 0) > 50 ? '#dc2626' : '#16a34a'}">${threat.abuseipdb_score || 0}%</div></div>
                    <div class="m-intel-item"><div class="src">Risk</div><div class="score" style="color:${rc}">${risk >= 80 ? 'Critical' : risk >= 60 ? 'High' : risk >= 40 ? 'Medium' : 'Low'}</div></div>
                    <div class="m-intel-item"><div class="src">Bans</div><div class="score">${d.ban_count || 0}</div></div>
                </div>
            </div>`;
    },

    async loadHistory() {
        document.getElementById('f2bMHistory').innerHTML = '<div class="h-load">Loading...</div>';
        try {
            const r = await fetch(`/api/agents/fail2ban/by-ip?ip=${encodeURIComponent(this.mIP)}&page_size=100&time_range=30d`);
            const d = await r.json();
            if (d.success && d.events?.length) {
                const bans = d.events.filter(e => e.event_type === 'ban').length;
                const unbans = d.events.filter(e => e.event_type === 'unban').length;
                document.getElementById('f2bMHistory').innerHTML = `
                    <div class="h-over">
                        <div class="h-stat"><div class="h-stat-val">${d.events.length}</div><div class="h-stat-lbl">Total</div></div>
                        <div class="h-stat"><div class="h-stat-val red">${bans}</div><div class="h-stat-lbl">Bans</div></div>
                        <div class="h-stat"><div class="h-stat-val green">${unbans}</div><div class="h-stat-lbl">Unbans</div></div>
                    </div>
                    <div class="h-wrap"><table class="h-tbl"><thead><tr><th>Time</th><th>IP</th><th>Jail</th><th>Action</th><th>Failures</th></tr></thead>
                    <tbody>${d.events.map(e => `<tr>
                        <td>${this.fmtTime(e.timestamp)}</td>
                        <td style="font-family:monospace;color:var(--azure-blue)">${this.esc(e.source_ip || e.ip)}</td>
                        <td>${this.esc(e.jail_name || 'sshd')}</td>
                        <td><span class="c-badge ${e.event_type}">${e.event_type}</span></td>
                        <td>${e.failures || 0}</td>
                    </tr>`).join('')}</tbody></table></div>`;
            } else {
                document.getElementById('f2bMHistory').innerHTML = '<div class="h-load">No events found</div>';
            }
        } catch (e) {
            document.getElementById('f2bMHistory').innerHTML = '<div class="h-load">Error loading</div>';
        }
    },

    esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; },
    getFlag(cc) { return cc ? String.fromCodePoint(...cc.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0))) : ''; },
    getTags(loc) {
        const t = [loc.is_tor && 'tor', loc.is_vpn && 'vpn', loc.is_proxy && 'proxy'].filter(Boolean);
        return t.length ? `<div class="c-tags">${t.map(x => `<span class="c-tag ${x}">${x.toUpperCase()}</span>`).join('')}</div>` : '';
    },
    fmtTime(t) {
        if (!t) return '-';
        if (window.TimeSettings?.isLoaded()) return window.TimeSettings.formatFull(t);
        const d = new Date(t);
        return d.toLocaleString();
    }
};

window.loadFail2banPage = () => F2B.init();
window.F2B = F2B;
</script>
