<!-- SSH Guardian v3.0 - Unified Firewall Management (UFW + Fail2ban) -->
<div id="page-firewall" class="page-content" style="display: none;">
    <div class="page-header-with-cache">
        <div>
            <h1 class="page-title">Firewall & Blocking</h1>
            <p class="page-subtitle">Manage Fail2ban bans, UFW rules, and IP blocks</p>
        </div>
        <div class="page-header-actions" style="display: flex; gap: 12px; align-items: center;">
            <button id="recentActivityBtn" onclick="toggleRecentActivityPanel(event)" class="activity-toggle-btn">
                <span>üìã</span> Recent Activity
            </button>
            <div class="cache-indicator loading" data-cache-endpoint="firewall">
                <span class="cache-status-dot"></span>
                <span class="cache-indicator-text">Loading...</span>
                <button class="cache-refresh-btn" onclick="loadFirewallPage()" title="Refresh">‚Üª</button>
            </div>
        </div>
    </div>

    <!-- Agent Selector -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
            <div style="flex: 1; min-width: 250px;">
                <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px;">Select Server</label>
                <select id="firewallAgentSelector" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface);">
                    <option value="">-- Select a server --</option>
                </select>
            </div>
            <div style="display: flex; gap: 8px; align-items: flex-end;">
                <button id="syncNowBtn" onclick="requestFirewallSync()" style="display: none; padding: 10px 20px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    üîÑ Sync Now
                </button>
            </div>
        </div>
    </div>

    <!-- No Agent Selected -->
    <div id="firewallNoAgent" class="card" style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">üõ°Ô∏è</div>
        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Select a Server</h3>
        <p style="color: var(--text-secondary); font-size: 14px;">Choose a server from the dropdown to manage firewall and blocking.</p>
    </div>

    <!-- Firewall Content -->
    <div id="firewallContent" style="display: none;">

        <!-- Agent Health & Quick Stats Row -->
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px; align-items: start;">
            <!-- Agent Health -->
            <div class="card" id="agentHealthCard" style="margin: 0;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div id="agentHealthIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;"></div>
                    <h3 id="agentHealthHostname" style="font-size: 16px; font-weight: 600; margin: 0;">-</h3>
                    <span id="agentHealthStatus" class="rule-badge" style="background: var(--surface);">Unknown</span>
                    <span id="agentHealthIP" style="font-family: monospace; font-size: 13px; color: var(--text-secondary);">-</span>
                </div>
                <div id="agentApprovalStatus" style="display: none; margin-top: 10px; padding: 8px 12px; background: rgba(255, 185, 0, 0.1); border-radius: 4px; color: #CC9400; font-size: 12px;">
                    ‚ö†Ô∏è Agent not approved - <a href="#" onclick="approveAgentFromFirewall()" style="color: #CC9400; font-weight: 600;">Approve Now</a>
                </div>
            </div>

            <!-- Quick Stats -->
            <div style="display: flex; gap: 12px;">
                <div class="card" style="padding: 12px 16px; margin: 0; text-align: center; min-width: 80px;">
                    <div id="stat-f2b-bans" style="font-size: 24px; font-weight: 700; color: #ef4444;">-</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Bans</div>
                </div>
                <div class="card" style="padding: 12px 16px; margin: 0; text-align: center; min-width: 80px;">
                    <div id="stat-fw-status" style="font-size: 14px; font-weight: 600;">-</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">UFW</div>
                </div>
                <div class="card" style="padding: 12px 16px; margin: 0; text-align: center; min-width: 80px;">
                    <div id="stat-fw-allowed" style="font-size: 24px; font-weight: 700; color: #10b981;">-</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Allow</div>
                </div>
                <div class="card" style="padding: 12px 16px; margin: 0; text-align: center; min-width: 80px;">
                    <div id="stat-fw-blocked" style="font-size: 24px; font-weight: 700; color: #f59e0b;">-</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">Deny</div>
                </div>
            </div>
        </div>

        <!-- Main Content: Full Width Tabs -->
        <div>
            <!-- Tab Navigation -->
            <div class="fw-tabs" style="display: flex; gap: 0; margin-bottom: 0; border-bottom: 2px solid var(--border);">
                <button class="fw-tab active" data-tab="fail2ban" onclick="switchFirewallTab('fail2ban')">
                    üîí Fail2ban
                </button>
                <button class="fw-tab" data-tab="ufw" onclick="switchFirewallTab('ufw')">
                    üî• UFW Rules
                </button>
                <button class="fw-tab" data-tab="blocked" onclick="switchFirewallTab('blocked')">
                    üö´ Blocked IPs
                </button>
                <button class="fw-tab" data-tab="rules" onclick="switchFirewallTab('rules')">
                    üìã Blocking Rules
                </button>
            </div>

                <!-- Tab: Fail2ban Bans (Default) -->
                <div id="tab-fail2ban" class="fw-tab-content card" style="border-top-left-radius: 0; margin-top: 0;">
                    <!-- Fail2ban Stats Row -->
                    <div class="f2b-stats-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="f2bStatActive">0</div>
                            <div class="f2b-stat-label">Active Bans</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="f2bStatTotal">0</div>
                            <div class="f2b-stat-label">Total Bans (24h)</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="f2bStatRepeat">0</div>
                            <div class="f2b-stat-label">Repeat Offenders</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="f2bStatEscalated">0</div>
                            <div class="f2b-stat-label">Escalated to UFW</div>
                        </div>
                    </div>

                    <!-- Sub-tabs for Active / History -->
                    <div style="display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border);">
                        <button class="f2b-subtab active" data-subtab="active" onclick="switchF2bSubtab('active')">
                            Active Bans
                        </button>
                        <button class="f2b-subtab" data-subtab="history" onclick="switchF2bSubtab('history')">
                            Ban History
                        </button>
                        <button class="f2b-subtab" data-subtab="threats" onclick="switchF2bSubtab('threats')">
                            Threat Analysis
                        </button>
                    </div>

                    <!-- Active Bans Sub-tab -->
                    <div id="f2b-subtab-active" class="f2b-subtab-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span id="f2bBanCount" style="font-size: 12px; color: var(--text-secondary);">0 active</span>
                            <button onclick="loadFail2banBans()" style="padding: 6px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; font-size: 12px; cursor: pointer;">
                                üîÑ Refresh
                            </button>
                        </div>

                        <div id="f2bBansLoading" style="text-align: center; padding: 30px; color: var(--text-secondary); display: none;">
                            Loading fail2ban bans...
                        </div>

                        <div id="f2bBansContainer" style="max-height: 400px; overflow-y: auto;">
                            <div id="f2bBansList"></div>
                        </div>

                        <div id="f2bNoBans" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 32px; margin-bottom: 12px;">‚úÖ</div>
                            <p style="margin: 0; font-weight: 500;">No Active Bans</p>
                            <p style="margin: 8px 0 0 0; font-size: 13px;">All clear! No IPs are currently banned by Fail2ban.</p>
                        </div>
                    </div>

                    <!-- Ban History Sub-tab -->
                    <div id="f2b-subtab-history" class="f2b-subtab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <select id="f2bHistoryRange" onchange="loadF2bHistory()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--surface);">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                            <button onclick="loadF2bHistory()" style="padding: 6px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; font-size: 12px; cursor: pointer;">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div id="f2bHistoryLoading" style="text-align: center; padding: 20px; color: var(--text-secondary); display: none;">
                            Loading history...
                        </div>
                        <div id="f2bHistoryList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <!-- Threat Analysis Sub-tab -->
                    <div id="f2b-subtab-threats" class="f2b-subtab-content" style="display: none;">
                        <div class="f2b-threat-info" style="padding: 16px; background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.1)); border-radius: 8px; margin-bottom: 16px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text-primary);">üß† ML-Enhanced Blocking</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                                SSH Guardian analyzes each banned IP using machine learning to determine threat level.
                                High-risk IPs are automatically escalated to permanent UFW blocks.
                            </p>
                        </div>
                        <div id="f2bThreatList" style="max-height: 350px; overflow-y: auto;"></div>
                        <div id="f2bNoThreats" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            <p style="margin: 0;">No threat analysis data available yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: UFW Rules -->
                <div id="tab-ufw" class="fw-tab-content card" style="display: none; border-top-left-radius: 0; margin-top: 0;">
                    <!-- Quick Actions -->
                    <div style="margin-bottom: 20px;">
                        <div class="card-title" style="margin-bottom: 12px;">Quick Actions</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="quickAction('allow-ssh')" class="quick-action-sm">üîê Allow SSH</button>
                            <button onclick="quickAction('allow-http')" class="quick-action-sm">üåê Allow HTTP/S</button>
                            <button onclick="quickAction('limit-ssh')" class="quick-action-sm">‚è±Ô∏è Rate Limit SSH</button>
                            <button id="ufwToggleBtn" onclick="toggleUFW()" class="quick-action-sm ufw-toggle-btn" data-status="unknown">
                                <span class="toggle-icon">üî•</span>
                                <span class="toggle-text">UFW Loading...</span>
                            </button>
                        </div>
                    </div>

                    <!-- Add Rule Form -->
                    <div style="margin-bottom: 20px; padding: 16px; background: var(--background); border-radius: 4px;">
                        <div class="card-title" style="margin-bottom: 12px;">Add Rule</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                            <select id="simpleRuleAction" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface);">
                                <option value="ACCEPT">‚úÖ Allow</option>
                                <option value="DROP">üö´ Block</option>
                            </select>
                            <select id="simpleRulePort" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface);" onchange="toggleCustomPort(this)">
                                <option value="any">Any Port</option>
                                <option value="22">SSH (22)</option>
                                <option value="80">HTTP (80)</option>
                                <option value="443">HTTPS (443)</option>
                                <option value="3306">MySQL (3306)</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input type="text" id="simpleRuleCustomPort" placeholder="Port" style="display: none; width: 80px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px;">
                            <select id="simpleRuleProtocol" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface);">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                                <option value="all">All</option>
                            </select>
                            <input type="text" id="simpleRuleCustomSource" placeholder="From IP (optional)" style="width: 140px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px;">
                            <button onclick="addSimpleRule()" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                ‚ûï Add
                            </button>
                        </div>
                        <div id="addRuleMessage" style="display: none; margin-top: 10px; padding: 8px 12px; border-radius: 4px; font-size: 12px;"></div>
                    </div>

                    <!-- Current Rules -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div class="card-title" style="margin: 0;">Current Rules</div>
                            <select id="filterRuleType" onchange="filterSimpleRules()" style="padding: 4px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
                                <option value="all">All</option>
                                <option value="allow">Allow</option>
                                <option value="block">Block</option>
                            </select>
                        </div>

                        <div id="simpleRulesLoading" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            Loading rules...
                        </div>

                        <div id="simpleRulesContainer" style="display: none; max-height: 400px; overflow-y: auto;">
                            <div id="simpleRulesList"></div>
                        </div>

                        <div id="noRulesMessage" style="display: none; text-align: center; padding: 30px; color: var(--text-secondary);">
                            <div style="font-size: 24px; margin-bottom: 8px;">üìã</div>
                            <p style="margin: 0;">No UFW rules configured</p>
                        </div>

                        <div id="noFirewallDataWarning" style="display: none; text-align: center; padding: 30px; color: var(--text-secondary);">
                            <div style="font-size: 24px; margin-bottom: 8px;">üìã</div>
                            <p style="margin: 0;">No firewall data yet</p>
                            <p style="font-size: 12px; margin: 8px 0 0 0;">Click "Sync Now" to fetch data from agent</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Blocked IPs -->
                <div id="tab-blocked" class="fw-tab-content card" style="display: none; border-top-left-radius: 0; margin-top: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="card-title" style="margin: 0;">Currently Blocked IPs</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="blockedSourceFilter" onchange="filterBlockedIPs()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--surface);">
                                <option value="all">All Sources</option>
                                <option value="fail2ban">Fail2ban</option>
                                <option value="rule_based">Rule-based (UFW)</option>
                                <option value="manual">Manual</option>
                                <option value="ml_model">ML Model</option>
                            </select>
                            <button onclick="loadBlockedIPs()" style="padding: 6px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; font-size: 12px; cursor: pointer;">
                                üîÑ Refresh
                            </button>
                            <button onclick="showBlockIPModal()" style="padding: 6px 14px; background: #D13438; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">
                                ‚ûï Block IP
                            </button>
                        </div>
                    </div>

                    <!-- Blocked Stats -->
                    <div class="blocked-stats-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="blockedStatTotal">0</div>
                            <div class="f2b-stat-label">Total Blocked</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="blockedStatFail2ban">0</div>
                            <div class="f2b-stat-label">Fail2ban</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="blockedStatUFW">0</div>
                            <div class="f2b-stat-label">UFW (Permanent)</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="blockedStatML">0</div>
                            <div class="f2b-stat-label">ML Auto-blocked</div>
                        </div>
                    </div>

                    <div id="blockedIPsLoading" style="text-align: center; padding: 30px; color: var(--text-secondary); display: none;">
                        Loading blocked IPs...
                    </div>

                    <div id="blockedIPsContainer" style="max-height: 450px; overflow-y: auto;">
                        <div id="blockedIPsList"></div>
                    </div>

                    <div id="noBlockedIPs" style="text-align: center; padding: 40px; color: var(--text-secondary); display: none;">
                        <div style="font-size: 32px; margin-bottom: 12px;">‚úÖ</div>
                        <p style="margin: 0; font-weight: 500;">No Blocked IPs</p>
                        <p style="margin: 8px 0 0 0; font-size: 13px;">No IP addresses are currently blocked.</p>
                    </div>
                </div>

                <!-- Tab: Blocking Rules -->
                <div id="tab-rules" class="fw-tab-content" style="display: none; margin-top: 0;">
                    <!-- Overall Blocking Statistics -->
                    <div id="fwOverallBlockingStats" class="card" style="margin-bottom: 16px; display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--azure-blue);" id="fwStatTotalBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Total Blocks</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #107C10;" id="fwStatActiveBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Active</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #8A8886;" id="fwStatManualBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Manual</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #0078D4;" id="fwStatRuleBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Rule-Based</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #FFB900;" id="fwStatRecent24h">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Last 24h</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card" style="margin-bottom: 16px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button id="fwShowCreateRuleForm" style="padding: 8px 14px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                ‚ûï Create Rule
                            </button>
                            <button id="fwRefreshRules" style="padding: 8px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 13px;">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Create Rule Form (Hidden by default) -->
                    <div id="fwCreateRuleForm" class="card" style="display: none; margin-bottom: 16px;">
                        <div class="card-title">Create Blocking Rule</div>
                        <div style="display: grid; gap: 12px; max-width: 600px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Rule Name *</label>
                                <input type="text" id="fwRuleName" placeholder="Brute Force Protection" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Rule Type *</label>
                                <select id="fwRuleType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px;">
                                    <option value="">Select type...</option>
                                    <option value="brute_force">Brute Force Detection</option>
                                    <option value="ml_threshold">ML Risk Threshold</option>
                                    <option value="api_reputation">API Reputation (AbuseIPDB)</option>
                                    <option value="velocity">Velocity / DDoS Detection</option>
                                    <option value="distributed_brute_force">Distributed Brute Force</option>
                                    <option value="account_takeover">Account Takeover Detection</option>
                                    <option value="off_hours_anomaly">Off-Hours Anomaly</option>
                                    <option value="repeat_offender">Repeat Offender Escalation</option>
                                </select>
                            </div>
                            <div id="fwBruteForceConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Brute Force Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); border-left: 4px solid #f9a825; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #5d4037; margin-bottom: 6px;">How it works</div>
                                    <div style="font-size: 10px; color: #5d4037; line-height: 1.5;">
                                        Blocks an IP after X failed login attempts within Y minutes from the <strong>same IP address</strong>.
                                    </div>
                                    <div style="font-size: 10px; color: #6d4c41; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #bcaaa4;">
                                        <strong>Example:</strong> IP 192.168.1.100 tries passwords for "admin" 5 times in 10 minutes ‚Üí Blocked
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Failed Attempts</label>
                                        <input type="number" id="fwFailedAttempts" value="5" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Time Window (min)</label>
                                        <input type="number" id="fwTimeWindow" value="10" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- ML Threshold Conditions -->
                            <div id="fwMlConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">ML Threshold Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #1976d2; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #0d47a1; margin-bottom: 6px;">How it works (ML-Powered)</div>
                                    <div style="font-size: 10px; color: #1565c0; line-height: 1.5;">
                                        Uses <strong>Machine Learning</strong> to analyze behavior patterns and assign a risk score (0-100). Blocks when ML predicts the IP is malicious with high confidence.
                                    </div>
                                    <div style="font-size: 10px; color: #1565c0; margin-top: 6px;">
                                        <strong>ML analyzes:</strong> Login timing, username patterns, geographic anomalies, historical behavior
                                    </div>
                                    <div style="font-size: 10px; color: #0d47a1; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #90caf9;">
                                        <strong>Example:</strong> IP shows bot-like behavior (perfect timing, sequential usernames) ‚Üí Risk: 92, Confidence: 0.95 ‚Üí Blocked
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Min Risk Score</label>
                                        <input type="number" id="fwMinRiskScore" value="85" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Min Confidence</label>
                                        <input type="number" id="fwMlMinConfidence" value="0.8" step="0.1" min="0" max="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- API Reputation Conditions -->
                            <div id="fwApiConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">API Reputation Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border-left: 4px solid #c2185b; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #880e4f; margin-bottom: 6px;">How it works (API-Powered)</div>
                                    <div style="font-size: 10px; color: #ad1457; line-height: 1.5;">
                                        Queries <strong>AbuseIPDB</strong> & <strong>VirusTotal</strong> to check if the IP is reported as malicious by the global security community. Score 0-100 (higher = more reports).
                                    </div>
                                    <div style="font-size: 10px; color: #ad1457; margin-top: 6px;">
                                        <strong>APIs check:</strong> Spam reports, hacking attempts, malware distribution, botnet membership
                                    </div>
                                    <div style="font-size: 10px; color: #880e4f; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #f48fb1;">
                                        <strong>Example:</strong> IP 45.33.32.156 has AbuseIPDB score 95 (reported 500+ times for SSH attacks) ‚Üí Blocked immediately
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Min AbuseIPDB Score</label>
                                        <input type="number" id="fwMinAbuseScore" value="90" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Block on Success?</label>
                                        <select id="fwBlockOnSuccess" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
                                            <option value="true" selected>Yes</option>
                                            <option value="false">No (require failed login)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Velocity Conditions -->
                            <div id="fwVelocityConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Velocity / DDoS Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 4px solid #d32f2f; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #b71c1c; margin-bottom: 6px;">How it works</div>
                                    <div style="font-size: 10px; color: #c62828; line-height: 1.5;">
                                        Detects <strong>rapid-fire attacks</strong> by counting events per second. Blocks IPs sending too many requests too quickly (DDoS/automated attacks).
                                    </div>
                                    <div style="font-size: 10px; color: #b71c1c; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #ef9a9a;">
                                        <strong>Example:</strong> IP sends 25 login requests in 60 seconds (automated script) ‚Üí Blocked for DDoS-like behavior
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Max Events</label>
                                        <input type="number" id="fwMaxEvents" value="20" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Time Window (seconds)</label>
                                        <input type="number" id="fwTimeWindowSeconds" value="60" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- Repeat Offender Conditions -->
                            <div id="fwRepeatConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Repeat Offender Escalation</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-left: 4px solid #7b1fa2; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #4a148c; margin-bottom: 6px;">How it works</div>
                                    <div style="font-size: 10px; color: #6a1b9a; line-height: 1.5;">
                                        <strong>Increases block duration</strong> for IPs that keep coming back. Each offense gets a longer ban. Persistent attackers get permanently blocked.
                                    </div>
                                    <div style="font-size: 10px; color: #4a148c; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #ce93d8;">
                                        <strong>Escalation:</strong> 1st = base duration, 2nd = 2 days, 3rd = 7 days, 4th+ = 30 days
                                    </div>
                                </div>
                            </div>
                            <!-- Distributed Brute Force Conditions -->
                            <div id="fwDistributedBFConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Distributed Brute Force Detection</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-left: 4px solid #e65100; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #bf360c; margin-bottom: 6px;">How it works (ML + API Enhanced)</div>
                                    <div style="font-size: 10px; color: #d84315; line-height: 1.5;">
                                        Detects <strong>botnet-style attacks</strong> where many different IPs try many different usernames with LOW frequency per IP (to evade simple rate limits).
                                    </div>
                                    <div style="font-size: 10px; color: #d84315; margin-top: 6px;">
                                        <strong>ML Enhancement:</strong> Calculates "pattern score" based on IP distribution + username diversity + timing patterns<br>
                                        <strong>API Enhancement:</strong> Checks if participating IPs are known threat actors via AbuseIPDB
                                    </div>
                                    <div style="font-size: 10px; color: #bf360c; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #ffcc80;">
                                        <strong>Example:</strong> 8 different IPs each try 2-3 attempts on 15 different usernames in 1 hour ‚Üí Pattern detected as coordinated botnet attack ‚Üí All IPs blocked
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique IPs</label>
                                        <input type="number" id="fwDistBFUniqueIPs" value="5" min="2" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique Usernames</label>
                                        <input type="number" id="fwDistBFUniqueUsernames" value="10" min="3" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Time Window (min)</label>
                                        <input type="number" id="fwDistBFTimeWindow" value="60" min="10" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Max Attempts/IP (slow)</label>
                                        <input type="number" id="fwDistBFMaxPerIP" value="3" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- Account Takeover Conditions -->
                            <div id="fwAccountTakeoverConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Account Takeover Detection</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #2e7d32; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #1b5e20; margin-bottom: 6px;">How it works (GeoIP + API Enhanced)</div>
                                    <div style="font-size: 10px; color: #2e7d32; line-height: 1.5;">
                                        Detects <strong>credential stuffing</strong> where the SAME username is being tried from MULTIPLE IPs/countries in a short time (leaked credentials being tested globally).
                                    </div>
                                    <div style="font-size: 10px; color: #2e7d32; margin-top: 6px;">
                                        <strong>GeoIP Enhancement:</strong> Uses geolocation to detect geographic diversity (impossible travel)<br>
                                        <strong>API Enhancement:</strong> Weights threat score higher if attacking IPs have bad AbuseIPDB reputation
                                    </div>
                                    <div style="font-size: 10px; color: #1b5e20; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #a5d6a7;">
                                        <strong>Example:</strong> Username "john.doe" gets login attempts from USA, Russia, and China within 30 mins ‚Üí Credential likely leaked on dark web ‚Üí Block all attacking IPs
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique IPs/Username</label>
                                        <input type="number" id="fwATOUniqueIPs" value="3" min="2" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique Countries</label>
                                        <input type="number" id="fwATOUniqueCountries" value="2" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Time Window (min)</label>
                                        <input type="number" id="fwATOTimeWindow" value="30" min="5" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; padding-top: 18px;">
                                        <input type="checkbox" id="fwATOCheckThreatIntel" checked>
                                        <label for="fwATOCheckThreatIntel" style="font-size: 11px;">Use Threat Intel</label>
                                    </div>
                                </div>
                            </div>
                            <!-- Off-Hours Anomaly Conditions -->
                            <div id="fwOffHoursConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Off-Hours Anomaly Detection</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border-left: 4px solid #00838f; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #006064; margin-bottom: 6px;">How it works (Baseline + API Enhanced)</div>
                                    <div style="font-size: 10px; color: #00838f; line-height: 1.5;">
                                        Detects login attempts <strong>outside business hours</strong> or on weekends. Compares against each user's historical login patterns to detect anomalies.
                                    </div>
                                    <div style="font-size: 10px; color: #00838f; margin-top: 6px;">
                                        <strong>Baseline Learning:</strong> Learns each user's typical login hours from 30-day history<br>
                                        <strong>API Enhancement:</strong> Multiplies threat score if IP has bad reputation (1.5x-2x multiplier)
                                    </div>
                                    <div style="font-size: 10px; color: #006064; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #80deea;">
                                        <strong>Example:</strong> User "admin" normally logs in 9am-5pm. Attempt at 3am from suspicious IP (AbuseIPDB: 45) ‚Üí Flagged as potential compromise ‚Üí Require approval before block
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Work Start Hour</label>
                                        <input type="number" id="fwOffHoursStart" value="8" min="0" max="23" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Work End Hour</label>
                                        <input type="number" id="fwOffHoursEnd" value="18" min="0" max="23" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Off-Hours Attempts</label>
                                        <input type="number" id="fwOffHoursMinAttempts" value="3" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 16px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" id="fwOffHoursCheckBaseline" checked>
                                        <label for="fwOffHoursCheckBaseline" style="font-size: 11px;">Check User Baseline</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" id="fwOffHoursRequireApproval" checked>
                                        <label for="fwOffHoursRequireApproval" style="font-size: 11px;">Require Approval</label>
                                    </div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Block Duration (min)</label>
                                    <input type="number" id="fwRuleBlockDuration" value="1440" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Priority</label>
                                    <input type="number" id="fwRulePriority" value="50" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Description</label>
                                <textarea id="fwRuleDescription" placeholder="Rule description..." style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; min-height: 60px; box-sizing: border-box;"></textarea>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button id="fwSubmitCreateRule" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    Create Rule
                                </button>
                                <button id="fwCancelRuleForm" style="padding: 8px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Rules Table -->
                    <div class="card">
                        <div id="fwRulesLoading" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            Loading blocking rules...
                        </div>
                        <div id="fwRulesTable" style="display: none;">
                            <div class="table-wrapper" style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 700px;">
                                    <thead>
                                        <tr style="background: var(--background); border-bottom: 2px solid var(--border);">
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Rule Name</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Type</th>
                                            <th style="padding: 10px; text-align: center; font-weight: 600;">Priority</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Conditions</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Stats</th>
                                            <th style="padding: 10px; text-align: center; font-weight: 600;">Status</th>
                                            <th style="padding: 10px; text-align: right; font-weight: 600;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fwRulesTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="fwRulesEmpty" style="display: none; text-align: center; padding: 30px; color: var(--text-secondary);">
                            No blocking rules configured
                        </div>
                        <div id="fwRulesError" style="display: none; text-align: center; padding: 30px; color: #D13438;">
                            Error loading blocking rules
                        </div>
                    </div>
                </div>
        </div>

    </div>

    <!-- Recent Activity Backdrop -->
    <div id="recentActivityBackdrop" class="activity-backdrop" onclick="closeRecentActivityPanel()"></div>

    <!-- Recent Activity Slide-out Panel -->
    <div id="recentActivityPanel" class="activity-slide-panel">
        <div class="activity-panel-header">
            <h3>üìã Recent Activity</h3>
            <button onclick="closeRecentActivityPanel()" class="activity-panel-close">‚úï</button>
        </div>
        <div class="activity-panel-filters">
            <select id="logTypeFilter" onchange="filterRecentLogs()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--surface); flex: 1;">
                <option value="all">All Activity</option>
                <option value="failed">Failed Logins</option>
                <option value="success">Successful Logins</option>
            </select>
            <button onclick="loadRecentLogs(currentAgentId)" style="padding: 6px 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; font-size: 12px; cursor: pointer;">
                üîÑ
            </button>
        </div>
        <div class="activity-panel-content">
            <div id="recentLogsLoading" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                Loading...
            </div>
            <div id="recentLogsContainer" style="display: none;">
                <div id="recentLogsList"></div>
            </div>
            <div id="noLogsMessage" style="display: none; text-align: center; padding: 30px; color: var(--text-secondary);">
                <div style="font-size: 20px; margin-bottom: 8px;">üìù</div>
                <p style="margin: 0; font-size: 13px;">No recent activity</p>
            </div>
        </div>
    </div>

    <!-- Block IP Modal -->
    <div id="blockIPModal" class="fw-modal-overlay" style="display: none;">
        <div class="fw-modal" style="width: 450px;">
            <div class="fw-modal-header">
                <h3>üö´ Block IP Address</h3>
                <button class="fw-modal-close" onclick="closeBlockIPModal()">‚úï</button>
            </div>
            <div class="fw-modal-body">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">IP ADDRESS</label>
                        <input type="text" id="quickBlockIP" placeholder="e.g., 192.168.1.100" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface);">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">METHOD</label>
                            <select id="quickBlockMethod" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface);">
                                <option value="fail2ban">Fail2ban (Temporary)</option>
                                <option value="ufw">UFW (Permanent)</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">DURATION</label>
                            <select id="quickBlockDuration" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface);">
                                <option value="3600">1 hour</option>
                                <option value="86400" selected>24 hours</option>
                                <option value="604800">7 days</option>
                                <option value="2592000">30 days</option>
                                <option value="0">Permanent</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">REASON (Optional)</label>
                        <input type="text" id="quickBlockReason" placeholder="e.g., Suspicious activity" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface);">
                    </div>

                    <button onclick="quickBlockIP()" style="padding: 14px 24px; background: #D13438; color: white; border: none; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer;">
                        üö´ Block IP Address
                    </button>

                    <div id="quickBlockMessage" style="display: none; padding: 12px; border-radius: 4px; font-size: 13px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Tab styles */
    .fw-tabs {
        background: var(--surface);
        border-radius: 4px 4px 0 0;
    }

    .fw-tab {
        padding: 12px 20px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: -2px;
    }

    .fw-tab:hover {
        color: var(--text-primary);
        background: var(--background);
    }

    .fw-tab.active {
        color: var(--azure-blue);
        border-bottom-color: var(--azure-blue);
        background: var(--surface);
    }

    .fw-tab-content {
        border-top: none;
    }

    /* Quick action small buttons */
    .quick-action-sm {
        padding: 8px 14px;
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .quick-action-sm:hover {
        border-color: var(--azure-blue);
        background: rgba(0, 120, 212, 0.05);
    }

    .quick-action-sm.success {
        border-color: rgba(16, 124, 16, 0.3);
        background: rgba(16, 124, 16, 0.05);
    }

    .quick-action-sm.success:hover {
        border-color: #107C10;
    }

    .quick-action-sm.danger {
        border-color: rgba(209, 52, 56, 0.3);
        background: rgba(209, 52, 56, 0.05);
    }

    .quick-action-sm.danger:hover {
        border-color: #D13438;
    }

    /* Rule card styles */
    .simple-rule-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: 4px;
        margin-bottom: 6px;
        transition: border-color 0.15s;
    }

    .simple-rule-card:hover {
        border-color: var(--azure-blue);
    }

    .rule-icon {
        font-size: 18px;
        width: 28px;
        text-align: center;
    }

    .rule-details {
        flex: 1;
        min-width: 0;
    }

    .rule-title {
        font-weight: 600;
        font-size: 13px;
    }

    .rule-subtitle {
        font-size: 11px;
        color: var(--text-secondary);
    }

    .rule-badge {
        padding: 3px 10px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .rule-badge.allow {
        background: rgba(16, 124, 16, 0.1);
        color: #107C10;
    }

    .rule-badge.block, .rule-badge.deny {
        background: rgba(209, 52, 56, 0.1);
        color: #D13438;
    }

    .rule-delete-btn {
        padding: 4px 10px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 11px;
    }

    .rule-delete-btn:hover {
        background: rgba(209, 52, 56, 0.1);
        border-color: #D13438;
        color: #D13438;
    }

    /* Fail2ban ban card styles */
    .f2b-ban-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: rgba(239, 68, 68, 0.05);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 4px;
        margin-bottom: 8px;
    }

    .f2b-ban-card:hover {
        border-color: rgba(239, 68, 68, 0.4);
    }

    .f2b-ban-icon {
        font-size: 18px;
    }

    .f2b-ban-details {
        flex: 1;
        min-width: 0;
    }

    .f2b-ban-ip {
        font-family: monospace;
        font-weight: 600;
        font-size: 14px;
        color: #dc2626;
    }

    .f2b-ban-meta {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 3px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .f2b-unban-btn {
        padding: 5px 12px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
    }

    .f2b-unban-btn:hover {
        background: #059669;
    }

    /* Fail2ban Stats */
    .f2b-stat-card {
        padding: 12px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 6px;
        text-align: center;
    }

    .f2b-stat-value {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .f2b-stat-label {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    /* Fail2ban Sub-tabs */
    .f2b-subtab {
        padding: 8px 16px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .f2b-subtab:hover {
        color: var(--text-primary);
    }

    .f2b-subtab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
    }

    /* Ban Duration Badge */
    .f2b-duration {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 3px;
        font-size: 10px;
        font-weight: 500;
        color: #dc2626;
    }

    .f2b-duration.expiring-soon {
        background: rgba(245, 158, 11, 0.15);
        color: #d97706;
    }

    /* History Item */
    .f2b-history-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 4px;
        margin-bottom: 6px;
    }

    .f2b-history-item.ban {
        border-left: 3px solid #ef4444;
    }

    .f2b-history-item.unban {
        border-left: 3px solid #10b981;
    }

    .f2b-history-icon {
        font-size: 16px;
    }

    .f2b-history-details {
        flex: 1;
    }

    .f2b-history-ip {
        font-family: monospace;
        font-weight: 600;
        font-size: 13px;
    }

    .f2b-history-meta {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
    }

    .f2b-history-time {
        font-size: 11px;
        color: var(--text-secondary);
        text-align: right;
    }

    /* Threat Card */
    .f2b-threat-card {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .f2b-threat-card.critical {
        border-left: 3px solid #dc2626;
        background: rgba(220, 38, 38, 0.05);
    }

    .f2b-threat-card.high {
        border-left: 3px solid #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }

    .f2b-threat-card.medium {
        border-left: 3px solid #3b82f6;
    }

    .f2b-threat-score {
        min-width: 44px;
        padding: 6px 8px;
        border-radius: 4px;
        text-align: center;
        font-weight: 700;
        font-size: 14px;
    }

    .f2b-threat-score.critical {
        background: rgba(220, 38, 38, 0.15);
        color: #dc2626;
    }

    .f2b-threat-score.high {
        background: rgba(245, 158, 11, 0.15);
        color: #d97706;
    }

    .f2b-threat-score.medium {
        background: rgba(59, 130, 246, 0.15);
        color: #2563eb;
    }

    .f2b-threat-details {
        flex: 1;
    }

    .f2b-threat-ip {
        font-family: monospace;
        font-weight: 600;
        font-size: 13px;
    }

    .f2b-threat-factors {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
        line-height: 1.5;
    }

    .f2b-escalate-btn {
        padding: 6px 10px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
    }

    .f2b-escalate-btn:hover {
        background: #b91c1c;
    }

    /* Log entry styles */
    .log-entry {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid var(--border);
        font-size: 12px;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-icon {
        font-size: 14px;
        width: 20px;
        text-align: center;
    }

    .log-content {
        flex: 1;
        min-width: 0;
    }

    .log-ip {
        font-family: monospace;
        font-weight: 600;
        font-size: 12px;
    }

    .log-action {
        padding: 1px 6px;
        border-radius: 8px;
        font-size: 10px;
        font-weight: 600;
        margin-left: 6px;
    }

    .log-action.failed {
        background: rgba(209, 52, 56, 0.1);
        color: #D13438;
    }

    .log-action.success {
        background: rgba(16, 124, 16, 0.1);
        color: #107C10;
    }

    .log-meta {
        color: var(--text-secondary);
        font-size: 11px;
        margin-top: 2px;
    }

    .log-time {
        color: var(--text-secondary);
        font-size: 10px;
        white-space: nowrap;
    }

    /* Responsive */
    @media (max-width: 1000px) {
        #firewallContent > div:nth-child(2) {
            grid-template-columns: 1fr !important;
        }
    }

    /* Clickable IP */
    .clickable-ip {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 4px;
        margin: -2px -4px;
        border-radius: 3px;
        transition: background 0.15s;
    }

    .clickable-ip:hover {
        background: rgba(0, 120, 212, 0.1);
    }

    .ip-details-hint {
        font-size: 11px;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .clickable-ip:hover .ip-details-hint {
        opacity: 0.7;
    }

    /* Modal */
    .fw-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: modalFade 0.15s ease;
    }

    @keyframes modalFade {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .fw-modal {
        background: var(--card-bg, #fff);
        border-radius: 10px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        width: 400px;
        max-width: 92vw;
        overflow: hidden;
        animation: modalSlide 0.2s ease;
    }

    @keyframes modalSlide {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .fw-modal-header {
        padding: 14px 18px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .fw-modal-header h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        font-family: 'SF Mono', Monaco, monospace;
        color: var(--text-primary);
    }

    .fw-modal-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 4px 8px;
        line-height: 1;
        border-radius: 4px;
    }

    .fw-modal-close:hover {
        background: var(--background);
        color: var(--text-primary);
    }

    .fw-modal-body {
        padding: 16px 18px 18px;
    }

    /* Loading spinner */
    .ip-loading-spinner {
        width: 24px;
        height: 24px;
        border: 2px solid var(--border);
        border-top-color: var(--azure-blue);
        border-radius: 50%;
        margin: 0 auto;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Rich IP Modal */
    .ip-modal-rich {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    /* Risk Header */
    .ip-risk-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: var(--background);
        border-radius: 6px;
        border-left: 4px solid;
    }

    .ip-risk-score {
        font-size: 28px;
        font-weight: 700;
        line-height: 1;
    }

    .ip-risk-label {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .ip-risk-level {
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .ip-risk-level.critical { color: #dc2626; }
    .ip-risk-level.warning { color: #f59e0b; }
    .ip-risk-level.low { color: #10b981; }

    .ip-threat-type {
        font-size: 11px;
        color: var(--text-secondary);
    }

    /* Stats Grid */
    .ip-stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }

    .ip-stat-box {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: var(--background);
        border-radius: 6px;
    }

    .ip-stat-icon {
        font-size: 16px;
    }

    .ip-stat-info {
        min-width: 0;
    }

    .ip-stat-value {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .ip-stat-label {
        font-size: 10px;
        color: var(--text-secondary);
    }

    /* Threat Indicators */
    .ip-indicators {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .ip-tag {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .ip-tag.danger {
        background: rgba(220, 38, 38, 0.1);
        color: #dc2626;
    }

    .ip-tag.warning {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    .ip-tag.neutral {
        background: var(--background);
        color: var(--text-secondary);
    }

    /* Behavior Section */
    .ip-behavior {
        padding: 10px 12px;
        background: var(--background);
        border-radius: 6px;
    }

    .ip-section-title {
        font-size: 10px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .ip-behavior-text {
        font-size: 12px;
        color: var(--text-primary);
        line-height: 1.4;
    }

    /* ISP Info */
    .ip-isp {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        color: var(--text-secondary);
        padding-top: 4px;
    }

    .ip-isp-label {
        color: var(--text-secondary);
    }

    .ip-isp-value {
        color: var(--text-primary);
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .ip-asn {
        background: var(--background);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
    }

    /* Actions */
    .ip-modal-actions {
        display: flex;
        gap: 8px;
        padding-top: 6px;
    }

    .ip-btn-unban {
        flex: 1;
        padding: 10px 16px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s;
    }

    .ip-btn-unban:hover {
        background: #059669;
    }

    .ip-btn-close {
        padding: 10px 16px;
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 5px;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .ip-btn-close:hover {
        background: var(--background);
    }

    /* Activity Toggle Button */
    .activity-toggle-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.15s;
    }

    .activity-toggle-btn:hover {
        border-color: var(--azure-blue);
        background: rgba(0, 120, 212, 0.05);
    }

    /* Slide-out Panel */
    .activity-slide-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 380px;
        height: 100vh;
        background: var(--card-bg, #fff);
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
    }

    .activity-slide-panel.open {
        right: 0;
    }

    .activity-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 18px;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
    }

    .activity-panel-header h3 {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
    }

    .activity-panel-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--text-secondary);
        padding: 4px 8px;
        border-radius: 4px;
    }

    .activity-panel-close:hover {
        background: var(--background);
        color: var(--text-primary);
    }

    .activity-panel-filters {
        display: flex;
        gap: 8px;
        padding: 12px 18px;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
    }

    .activity-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 14px 18px;
    }

    /* Activity Panel Backdrop */
    .activity-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .activity-backdrop.open {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    /* Rule Category Card */
    .rule-category-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .rule-category-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        cursor: pointer;
        transition: background 0.15s;
    }

    .rule-category-header:hover {
        background: var(--background);
    }

    .rule-category-icon {
        font-size: 20px;
    }

    .rule-category-info {
        flex: 1;
    }

    .rule-category-info h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .rule-category-info p {
        margin: 2px 0 0 0;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .rule-category-count {
        font-size: 11px;
        color: var(--text-secondary);
        background: var(--background);
        padding: 3px 8px;
        border-radius: 10px;
    }

    .rule-category-toggle {
        color: var(--text-secondary);
        font-size: 12px;
        transition: transform 0.2s;
    }

    .rule-category-card.expanded .rule-category-toggle {
        transform: rotate(180deg);
    }

    .rule-category-content {
        border-top: 1px solid var(--border);
        padding: 8px;
        background: var(--background);
    }

    /* Rule Item */
    .rule-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: var(--surface);
        border-radius: 4px;
        margin-bottom: 4px;
    }

    .rule-item:last-child {
        margin-bottom: 0;
    }

    .rule-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .rule-status.active {
        background: #10b981;
    }

    .rule-status.inactive {
        background: #9ca3af;
    }

    .rule-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .rule-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
    }

    .rule-desc {
        font-size: 11px;
        color: var(--text-secondary);
    }

    .rule-action {
        font-size: 10px;
        font-weight: 600;
        color: #6366f1;
        background: rgba(99, 102, 241, 0.1);
        padding: 3px 8px;
        border-radius: 3px;
    }

    /* Blocked IP Card */
    .blocked-ip-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-left: 3px solid #ef4444;
        border-radius: 4px;
        margin-bottom: 8px;
    }

    .blocked-ip-card:hover {
        border-color: rgba(239, 68, 68, 0.4);
    }

    .blocked-ip-icon {
        font-size: 20px;
    }

    .blocked-ip-details {
        flex: 1;
        min-width: 0;
    }

    .blocked-ip-address {
        font-family: monospace;
        font-weight: 600;
        font-size: 14px;
        color: #dc2626;
    }

    .blocked-ip-meta {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 3px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .blocked-ip-source {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
    }

    .blocked-ip-source.fail2ban {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    .blocked-ip-source.rule_based {
        background: rgba(220, 38, 38, 0.1);
        color: #dc2626;
    }

    .blocked-ip-source.manual {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
    }

    .blocked-ip-source.ml_model {
        background: rgba(147, 51, 234, 0.1);
        color: #9333ea;
    }

    .blocked-ip-unblock-btn {
        padding: 5px 12px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
    }

    .blocked-ip-unblock-btn:hover {
        background: #059669;
    }

    /* Rule name tooltip styles */
    .rule-tooltip-container {
        position: fixed;
        z-index: 10000;
        max-width: 420px;
        padding: 14px 16px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #e8e8e8;
        border-radius: 8px;
        font-size: 11px;
        line-height: 1.6;
        white-space: pre-wrap;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        pointer-events: none;
        opacity: 0;
        transform: translateY(5px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        font-family: 'Consolas', 'Monaco', monospace;
    }

    .rule-tooltip-container.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .rule-tooltip-container::before {
        content: '';
        position: absolute;
        top: -6px;
        left: 20px;
        width: 12px;
        height: 12px;
        background: #1a1a2e;
        transform: rotate(45deg);
        border-left: 1px solid rgba(255, 255, 255, 0.1);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .rule-name-tooltip {
        position: relative;
    }

    .rule-name-tooltip:hover {
        color: var(--azure-blue);
    }

    /* UFW Toggle Button Styles */
    .ufw-toggle-btn {
        min-width: 140px;
        transition: all 0.3s ease;
        display: flex !important;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .ufw-toggle-btn[data-status="active"] {
        background: linear-gradient(135deg, #107C10, #0e6b0e) !important;
        color: white !important;
        border-color: #0a5a0a !important;
    }

    .ufw-toggle-btn[data-status="active"]:hover {
        background: linear-gradient(135deg, #d13438, #b92d31) !important;
        border-color: #a02528 !important;
    }

    .ufw-toggle-btn[data-status="active"]:hover .toggle-text::after {
        content: ' (Click to Disable)';
        font-size: 9px;
        opacity: 0.8;
    }

    .ufw-toggle-btn[data-status="inactive"] {
        background: linear-gradient(135deg, #d13438, #b92d31) !important;
        color: white !important;
        border-color: #a02528 !important;
    }

    .ufw-toggle-btn[data-status="inactive"]:hover {
        background: linear-gradient(135deg, #107C10, #0e6b0e) !important;
        border-color: #0a5a0a !important;
    }

    .ufw-toggle-btn[data-status="unknown"] {
        background: #6b7280 !important;
        color: white !important;
        border-color: #4b5563 !important;
        cursor: wait;
    }

    .ufw-toggle-btn .toggle-icon {
        font-size: 14px;
    }

    .ufw-toggle-btn .toggle-text {
        font-weight: 600;
    }
</style>

<script>
function switchFirewallTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.fw-tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active class from all tabs
    document.querySelectorAll('.fw-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected tab content
    document.getElementById('tab-' + tabName).style.display = 'block';

    // Add active class to selected tab
    document.querySelector(`.fw-tab[data-tab="${tabName}"]`).classList.add('active');

    // Load data for specific tabs
    if (tabName === 'blocked') {
        loadBlockedIPs();
    } else if (tabName === 'rules') {
        loadBlockingRules();
    }
}

// ===============================================
// Recent Activity Slide Panel
// ===============================================
function toggleRecentActivityPanel(event) {
    if (event) {
        event.stopPropagation();
    }
    const panel = document.getElementById('recentActivityPanel');
    const backdrop = document.getElementById('recentActivityBackdrop');

    if (panel.classList.contains('open')) {
        closeRecentActivityPanel();
    } else {
        panel.classList.add('open');
        backdrop.classList.add('open');
        // Use currentAgentId from the module's global variable
        if (currentAgentId) {
            loadRecentLogs(currentAgentId);
        }
    }
}

function closeRecentActivityPanel() {
    const panel = document.getElementById('recentActivityPanel');
    const backdrop = document.getElementById('recentActivityBackdrop');
    if (panel) panel.classList.remove('open');
    if (backdrop) backdrop.classList.remove('open');
}

// filterRecentLogs - reload logs when filter changes
function filterRecentLogs() {
    if (currentAgentId) {
        loadRecentLogs(currentAgentId);
    }
}

// ===============================================
// Blocked IPs Tab
// ===============================================
let allBlockedIPs = [];

function loadBlockedIPs() {
    const loading = document.getElementById('blockedIPsLoading');
    const container = document.getElementById('blockedIPsContainer');
    const list = document.getElementById('blockedIPsList');
    const noBlocked = document.getElementById('noBlockedIPs');

    loading.style.display = 'block';
    container.style.display = 'none';
    noBlocked.style.display = 'none';

    // Build API URL with agent filter if a server is selected
    let apiUrl = '/api/dashboard/blocking/blocks/list?is_active=true&limit=200';
    if (currentAgentId) {
        apiUrl += `&agent_id=${encodeURIComponent(currentAgentId)}`;
    }

    fetch(apiUrl)
        .then(r => r.json())
        .then(data => {
            loading.style.display = 'none';
            if (data.success && data.blocks && data.blocks.length > 0) {
                // Map response format to internal format (include agent_name)
                allBlockedIPs = data.blocks.map(b => ({
                    id: b.id,
                    ip_address_text: b.ip_address,
                    block_source: b.source,
                    block_reason: b.reason,
                    blocked_at: b.blocked_at,
                    threat_level: b.threat_level,
                    agent_name: b.agent_name || 'Global'
                }));
                updateBlockedIPsStats(allBlockedIPs);
                renderBlockedIPs(allBlockedIPs);
                container.style.display = 'block';
            } else {
                noBlocked.style.display = 'block';
                updateBlockedIPsStats([]);
            }
        })
        .catch(err => {
            loading.style.display = 'none';
            noBlocked.style.display = 'block';
            console.error('Error loading blocked IPs:', err);
        });
}

function updateBlockedIPsStats(blocks) {
    const total = blocks.length;
    const fail2ban = blocks.filter(b => b.block_source === 'fail2ban').length;
    const ufw = blocks.filter(b => b.block_source === 'rule_based' || b.block_source === 'manual').length;
    const ml = blocks.filter(b => b.block_source === 'ml_model').length;

    document.getElementById('blockedStatTotal').textContent = total;
    document.getElementById('blockedStatFail2ban').textContent = fail2ban;
    document.getElementById('blockedStatUFW').textContent = ufw;
    document.getElementById('blockedStatML').textContent = ml;
}

function renderBlockedIPs(blocks) {
    const list = document.getElementById('blockedIPsList');

    if (blocks.length === 0) {
        list.innerHTML = '';
        document.getElementById('noBlockedIPs').style.display = 'block';
        document.getElementById('blockedIPsContainer').style.display = 'none';
        return;
    }

    document.getElementById('noBlockedIPs').style.display = 'none';
    document.getElementById('blockedIPsContainer').style.display = 'block';

    list.innerHTML = blocks.map(b => {
        const sourceLabel = {
            'fail2ban': 'Fail2ban',
            'rule_based': 'UFW Rule',
            'manual': 'Manual',
            'ml_model': 'ML Model'
        }[b.block_source] || b.block_source;

        const sourceClass = b.block_source.replace('_', '-');
        const blockedAt = b.blocked_at ? formatTimeAgo(b.blocked_at) : 'Unknown';
        const reason = b.block_reason || 'No reason specified';
        const serverName = b.agent_name || 'Global';

        return `
            <div class="blocked-ip-card">
                <span class="blocked-ip-icon">üö´</span>
                <div class="blocked-ip-details">
                    <span class="blocked-ip-address clickable-ip" onclick="showIPDetails('${b.ip_address_text}')">${b.ip_address_text}</span>
                    <div class="blocked-ip-meta">
                        <span class="blocked-ip-source ${b.block_source}">${sourceLabel}</span>
                        <span style="background: rgba(0, 120, 212, 0.1); color: #0078D4; padding: 2px 6px; border-radius: 3px; font-size: 10px;">üìç ${serverName}</span>
                        <span>Blocked ${blockedAt}</span>
                        <span title="${reason}">${reason.length > 30 ? reason.substring(0, 30) + '...' : reason}</span>
                    </div>
                </div>
                <button class="blocked-ip-unblock-btn" onclick="unblockIP('${b.ip_address_text}', ${b.id})">Unblock</button>
            </div>
        `;
    }).join('');
}

function filterBlockedIPs() {
    const filter = document.getElementById('blockedSourceFilter').value;

    if (filter === 'all') {
        renderBlockedIPs(allBlockedIPs);
    } else {
        const filtered = allBlockedIPs.filter(b => b.block_source === filter);
        renderBlockedIPs(filtered);
    }
}

function unblockIP(ip, blockId) {
    if (!confirm(`Unblock IP address ${ip}?`)) return;

    fetch('/api/dashboard/blocking/blocks/unblock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip_address: ip, reason: 'Manual unblock from dashboard' })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showNotification('success', `Unblocked ${ip}`);
            loadBlockedIPs();
        } else {
            showNotification('error', data.error || 'Failed to unblock IP');
        }
    })
    .catch(err => {
        showNotification('error', 'Error unblocking IP');
        console.error(err);
    });
}

// ===============================================
// Block IP Modal
// ===============================================
function showBlockIPModal() {
    document.getElementById('blockIPModal').style.display = 'flex';
    document.getElementById('quickBlockIP').value = '';
    document.getElementById('quickBlockReason').value = '';
    document.getElementById('quickBlockMessage').style.display = 'none';
}

function closeBlockIPModal() {
    document.getElementById('blockIPModal').style.display = 'none';
}

function quickBlockIP() {
    const ip = document.getElementById('quickBlockIP').value.trim();
    const method = document.getElementById('quickBlockMethod').value;
    const duration = parseInt(document.getElementById('quickBlockDuration').value);
    const reason = document.getElementById('quickBlockReason').value.trim() || 'Manual block from dashboard';
    const msgEl = document.getElementById('quickBlockMessage');

    if (!ip) {
        msgEl.textContent = 'Please enter an IP address';
        msgEl.style.background = 'rgba(209, 52, 56, 0.1)';
        msgEl.style.color = '#D13438';
        msgEl.style.display = 'block';
        return;
    }

    // Validate IP format
    const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipRegex.test(ip)) {
        msgEl.textContent = 'Invalid IP address format';
        msgEl.style.background = 'rgba(209, 52, 56, 0.1)';
        msgEl.style.color = '#D13438';
        msgEl.style.display = 'block';
        return;
    }

    msgEl.textContent = 'Blocking IP...';
    msgEl.style.background = 'rgba(0, 120, 212, 0.1)';
    msgEl.style.color = 'var(--azure-blue)';
    msgEl.style.display = 'block';

    // Convert seconds to minutes for the API
    const durationMinutes = Math.floor(duration / 60);
    const endpoint = method === 'fail2ban' ? '/api/fail2ban/ban' : '/api/dashboard/blocking/blocks/manual';
    const payload = method === 'fail2ban'
        ? { ip_address: ip, bantime: duration, reason: reason }
        : { ip_address: ip, reason: reason, duration_minutes: durationMinutes || 1440 };

    fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            msgEl.textContent = `Successfully blocked ${ip}`;
            msgEl.style.background = 'rgba(16, 124, 16, 0.1)';
            msgEl.style.color = '#107C10';
            setTimeout(() => {
                closeBlockIPModal();
                loadBlockedIPs();
                loadFail2banBans();
            }, 1000);
        } else {
            msgEl.textContent = data.error || 'Failed to block IP';
            msgEl.style.background = 'rgba(209, 52, 56, 0.1)';
            msgEl.style.color = '#D13438';
        }
    })
    .catch(err => {
        msgEl.textContent = 'Error blocking IP';
        msgEl.style.background = 'rgba(209, 52, 56, 0.1)';
        msgEl.style.color = '#D13438';
        console.error(err);
    });
}

// ===============================================
// Blocking Rules Tab
// ===============================================
let fwEditingRuleId = null;

function loadBlockingRules() {
    loadFwRulesStats();
    loadFwRulesList();
    setupFwRulesEventListeners();
}

async function loadFwRulesStats() {
    try {
        const response = await fetch('/api/dashboard/blocking/stats');
        const data = await response.json();
        if (data.success && data.stats) {
            const stats = data.stats;
            document.getElementById('fwStatTotalBlocks').textContent = stats.total_blocks || 0;
            document.getElementById('fwStatActiveBlocks').textContent = stats.active_blocks || 0;
            document.getElementById('fwStatManualBlocks').textContent = stats.blocks_by_source?.manual || 0;
            document.getElementById('fwStatRuleBlocks').textContent = stats.blocks_by_source?.rule_based || 0;
            document.getElementById('fwStatRecent24h').textContent = stats.recent_24h || 0;
            document.getElementById('fwOverallBlockingStats').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading rules stats:', error);
    }
}

async function loadFwRulesList() {
    const loadingEl = document.getElementById('fwRulesLoading');
    const tableEl = document.getElementById('fwRulesTable');
    const emptyEl = document.getElementById('fwRulesEmpty');
    const errorEl = document.getElementById('fwRulesError');

    loadingEl.style.display = 'block';
    tableEl.style.display = 'none';
    emptyEl.style.display = 'none';
    errorEl.style.display = 'none';

    try {
        const response = await fetch('/api/dashboard/blocking/rules/list');
        const data = await response.json();

        loadingEl.style.display = 'none';

        if (!data.success || !data.rules || data.rules.length === 0) {
            emptyEl.style.display = 'block';
            return;
        }

        const tableBody = document.getElementById('fwRulesTableBody');
        tableBody.innerHTML = data.rules.map(rule => {
            const statusBadge = rule.is_enabled
                ? '<span style="padding: 3px 10px; background: #107C10; color: white; border-radius: 3px; font-size: 11px; font-weight: 600;">Enabled</span>'
                : '<span style="padding: 3px 10px; background: #8A8886; color: white; border-radius: 3px; font-size: 11px; font-weight: 600;">Disabled</span>';

            const conditions = formatFwRuleConditions(rule.rule_type, rule.conditions);
            const stats = `<div style="font-size: 11px;"><div>Triggered: ${rule.times_triggered || 0}x</div><div>Blocked: ${rule.ips_blocked_total || 0} IPs</div></div>`;
            const isSystemRule = rule.is_system_rule;

            const deleteBtn = isSystemRule
                ? '<button disabled style="padding: 4px 8px; border: 1px solid #8A8886; background: var(--surface); color: #8A8886; border-radius: 3px; cursor: not-allowed; font-size: 11px;" title="System rule">üîí</button>'
                : `<button onclick="fwDeleteRule(${rule.id}, '${escapeHtml(rule.rule_name)}')" style="padding: 4px 8px; border: 1px solid #D13438; background: var(--surface); color: #D13438; border-radius: 3px; cursor: pointer; font-size: 11px;">Del</button>`;

            const tooltip = getRuleTypeTooltip(rule.rule_type);
            return `
                <tr style="border-bottom: 1px solid var(--border-light);">
                    <td style="padding: 10px; font-size: 12px; font-weight: 600; position: relative;">
                        <span class="rule-name-tooltip" data-tooltip="${escapeHtml(tooltip)}" style="cursor: help; border-bottom: 1px dotted var(--text-secondary);">
                            ${escapeHtml(rule.rule_name)}
                        </span>
                        ${isSystemRule ? '<span style="margin-left: 6px; padding: 2px 5px; background: #0078D4; color: white; border-radius: 2px; font-size: 9px;">SYS</span>' : ''}
                    </td>
                    <td style="padding: 10px; font-size: 12px;">${escapeHtml(rule.rule_type)}</td>
                    <td style="padding: 10px; font-size: 12px; text-align: center;">${rule.priority}</td>
                    <td style="padding: 10px;">${conditions}</td>
                    <td style="padding: 10px;">${stats}</td>
                    <td style="padding: 10px; text-align: center;">${statusBadge}</td>
                    <td style="padding: 10px; text-align: right; white-space: nowrap;">
                        <button onclick="fwToggleRule(${rule.id}, ${rule.is_enabled})" style="padding: 4px 8px; border: 1px solid var(--border); background: var(--surface); border-radius: 3px; cursor: pointer; font-size: 11px; margin-right: 4px;">${rule.is_enabled ? 'Disable' : 'Enable'}</button>
                        <button onclick="fwEditRule(${rule.id})" style="padding: 4px 8px; border: 1px solid var(--border); background: var(--surface); border-radius: 3px; cursor: pointer; font-size: 11px; margin-right: 4px;">Edit</button>
                        ${deleteBtn}
                    </td>
                </tr>
            `;
        }).join('');

        tableEl.style.display = 'block';

        // Initialize tooltips after table is rendered
        initRuleTooltips();
    } catch (error) {
        console.error('Error loading rules:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
    }
}

function formatFwRuleConditions(ruleType, conditions) {
    if (typeof conditions === 'string') {
        try { conditions = JSON.parse(conditions); } catch (e) { return '<span style="font-size:11px;">Invalid</span>'; }
    }
    if (!conditions) return '<span style="font-size:11px;">-</span>';

    switch (ruleType) {
        case 'brute_force':
            return `<div style="font-size:11px;"><div>${conditions.failed_attempts || 'N/A'} fails</div><div>${conditions.time_window_minutes || 'N/A'} min window</div></div>`;
        case 'ml_threshold':
            return `<div style="font-size:11px;"><div>Risk ‚â• ${conditions.min_risk_score || 'N/A'}</div><div>Conf ‚â• ${conditions.min_confidence || 'N/A'}</div></div>`;
        case 'api_reputation':
            return `<div style="font-size:11px;"><div>AbuseIPDB ‚â• ${conditions.min_abuseipdb_score || 'N/A'}</div></div>`;
        case 'velocity':
            return `<div style="font-size:11px;"><div>${conditions.max_events || 'N/A'} events</div><div>${conditions.time_window_seconds || 'N/A'}s window</div></div>`;
        case 'repeat_offender':
            return `<div style="font-size:11px;"><div>Escalating blocks</div></div>`;
        case 'distributed_brute_force':
            return `<div style="font-size:11px;"><div>${conditions.unique_ips_threshold || 'N/A'} IPs, ${conditions.unique_usernames_threshold || 'N/A'} users</div><div>${conditions.time_window_minutes || 'N/A'} min, ‚â§${conditions.max_attempts_per_ip || 'N/A'}/IP</div></div>`;
        case 'account_takeover':
            return `<div style="font-size:11px;"><div>${conditions.unique_ips_threshold || 'N/A'} IPs/user</div><div>${conditions.unique_countries_threshold || 'N/A'} countries, ${conditions.time_window_minutes || 'N/A'} min</div></div>`;
        case 'off_hours_anomaly':
            return `<div style="font-size:11px;"><div>Work: ${conditions.work_start_hour || 8}:00-${conditions.work_end_hour || 18}:00</div><div>Min ${conditions.min_off_hours_attempts || 3} off-hours attempts</div></div>`;
        default:
            return '<div style="font-size:11px;">Custom</div>';
    }
}

// Rule type tooltip descriptions
function getRuleTypeTooltip(ruleType) {
    const tooltips = {
        'brute_force': `BRUTE FORCE DETECTION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Blocks IP after X failed login attempts within Y minutes from the same IP.

Example: IP 192.168.1.100 tries 5 passwords for "admin" in 10 min ‚Üí Blocked`,

        'ml_threshold': `ML THRESHOLD (Machine Learning)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Uses ML to analyze behavior patterns and assign risk score (0-100).

ML analyzes: Login timing, username patterns, geographic anomalies

Example: Bot-like behavior detected (perfect timing, sequential usernames) ‚Üí Risk: 92 ‚Üí Blocked`,

        'api_reputation': `API REPUTATION (AbuseIPDB + VirusTotal)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Queries threat intelligence APIs to check if IP is reported malicious.

APIs check: Spam reports, hacking attempts, malware, botnet membership

Example: IP has AbuseIPDB score 95 (reported 500+ times) ‚Üí Blocked immediately`,

        'velocity': `VELOCITY / DDoS DETECTION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Detects rapid-fire attacks by counting events per second.

Example: IP sends 25 login requests in 60 seconds ‚Üí Blocked for DDoS behavior`,

        'repeat_offender': `REPEAT OFFENDER ESCALATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Increases block duration for IPs that keep coming back.

Escalation: 1st = base, 2nd = 2 days, 3rd = 7 days, 4th+ = 30 days`,

        'distributed_brute_force': `DISTRIBUTED BRUTE FORCE (ML + API Enhanced)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Detects botnet-style attacks: many IPs try many usernames with LOW frequency per IP (evades rate limits).

ML Enhancement: Pattern score from IP distribution + username diversity + timing
API Enhancement: Checks if IPs are known threats via AbuseIPDB

Example: 8 IPs each try 2-3 attempts on 15 usernames in 1 hour ‚Üí Botnet detected ‚Üí All blocked`,

        'account_takeover': `ACCOUNT TAKEOVER (GeoIP + API Enhanced)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Detects credential stuffing: SAME username tried from MULTIPLE IPs/countries quickly.

GeoIP Enhancement: Detects geographic diversity (impossible travel)
API Enhancement: Weights score higher if IPs have bad reputation

Example: "john.doe" login attempts from USA, Russia, China in 30 min ‚Üí Leaked credentials ‚Üí Block all`,

        'off_hours_anomaly': `OFF-HOURS ANOMALY (Baseline + API Enhanced)
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Detects login attempts outside business hours or weekends.

Baseline Learning: Learns user's typical login hours from 30-day history
API Enhancement: 1.5x-2x threat multiplier for bad reputation IPs

Example: "admin" normally logs in 9am-5pm, attempt at 3am from suspicious IP ‚Üí Flagged`
    };
    return tooltips[ruleType] || 'Custom blocking rule';
}

// Initialize rule name tooltips
function initRuleTooltips() {
    // Create tooltip container if not exists
    let tooltipEl = document.getElementById('ruleTooltipContainer');
    if (!tooltipEl) {
        tooltipEl = document.createElement('div');
        tooltipEl.id = 'ruleTooltipContainer';
        tooltipEl.className = 'rule-tooltip-container';
        document.body.appendChild(tooltipEl);
    }

    // Add event listeners to all rule name tooltips
    document.querySelectorAll('.rule-name-tooltip').forEach(el => {
        el.addEventListener('mouseenter', function(e) {
            const tooltip = this.getAttribute('data-tooltip');
            if (!tooltip) return;

            tooltipEl.textContent = tooltip;
            tooltipEl.classList.add('visible');

            // Position tooltip below the element
            const rect = this.getBoundingClientRect();
            const tooltipRect = tooltipEl.getBoundingClientRect();

            let left = rect.left;
            let top = rect.bottom + 10;

            // Adjust if tooltip goes off screen right
            if (left + tooltipRect.width > window.innerWidth - 20) {
                left = window.innerWidth - tooltipRect.width - 20;
            }

            // Adjust if tooltip goes off screen bottom
            if (top + tooltipRect.height > window.innerHeight - 20) {
                top = rect.top - tooltipRect.height - 10;
                // Move arrow to bottom
                tooltipEl.style.setProperty('--arrow-position', 'bottom');
            }

            tooltipEl.style.left = left + 'px';
            tooltipEl.style.top = top + 'px';
        });

        el.addEventListener('mouseleave', function() {
            tooltipEl.classList.remove('visible');
        });
    });
}

function setupFwRulesEventListeners() {
    // Refresh button
    document.getElementById('fwRefreshRules')?.addEventListener('click', loadBlockingRules);

    // Show create form button
    document.getElementById('fwShowCreateRuleForm')?.addEventListener('click', () => {
        fwResetRuleForm();
        document.getElementById('fwCreateRuleForm').style.display = 'block';
    });

    // Cancel form button
    document.getElementById('fwCancelRuleForm')?.addEventListener('click', () => {
        document.getElementById('fwCreateRuleForm').style.display = 'none';
        fwResetRuleForm();
    });

    // Rule type selector
    document.getElementById('fwRuleType')?.addEventListener('change', function() {
        // Hide all condition panels
        document.getElementById('fwBruteForceConditions').style.display = 'none';
        document.getElementById('fwMlConditions').style.display = 'none';
        document.getElementById('fwApiConditions').style.display = 'none';
        document.getElementById('fwVelocityConditions').style.display = 'none';
        document.getElementById('fwRepeatConditions').style.display = 'none';
        document.getElementById('fwDistributedBFConditions').style.display = 'none';
        document.getElementById('fwAccountTakeoverConditions').style.display = 'none';
        document.getElementById('fwOffHoursConditions').style.display = 'none';
        // Show relevant panel
        if (this.value === 'brute_force') {
            document.getElementById('fwBruteForceConditions').style.display = 'block';
        } else if (this.value === 'ml_threshold') {
            document.getElementById('fwMlConditions').style.display = 'block';
        } else if (this.value === 'api_reputation') {
            document.getElementById('fwApiConditions').style.display = 'block';
        } else if (this.value === 'velocity') {
            document.getElementById('fwVelocityConditions').style.display = 'block';
        } else if (this.value === 'repeat_offender') {
            document.getElementById('fwRepeatConditions').style.display = 'block';
        } else if (this.value === 'distributed_brute_force') {
            document.getElementById('fwDistributedBFConditions').style.display = 'block';
        } else if (this.value === 'account_takeover') {
            document.getElementById('fwAccountTakeoverConditions').style.display = 'block';
        } else if (this.value === 'off_hours_anomaly') {
            document.getElementById('fwOffHoursConditions').style.display = 'block';
        }
    });

    // Submit button
    document.getElementById('fwSubmitCreateRule')?.addEventListener('click', async () => {
        if (fwEditingRuleId) {
            await fwUpdateRule(fwEditingRuleId);
        } else {
            await fwCreateRule();
        }
    });
}

async function fwCreateRule() {
    const ruleName = document.getElementById('fwRuleName').value;
    const ruleType = document.getElementById('fwRuleType').value;
    const blockDuration = parseInt(document.getElementById('fwRuleBlockDuration').value);
    const priority = parseInt(document.getElementById('fwRulePriority').value);
    const description = document.getElementById('fwRuleDescription').value;

    if (!ruleName || !ruleType) {
        alert('Please fill in required fields');
        return;
    }

    let conditions = {};
    if (ruleType === 'brute_force') {
        conditions = {
            failed_attempts: parseInt(document.getElementById('fwFailedAttempts').value),
            time_window_minutes: parseInt(document.getElementById('fwTimeWindow').value),
            event_type: 'failed'
        };
    } else if (ruleType === 'ml_threshold') {
        conditions = {
            min_risk_score: parseInt(document.getElementById('fwMinRiskScore').value),
            min_confidence: parseFloat(document.getElementById('fwMlMinConfidence').value)
        };
    } else if (ruleType === 'api_reputation') {
        conditions = {
            min_abuseipdb_score: parseInt(document.getElementById('fwMinAbuseScore').value),
            block_on_success: document.getElementById('fwBlockOnSuccess').value === 'true'
        };
    } else if (ruleType === 'velocity') {
        conditions = {
            max_events: parseInt(document.getElementById('fwMaxEvents').value),
            time_window_seconds: parseInt(document.getElementById('fwTimeWindowSeconds').value)
        };
    } else if (ruleType === 'repeat_offender') {
        conditions = {
            escalation: { "2": 2880, "3": 10080, "4": 43200 }
        };
    } else if (ruleType === 'distributed_brute_force') {
        conditions = {
            unique_ips_threshold: parseInt(document.getElementById('fwDistBFUniqueIPs').value),
            unique_usernames_threshold: parseInt(document.getElementById('fwDistBFUniqueUsernames').value),
            time_window_minutes: parseInt(document.getElementById('fwDistBFTimeWindow').value),
            max_attempts_per_ip: parseInt(document.getElementById('fwDistBFMaxPerIP').value),
            requires_approval: false
        };
    } else if (ruleType === 'account_takeover') {
        conditions = {
            unique_ips_threshold: parseInt(document.getElementById('fwATOUniqueIPs').value),
            time_window_minutes: parseInt(document.getElementById('fwATOTimeWindow').value),
            unique_countries_threshold: parseInt(document.getElementById('fwATOUniqueCountries').value),
            check_threat_intel: document.getElementById('fwATOCheckThreatIntel').checked,
            requires_approval: false
        };
    } else if (ruleType === 'off_hours_anomaly') {
        conditions = {
            work_start_hour: parseInt(document.getElementById('fwOffHoursStart').value),
            work_end_hour: parseInt(document.getElementById('fwOffHoursEnd').value),
            work_days: [0, 1, 2, 3, 4], // Monday to Friday (0=Mon in Python weekday)
            min_off_hours_attempts: parseInt(document.getElementById('fwOffHoursMinAttempts').value),
            check_user_baseline: document.getElementById('fwOffHoursCheckBaseline').checked,
            requires_approval: document.getElementById('fwOffHoursRequireApproval').checked
        };
    }

    try {
        const response = await fetch('/api/dashboard/blocking/rules/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rule_name: ruleName, rule_type: ruleType, conditions, block_duration_minutes: blockDuration, priority, description })
        });
        const data = await response.json();
        if (data.success) {
            alert('Rule created successfully');
            document.getElementById('fwCreateRuleForm').style.display = 'none';
            fwResetRuleForm();
            loadFwRulesList();
        } else {
            alert('Failed to create rule: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error creating rule:', error);
        alert('Error creating rule');
    }
}

async function fwEditRule(ruleId) {
    try {
        const response = await fetch('/api/dashboard/blocking/rules/list');
        const data = await response.json();
        if (!data.success) return alert('Failed to load rule');

        const rule = data.rules.find(r => r.id === ruleId);
        if (!rule) return alert('Rule not found');

        fwEditingRuleId = ruleId;
        document.getElementById('fwRuleName').value = rule.rule_name;
        document.getElementById('fwRuleType').value = rule.rule_type;
        document.getElementById('fwRuleBlockDuration').value = rule.block_duration_minutes;
        document.getElementById('fwRulePriority').value = rule.priority;
        document.getElementById('fwRuleDescription').value = rule.description || '';

        // Hide all condition panels
        document.getElementById('fwBruteForceConditions').style.display = 'none';
        document.getElementById('fwMlConditions').style.display = 'none';
        document.getElementById('fwApiConditions').style.display = 'none';
        document.getElementById('fwVelocityConditions').style.display = 'none';
        document.getElementById('fwRepeatConditions').style.display = 'none';
        document.getElementById('fwDistributedBFConditions').style.display = 'none';
        document.getElementById('fwAccountTakeoverConditions').style.display = 'none';
        document.getElementById('fwOffHoursConditions').style.display = 'none';

        // Show and populate relevant panel
        if (rule.rule_type === 'brute_force') {
            document.getElementById('fwBruteForceConditions').style.display = 'block';
            document.getElementById('fwFailedAttempts').value = rule.conditions?.failed_attempts || 5;
            document.getElementById('fwTimeWindow').value = rule.conditions?.time_window_minutes || 10;
        } else if (rule.rule_type === 'ml_threshold') {
            document.getElementById('fwMlConditions').style.display = 'block';
            document.getElementById('fwMinRiskScore').value = rule.conditions?.min_risk_score || 85;
            document.getElementById('fwMlMinConfidence').value = rule.conditions?.min_confidence || 0.8;
        } else if (rule.rule_type === 'api_reputation') {
            document.getElementById('fwApiConditions').style.display = 'block';
            document.getElementById('fwMinAbuseScore').value = rule.conditions?.min_abuseipdb_score || 90;
            document.getElementById('fwBlockOnSuccess').value = rule.conditions?.block_on_success !== false ? 'true' : 'false';
        } else if (rule.rule_type === 'velocity') {
            document.getElementById('fwVelocityConditions').style.display = 'block';
            document.getElementById('fwMaxEvents').value = rule.conditions?.max_events || 20;
            document.getElementById('fwTimeWindowSeconds').value = rule.conditions?.time_window_seconds || 60;
        } else if (rule.rule_type === 'repeat_offender') {
            document.getElementById('fwRepeatConditions').style.display = 'block';
        } else if (rule.rule_type === 'distributed_brute_force') {
            document.getElementById('fwDistributedBFConditions').style.display = 'block';
            document.getElementById('fwDistBFUniqueIPs').value = rule.conditions?.unique_ips_threshold || 5;
            document.getElementById('fwDistBFUniqueUsernames').value = rule.conditions?.unique_usernames_threshold || 10;
            document.getElementById('fwDistBFTimeWindow').value = rule.conditions?.time_window_minutes || 60;
            document.getElementById('fwDistBFMaxPerIP').value = rule.conditions?.max_attempts_per_ip || 3;
        } else if (rule.rule_type === 'account_takeover') {
            document.getElementById('fwAccountTakeoverConditions').style.display = 'block';
            document.getElementById('fwATOUniqueIPs').value = rule.conditions?.unique_ips_threshold || 3;
            document.getElementById('fwATOTimeWindow').value = rule.conditions?.time_window_minutes || 30;
            document.getElementById('fwATOUniqueCountries').value = rule.conditions?.unique_countries_threshold || 2;
            document.getElementById('fwATOCheckThreatIntel').checked = rule.conditions?.check_threat_intel !== false;
        } else if (rule.rule_type === 'off_hours_anomaly') {
            document.getElementById('fwOffHoursConditions').style.display = 'block';
            document.getElementById('fwOffHoursStart').value = rule.conditions?.work_start_hour || 8;
            document.getElementById('fwOffHoursEnd').value = rule.conditions?.work_end_hour || 18;
            document.getElementById('fwOffHoursMinAttempts').value = rule.conditions?.min_off_hours_attempts || 3;
            document.getElementById('fwOffHoursCheckBaseline').checked = rule.conditions?.check_user_baseline !== false;
            document.getElementById('fwOffHoursRequireApproval').checked = rule.conditions?.requires_approval === true;
        }

        document.getElementById('fwSubmitCreateRule').textContent = 'Update Rule';
        document.getElementById('fwCreateRuleForm').style.display = 'block';
        document.getElementById('fwCreateRuleForm').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('Error loading rule:', error);
        alert('Error loading rule');
    }
}

async function fwUpdateRule(ruleId) {
    const ruleName = document.getElementById('fwRuleName').value;
    const ruleType = document.getElementById('fwRuleType').value;
    const blockDuration = parseInt(document.getElementById('fwRuleBlockDuration').value);
    const priority = parseInt(document.getElementById('fwRulePriority').value);
    const description = document.getElementById('fwRuleDescription').value;

    if (!ruleName || !ruleType) {
        alert('Please fill in required fields');
        return;
    }

    let conditions = {};
    if (ruleType === 'brute_force') {
        conditions = {
            failed_attempts: parseInt(document.getElementById('fwFailedAttempts').value),
            time_window_minutes: parseInt(document.getElementById('fwTimeWindow').value),
            event_type: 'failed'
        };
    } else if (ruleType === 'ml_threshold') {
        conditions = {
            min_risk_score: parseInt(document.getElementById('fwMinRiskScore').value),
            min_confidence: parseFloat(document.getElementById('fwMlMinConfidence').value)
        };
    } else if (ruleType === 'api_reputation') {
        conditions = {
            min_abuseipdb_score: parseInt(document.getElementById('fwMinAbuseScore').value),
            block_on_success: document.getElementById('fwBlockOnSuccess').value === 'true'
        };
    } else if (ruleType === 'velocity') {
        conditions = {
            max_events: parseInt(document.getElementById('fwMaxEvents').value),
            time_window_seconds: parseInt(document.getElementById('fwTimeWindowSeconds').value)
        };
    } else if (ruleType === 'repeat_offender') {
        conditions = {
            escalation: { "2": 2880, "3": 10080, "4": 43200 }
        };
    } else if (ruleType === 'distributed_brute_force') {
        conditions = {
            unique_ips_threshold: parseInt(document.getElementById('fwDistBFUniqueIPs').value),
            unique_usernames_threshold: parseInt(document.getElementById('fwDistBFUniqueUsernames').value),
            time_window_minutes: parseInt(document.getElementById('fwDistBFTimeWindow').value),
            max_attempts_per_ip: parseInt(document.getElementById('fwDistBFMaxPerIP').value),
            requires_approval: false
        };
    } else if (ruleType === 'account_takeover') {
        conditions = {
            unique_ips_threshold: parseInt(document.getElementById('fwATOUniqueIPs').value),
            time_window_minutes: parseInt(document.getElementById('fwATOTimeWindow').value),
            unique_countries_threshold: parseInt(document.getElementById('fwATOUniqueCountries').value),
            check_threat_intel: document.getElementById('fwATOCheckThreatIntel').checked,
            requires_approval: false
        };
    } else if (ruleType === 'off_hours_anomaly') {
        conditions = {
            work_start_hour: parseInt(document.getElementById('fwOffHoursStart').value),
            work_end_hour: parseInt(document.getElementById('fwOffHoursEnd').value),
            work_days: [0, 1, 2, 3, 4], // Monday to Friday (0=Mon in Python weekday)
            min_off_hours_attempts: parseInt(document.getElementById('fwOffHoursMinAttempts').value),
            check_user_baseline: document.getElementById('fwOffHoursCheckBaseline').checked,
            requires_approval: document.getElementById('fwOffHoursRequireApproval').checked
        };
    }

    try {
        const response = await fetch(`/api/dashboard/blocking/rules/${ruleId}/update`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rule_name: ruleName, rule_type: ruleType, conditions, block_duration_minutes: blockDuration, priority, description })
        });
        const data = await response.json();
        if (data.success) {
            alert('Rule updated successfully');
            document.getElementById('fwCreateRuleForm').style.display = 'none';
            fwResetRuleForm();
            loadFwRulesList();
        } else {
            alert('Failed to update rule: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error updating rule:', error);
        alert('Error updating rule');
    }
}

async function fwToggleRule(ruleId, currentStatus) {
    if (!confirm(`${currentStatus ? 'Disable' : 'Enable'} this rule?`)) return;

    try {
        const response = await fetch(`/api/dashboard/blocking/rules/${ruleId}/toggle`, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            loadFwRulesList();
        } else {
            alert('Failed to toggle rule: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error toggling rule:', error);
        alert('Error toggling rule');
    }
}

async function fwDeleteRule(ruleId, ruleName) {
    if (!confirm(`Delete rule "${ruleName}"? This cannot be undone.`)) return;

    try {
        const response = await fetch(`/api/dashboard/blocking/rules/${ruleId}/delete`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
            alert('Rule deleted');
            loadFwRulesList();
        } else {
            alert('Failed to delete rule: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting rule:', error);
        alert('Error deleting rule');
    }
}

function fwResetRuleForm() {
    fwEditingRuleId = null;
    document.getElementById('fwRuleName').value = '';
    document.getElementById('fwRuleType').value = '';
    document.getElementById('fwRuleBlockDuration').value = '1440';
    document.getElementById('fwRulePriority').value = '50';
    document.getElementById('fwRuleDescription').value = '';
    // Brute force
    document.getElementById('fwFailedAttempts').value = '5';
    document.getElementById('fwTimeWindow').value = '10';
    // ML threshold
    document.getElementById('fwMinRiskScore').value = '85';
    document.getElementById('fwMlMinConfidence').value = '0.8';
    // API reputation
    document.getElementById('fwMinAbuseScore').value = '90';
    document.getElementById('fwBlockOnSuccess').value = 'true';
    // Velocity
    document.getElementById('fwMaxEvents').value = '20';
    document.getElementById('fwTimeWindowSeconds').value = '60';
    // Hide all condition panels
    document.getElementById('fwBruteForceConditions').style.display = 'none';
    document.getElementById('fwMlConditions').style.display = 'none';
    document.getElementById('fwApiConditions').style.display = 'none';
    document.getElementById('fwVelocityConditions').style.display = 'none';
    document.getElementById('fwRepeatConditions').style.display = 'none';
    document.getElementById('fwSubmitCreateRule').textContent = 'Create Rule';
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ===============================================
// Utility Functions
// ===============================================
function formatTimeAgo(dateStr) {
    if (!dateStr) return 'Unknown';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);

    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
    return date.toLocaleDateString();
}

function showNotification(type, message) {
    // Use existing notification system if available
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
    } else {
        alert(message);
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBlockIPModal();
        closeRecentActivityPanel();
    }
});

// Close modal on backdrop click
document.getElementById('blockIPModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeBlockIPModal();
    }
});
</script>
