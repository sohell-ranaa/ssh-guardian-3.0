<!-- SSH Guardian v3.0 - Unified Firewall Management (UFW + Fail2ban) -->
<style>
/* ========================================
   Firewall Page Scoped Styles
   ======================================== */

/* Buttons */
#page-firewall .fw-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
}

#page-firewall .fw-btn-primary {
    background: var(--azure-blue, #0078D4);
    color: white;
}

#page-firewall .fw-btn-primary:hover {
    background: #106ebe;
}

#page-firewall .fw-btn-secondary {
    background: var(--surface);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

#page-firewall .fw-btn-secondary:hover {
    background: var(--background);
}

/* Spinners */
@keyframes spin {
    to { transform: rotate(360deg); }
}

.fw-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(59, 130, 246, 0.2);
    border-top-color: var(--azure-blue);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.fw-spinner-sm {
    width: 12px;
    height: 12px;
    border-width: 2px;
}

.fw-spinner-lg {
    width: 24px;
    height: 24px;
    border-width: 3px;
    margin: 0 auto;
}

/* Command Queue */
.queue-count-badge {
    background: var(--azure-blue);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
}

.queue-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: var(--surface);
    border-radius: 6px;
    font-size: 12px;
    transition: all 0.2s ease;
}

.queue-item.pending { border-left: 3px solid #f59e0b; }
.queue-item.completed { border-left: 3px solid #10b981; opacity: 0.7; }
.queue-item.failed { border-left: 3px solid #ef4444; }
.queue-item .command-text { flex: 1; font-family: monospace; color: var(--text-secondary); }
.queue-item .status-text { font-size: 11px; font-weight: 500; }
.queue-item.pending .status-text { color: #f59e0b; }
.queue-item.completed .status-text { color: #10b981; }
.queue-item.failed .status-text { color: #ef4444; }

/* Sync Indicator */
.f2b-sync-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.06));
    border: 1px solid rgba(59, 130, 246, 0.25);
    border-radius: 12px;
    font-size: 11px;
    color: var(--azure-blue);
}

/* Agent Selector Card */
#page-firewall .agent-selector-card {
    margin-bottom: 20px;
}

#page-firewall .agent-selector-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
}

#page-firewall .agent-selector-field {
    flex: 1;
    min-width: 250px;
}

#page-firewall .agent-selector-field label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
}

#page-firewall .agent-selector-field select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 14px;
    background: var(--surface);
}

/* Stats Cards Row */
#page-firewall .fw-stats-row {
    display: flex;
    gap: 12px;
}

#page-firewall .fw-stat-card {
    padding: 12px 16px;
    margin: 0;
    text-align: center;
    min-width: 80px;
    cursor: help;
}

#page-firewall .fw-stat-value {
    font-size: 24px;
    font-weight: 700;
}

#page-firewall .fw-stat-label {
    font-size: 11px;
    color: var(--text-secondary);
}

/* Tabs */
#page-firewall .fw-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 0;
    border-bottom: 2px solid var(--border);
}

#page-firewall .fw-tab {
    padding: 12px 20px;
    background: none;
    border: none;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    position: relative;
    transition: color 0.15s;
}

#page-firewall .fw-tab:hover {
    color: var(--text-primary);
}

#page-firewall .fw-tab.active {
    color: var(--azure-blue);
}

#page-firewall .fw-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--azure-blue);
}

#page-firewall .fw-tab-content {
    border-top-left-radius: 0;
    margin-top: 0;
}

/* Empty State */
#page-firewall .fw-empty {
    text-align: center;
    padding: 60px 20px;
}

#page-firewall .fw-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

#page-firewall .fw-empty-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
}

#page-firewall .fw-empty-text {
    color: var(--text-secondary);
    font-size: 14px;
}

/* Loading State */
#page-firewall .fw-loading {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

/* Header Row */
#page-firewall .fw-header-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    margin-bottom: 20px;
    align-items: start;
}

@media (max-width: 900px) {
    #page-firewall .fw-header-row {
        grid-template-columns: 1fr;
    }
}

/* Agent Health Card */
#page-firewall .fw-agent-health {
    margin: 0;
}

#page-firewall .fw-agent-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

#page-firewall .fw-status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ccc;
    flex-shrink: 0;
}

#page-firewall .fw-status-dot.online { background: #10b981; }
#page-firewall .fw-status-dot.offline { background: #ef4444; }

#page-firewall .fw-agent-hostname {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
}

#page-firewall .fw-badge {
    padding: 4px 10px;
    background: var(--surface);
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

#page-firewall .fw-agent-ip {
    font-family: monospace;
    font-size: 13px;
    color: var(--text-secondary);
}

#page-firewall .fw-approval-warning {
    margin-top: 10px;
    padding: 8px 12px;
    background: rgba(255, 185, 0, 0.1);
    border-radius: 4px;
    color: #CC9400;
    font-size: 12px;
}

#page-firewall .fw-approval-warning a {
    color: #CC9400;
    font-weight: 600;
}

/* Activity Panel */
#page-firewall .activity-slide-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 380px;
    height: 100vh;
    background: var(--surface);
    box-shadow: -4px 0 20px rgba(0,0,0,0.15);
    z-index: 1001;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}

#page-firewall .activity-slide-panel.open {
    right: 0;
}

#page-firewall .activity-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

#page-firewall .activity-backdrop.open {
    opacity: 1;
    visibility: visible;
}

#page-firewall .activity-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}

#page-firewall .activity-panel-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

#page-firewall .activity-panel-close {
    width: 32px;
    height: 32px;
    border: none;
    background: none;
    font-size: 18px;
    cursor: pointer;
    border-radius: 4px;
    color: var(--text-secondary);
}

#page-firewall .activity-panel-close:hover {
    background: var(--background);
}

#page-firewall .activity-panel-filters {
    display: flex;
    gap: 8px;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
}

#page-firewall .activity-panel-filters select {
    flex: 1;
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 12px;
    background: var(--surface);
}

#page-firewall .activity-panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

/* Log Item */
#page-firewall .log-item {
    display: flex;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    background: var(--background);
    transition: background 0.15s;
}

#page-firewall .log-item:hover {
    background: var(--surface-alt, #f0f0f0);
}

#page-firewall .log-icon {
    font-size: 16px;
    flex-shrink: 0;
}

#page-firewall .log-details {
    flex: 1;
    min-width: 0;
}

#page-firewall .log-action {
    font-weight: 500;
    font-size: 13px;
}

#page-firewall .log-action.failed { color: #ef4444; }
#page-firewall .log-action.success { color: #10b981; }
#page-firewall .log-action.blocked { color: #f59e0b; }

#page-firewall .log-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
}

#page-firewall .log-ip {
    font-family: monospace;
    color: var(--azure-blue);
}

#page-firewall .log-location {
    padding: 1px 6px;
    background: var(--surface);
    border-radius: 3px;
}
</style>
<div id="page-firewall" class="page-content" style="display: none;">
    <div class="page-header">
        <h1 class="page-title">Firewall & Blocking</h1>
        <p class="page-subtitle">Manage Fail2ban bans, UFW rules, and IP blocks</p>
    </div>

    <!-- Agent Selector -->
    <div class="card agent-selector-card">
        <div class="agent-selector-row">
            <div class="agent-selector-field">
                <label>Select Server</label>
                <select id="firewallAgentSelector">
                    <option value="">-- Select a server --</option>
                </select>
            </div>
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-start;">
                <button id="syncNowBtn" onclick="requestFirewallSync()" class="fw-btn fw-btn-primary" style="display: none;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                    Sync Now
                </button>
                <div id="lastSyncDisplay" style="display: none; font-size: 11px; color: var(--text-hint);">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <span>üõ°Ô∏è UFW: <span id="lastSyncUFW">--</span></span>
                        <span>üîí F2B: <span id="lastSyncF2B">--</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- No Agent Selected -->
    <div id="firewallNoAgent" class="card fw-empty">
        <div class="fw-empty-icon">üõ°Ô∏è</div>
        <h3 class="fw-empty-title">Select a Server</h3>
        <p class="fw-empty-text">Choose a server from the dropdown to manage firewall and blocking.</p>
    </div>

    <!-- Firewall Content -->
    <div id="firewallContent" style="display: none;">

        <!-- Agent Health & Quick Stats Row -->
        <div class="fw-header-row">
            <!-- Agent Health -->
            <div class="card fw-agent-health" id="agentHealthCard">
                <div class="fw-agent-info">
                    <div id="agentHealthIndicator" class="fw-status-dot"></div>
                    <h3 id="agentHealthHostname" class="fw-agent-hostname">-</h3>
                    <span id="agentHealthStatus" class="fw-badge">Unknown</span>
                    <span id="agentHealthIP" class="fw-agent-ip">-</span>
                    <button id="recentActivityBtn" onclick="toggleRecentActivityPanel(event)" class="fw-btn fw-btn-secondary" style="margin-left: auto; padding: 6px 12px; font-size: 12px;">
                        üìã Activity
                    </button>
                </div>
                <div id="agentApprovalStatus" class="fw-approval-warning" style="display: none;">
                    ‚ö†Ô∏è Agent not approved - <a href="#" onclick="approveAgentFromFirewall()">Approve Now</a>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="fw-stats-row">
                <div class="card fw-stat-card" title="Active Fail2ban bans">
                    <div id="stat-f2b-bans" class="fw-stat-value" style="color: #ef4444;">-</div>
                    <div class="fw-stat-label">Bans</div>
                </div>
                <div class="card fw-stat-card" title="UFW status">
                    <div id="stat-fw-status" class="fw-stat-value" style="font-size: 14px;">-</div>
                    <div class="fw-stat-label">UFW</div>
                </div>
                <div class="card fw-stat-card" title="UFW ALLOW rules">
                    <div id="stat-fw-allowed" class="fw-stat-value" style="color: #10b981;">-</div>
                    <div class="fw-stat-label">Allow</div>
                </div>
                <div class="card fw-stat-card" title="UFW DENY rules">
                    <div id="stat-fw-blocked" class="fw-stat-value" style="color: #f59e0b;">-</div>
                    <div class="fw-stat-label">Deny</div>
                </div>
            </div>
        </div>

        <!-- Main Content: Full Width Tabs -->
        <div>
            <!-- Tab Navigation -->
            <div class="fw-tabs" style="display: flex; gap: 0; margin-bottom: 0; border-bottom: 2px solid var(--border);">
                <button class="fw-tab active" data-tab="fail2ban" onclick="switchFirewallTab('fail2ban')" title="Temporary bans for IPs with repeated failed SSH login attempts">
                    üîí Fail2ban
                </button>
                <button class="fw-tab" data-tab="ufw" onclick="switchFirewallTab('ufw')" title="Uncomplicated Firewall rules - permanent allow/deny rules">
                    üî• UFW Rules
                </button>
                <button class="fw-tab" data-tab="logins" onclick="switchFirewallTab('logins')" title="Successfully authenticated SSH sessions for monitoring">
                    ‚úÖ Successful Logins
                </button>
                <button class="fw-tab" data-tab="rules" onclick="switchFirewallTab('rules')" title="Automated blocking rules - ML, brute force detection, reputation-based blocking">
                    üìã Blocking Rules
                </button>
            </div>

                <!-- Tab: Fail2ban Bans (Default) -->
                <div id="tab-fail2ban" class="fw-tab-content card" style="border-top-left-radius: 0; margin-top: 0;">
                    <!-- Fail2ban Stats Row -->
                    <div class="f2b-stats-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div class="f2b-stat-card" title="Currently active Fail2ban bans - IPs temporarily blocked from SSH access">
                            <div class="f2b-stat-value" id="f2bStatActive">0</div>
                            <div class="f2b-stat-label">Active Bans</div>
                        </div>
                        <div class="f2b-stat-card" title="Total ban events in the last 24 hours (includes expired and released bans)">
                            <div class="f2b-stat-value" id="f2bStatTotal">0</div>
                            <div class="f2b-stat-label">Total Bans (24h)</div>
                        </div>
                        <div class="f2b-stat-card" title="IPs that have been banned multiple times - persistent attackers">
                            <div class="f2b-stat-value" id="f2bStatRepeat">0</div>
                            <div class="f2b-stat-label">Repeat Offenders</div>
                        </div>
                        <div class="f2b-stat-card" title="High-risk IPs permanently blocked via UFW firewall rules">
                            <div class="f2b-stat-value" id="f2bStatEscalated">0</div>
                            <div class="f2b-stat-label">Escalated to UFW</div>
                        </div>
                    </div>

                    <!-- Sub-tabs for Active / History -->
                    <div style="display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border);">
                        <button class="f2b-subtab active" data-subtab="active" onclick="switchF2bSubtab('active')">
                            Active Bans
                        </button>
                        <button class="f2b-subtab" data-subtab="history" onclick="switchF2bSubtab('history')">
                            Ban History
                        </button>
                    </div>

                    <!-- Active Bans Sub-tab -->
                    <div id="f2b-subtab-active" class="f2b-subtab-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span id="f2bBanCount" style="font-size: 12px; color: var(--text-secondary);">0 active</span>
                                <span id="f2bSyncIndicator" class="f2b-sync-indicator" style="display: none;">
                                    <span class="f2b-sync-spinner"></span>
                                    <span class="f2b-sync-text">Syncing...</span>
                                </span>
                            </div>
                            <button class="refresh-btn" onclick="loadFail2banBans()">
                                <span class="refresh-icon">‚Üª</span> Refresh
                            </button>
                        </div>

                        <div id="f2bBansLoading" style="text-align: center; padding: 30px; color: var(--text-secondary); display: none;">
                            <div class="f2b-loading-spinner"></div>
                            <div style="margin-top: 10px;">Loading fail2ban bans...</div>
                        </div>

                        <div id="f2bBansContainer" style="max-height: 400px; overflow-y: auto;">
                            <div id="f2bBansList"></div>
                        </div>

                        <div id="f2bNoBans" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                            <div style="font-size: 32px; margin-bottom: 12px;">‚úÖ</div>
                            <p style="margin: 0; font-weight: 500;">No Active Bans</p>
                            <p style="margin: 8px 0 0 0; font-size: 13px;">All clear! No IPs are currently banned by Fail2ban.</p>
                        </div>
                    </div>

                    <!-- Ban History Sub-tab -->
                    <div id="f2b-subtab-history" class="f2b-subtab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <select id="f2bHistoryRange" onchange="loadF2bHistory()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--surface);">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="all">All Time</option>
                            </select>
                            <button class="refresh-btn" onclick="loadF2bHistory()">
                                <span class="refresh-icon">‚Üª</span> Refresh
                            </button>
                        </div>
                        <div id="f2bHistoryLoading" style="text-align: center; padding: 20px; color: var(--text-secondary); display: none;">
                            Loading history...
                        </div>
                        <div id="f2bHistoryList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                </div>

                <!-- Tab: UFW Rules -->
                <div id="tab-ufw" class="fw-tab-content card" style="display: none; border-top-left-radius: 0; margin-top: 0;">
                    <!-- UFW Overview Stats -->
                    <div class="ufw-stats-row" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="ufwStatStatus" style="font-size: 14px;">--</div>
                            <div class="f2b-stat-label">UFW Status</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="ufwStatTotalRules">0</div>
                            <div class="f2b-stat-label">Total Rules</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="ufwStatAllowRules">0</div>
                            <div class="f2b-stat-label">Allow Rules</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="ufwStatDenyRules">0</div>
                            <div class="f2b-stat-label">Deny Rules</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="ufwStatLastSync">--</div>
                            <div class="f2b-stat-label">Last Sync</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="margin-bottom: 20px;">
                        <div class="card-title" style="margin-bottom: 12px;">Quick Actions</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="quickAction('allow-ssh')" class="quick-action-sm">üîê Allow SSH</button>
                            <button onclick="quickAction('allow-http')" class="quick-action-sm">üåê Allow HTTP/S</button>
                            <button id="ufwToggleBtn" onclick="toggleUFW()" class="quick-action-sm ufw-toggle-btn" data-status="unknown">
                                <span class="toggle-icon">üî•</span>
                                <span class="toggle-text">UFW Loading...</span>
                            </button>
                        </div>
                    </div>

                    <!-- Command Queue Panel -->
                    <div id="ufwCommandQueue" style="display: none; margin-bottom: 20px; padding: 12px 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="command-queue-spinner"></div>
                                <span style="font-size: 13px; font-weight: 600; color: var(--azure-blue);">Pending Commands</span>
                                <span id="ufwQueueCount" class="queue-count-badge">0</span>
                            </div>
                            <button onclick="clearCompletedCommands()" style="padding: 4px 10px; background: transparent; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; cursor: pointer; color: var(--text-secondary);">
                                Clear Completed
                            </button>
                        </div>
                        <div id="ufwQueueList" style="display: flex; flex-direction: column; gap: 6px; max-height: 150px; overflow-y: auto;"></div>
                    </div>

                    <!-- Add Rule Form -->
                    <div style="margin-bottom: 20px; padding: 16px; background: var(--background); border-radius: 4px;">
                        <div class="card-title" style="margin-bottom: 12px;">Add Rule</div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                            <select id="simpleRuleAction" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface);">
                                <option value="ACCEPT">‚úÖ Allow</option>
                                <option value="DROP">üö´ Block</option>
                            </select>
                            <select id="simpleRulePort" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface);" onchange="toggleCustomPort(this)">
                                <option value="any">Any Port</option>
                                <option value="22">SSH (22)</option>
                                <option value="80">HTTP (80)</option>
                                <option value="443">HTTPS (443)</option>
                                <option value="3306">MySQL (3306)</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <input type="text" id="simpleRuleCustomPort" placeholder="Port" style="display: none; width: 80px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px;">
                            <select id="simpleRuleProtocol" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; background: var(--surface);">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                                <option value="all">All</option>
                            </select>
                            <input type="text" id="simpleRuleCustomSource" placeholder="From IP (optional)" style="width: 140px; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px;">
                            <button onclick="addSimpleRule()" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                ‚ûï Add
                            </button>
                        </div>
                        <div id="addRuleMessage" style="display: none; margin-top: 10px; padding: 8px 12px; border-radius: 4px; font-size: 12px;"></div>
                    </div>

                    <!-- Current Rules -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="card-title" style="margin: 0;">Current Rules</div>
                                <span id="ufwRuleCount" style="font-size: 12px; color: var(--text-secondary);">0 rules</span>
                                <span id="ufwSyncIndicator" class="f2b-sync-indicator" style="display: none;">
                                    <span class="f2b-sync-spinner"></span>
                                    <span class="ufw-sync-text">Syncing...</span>
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" id="ufwRuleSearch" placeholder="Search IP, port..." oninput="filterSimpleRules()" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; width: 160px;">
                                <select id="filterRuleType" onchange="filterSimpleRules()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
                                    <option value="all">All Types</option>
                                    <option value="allow">Allow</option>
                                    <option value="deny">Deny/Block</option>
                                </select>
                                <button class="refresh-btn" onclick="loadUFWData(window.currentAgentId)" title="Refresh UFW rules">
                                    <span class="refresh-icon">‚Üª</span> Refresh
                                </button>
                            </div>
                        </div>

                        <div id="simpleRulesLoading" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            Loading rules...
                        </div>

                        <div id="simpleRulesContainer" style="display: none; max-height: 400px; overflow-y: auto;">
                            <div id="simpleRulesList"></div>
                        </div>

                        <div id="noRulesMessage" style="display: none; text-align: center; padding: 30px; color: var(--text-secondary);">
                            <div style="font-size: 24px; margin-bottom: 8px;">üìã</div>
                            <p style="margin: 0;">No UFW rules configured</p>
                        </div>

                        <div id="noFirewallDataWarning" style="display: none; text-align: center; padding: 30px; color: var(--text-secondary);">
                            <div style="font-size: 24px; margin-bottom: 8px;">üìã</div>
                            <p style="margin: 0;">No firewall data yet</p>
                            <p style="font-size: 12px; margin: 8px 0 0 0;">Click "Sync Now" to fetch data from agent</p>
                        </div>
                    </div>
                </div>

                <!-- Tab: Successful Logins -->
                <div id="tab-logins" class="fw-tab-content card" style="display: none; border-top-left-radius: 0; margin-top: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="card-title" style="margin: 0;">Successful Login Activity</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="loginTimeFilter" onchange="loadSuccessfulLoginsFirewall()" style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--surface);">
                                <option value="24h" selected>Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="">All Time</option>
                            </select>
                            <input type="text" id="loginSearchFilter" placeholder="Search user or IP..."
                                onkeyup="if(event.key==='Enter')loadSuccessfulLoginsFirewall()"
                                style="padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--surface); width: 160px;">
                            <button class="refresh-btn" onclick="loadSuccessfulLoginsFirewall()">
                                <span class="refresh-icon">‚Üª</span> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Login Stats -->
                    <div class="blocked-stats-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="loginStatTotal" style="color: #10b981;">0</div>
                            <div class="f2b-stat-label">Total Logins</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="loginStatUniqueUsers">0</div>
                            <div class="f2b-stat-label">Unique Users</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="loginStatUniqueIPs" style="color: #f59e0b;">0</div>
                            <div class="f2b-stat-label">Unique IPs</div>
                        </div>
                        <div class="f2b-stat-card">
                            <div class="f2b-stat-value" id="loginStatToday" style="color: #8b5cf6;">0</div>
                            <div class="f2b-stat-label">Today</div>
                        </div>
                    </div>

                    <div id="loginsLoading" style="text-align: center; padding: 30px; color: var(--text-secondary); display: none;">
                        Loading successful logins...
                    </div>

                    <div id="loginsContainer" style="max-height: 450px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: var(--background); border-bottom: 2px solid var(--border); position: sticky; top: 0;">
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">User</th>
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">IP Address</th>
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Location</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Risk</th>
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Login Time</th>
                                    <th style="padding: 10px; text-align: center; font-weight: 600;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="fwLoginsTableBody">
                                <!-- Rows will be inserted by JS -->
                            </tbody>
                        </table>
                    </div>

                    <div id="noLogins" style="text-align: center; padding: 40px; color: var(--text-secondary); display: none;">
                        <div style="font-size: 32px; margin-bottom: 12px;">üìù</div>
                        <p style="margin: 0; font-weight: 500;">No Successful Logins</p>
                        <p style="margin: 8px 0 0 0; font-size: 13px;">No successful login events found for the selected filters.</p>
                    </div>

                    <!-- Pagination -->
                    <div id="loginsPagination" style="padding: 12px 0; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); margin-top: 12px;">
                        <div id="loginsInfo" style="color: var(--text-secondary); font-size: 12px;"></div>
                        <div style="display: flex; gap: 8px;">
                            <button id="prevLoginsPage" onclick="loadSuccessfulLoginsFirewall(currentLoginsPageFW - 1)" style="padding: 6px 12px; border: 1px solid var(--border); background: var(--surface); border-radius: 4px; cursor: pointer; font-size: 12px;">‚Üê Previous</button>
                            <button id="nextLoginsPage" onclick="loadSuccessfulLoginsFirewall(currentLoginsPageFW + 1)" style="padding: 6px 12px; border: 1px solid var(--border); background: var(--surface); border-radius: 4px; cursor: pointer; font-size: 12px;">Next ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Blocking Rules -->
                <div id="tab-rules" class="fw-tab-content" style="display: none; margin-top: 0;">
                    <!-- Overall Blocking Statistics -->
                    <div id="fwOverallBlockingStats" class="card" style="margin-bottom: 16px; display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                            <div style="text-align: center;" title="Total IP blocks recorded in the system">
                                <div style="font-size: 24px; font-weight: 700; color: var(--azure-blue);" id="fwStatTotalBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Total Blocks</div>
                            </div>
                            <div style="text-align: center;" title="Currently active blocks enforced on firewall">
                                <div style="font-size: 24px; font-weight: 700; color: #107C10;" id="fwStatActiveBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Active</div>
                            </div>
                            <div style="text-align: center;" title="Blocks created manually by administrators">
                                <div style="font-size: 24px; font-weight: 700; color: #8A8886;" id="fwStatManualBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Manual</div>
                            </div>
                            <div style="text-align: center;" title="Blocks triggered by automated rules (brute force, velocity, etc.)">
                                <div style="font-size: 24px; font-weight: 700; color: #0078D4;" id="fwStatRuleBlocks">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Rule-Based</div>
                            </div>
                            <div style="text-align: center;" title="New blocks in the last 24 hours">
                                <div style="font-size: 24px; font-weight: 700; color: #FFB900;" id="fwStatRecent24h">-</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">Last 24h</div>
                            </div>
                        </div>
                    </div>

                    <!-- ML Detection Statistics Card -->
                    <div id="fwMLDetectionStats" class="card" style="margin-bottom: 16px; display: none; background: linear-gradient(135deg, rgba(138, 43, 226, 0.05) 0%, rgba(75, 0, 130, 0.08) 100%); border: 1px solid rgba(138, 43, 226, 0.2);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 20px;">ü§ñ</span>
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: #6B21A8;">ML-Powered Protection</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">Anomaly detection using Isolation Forest algorithm</div>
                            </div>
                            <span class="help-icon" title="Machine Learning enhances detection by identifying behavioral anomalies that rule-based systems miss. It analyzes patterns like: unusual timing, geographic inconsistencies, rapid authentication attempts, and deviation from baseline behavior." style="margin-left: auto; cursor: help; background: rgba(138, 43, 226, 0.1); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">?</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 6px;" title="Total IPs blocked by ML anomaly detection (all time)">
                                <div style="font-size: 28px; font-weight: 700; color: #7C3AED;" id="fwStatMLTotal">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">ML Blocks (Total)</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 6px;" title="IPs blocked by ML today - threats caught by behavioral analysis">
                                <div style="font-size: 28px; font-weight: 700; color: #9333EA;" id="fwStatMLToday">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">ML Today</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 6px;" title="IPs blocked by ML this week - weekly protection summary">
                                <div style="font-size: 28px; font-weight: 700; color: #A855F7;" id="fwStatMLWeek">0</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">ML This Week</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(138, 43, 226, 0.08); border-radius: 4px; font-size: 11px; color: #6B21A8;">
                            <strong>How ML helps:</strong> Detects zero-day attacks, credential stuffing, and sophisticated threats that evade traditional rules by analyzing behavioral patterns in real-time.
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card" style="margin-bottom: 16px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button id="fwShowCreateRuleForm" style="padding: 8px 14px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                ‚ûï Create Rule
                            </button>
                            <button id="fwRefreshRules" class="refresh-btn">
                                <span class="refresh-icon">‚Üª</span> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Create Rule Form (Hidden by default) -->
                    <div id="fwCreateRuleForm" class="card" style="display: none; margin-bottom: 16px;">
                        <div class="card-title">Create Blocking Rule</div>
                        <div style="display: grid; gap: 12px; max-width: 600px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Rule Name *</label>
                                <input type="text" id="fwRuleName" placeholder="Brute Force Protection" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Rule Type *</label>
                                <select id="fwRuleType" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px;">
                                    <option value="">Select type...</option>
                                    <option value="brute_force">Brute Force Detection</option>
                                    <option value="ml_threshold">ML Risk Threshold</option>
                                    <option value="api_reputation">API Reputation (AbuseIPDB)</option>
                                    <option value="velocity">Velocity / DDoS Detection</option>
                                    <option value="distributed_brute_force">Distributed Brute Force</option>
                                    <option value="account_takeover">Account Takeover Detection</option>
                                    <option value="off_hours_anomaly">Off-Hours Anomaly</option>
                                    <option value="repeat_offender">Repeat Offender Escalation</option>
                                </select>
                            </div>
                            <div id="fwBruteForceConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Brute Force Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); border-left: 4px solid #f9a825; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #5d4037; margin-bottom: 6px;">How it works</div>
                                    <div style="font-size: 10px; color: #5d4037; line-height: 1.5;">
                                        Blocks an IP after X failed login attempts within Y minutes from the <strong>same IP address</strong>.
                                    </div>
                                    <div style="font-size: 10px; color: #6d4c41; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #bcaaa4;">
                                        <strong>Example:</strong> IP 192.168.1.100 tries passwords for "admin" 5 times in 10 minutes ‚Üí Blocked
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Failed Attempts</label>
                                        <input type="number" id="fwFailedAttempts" value="5" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Time Window (min)</label>
                                        <input type="number" id="fwTimeWindow" value="10" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- ML Threshold Conditions -->
                            <div id="fwMlConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">ML Threshold Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #1976d2; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #0d47a1; margin-bottom: 6px;">How it works (ML-Powered)</div>
                                    <div style="font-size: 10px; color: #1565c0; line-height: 1.5;">
                                        Uses <strong>Machine Learning</strong> to analyze behavior patterns and assign a risk score (0-100). Blocks when ML predicts the IP is malicious with high confidence.
                                    </div>
                                    <div style="font-size: 10px; color: #1565c0; margin-top: 6px;">
                                        <strong>ML analyzes:</strong> Login timing, username patterns, geographic anomalies, historical behavior
                                    </div>
                                    <div style="font-size: 10px; color: #0d47a1; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #90caf9;">
                                        <strong>Example:</strong> IP shows bot-like behavior (perfect timing, sequential usernames) ‚Üí Risk: 92, Confidence: 0.95 ‚Üí Blocked
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Min Risk Score</label>
                                        <input type="number" id="fwMinRiskScore" value="85" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Min Confidence</label>
                                        <input type="number" id="fwMlMinConfidence" value="0.8" step="0.1" min="0" max="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- API Reputation Conditions -->
                            <div id="fwApiConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">API Reputation Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); border-left: 4px solid #c2185b; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #880e4f; margin-bottom: 6px;">How it works (API-Powered)</div>
                                    <div style="font-size: 10px; color: #ad1457; line-height: 1.5;">
                                        Queries <strong>AbuseIPDB</strong> & <strong>VirusTotal</strong> to check if the IP is reported as malicious by the global security community. Score 0-100 (higher = more reports).
                                    </div>
                                    <div style="font-size: 10px; color: #ad1457; margin-top: 6px;">
                                        <strong>APIs check:</strong> Spam reports, hacking attempts, malware distribution, botnet membership
                                    </div>
                                    <div style="font-size: 10px; color: #880e4f; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #f48fb1;">
                                        <strong>Example:</strong> IP 45.33.32.156 has AbuseIPDB score 95 (reported 500+ times for SSH attacks) ‚Üí Blocked immediately
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Min AbuseIPDB Score</label>
                                        <input type="number" id="fwMinAbuseScore" value="90" min="0" max="100" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Block on Success?</label>
                                        <select id="fwBlockOnSuccess" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
                                            <option value="true" selected>Yes</option>
                                            <option value="false">No (require failed login)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Velocity Conditions -->
                            <div id="fwVelocityConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Velocity / DDoS Conditions</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 4px solid #d32f2f; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #b71c1c; margin-bottom: 6px;">How it works</div>
                                    <div style="font-size: 10px; color: #c62828; line-height: 1.5;">
                                        Detects <strong>rapid-fire attacks</strong> by counting events per second. Blocks IPs sending too many requests too quickly (DDoS/automated attacks).
                                    </div>
                                    <div style="font-size: 10px; color: #b71c1c; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #ef9a9a;">
                                        <strong>Example:</strong> IP sends 25 login requests in 60 seconds (automated script) ‚Üí Blocked for DDoS-like behavior
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Max Events</label>
                                        <input type="number" id="fwMaxEvents" value="20" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 4px;">Time Window (seconds)</label>
                                        <input type="number" id="fwTimeWindowSeconds" value="60" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- Repeat Offender Conditions -->
                            <div id="fwRepeatConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Repeat Offender Escalation</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border-left: 4px solid #7b1fa2; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #4a148c; margin-bottom: 6px;">How it works</div>
                                    <div style="font-size: 10px; color: #6a1b9a; line-height: 1.5;">
                                        <strong>Increases block duration</strong> for IPs that keep coming back. Each offense gets a longer ban. Persistent attackers get permanently blocked.
                                    </div>
                                    <div style="font-size: 10px; color: #4a148c; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #ce93d8;">
                                        <strong>Escalation:</strong> 1st = base duration, 2nd = 2 days, 3rd = 7 days, 4th+ = 30 days
                                    </div>
                                </div>
                            </div>
                            <!-- Distributed Brute Force Conditions -->
                            <div id="fwDistributedBFConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Distributed Brute Force Detection</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-left: 4px solid #e65100; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #bf360c; margin-bottom: 6px;">How it works (ML + API Enhanced)</div>
                                    <div style="font-size: 10px; color: #d84315; line-height: 1.5;">
                                        Detects <strong>botnet-style attacks</strong> where many different IPs try many different usernames with LOW frequency per IP (to evade simple rate limits).
                                    </div>
                                    <div style="font-size: 10px; color: #d84315; margin-top: 6px;">
                                        <strong>ML Enhancement:</strong> Calculates "pattern score" based on IP distribution + username diversity + timing patterns<br>
                                        <strong>API Enhancement:</strong> Checks if participating IPs are known threat actors via AbuseIPDB
                                    </div>
                                    <div style="font-size: 10px; color: #bf360c; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #ffcc80;">
                                        <strong>Example:</strong> 8 different IPs each try 2-3 attempts on 15 different usernames in 1 hour ‚Üí Pattern detected as coordinated botnet attack ‚Üí All IPs blocked
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique IPs</label>
                                        <input type="number" id="fwDistBFUniqueIPs" value="5" min="2" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique Usernames</label>
                                        <input type="number" id="fwDistBFUniqueUsernames" value="10" min="3" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Time Window (min)</label>
                                        <input type="number" id="fwDistBFTimeWindow" value="60" min="10" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Max Attempts/IP (slow)</label>
                                        <input type="number" id="fwDistBFMaxPerIP" value="3" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>
                            <!-- Account Takeover Conditions -->
                            <div id="fwAccountTakeoverConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Account Takeover Detection</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #2e7d32; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #1b5e20; margin-bottom: 6px;">How it works (GeoIP + API Enhanced)</div>
                                    <div style="font-size: 10px; color: #2e7d32; line-height: 1.5;">
                                        Detects <strong>credential stuffing</strong> where the SAME username is being tried from MULTIPLE IPs/countries in a short time (leaked credentials being tested globally).
                                    </div>
                                    <div style="font-size: 10px; color: #2e7d32; margin-top: 6px;">
                                        <strong>GeoIP Enhancement:</strong> Uses geolocation to detect geographic diversity (impossible travel)<br>
                                        <strong>API Enhancement:</strong> Weights threat score higher if attacking IPs have bad AbuseIPDB reputation
                                    </div>
                                    <div style="font-size: 10px; color: #1b5e20; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #a5d6a7;">
                                        <strong>Example:</strong> Username "john.doe" gets login attempts from USA, Russia, and China within 30 mins ‚Üí Credential likely leaked on dark web ‚Üí Block all attacking IPs
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique IPs/Username</label>
                                        <input type="number" id="fwATOUniqueIPs" value="3" min="2" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Unique Countries</label>
                                        <input type="number" id="fwATOUniqueCountries" value="2" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Time Window (min)</label>
                                        <input type="number" id="fwATOTimeWindow" value="30" min="5" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; padding-top: 18px;">
                                        <input type="checkbox" id="fwATOCheckThreatIntel" checked>
                                        <label for="fwATOCheckThreatIntel" style="font-size: 11px;">Use Threat Intel</label>
                                    </div>
                                </div>
                            </div>
                            <!-- Off-Hours Anomaly Conditions -->
                            <div id="fwOffHoursConditions" style="display: none; padding: 12px; background: var(--background); border-radius: 4px;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 10px;">Off-Hours Anomaly Detection</div>
                                <!-- Sticky Note Help -->
                                <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border-left: 4px solid #00838f; padding: 10px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                                    <div style="font-size: 11px; font-weight: 600; color: #006064; margin-bottom: 6px;">How it works (Baseline + API Enhanced)</div>
                                    <div style="font-size: 10px; color: #00838f; line-height: 1.5;">
                                        Detects login attempts <strong>outside business hours</strong> or on weekends. Compares against each user's historical login patterns to detect anomalies.
                                    </div>
                                    <div style="font-size: 10px; color: #00838f; margin-top: 6px;">
                                        <strong>Baseline Learning:</strong> Learns each user's typical login hours from 30-day history<br>
                                        <strong>API Enhancement:</strong> Multiplies threat score if IP has bad reputation (1.5x-2x multiplier)
                                    </div>
                                    <div style="font-size: 10px; color: #006064; margin-top: 8px; padding-top: 6px; border-top: 1px dashed #80deea;">
                                        <strong>Example:</strong> User "admin" normally logs in 9am-5pm. Attempt at 3am from suspicious IP (AbuseIPDB: 45) ‚Üí Flagged as potential compromise ‚Üí Require approval before block
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Work Start Hour</label>
                                        <input type="number" id="fwOffHoursStart" value="8" min="0" max="23" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Work End Hour</label>
                                        <input type="number" id="fwOffHoursEnd" value="18" min="0" max="23" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 11px; margin-bottom: 3px;">Min Off-Hours Attempts</label>
                                        <input type="number" id="fwOffHoursMinAttempts" value="3" min="1" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                                    </div>
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 16px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" id="fwOffHoursCheckBaseline" checked>
                                        <label for="fwOffHoursCheckBaseline" style="font-size: 11px;">Check User Baseline</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" id="fwOffHoursRequireApproval" checked>
                                        <label for="fwOffHoursRequireApproval" style="font-size: 11px;">Require Approval</label>
                                    </div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Block Duration (min)</label>
                                    <input type="number" id="fwRuleBlockDuration" value="1440" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Priority</label>
                                    <input type="number" id="fwRulePriority" value="50" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px;">Description</label>
                                <textarea id="fwRuleDescription" placeholder="Rule description..." style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; min-height: 60px; box-sizing: border-box;"></textarea>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button id="fwSubmitCreateRule" style="padding: 8px 16px; background: var(--azure-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    Create Rule
                                </button>
                                <button id="fwCancelRuleForm" style="padding: 8px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 13px;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Rules Table -->
                    <div class="card">
                        <div id="fwRulesLoading" style="text-align: center; padding: 30px; color: var(--text-secondary);">
                            Loading blocking rules...
                        </div>
                        <div id="fwRulesTable" style="display: none;">
                            <div class="table-wrapper" style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px; min-width: 700px;">
                                    <thead>
                                        <tr style="background: var(--background); border-bottom: 2px solid var(--border);">
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Rule Name</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Type</th>
                                            <th style="padding: 10px; text-align: center; font-weight: 600;">Priority</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Conditions</th>
                                            <th style="padding: 10px; text-align: left; font-weight: 600;">Stats</th>
                                            <th style="padding: 10px; text-align: center; font-weight: 600;">Status</th>
                                            <th style="padding: 10px; text-align: right; font-weight: 600;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fwRulesTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="fwRulesEmpty" style="display: none; text-align: center; padding: 30px; color: var(--text-secondary);">
                            No blocking rules configured
                        </div>
                        <div id="fwRulesError" style="display: none; text-align: center; padding: 30px; color: #D13438;">
                            Error loading blocking rules
                        </div>
                    </div>
                </div>
        </div>

    </div>

    <!-- Recent Activity Backdrop -->
    <div id="recentActivityBackdrop" class="activity-backdrop" onclick="closeRecentActivityPanel()"></div>

    <!-- Recent Activity Slide-out Panel -->
    <div id="recentActivityPanel" class="activity-slide-panel">
        <div class="activity-panel-header">
            <h3>üìã Recent Activity</h3>
            <button onclick="closeRecentActivityPanel()" class="activity-panel-close">‚úï</button>
        </div>
        <div class="activity-panel-filters">
            <select id="logTypeFilter" onchange="filterRecentLogs()">
                <option value="all">All Activity</option>
                <option value="failed">Failed Logins</option>
                <option value="success">Successful Logins</option>
            </select>
            <button class="fw-btn fw-btn-secondary" onclick="loadRecentLogs(window.currentAgentId)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            </button>
        </div>
        <div class="activity-panel-content">
            <div id="recentLogsLoading" class="fw-loading">
                <div class="fw-spinner fw-spinner-lg"></div>
                <p style="margin-top:12px">Loading activity...</p>
            </div>
            <div id="recentLogsContainer" style="display: none;">
                <div id="recentLogsList"></div>
            </div>
            <div id="noLogsMessage" class="fw-empty" style="display: none; padding: 30px;">
                <div class="fw-empty-icon">üìù</div>
                <p class="fw-empty-text">No recent activity</p>
                <p style="font-size:12px;color:var(--text-hint);margin-top:8px">Select a server to view activity</p>
            </div>
        </div>
    </div>

    <!-- Block IP Modal -->
    <div id="blockIPModal" class="fw-modal-overlay" style="display: none;">
        <div class="fw-modal" style="width: 450px;">
            <div class="fw-modal-header">
                <h3>üö´ Block IP Address</h3>
                <button class="fw-modal-close" onclick="closeBlockIPModal()">‚úï</button>
            </div>
            <div class="fw-modal-body">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">IP ADDRESS (IPv4)</label>
                        <div id="ipInputContainer" style="display: flex; align-items: center; border: 2px solid var(--border); border-radius: 6px; padding: 8px 12px; background: var(--surface); gap: 4px;">
                            <input type="text" id="ipOctet1" class="ip-octet" maxlength="3" placeholder="192"
                                   style="width: 50px; border: none; text-align: center; font-size: 16px; font-family: monospace; background: transparent; outline: none;">
                            <span style="font-size: 20px; font-weight: bold; color: var(--text-secondary);">.</span>
                            <input type="text" id="ipOctet2" class="ip-octet" maxlength="3" placeholder="168"
                                   style="width: 50px; border: none; text-align: center; font-size: 16px; font-family: monospace; background: transparent; outline: none;">
                            <span style="font-size: 20px; font-weight: bold; color: var(--text-secondary);">.</span>
                            <input type="text" id="ipOctet3" class="ip-octet" maxlength="3" placeholder="1"
                                   style="width: 50px; border: none; text-align: center; font-size: 16px; font-family: monospace; background: transparent; outline: none;">
                            <span style="font-size: 20px; font-weight: bold; color: var(--text-secondary);">.</span>
                            <input type="text" id="ipOctet4" class="ip-octet" maxlength="3" placeholder="100"
                                   style="width: 50px; border: none; text-align: center; font-size: 16px; font-family: monospace; background: transparent; outline: none;">
                        </div>
                        <input type="hidden" id="quickBlockIP" value="">
                    </div>

                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">TARGET AGENT/SERVER</label>
                        <input type="hidden" id="quickBlockAgentId" value="">
                        <div id="quickBlockAgentDisplay" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface-alt, #f5f5f5); color: var(--text-primary);">
                            --
                        </div>
                    </div>

                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">BLOCK METHOD</label>
                        <select id="quickBlockMethod" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface);">
                            <option value="ufw" selected>UFW Firewall</option>
                            <option value="fail2ban">Fail2ban</option>
                        </select>
                        <input type="hidden" id="quickBlockDuration" value="0">
                    </div>

                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">REASON (Optional)</label>
                        <input type="text" id="quickBlockReason" placeholder="e.g., Suspicious activity" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; background: var(--surface);">
                    </div>

                    <button onclick="quickBlockIP()" style="padding: 14px 24px; background: #D13438; color: white; border: none; border-radius: 4px; font-size: 15px; font-weight: 600; cursor: pointer;">
                        üö´ Block IP Address
                    </button>

                    <div id="quickBlockMessage" style="display: none; padding: 12px; border-radius: 4px; font-size: 13px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firewall Simple Page Styles -->
<link rel="stylesheet" href="/static/css/pages/firewall_simple.css">

<!-- Firewall Simple Page Inline Scripts -->
<!-- Note: firewall_simple.js, firewall_ufw.js, firewall_fail2ban.js are loaded by dashboard_modular.html -->
<script src="/static/js/modules/firewall_utils.js?v=3.0.1"></script>
<script src="/static/js/modules/firewall_rules.js?v=3.0.1"></script>
<script src="/static/js/modules/firewall_detail.js?v=3.0.1"></script>
<script src="/static/js/modules/firewall_inline.js?v=3.0.60"></script>

