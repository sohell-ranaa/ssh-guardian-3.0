<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH Guardian v3.0</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <!-- Modular CSS -->
    <link rel="stylesheet" href="/static/css/dashboard-modular.css">
    <!-- Shared Component CSS -->
    <link rel="stylesheet" href="/static/css/components/events-table.css">
    <link rel="stylesheet" href="/static/css/components/cell-badges.css">
    <link rel="stylesheet" href="/static/css/components/analysis-modal.css">
    <!-- Page-specific CSS -->
    <link rel="stylesheet" href="/static/css/pages/firewall_simple.css">
    <link rel="stylesheet" href="/static/css/pages/simulation.css">
    <link rel="stylesheet" href="/static/css/pages/ml_training.css">
    <link rel="stylesheet" href="/static/css/pages/dashboard_analytics.css">
    <link rel="stylesheet" href="/static/css/pages/events_live.css">
</head>
<body>
    <!-- Top Bar -->
    {% include 'components/topbar.html' %}

    <!-- Sidebar -->
    {% include 'components/sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="content-wrapper">
            <!-- Page Templates -->
            {% include 'pages/overview.html' %}
            {% include 'pages/dashboard_analytics.html' %}
            {% include 'pages/events_live.html' %}
            {% include 'pages/blocked_ips.html' %}
            {% include 'pages/events_timeline.html' %}
            {% include 'pages/agents_page.html' %}
            {% include 'pages/ip_blocks.html' %}
            {% include 'pages/ip_intelligence.html' %}
            {% include 'pages/rules.html' %}
            {% include 'pages/settings_general.html' %}
            {% include 'pages/settings_integrations.html' %}
            {% include 'pages/settings_api.html' %}
            {% include 'pages/users.html' %}
            {% include 'pages/audit.html' %}
            {% include 'pages/notif_rules.html' %}
            {% include 'pages/notif_history.html' %}
            {% include 'pages/notif_channels.html' %}
            {% include 'pages/email_routing.html' %}
            {% include 'pages/reports_daily.html' %}
            {% include 'pages/reports_trends.html' %}
            {% include 'pages/reports_export.html' %}
            {% include 'pages/simulation.html' %}
            {% include 'pages/firewall_simple.html' %}
            {% include 'pages/fail2ban.html' %}
            {% include 'pages/trusted_ips.html' %}

            <!-- ML Intelligence Pages (Consolidated v3.2) -->
            {% include 'pages/ml_overview.html' %}
            {% include 'pages/ml_benefits.html' %}

            <!-- Other pages will be loaded dynamically -->
            <div id="dynamic-content" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Load user info
        fetch('/auth/me',{credentials:'same-origin'})
            .then(r=>{if(!r.ok){window.location.href='/login';throw new Error('Not authenticated');}return r.json();})
            .then(d=>document.getElementById('userName').textContent=d.user.full_name)
            .catch(e=>console.error('Error loading user:',e));

        // Logout
        document.getElementById('logoutBtn').addEventListener('click',async()=>{
            try{const r=await fetch('/auth/logout',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'same-origin'});if(r.ok)window.location.href='/login';}
            catch(e){console.error('Logout error:',e);}
        });

        // Sidebar
        const sidebar=document.getElementById('sidebar');
        const mainContent=document.getElementById('mainContent');
        const sidebarOverlay=document.getElementById('sidebarOverlay');
        const isMobile=()=>window.innerWidth<=768;
        let wasMobile=isMobile();

        // Collapse sidebar on mobile by default
        if(isMobile()){
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
        }

        // Handle resize - only when crossing breakpoint
        window.addEventListener('resize',()=>{
            const nowMobile=isMobile();
            if(nowMobile!==wasMobile){
                wasMobile=nowMobile;
                if(nowMobile){
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                    sidebarOverlay.classList.remove('active');
                }else{
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                    sidebarOverlay.classList.remove('active');
                }
            }
        });

        function toggleSidebar(){
            const isCollapsed=sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded',isCollapsed);
            if(isMobile())sidebarOverlay.classList.toggle('active',!isCollapsed);
        }

        function closeSidebar(){
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
            sidebarOverlay.classList.remove('active');
        }

        document.getElementById('menuToggle').addEventListener('click',toggleSidebar);
        sidebarOverlay.addEventListener('click',closeSidebar);

        // Page loaders map
        const pageLoaders={
            'overview':'loadOverviewPage',
            'dashboard':'loadDashboardAnalytics',
            'events-live':'loadEventsLivePage',
            'agents':'loadAgentsPage',
            'ip-intel':'loadIPIntelPage',
            'ip-blocks':'loadBlockedIPsPage',
            'rules':'loadBlockingRulesPage',
            'blocked-ips':'initBlockedIpsPage',
            'events-timeline':'loadEventsTimelinePage',
            'settings-general':'loadSettingsGeneralPage',
            'settings-integrations':'loadSettingsIntegrationsPage',
            'settings-api':'loadSettingsApiPage',
            'users':'loadUsersPage',
            'audit':'loadAuditPage',
            'notif-rules':'loadNotificationRulesPage',
            'notif-history':'loadNotificationHistoryPage',
            'notif-channels':'loadNotificationChannelsPage',
            'email-routing':'loadEmailRoutingPage',
            'reports-daily':'loadDailyReportsPage',
            'reports-trends':'loadTrendsReportsPage',
            'reports-export':'loadReportsExportPage',
            'ml-overview':'loadMLOverview',
            'ml-benefits':'loadBenefitsReport',
            'system-status':'loadSystemStatusPage',
            'firewall':'initFirewallPage',
            'fail2ban':'loadFail2banPage',
            'trusted-ips':'loadTrustedIPsPage'
        };

        // Page titles for browser tab
        const pageTitles={
            'overview':'Overview',
            'dashboard':'Analytics Dashboard',
            'events-live':'Live Events',
            'agents':'Agents',
            'ip-intel':'IP Intelligence',
            'ip-blocks':'IP Blocks',
            'rules':'Blocking Rules',
            'blocked-ips':'Blocked IPs',
            'events-timeline':'Events Timeline',
            'settings-general':'General Settings',
            'settings-integrations':'Integrations',
            'settings-api':'API Settings',
            'users':'User Management',
            'audit':'Audit Log',
            'notif-rules':'Notification Rules',
            'notif-history':'Notification History',
            'notif-channels':'Notification Channels',
            'email-routing':'Email Routing',
            'reports-daily':'Daily Reports',
            'reports-trends':'Trends Reports',
            'reports-export':'Export Reports',
            'ml-overview':'ML Overview & Models',
            'ml-benefits':'ML Benefits & Comparison',
            'system-status':'System Status',
            'firewall':'Firewall',
            'fail2ban':'Fail2ban',
            'trusted-ips':'Trusted IPs'
        };

        // Page navigation
        function showPage(pageName){
            const basePageName=pageName.split('?')[0];
            document.querySelectorAll('.page-content').forEach(p=>{p.style.display='none';p.classList.remove('active');});

            const pageId='page-'+basePageName;
            const page=document.getElementById(pageId);
            if(!page)return;

            page.style.display='block';
            page.classList.add('active');

            // Update browser tab title
            const pageTitle=pageTitles[basePageName]||basePageName.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
            document.title=pageTitle+' | SSH Guardian';

            // Update nav
            document.querySelectorAll('.nav-item,.nav-subitem').forEach(n=>n.classList.remove('active'));
            const navItem=document.querySelector(`[data-page="${basePageName}"]`);
            if(navItem){
                navItem.classList.add('active');
                const parentSubmenu=navItem.closest('.nav-submenu');
                if(parentSubmenu){
                    parentSubmenu.classList.add('show');
                    const parentItem=document.querySelector(`[data-submenu="${parentSubmenu.id.replace('submenu-','')}"]`);
                    if(parentItem)parentItem.classList.add('expanded');
                }
            }

            // Call page loader
            const loader=pageLoaders[basePageName];
            if(loader&&typeof window[loader]==='function')window[loader]();
        }

        // Collapse all submenus except the one to keep open
        function collapseAllSubmenus(exceptSubmenuId){
            document.querySelectorAll('.nav-item[data-submenu]').forEach(item=>{
                const submenuId='submenu-'+item.dataset.submenu;
                const submenu=document.getElementById(submenuId);
                if(submenu && submenuId!==exceptSubmenuId){
                    item.classList.remove('expanded');
                    submenu.classList.remove('show');
                }
            });
        }

        // Nav click handlers for items with data-page (no submenu)
        document.querySelectorAll('.nav-item[data-page],.nav-subitem[data-page]').forEach(item=>{
            item.addEventListener('click',()=>{
                const pageName=item.dataset.page||'overview';
                window.location.hash=pageName;
                showPage(pageName);

                // If clicking a subitem, keep its parent expanded; otherwise collapse all
                const parentSubmenu=item.closest('.nav-submenu');
                if(parentSubmenu){
                    collapseAllSubmenus(parentSubmenu.id);
                }else{
                    // Clicking a top-level item without submenu - collapse all
                    collapseAllSubmenus(null);
                }

                if(isMobile())closeSidebar();
            });
        });

        // Parent menu items with submenu - click expands and navigates to first child
        document.querySelectorAll('.nav-item[data-submenu]').forEach(item=>{
            item.addEventListener('click',()=>{
                const submenuId='submenu-'+item.dataset.submenu;
                const submenu=document.getElementById(submenuId);
                if(submenu){
                    // Collapse all other submenus first
                    collapseAllSubmenus(submenuId);

                    // Expand this submenu
                    item.classList.add('expanded');
                    submenu.classList.add('show');

                    // Navigate to first child page
                    const firstChild=submenu.querySelector('.nav-subitem[data-page]');
                    if(firstChild){
                        const pageName=firstChild.dataset.page;
                        window.location.hash=pageName;
                        showPage(pageName);
                        if(isMobile())closeSidebar();
                    }
                }
            });
        });

        // Default landing page
        let defaultLandingPage='overview';

        async function handleHash(){
            let hash=window.location.hash.substring(1);
            if(!hash){
                try{
                    const r=await fetch('/api/dashboard/settings/navigation');
                    const d=await r.json();
                    if(d.success&&d.data?.default_landing_page)defaultLandingPage=d.data.default_landing_page;
                }catch(e){}
                hash=defaultLandingPage;
                window.location.hash=hash;
                return;
            }
            showPage(hash);
        }

        window.addEventListener('hashchange',()=>{const hash=window.location.hash.substring(1);if(hash)showPage(hash);});
        window.loadCurrentPage=()=>showPage(window.location.hash.substring(1)||'overview');

        // Quick actions
        async function quickBlock(ipAddress,reason='Blocked from events view'){
            if(!confirm(`Block IP ${ipAddress}?\n\nReason: ${reason}`))return;
            try{
                const r=await fetch('/api/dashboard/blocking/blocks/manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ip_address:ipAddress,reason:reason,duration_minutes:1440})});
                const d=await r.json();
                if(d.success){
                    alert(`IP ${ipAddress} blocked successfully!`);
                    const h=window.location.hash.substring(1);
                    if(h==='ip-blocks'&&typeof loadBlockedIPsPage==='function')loadBlockedIPsPage();
                    else if(h==='firewall'&&typeof loadBlockedIPs==='function')loadBlockedIPs();
                }else{
                    if(d.message?.includes('already blocked')){
                        if(confirm(`IP ${ipAddress} is already blocked!\n\nView blocked IPs?`)){window.location.hash='firewall';showPage('firewall');setTimeout(()=>{if(typeof switchFirewallTab==='function')switchFirewallTab('blocked');},300);}
                    }else alert(`Failed to block IP: ${d.message||d.error||'Unknown error'}`);
                }
            }catch(e){console.error('Error blocking IP:',e);alert('Error blocking IP.');}
        }

        async function quickUnblock(ipAddress){
            if(!confirm(`Unblock IP ${ipAddress}?`))return;
            try{
                const r=await fetch('/api/dashboard/blocking/blocks/unblock',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ip_address:ipAddress,reason:'Quick unblock from dashboard'})});
                const d=await r.json();
                if(d.success){alert(d.message);if(typeof loadBlockedIPsPage==='function')loadBlockedIPsPage();}
                else alert(`Failed to unblock IP: ${d.error||'Unknown error'}`);
            }catch(e){console.error('Error unblocking IP:',e);alert('Error unblocking IP.');}
        }
    </script>

    <!-- Global Footer -->
    {% include 'components/footer.html' %}

    <!-- JavaScript Modules -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/utils/dashboard-utils.js"></script>
    <script src="/static/js/modules/toast.js"></script>
    <script src="/static/js/modules/notification_poller.js"></script>
    <script src="/static/js/modules/utils.js"></script>
    <script src="/static/js/modules/agents.js"></script>
    <script src="/static/js/modules/ip_intel_page.js"></script>
    <script src="/static/js/modules/blocking_rules_page.js"></script>
    <script src="/static/js/modules/blocked_ips_logins.js?v=3.0.1"></script>
    <script src="/static/js/modules/blocked_ips_page.js?v=3.0.6"></script>
    <script src="/static/js/modules/event_actions.js?v=3.0.1"></script>
    <script src="/static/js/modules/event_actions_analysis.js?v=3.0.1"></script>
    <!-- events_live JS is now inline in events_live.html -->
    <script src="/static/js/modules/events_timeline_page.js"></script>
    <script src="/static/js/modules/events_analysis_page.js?v=3.0.1"></script>
    <script src="/static/js/modules/events_analysis_table.js?v=3.0.1"></script>
    <script src="/static/js/modules/time_settings.js"></script>
    <script src="/static/js/modules/settings_general_page.js"></script>
    <script src="/static/js/modules/settings_integrations_page.js"></script>
    <script src="/static/js/modules/settings_api_page.js"></script>
    <script src="/static/js/modules/users_page.js"></script>
    <script src="/static/js/modules/audit_page.js"></script>
    <script src="/static/js/modules/notification_rules_page.js?v=3.1.0"></script>
    <script src="/static/js/modules/notification_history_page.js?v=3.1.0"></script>
    <script src="/static/js/modules/notification_channels_page.js?v=3.1.0"></script>
    <script src="/static/js/modules/email_routing_page.js?v=3.1.0"></script>
    <script src="/static/js/modules/daily_reports_page.js"></script>
    <script src="/static/js/modules/trends_reports_page.js"></script>
    <script src="/static/js/modules/firewall_simple.js?v=3.0.60"></script>
    <script src="/static/js/modules/sync_indicator.js?v=3.0.1"></script>
    <script src="/static/js/modules/firewall_ufw.js?v=3.0.63"></script>
    <script src="/static/js/modules/firewall_fail2ban_actions.js?v=3.0.66"></script>
    <script src="/static/js/modules/firewall_fail2ban.js?v=3.0.66"></script>
    <script src="/static/js/modules/firewall_page.js?v=3.0.7"></script>
    <script src="/static/js/modules/firewall_page_extended.js?v=3.0.2"></script>
    <!-- firewall_inline.js is loaded from firewall_simple.html page template to avoid double-loading -->
    <script src="/static/js/modules/ml-reasoning.js?v=3.0.1"></script>
    <script src="/static/js/modules/simulation_core.js?v=3.0.2"></script>
    <script src="/static/js/modules/simulation_scenarios.js?v=3.0.1"></script>
    <script src="/static/js/modules/simulation.js?v=3.0.54"></script>
    <script src="/static/js/modules/simulation_targets.js?v=3.0.1"></script>
    <script src="/static/js/modules/ml_training.js"></script>
    <script src="/static/js/modules/dashboard_analytics.js"></script>
    <script src="/static/js/modules/notification_pane.js"></script>
    <script src="/static/js/modules/trusted_ips_page.js"></script>

    <script>
        // Initialize global components
        if (window.HardReload) {
            window.HardReload.init();
        }

        // Initialize page after all scripts loaded
        if(document.readyState==='loading'){
            document.addEventListener('DOMContentLoaded',()=>setTimeout(handleHash,50));
        }else{
            setTimeout(handleHash,50);
        }
    </script>
</body>
</html>
