# SSH Guardian v3.0 - Database Connection Reference

**Last Updated:** 2025-12-04

---

## Connection Details

**Database:** ssh_guardian_v3
**MySQL Version:** 9.5.0
**Host:** localhost (Docker container)
**Port:** 3306 (default)
**User:** root
**Password:** 123123

**Connection Method:** Connection pooling via `dbs/connection.py`
- Pool size: 30 connections
- Auto-reconnect enabled
- Used in all Python scripts

---

## Important: MySQL is in Docker

MySQL is running in a Docker container, so standard `mysql` command-line tool won't work directly.

### Access MySQL Console (via Docker):

```bash
# Find MySQL container
docker ps | grep mysql

# Access MySQL console
docker exec -it <container-name> mysql -u root -p123123 ssh_guardian_v3

# Quick query
docker exec -it <container-name> mysql -u root -p123123 ssh_guardian_v3 -e "SELECT COUNT(*) FROM auth_events;"
```

### Use Python Scripts Instead:

For database operations, **always use Python scripts** instead of mysql CLI:

```bash
# Check database schema
python3 scripts/db_schema_check.py

# Verify events
python3 scripts/verify_event.py

# Create test agent
python3 scripts/create_test_agent.py

# Any custom query
# Create a script in scripts/ folder using connection.py
```

---

## Python Connection Usage

```python
import sys
from pathlib import Path

# Add project paths
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.append(str(PROJECT_ROOT / "dbs"))

from connection import get_connection

# Get connection from pool
conn = get_connection()
cursor = conn.cursor(dictionary=True)

try:
    cursor.execute("SELECT * FROM agents LIMIT 1")
    result = cursor.fetchone()
    print(result)
finally:
    cursor.close()
    conn.close()
```

---

## Important Tables Reference

### agents
- **Primary Key:** `id` (int)
- **Unique:** `agent_uuid`, `agent_id`, `api_key`
- **Key Fields:** `display_name`, `hostname`, `status`, `is_active`
- ⚠️ **Note:** Column is `display_name` NOT `agent_name`

### auth_events
- **Primary Key:** `id` (bigint)
- **Unique:** `event_uuid`
- **Key Fields:**
  - `event_type` (enum: 'failed', 'successful', 'invalid')
  - `target_username` (NOT `username`)
  - `target_server` (NOT `hostname`)
  - `target_port` (NOT `port`)
  - `raw_log_line` (NOT `raw_log`)
  - `source_ip` (VARBINARY)
  - `source_ip_text` (VARCHAR)

### ip_geolocation
- **Primary Key:** `id` (int)
- **Unique:** `ip_address` (VARBINARY), `ip_address_text` (VARCHAR)
- **Key Fields:** `country_code`, `city`, `latitude`, `longitude`, `asn`

### ip_blocks
- **Primary Key:** `id` (int)
- **Key Fields:** `ip_address`, `block_reason`, `is_active`, `blocked_at`

### users
- **Primary Key:** `id` (int)
- **Unique:** `email`
- **Key Fields:** `email`, `full_name`, `role_id`, `is_active`

### user_sessions
- **Primary Key:** `id` (int)
- **Unique:** `session_token`
- **Key Fields:** `user_id`, `expires_at`, `last_activity`

---

## Common Queries

### Check event count
```python
cursor.execute("SELECT COUNT(*) as count FROM auth_events")
result = cursor.fetchone()
print(f"Total events: {result['count']}")
```

### Get recent events
```python
cursor.execute("""
    SELECT id, event_uuid, timestamp, source_ip_text, target_username, event_type
    FROM auth_events
    ORDER BY timestamp DESC
    LIMIT 10
""")
events = cursor.fetchall()
```

### Check agent status
```python
cursor.execute("""
    SELECT id, display_name, hostname, status, last_heartbeat
    FROM agents
    WHERE is_active = TRUE
""")
agents = cursor.fetchall()
```

---

## Schema Files

**Migration Files:** `dbs/migrations/`
- `001_initial_schema.sql` - Core tables
- `002_auth_and_system_tables.sql` - Auth and system tables
- `003_add_api_key_to_agents.sql` - API key for agents

**Current Schema:** `docs/CURRENT_DB_SCHEMA.txt`
- Generated by `scripts/db_schema_check.py`
- Shows all tables with column names, types, keys
- **Always check this file before writing queries**

**V3 Design:** `docs/V3_DATABASE_DESIGN.md`
- Original design document
- Table relationships and descriptions

---

## Environment Variables

Database connection is configured in `.env`:

```
DB_HOST=localhost
DB_PORT=3306
DB_NAME=ssh_guardian_v3
DB_USER=root
DB_PASSWORD=123123
DB_POOL_SIZE=30
```

Used by `dbs/connection.py` for connection pooling.

---

## Troubleshooting

### Connection Pool Errors
```bash
# Restart Python scripts to reset pool
# Connection pool is created on first import
```

### Docker MySQL Not Running
```bash
# Check Docker containers
docker ps

# Start MySQL container if needed
docker start <container-name>
```

### Wrong Column Names
```bash
# Always check schema first
python3 scripts/db_schema_check.py

# Reference: docs/CURRENT_DB_SCHEMA.txt
```

---

## Best Practices

1. **Always use connection.py** - Don't create raw connections
2. **Check schema first** - Run `db_schema_check.py` before queries
3. **Use Python scripts** - Not mysql CLI (Docker limitation)
4. **Close connections** - Use try/finally blocks
5. **Dictionary cursors** - `cursor(dictionary=True)` for easy access
6. **Binary IPs** - Use `ip_to_binary()` and `binary_to_ip()` helpers

---

## Quick Reference Scripts

```bash
# Activate venv
source /home/rana-workspace/ssh_guardian_2.0/venv/bin/activate

# Check schema
python3 scripts/db_schema_check.py

# Verify events
python3 scripts/verify_event.py

# Create test agent
python3 scripts/create_test_agent.py

# Check migration status
ls -la dbs/migrations/
```
